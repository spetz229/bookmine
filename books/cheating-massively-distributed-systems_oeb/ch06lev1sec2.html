---
layout: page
title: "Exploiting Online Games: Cheating Massively Distributed Systems"
prev: ch06lev1sec1.html
next: ch06lev1sec3.html
book_path: books/cheating-massively-distributed-systems_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<a name="toppage" class="pcalibre calibre1"></a><table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody"><tr valign="top" class="calibre2"><td class="calibre3"><a name="MainContent" class="pcalibre calibre1"></a><table width="95%" class="sfbody"><tr class="calibre2"><td class="pcalibre1 v"><!--Copyright (c) 2002 Safari Tech Books Online--><table width="100%" border="0" cellspacing="0" cellpadding="2" class="calibre4"><tr class="calibre2"><td valign="middle" class="v1 pcalibre1" height="5"><img src="pixel.gif" alt="" border="0" class="calibre5"/></td></tr><tr class="calibre2"><td valign="middle" class="v1 pcalibre1"><table cellpadding="0" cellspacing="0" border="0" width="100%" class="calibre4"><tr class="calibre2"><td class="calibre6"><span class="calibre7"> </span>
                   
                  <span class="calibre7">   </span>
             <span class="calibre7"> </span></td></tr></table></td><td class="calibre8"/><td valign="middle" class="v2 pcalibre1"> 
           
          <span class="calibre7"><a target="_self" href="ch06lev1sec1.html" title="Previous section" class="pcalibre calibre1"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre16"/></a></span>
				
				 
				
				<span class="calibre7"><a target="_self" href="ch06lev1sec3.html" title="Next section" class="pcalibre calibre1"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre16"/></a></span></td></tr></table><div id="section" class="calibre15"><table width="100%" border="0" cellspacing="0" cellpadding="0" class="calibre4"><tr class="calibre2"><td valign="top" class="calibre8">Security Game Programming Networking Programming Greg Hoglund Gary McGraw Addison Wesley Professional Exploiting Online Games: Cheating Massively Distributed Systems<a name="ch06lev1sec2" class="pcalibre calibre1"></a>
<h3 id="title-IDAAWFDP" class="docSection1Title">Countermeasures against Reverse Engineering</h3>
<p class="docText">Some game developers have gotten wise to the fact that hackers use disassemblers and debuggers to reverse engineer their games and have developed many countermeasures for use against them. These techniques <a name="iddle1022" class="pcalibre calibre1"></a><a name="iddle1383" class="pcalibre calibre1"></a><a name="iddle1384" class="pcalibre calibre1"></a><a name="iddle1807" class="pcalibre calibre1"></a><a name="iddle1819" class="pcalibre calibre1"></a><a name="iddle1895" class="pcalibre calibre1"></a><a name="iddle1953" class="pcalibre calibre1"></a><a name="iddle1969" class="pcalibre calibre1"></a><a name="iddle1972" class="pcalibre calibre1"></a><a name="iddle1978" class="pcalibre calibre1"></a><a name="iddle2192" class="pcalibre calibre1"></a>include obfuscating program code and interlacing runtime checks to see if a debugger is present. Hackers can counter almost all of these tricks, but they must know about them first. This is a classic computer security arms race.</p>
<a name="ch06lev2sec2" class="pcalibre calibre1"></a>
<h4 id="title-IDA3YFDP" class="docSection2Title">Packing</h4>
<p class="docText">One very easy countermeasure, and a popular one to boot, is <span class="docEmphasis">packing</span>. A packer changes the way the compiled binary looks on disk. If you try to import a packed binary into a disassembler, the disassembler is not likely to be able to read the file. Instead of getting program code when you disassemble, you simply get an error. In some cases, some of the program may be disassembled, but most of it will remain in data form with no translation back into code.</p>
<p class="docText">Packers can be countered by using <span class="docEmphasis">unpackers</span>. There are several universal unpackers available that understand and can undo most popular packing formats. These tools can't cope with custom packers, however. A program that has been packed with a custom packer will need to be read directly from memory instead. This technique requires the ability to read the executable image from memory after the program has launched. In most cases, the memory trawling technique works because packers need to unpack themselves before the program can run. The unpacked version will remain in memory and can be analyzed.</p>
<p class="docText">Another approach to the packing problem is to single-step trace the software as it runs and simply capture all the instructions. Assuming the program cannot detect that it's being traced, this approach allows you to recover many of the instructions so that they can be undone.</p>
<a name="ch06lev2sec3" class="pcalibre calibre1"></a>
<h4 id="title-IDATZFDP" class="docSection2Title">Anti-Debugging</h4>
<p class="docText">Programs can also use anti-debugging tricks to defeat reversing. These techniques amount to checking the system to see if a debugger is present—and doing weird things with exceptions if they are—in an attempt to get the debugger to handle an exception rather than forwarding it. The debugger detection flag is an easy trick and can be defeated by clearing the <tt class="calibre38">BeingDebugged</tt> flag from the process environment block (PEB).</p>
<a name="ch06lev3sec7" class="pcalibre calibre1"></a>
<h5 id="title-IDAB0FDP" class="docSection3Title">Altering Data in the PEB</h5>
<p class="docText">The following short snippet of code can be used to get the PEB base address for a program that is being debugged:</p>
<div class="docText1"><pre class="calibre43">DWORD GetPEBBase(HANDLE theProcessHandle)
{
       PROCESS_BASIC_INFORMATION pbi;

       DWORD len = sizeof(pbi);
</pre></div><br class="calibre15"/>
<p class="docText"><a name="iddle1061" class="pcalibre calibre1"></a>This function uses the native API call <tt class="calibre38">NtQueryInformationProcess</tt>:</p>
<div class="docText1"><pre class="calibre43">NtQueryInformationProcess(
               theProcessHandle,
               ProcessBasicInformation,
               &amp;pbi,
               len,
               NULL);

       return (DWORD)(pbi.PebBaseAddress);
}
</pre></div><br class="calibre15"/>
<p class="docText">Once the PEB is obtained, the next step is to simply clear the <tt class="calibre38">BeingDebugged</tt> flag. Remember that if you have attached as a debugger, you need to write the change to remote process memory, not to local memory. To do this, use the <tt class="calibre38">ReadProcessMemory</tt> and <tt class="calibre38">WriteProcessMemory</tt> functions:</p>
<div class="docText1"><pre class="calibre43">void ClearDebuggerPresentFlag(HANDLE theProcessHandle)
{
        DWORD pebBase = GetPEBBase(theProcessHandle);
        PEB aPeb;
        DWORD lpRead;
</pre></div><br class="calibre15"/>
<p class="docText">We make sure to read the PEB from the <span class="docEmphasis">remote</span> process:</p>
<div class="docText1"><pre class="calibre43">        ReadProcessMemory(
               theProcessHandle,
               (LPCVOID)pebBase,
               &amp;aPeb,
               sizeof(PEB),
               &amp;lpRead);
</pre></div><br class="calibre15"/>
<p class="docText">Once read, we can alter the structure as we want to:</p>
<div class="docText1"><pre class="calibre43">       aPeb.BeingDebugged = FALSE;</pre></div><br class="calibre15"/>
<p class="docText">And then write the altered version back to the remote process:</p>
<div class="docText1"><pre class="calibre43">       WriteProcessMemory(
              theProcessHandle,
              (LPVOID)pebBase,
              &amp;aPeb,
              sizeof(PEB),
              &amp;lpRead)
}
</pre></div><br class="calibre15"/>
<p class="docText"><a name="iddle1381" class="pcalibre calibre1"></a><a name="iddle1517" class="pcalibre calibre1"></a><a name="iddle1965" class="pcalibre calibre1"></a>This illustrates how to manipulate memory in the remote process. We cover this technique in more detail later.</p>
<a name="ch06lev3sec8" class="pcalibre calibre1"></a>
<h5 id="title-IDAY3FDP" class="docSection3Title">Forwarding Exceptions</h5>
<p class="docText">Many anti-debugging tricks rely on the fact that debuggers will not handle or forward exceptions properly. For example, a game program may throw a "divide by zero" exception on purpose to confuse the debugger. This exception would normally be thrown by a bug in the program, but in this case the program throws it on purpose to confuse things.</p>
<p class="docText">The game program sets up an exception handler that is supposed to be called when bugs like this occur. When the on-purpose bug is then thrown, the expectation is that the special exception handler will be called. If your debugger is attached, you will see the exception for the on-purpose bug—and if you treat it like a real bug, your debugger may try to handle the situation instead of forwarding the bug to the game program's special exception handler. Ultimately, this means that the game's exception handler doesn't get called, and the game will have subsequently detected your debugger by virtue of this fact.</p>
<p class="docText">Exception tricks like these are easy to defeat. All you need to remember is to forward all exceptions to the target program. Debugger events are forwarded to the program using the following call:</p>
<div class="docText1"><pre class="calibre43">ContinueDebugEvent(
       thePid,
       dbg_evt.dwThreadId,
       DBG_EXCEPTION_NOT_HANDLED);
</pre></div><br class="calibre15"/>
<p class="docText">The key is the <tt class="calibre38">DBG_EXCEPTION_NOT_HANDLED</tt> flag. This tells the debugger to forward the exception to the target program. The game program is then free to handle its own exceptions, as it should be. We cover the <tt class="calibre38">ContinueDebugEvent</tt> call in more detail in <a class="pcalibre6 pcalibre5 calibre1" href="ch07.html#ch07">Chapter 7</a>.</p>
<a name="ch06lev3sec9" class="pcalibre calibre1"></a>
<h5 id="title-IDAA5FDP" class="docSection3Title">Single-Step Timing</h5>
<p class="docText"><a name="iddle1375" class="pcalibre calibre1"></a><a name="iddle1974" class="pcalibre calibre1"></a><a name="iddle2063" class="pcalibre calibre1"></a>Another form of reversing detection is based on timing. In this case, the game program is set up to read the system time at normal intervals. If the time between samples grows beyond a defined threshold, the program will assume it's being debugged. This works because debuggers can slow a program down. The way to get around this kind of check is to avoid pausing the target game program and to avoid activity that slows the game considerably. Usually the thresholds are not very accurate, and as a result this kind of countermeasure is easy to defeat.</p>
<p class="docText">There are many more tricks for anti-debugging than the ones we have described here, but this gives you an idea of the kinds of challenges a budding game analyst may run across. As it turns out, some anti-debugging tricks can get very complex, and subsequently, defeating them also gets quite complex. What results is a constant game of cat and mouse.</p>
<p class="docText">The ultimate technique to date involves using virtual machines to perform debugging, but this requires a virtual machine that the game will work with. It also relies on the hope that the game doesn't try to detect that it's running in a VM.</p>
<ul class="calibre18"></ul></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2" class="calibre4"><tr class="calibre2"><td valign="middle" class="v1 pcalibre1" height="5"><img src="pixel.gif" alt="" border="0" class="calibre5"/></td></tr><tr class="calibre2"><td valign="middle" class="v1 pcalibre1"><table cellpadding="0" cellspacing="0" border="0" width="100%" class="calibre4"><tr class="calibre2"><td class="calibre6"><span class="calibre7"> </span>
                   
                  <span class="calibre7">   </span>
             <span class="calibre7"> </span></td></tr></table></td><td class="calibre8"/><td valign="middle" class="v2 pcalibre1"> 
           
          <span class="calibre7"><a target="_self" href="ch06lev1sec1.html" title="Previous section" class="pcalibre calibre1"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre16"/></a></span>
				
				 
				
				<span class="calibre7"><a target="_self" href="ch06lev1sec3.html" title="Next section" class="pcalibre calibre1"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre16"/></a></span></td></tr></table><table width="100%" border="0" cellspacing="0" cellpadding="2" class="calibre4"><tr class="calibre2"><td valign="top" class="calibre14"><span class="calibre7"></span></td></tr></table></div><!--IP User 2--></td></tr></table></td><td class="calibre3">
                         
                      </td></tr><tr class="calibre2"><td colspan="3" valign="bottom" class="calibre3"><br class="calibre15"/><p class="v5 pcalibre1"></p><br class="calibre15"/></td></tr></table></div>

{% endraw %}

