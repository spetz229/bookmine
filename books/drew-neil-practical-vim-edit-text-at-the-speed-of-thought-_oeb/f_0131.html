---
layout: page
title: "Practical Vim (for Kathryn Amaral)"
prev: f_0130.html
next: f_0132.html
book_path: books/drew-neil-practical-vim-edit-text-at-the-speed-of-thought-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>


<table class="arr-recipe" id="sec.substitute.in.project">
<tr class="calibre14">
<td class="arr-recipe-number">Tip 96</td>
<td class="arr-recipe-name">Find and Replace Across Multiple Files</td>
</tr>
</table>
<p id="N19FC6" class="calibre4">
<span class="calibre5">
        The substitute command operates on the current file. So what do we do if we want to make the same substitution throughout an entire project? Although this scenario is common, Vim doesn’t include a dedicated command for project-wide find and replace. We can get this functionality by combining a couple of Vim’s primitive commands. 
    </span>
</p>
<p id="N19FDA" class="calibre4">
      We’ll start with a crude but effective solution, and then we’ll look at how it can be refined. As a demonstration, we’ll use the <code class="cf">refactor-project</code> directory, which you can find in the source files that come distributed with this book. It contains the following files, reproduced here with their contents:
    </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​refactor-project/​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​  about.txt​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​  Pragmatic Vim is a hands-on guide to working with Vim.​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​  credits.txt​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​  Pragmatic Vim is written by Drew Neil.​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​  license.txt​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​  The Pragmatic Bookshelf holds the copyright for this book.​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​  extra/​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​    praise.txt​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​    What people are saying about Pragmatic Vim...​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​    titles.txt​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​    Other titles from the Pragmatic Bookshelf...​</code>​</div>
</td>
</tr>
</table>
<p id="N1A014" class="calibre4">
      Each of these files contains the word “Pragmatic,” either as part of the phrase “Pragmatic Bookshelf” or “Pragmatic Vim.” We’ll do a find and replace to change each occurrence of “Pragmatic Vim” to “Practical Vim” while leaving each occurrence of “Pragmatic Bookshelf” unchanged.
    </p>
<p id="N1A017" class="calibre4">
      If you’d like to follow along, download the source code from <span class="calibre5">Practical Vim</span>’s book page on the Pragmatic Bookshelf site. Before opening Vim, change to the <code class="cf">refactor-project</code> directory.
    </p>
<h3 class="calibre22">The Substitute Command</h3>
<p id="N1A024" class="calibre4">
        Let’s start by devising the substitute command. We want to compose a pattern that matches the word “Pragmatic” when it appears in the phrase “Pragmatic Vim” but not when it appears in the phrase “Pragmatic Bookshelf.” This pattern will do the trick:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">/Pragmatic\ze Vim</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A034" class="calibre4">
        This uses the <code class="cf">\ze</code> item to exclude the word “Vim” from the match (see <a xmlns:str="http://exslt.org/strings" href="f_0110.html#sec.pattern.zs">Tip 77</a>). Then we can run this substitute command:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:%s//Practical/g</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A050" class="calibre4">
        Next we just need to figure out how to execute that command across the entire project.
      </p>
<h3 class="calibre22">Execute a Substitute Command on All Files in the Current Project</h3>
<p id="N1A057" class="calibre4">
        In <a xmlns:str="http://exslt.org/strings" href="f_0061.html#sec.args">Tip 37</a>, we learned that the <code class="cf">:argdo</code> command allows us to run an Ex command in a set of files. We can use this technique to run the substitute command for all files in a project. But first, we must populate the argument list with all of those files by running this:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:args **/*.txt</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A080" class="calibre4">
        We should do one more thing before we continue. Run this:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:set hidden</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A090" class="calibre4">
        This setting enables us to navigate away from a modified file without first saving it. Refer to <a xmlns:str="http://exslt.org/strings" href="f_0061.html#sec.args">Tip 37</a>, for a more detailed discussion.
      </p>
<p id="N1A09C" class="calibre4">
        Now we can execute our substitution command in all of these files by running this:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:argdo %s//Practical/g</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>&lt;= </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​E486: Pattern not found: Pragmatic\ze Vim​</code>​</div>
</td>
</tr>
</table>
<p id="N1A0B0" class="calibre4">
        This gets the job done, but Vim reports a “Pattern not found” error in the output. Remember, some of the files that we’re working with contain the phrase “Pragmatic Bookshelf” but not “Pragmatic Vim.” So when the substitute command is executed in these files, Vim throws an error.
      </p>
<p id="N1A0B7" class="calibre4">
        The error message is just noise. Vim carries on regardless, executing the substitute command for each of the remaining files. It’s not critical, but it can be distracting, especially if we’re dealing with a larger list of files. Supplying the <code class="cf">e</code> flag to the substitute command will suppress these error messages. So we could instead run this:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:argdo %s//Practical/ge</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A0CA" class="calibre4">
        And this way presents fewer distractions.
      </p>
<p id="N1A0CD" class="calibre4">
        Let’s pause for a moment and think about what we’ve done. Running <code class="cf">:args **/*.txt</code> loads <span class="calibre5">all files</span> from the current project into the argument list. Then when we run <code class="cf">:argdo %s//Practical/ge</code>, Vim proceeds to execute the substitute command in every one of those files. Our example contains only a handful of buffers, but in a real-world situation, the list could number in the hundreds or thousands. Using this technique, we can be sure that we’ll hit our targets, but we also run the substitute command unnecessarily many times over. It’s a scatter-shot approach.
      </p>
<p id="N1A0D9" class="calibre4">
        Let’s see if we can tighten our focus.
      </p>
<h3 class="calibre22">Build a List of Files Containing Our Target Pattern</h3>
<p id="N1A0E0" class="calibre4">
        How about if we break the problem into two steps? First we’ll perform a project-wide search for our target pattern. Then we’ll run the substitute command on the files that returned a positive match.
      </p>
<p id="N1A0ED" class="calibre4">
        To perform a project-wide search, we’ll reach for the <code class="cf">:vimgrep</code> command (see <a xmlns:str="http://exslt.org/strings" href="f_0147.html#chp.grep">Chapter 18, ​<em class="calibre5">Search Project-Wide <br class="calibre1"/>with grep, vimgrep, and Others</em>​</a>). Since this uses Vim’s built-in search engine, we can reuse the exact same pattern. Try running this:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">/Pragmatic\ze Vim</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:vimgrep /&lt;C-r&gt;// **/*.txt</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A10E" class="calibre4">
        Pressing <span class="calibre17">&lt;C-r&gt;/</span> inserts the last search pattern. Again, we use the <code class="cf">**/*.txt</code> wildcard to tell <code class="cf">vimgrep</code> to look inside all files contained in the current directory.
      </p>
<p id="N1A11A" class="calibre4">
        Each match returned by <code class="cf">vimgrep</code> is recorded in the quickfix list (see <a xmlns:str="http://exslt.org/strings" href="f_0142.html#chp.quickfix">Chapter 17, ​<em class="calibre5">Compile Code and Navigate Errors <br class="calibre1"/>with the Quickfix List</em>​</a>). We can browse the results by running <code class="cf">:copen</code>, which opens the quickfix window. But instead of stepping through the results, one at a time, we want to run the substitute command on every file that appears in the quickfix list.
      </p>
<p id="N1A127" class="calibre4">
        It would be convenient if Vim included a <code class="cf">:quickfixdo</code> command, but there is no such thing. So instead we’ll use this small snippet of Vim script:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td colspan="2" class="calibre33">
<a href="http://media.pragprog.com/titles/dnvim/code/substitution/qargs.vim">substitution/qargs.vim</a>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">command</strong>! -nargs=0 -bar Qargs execute <em class="string">'args'</em> QuickfixFilenames()​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">function</strong>! QuickfixFilenames()​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​  <strong class="prompt">let</strong> buffer_numbers = {}​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​  <strong class="prompt">for</strong> quickfix_item in getqflist()​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​    <strong class="prompt">let</strong> buffer_numbers[quickfix_item[<em class="string">'bufnr'</em>]] = bufname(quickfix_item[<em class="string">'bufnr'</em>])​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​  <strong class="prompt">endfor</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​  <strong class="prompt">return</strong> <strong class="prompt">join</strong>(<strong class="prompt">map</strong>(values(buffer_numbers), <em class="string">'fnameescape(v:val)'</em>))​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">endfunction</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A177" class="calibre4">
        You can either add this code to your <code class="cf">vimrc</code> file or install it as a plugin.<a id="FNPTR-26" href="#FOOTNOTE-26">[26]</a>
</p>
<p id="N1A182" class="calibre4">
        Now we can run <code class="cf">:Qargs</code>, and it will populate the argument list with each of the files named in the quickfix list. If we run the substitute command in each of the files in the argument list now, we can be sure that it only includes the files that match our pattern. We can leave off the <code class="cf">e</code> flag, since we don’t anticipate the substitute command raising any errors.
      </p>
<p id="N1A18B" class="calibre4">
        Here’s the full sequence of commands:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">/Pragmatic\ze Vim</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:vimgrep /&lt;C-r&gt;// **/*.txt</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:Qargs</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:argdo %s//Practical/g</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:argdo update</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A1AF" class="calibre4">
        The <code class="cf">:update</code> command saves the file, but only if it has been changed (see <strong xmlns:str="http://exslt.org/strings" class="calibre10">update</strong>
<a xmlns:str="http://exslt.org/strings" href="http://vimdoc.sourceforge.net/htmldoc/editing.html#update">
<img alt="info" src="images/information.png" class="calibre21"/>​</a>). Note that the last three commands could be combined into one, like this:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:Qargs | argdo %s//Practical/g | update</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A1CB" class="calibre4">
        The <code class="cf">|</code> character has a different meaning on Vim’s command line than shell users might expect. Whereas in Unix, the pipe character passes standard output from one command into the standard input of the next command (creating a “pipeline”). On Vim’s command line, <code class="cf">|</code> simply stands for a command separator, making it equivalent to the semicolon in the Unix shell. Look up <strong xmlns:str="http://exslt.org/strings" class="calibre10">:bar</strong>
<a xmlns:str="http://exslt.org/strings" href="http://vimdoc.sourceforge.net/htmldoc/cmdline.html#:bar">
<img alt="info" src="images/information.png" class="calibre21"/>​</a> for more details.
      </p>
<p id="N1A1DF" class="calibre4">
        Previously we used a scatter-shot approach, where the substitute command was executed in every file in the project, whether or not that file contained our target pattern. This strategy is a refinement. We still have to look inside every file in the project, but this time we use <code class="cf">vimgrep</code> to do it. Then, with our custom <code class="cf">:Qargs</code> command, we copy each file from the quickfix list into the argument list. This allows us to be more focused when we run the substitute command, only targeting the files that contain a match for our pattern.
      </p>
<p id="N1A1E8" class="calibre4">
        A convenient side effect of this approach is that we are left with an argument list containing each file that was changed by the substitute command. If we want to review our changes, we can run <code class="cf">:first</code> and then step through the files by running <code class="cf">:next</code>.
      </p>

<div class="footnotes">
<h4 class="calibre20">Footnotes</h4>
<table cellspacing="3" class="table-of-contents">
<tr valign="top" class="calibre14">
<td class="footnote-number">
<a id="FOOTNOTE-25" href="f_0130.html#FNPTR-25">[25]</a>
</td>
<td class="calibre8">
<p id="N19F95" class="calibre4">
<a href="https://github.com/tpope/vim-abolish">https://github.com/tpope/vim-abolish</a>
</p>
</td>
</tr>
<tr valign="top" class="calibre14">
<td class="footnote-number">
<a id="FOOTNOTE-26" href="#FNPTR-26">[26]</a>
</td>
<td class="calibre8">
<p id="N1A17E" class="calibre4">
<a href="https://github.com/nelstrom/vim-qargs">https://github.com/nelstrom/vim-qargs</a>
</p>
</td>
</tr>
</table>
</div>
<div class="copyright">Copyright © 2012, The Pragmatic Bookshelf.</div>




<script src="scripts/book_local.js" type="text/javascript" class="calibre2"/>
</div>

{% endraw %}

