---
layout: page
title: "Practical Vim (for Kathryn Amaral)"
prev: f_0101.html
next: f_0103.html
book_path: books/drew-neil-practical-vim-edit-text-at-the-speed-of-thought-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>


<table class="arr-recipe" id="sec.macro.edit">
<tr class="calibre14">
<td class="arr-recipe-number">Tip 71</td>
<td class="arr-recipe-name">Edit the Contents of a Macro</td>
</tr>
</table>
<p id="N17E25" class="calibre4">
<span class="calibre5">
        In <a xmlns:str="http://exslt.org/strings" href="f_0099.html#sec.macro.append">Tip 68</a>, we saw that adding commands at the end of a macro is straightforward. But what if we want to remove the last command? Or change something at the beginning of the macro? In this tip, we’ll learn how to edit the content of a macro just as if it were plain text.
    </span>
</p>
<h3 class="calibre22">The Problem: Nonstandard Formatting</h3>
<p id="N17E3D" class="calibre4">
        Suppose that we’ve just followed the steps in <a xmlns:str="http://exslt.org/strings" href="f_0098.html#sec.macro.lines.record">​<em class="calibre5">Record One Unit of Work</em>​</a>, saving our keystrokes into register <code class="cf">a</code>. Now we’re faced with this file, which is formatted slightly differently:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td colspan="2" class="calibre33">
<a href="http://media.pragprog.com/titles/dnvim/code/macros/mixed-lines.txt">macros/mixed-lines.txt</a>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​1. One​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​2. Two​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​3. three​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​4. four​</code>​</div>
</td>
</tr>
</table>
<p id="N17E5D" class="calibre4">
        Some of the lines already use a capital letter; others use a lowercase letter. In our macro, we used the <span class="calibre17">~</span> command, which toggles the case of the letter under the cursor (see <strong xmlns:str="http://exslt.org/strings" class="calibre10">~</strong>
<a xmlns:str="http://exslt.org/strings" href="http://vimdoc.sourceforge.net/htmldoc/change.html#~">
<img alt="info" src="images/information.png" class="calibre21"/>​</a>). Instead of using <span class="calibre17">~</span>, let’s update the macro to use the command <span class="calibre17">vU</span>, which uppercases the letter under the cursor (see <strong xmlns:str="http://exslt.org/strings" class="calibre10">v_U</strong>
<a xmlns:str="http://exslt.org/strings" href="http://vimdoc.sourceforge.net/htmldoc/change.html#v_U">
<img alt="info" src="images/information.png" class="calibre21"/>​</a>).
      </p>
<div class="sidebar" id="sidebar.macro.keycodes">
<div class="sidebar-title">Keyboard Codes in Macros</div>
<div class="calibre1">
<p id="N17E8F" class="calibre4">
	  In this example, we are working with a relatively simple register. But things can get messy quickly if we attempt to edit a larger macro. For example, let’s inspect the macro that was recorded in <a xmlns:str="http://exslt.org/strings" href="f_0100.html#sec.macro.files">Tip 69</a>:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix4" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline4" valign="top">
<div class="calibre38">
​<code class="calibre39">​<strong class="prompt">:reg a</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix4" valign="top">
<span>&lt;= </span>
</td>
<td class="codeline4" valign="top">
<div class="calibre38">
​<code class="calibre39">​--- Registers ---​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix4" valign="top">
<span> </span>
</td>
<td class="codeline4" valign="top">
<div class="calibre38">
​<code class="calibre39">​"a      Omoul&lt;80&gt;kb&lt;80&gt;kbdule Rank^[j&gt;GGoend^[​</code>​</div>
</td>
</tr>
</table>
<p id="N17EB4" class="calibre4">
        Notice anything strange? First of all, the <code class="cf1">^[</code> symbol appears a couple of times. No matter whether you press <span class="calibre17">&lt;Esc&gt;</span> or <span class="calibre17">&lt;C-[&gt;</span>, that’s how Vim represents the Escape key.
      </p>
<p id="N17EC5" class="calibre4">
        Stranger still is the <code class="cf1">&lt;80&gt;kb</code> symbol, which represents the backspace key. Study the keystrokes. When I recorded this macro, I started off by typing “moul.” Upon seeing my mistake, I hit the backspace key a couple of times and then typed out “dule,” the rest of the word.
      </p>
<p id="N17ED0" class="calibre4">
        This action is of no practical consequence. If I replay those keystrokes, Vim will reproduce my mistake followed by my correction. The net result will be correct. But it does make the register harder to read and more fiddly to edit.
      </p>
</div>
</div>
<h3 class="calibre22">Paste the Macro into a Document</h3>
<p id="N17ED7" class="calibre4">
        The registers that we use for recording macros are the very same with which the yank and put operations interact. So if we want to make changes to the macro saved in register <code class="cf">a</code>, we simply have to paste it into the document, where we can edit it as plain text.
      </p>
<p id="N17EEC" class="calibre4">
        Let’s press <span class="calibre17">G</span> and jump to the end of the current document. We want to paste the contents of register <code class="cf">a</code> into a new line. The simplest way of doing that is with the <code class="cf">:put</code> command:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:put a</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N17F0B" class="calibre4">
        Why didn’t we just use the <span class="calibre17">"ap</span> command? In this context, the <span class="calibre17">p</span> command would paste the contents of the <code class="cf">a</code> register after the cursor position <span class="calibre5">on</span> the current line. The <code class="cf">:put</code> command, on the other hand, always pastes <span class="calibre5">below</span> the current line, whether the specified register contains a line-wise or a character-wise set of text.
      </p>
<h3 class="calibre22">Edit the Text</h3>
<p id="N17F24" class="calibre4">
        Now we can edit the macro as plain text. The sequence of commands shown in <a xmlns:str="http://exslt.org/strings" href="#table.edit-text">Table 20, ​<em class="calibre5">Editing the Macro as Plain Text</em>​</a> replaces the <code class="cf">~</code> character with <code class="cf">vU</code>.
      </p>
<hr class="calibre37"/>
<div class="figurecaption" id="table.edit-text">Table 20. Editing the Macro as Plain Text</div>
<table class="simpletable">
<thead class="calibre23">
<tr class="calibre7">
<th class="hlines">Keystrokes</th>
<th class="hlines">Buffer Contents</th>
</tr>
</thead>
<tbody class="calibre6">
<tr class="calibre7">
<td class="calibre24">
<p class="last-para-in-cell">
<code class="cf">{start}</code>
</p>
</td>
<td class="calibre24">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix1" valign="top">
<span> </span>
</td>
<td class="codeline1" valign="top">
<div class="calibre32">
​<code class="calibre30">​<span class="shade-fg-white">0</span>f.r)w~j​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">f~</span>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​0f.r)w<span class="shade-fg-white">~</span>j​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">s</span>
<code class="cf">vU&lt;Esc&gt;</code>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​0f.r)wv<span class="shade-fg-white">U</span>j​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
</tbody>
</table>
<hr class="calibre37"/>
<h3 class="calibre22">Yank the Macro from the Document Back into a Register</h3>
<p id="N17F8E" class="calibre4">
        We’ve got the sequence of commands looking just the way we want it to, so we can yank it from the document back into a register. The simplest way is to run <span class="calibre17">"add</span> (or <code class="cf">:d a</code>), but this could cause us problems later. The <span class="calibre17">dd</span> command performs a line-wise deletion. The register contains a trailing <code class="cf">^J</code> character:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:reg a</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>&lt;= </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​0f.r)wvUj^J​</code>​</div>
</td>
</tr>
</table>
<p id="N17FB3" class="calibre4">
        This character represents a newline, which in most circumstances won’t matter. But sometimes this trailing newline could change the meaning of the macro. As a precaution, using a character-wise yank to get the characters from the document back into the register is a safer bet:
      </p>
<table class="simpletable">
<thead class="calibre23">
<tr class="calibre7">
<th class="hlines">Keystrokes</th>
<th class="hlines">Buffer Contents</th>
</tr>
</thead>
<tbody class="calibre6">
<tr class="calibre7">
<td class="calibre24">
<p class="last-para-in-cell">
<code class="cf">{start}</code>
</p>
</td>
<td class="calibre24">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix1" valign="top">
<span> </span>
</td>
<td class="codeline1" valign="top">
<div class="calibre32">
​<code class="calibre30">​// last line of the file proper​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix1" valign="top">
<span> </span>
</td>
<td class="codeline1" valign="top">
<div class="calibre32">
​<code class="calibre30">​0f.r)wv<span class="shade-fg-white">U</span>j​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">0</span>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​// last line of the file proper​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​<span class="shade-fg-white">0</span>f.r)wvUj​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">"ay$</span>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​// last line of the file proper​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​<span class="shade-fg-white">0</span>f.r)wvUj​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">dd</span>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​<span class="shade-fg-white">/</span>/ last line of the file proper​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
</tbody>
</table>
<p id="N18023" class="calibre4">
        When we run the command <span class="calibre17">0</span> followed by <span class="calibre17">"ay$</span>, we yank every character on that line except for the carriage return. Having captured everything that we want to keep into register <code class="cf">a</code>, we can then run <span class="calibre17">dd</span> to delete the line. This will end up in the default register, but we won’t use it.
      </p>
<p id="N18032" class="calibre4">
        Having followed these steps, register <code class="cf">a</code> now contains a new and improved macro. We can use it on the example text that we met at the start of this tip.
      </p>
<h3 class="calibre22">Discussion</h3>
<p id="N1803C" class="calibre4">
        Being able to paste a macro into the document, edit it right there, and then yank it back into a register and execute it is very handy. But the register can be fussy to work with for the reasons noted in <a xmlns:str="http://exslt.org/strings" href="#sidebar.macro.keycodes">​<em class="calibre5">Keyboard Codes in Macros</em>​</a>. If you only have to append a command at the end of your macro, following the procedure outlined in <a xmlns:str="http://exslt.org/strings" href="f_0099.html#sec.macro.append">Tip 68</a>, is simpler.
      </p>
<p id="N18047" class="calibre4">
        Since Vim’s registers are no more than containers for strings of text, we can also manipulate them programmatically using Vim script. For example, we could use the <code class="cf">substitute()</code> function (which is not the same as the <code class="cf">:substitute</code> command! See <strong xmlns:str="http://exslt.org/strings" class="calibre10">substitute()</strong>
<a xmlns:str="http://exslt.org/strings" href="http://vimdoc.sourceforge.net/htmldoc/eval.html#substitute()">
<img alt="info" src="images/information.png" class="calibre21"/>​</a>) to perform the same edit as before:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:let @a=substitute(@a, '\~', 'vU', 'g')</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N18066" class="calibre4">
        If you’re curious about this approach, look up <strong xmlns:str="http://exslt.org/strings" class="calibre10">function-list</strong>
<a xmlns:str="http://exslt.org/strings" href="http://vimdoc.sourceforge.net/htmldoc/usr_41.html#function-list">
<img alt="info" src="images/information.png" class="calibre21"/>​</a> for more ideas.
		</p>

<div class="footnotes">
<h4 class="calibre20">Footnotes</h4>
<table cellspacing="3" class="table-of-contents">
<tr valign="top" class="calibre14">
<td class="footnote-number">
<a id="FOOTNOTE-19" href="f_0095.html#FNPTR-19">[19]</a>
</td>
<td class="calibre8">
<p id="N171D7" class="calibre4">
<a href="http://all-sorts.org/of/robots">http://all-sorts.org/of/robots</a>
</p>
</td>
</tr>
</table>
</div>
<div class="copyright">Copyright © 2012, The Pragmatic Bookshelf.</div>




<script src="scripts/book_local.js" type="text/javascript" class="calibre2"/>
</div>

{% endraw %}

