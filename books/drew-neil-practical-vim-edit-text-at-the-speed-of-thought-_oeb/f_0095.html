---
layout: page
title: "Practical Vim (for Kathryn Amaral)"
prev: f_0094.html
next: f_0096.html
book_path: books/drew-neil-practical-vim-edit-text-at-the-speed-of-thought-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>


<table class="arr-recipe" id="sec.macro.intro">
<tr class="calibre14">
<td class="arr-recipe-number">Tip 64</td>
<td class="arr-recipe-name">Record and Execute a Macro</td>
</tr>
</table>
<p id="N16FF6" class="calibre4">
<span class="calibre5">
        Macros allow us to record a sequence of changes and then play them back. This tip shows how.
    </span>
</p>
<p id="N1700B" class="calibre4">
      Many repetitive tasks involve making multiple changes. If we want to automate these, we can record a macro and then execute it.
    </p>
<h3 class="calibre22">Capture a Sequence of Commands by Recording a Macro</h3>
<p id="N17012" class="calibre4">
        The <span class="calibre17">q</span> key functions both as the “record” button and the “stop” button. To begin recording our keystrokes, we type <span class="calibre17">q{register}</span>, giving the address of the register where we want to save the macro. We can tell that we’ve done it right if the word “recording” appears in the status line. Every command that we execute will be captured, right up until we press <span class="calibre17">q</span> again to stop recording.
      </p>
<p id="N17025" class="calibre4">
        Let’s see this in action:
      </p>
<table class="simpletable">
<thead class="calibre23">
<tr class="calibre7">
<th class="hlines">Keystrokes</th>
<th class="hlines">Buffer Contents</th>
</tr>
</thead>
<tbody class="calibre6">
<tr class="calibre7">
<td class="calibre24">
<p class="last-para-in-cell">
<span class="calibre17">qa</span>
</p>
</td>
<td class="calibre24">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix1" valign="top">
<span> </span>
</td>
<td class="codeline1" valign="top">
<div class="calibre32">
​<code class="calibre30">​<span class="shade-fg-white">f</span>oo = 1​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix1" valign="top">
<span> </span>
</td>
<td class="codeline1" valign="top">
<div class="calibre32">
​<code class="calibre30">​bar = 'a'​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix1" valign="top">
<span> </span>
</td>
<td class="codeline1" valign="top">
<div class="calibre32">
​<code class="calibre30">​foobar = foo + bar​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">A</span>
<code class="cf">;&lt;Esc&gt;</code>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​foo = 1<span class="shade-fg-white">;</span>​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​bar = 'a'​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​foobar = foo + bar​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">I</span>
<code class="cf">var<img xmlns:str="http://exslt.org/strings" alt="info" src="images/open_box.png" class="calibre21"/>&lt;Esc&gt;</code>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​var<span class="shade-fg-white"> </span>foo = 1;​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​bar = 'a'​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​foobar = foo + bar​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">q</span>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​var<span class="shade-fg-white"> </span>foo = 1;​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​bar = 'a'​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​foobar = foo + bar​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
</tbody>
</table>
<p id="N170A9" class="calibre4">
        Pressing <span class="calibre17">qa</span> begins recording and saves our macro into register <code class="cf">a</code>. We then perform two changes on the first line: appending a semicolon and prepending the word <code class="cf">var</code>. Having completed both of those changes, we press <span class="calibre17">q</span> to stop recording our macro (<strong xmlns:str="http://exslt.org/strings" class="calibre10">q</strong>
<a xmlns:str="http://exslt.org/strings" href="http://vimdoc.sourceforge.net/htmldoc/repeat.html#q">
<img alt="info" src="images/information.png" class="calibre21"/>​</a>).
      </p>
<p id="N170BC" class="calibre4">
        We can inspect the contents of register <code class="cf">a</code> by typing the following:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:reg a</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>&lt;= </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​--- Registers ---​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​"a   A;^[Ivar ^[​</code>​</div>
</td>
</tr>
</table>
<p id="N170DB" class="calibre4">
        It doesn’t make for easy reading, but the same sequence of commands that we recorded moments ago should be recognizable. The only surprise might be that the symbol <code class="cf">^[</code> is used to stand for the Escape key. See <a xmlns:str="http://exslt.org/strings" href="f_0102.html#sidebar.macro.keycodes">​<em class="calibre5">Keyboard Codes in Macros</em>​</a>, for an explanation.
      </p>
<h3 id="sec.macro.playback" class="calibre22">Play Back a Sequence of Commands by Executing a Macro</h3>
<p id="N170EB" class="calibre4">
        The <span class="calibre17">@{register}</span> command executes the contents of the specified register (see <strong xmlns:str="http://exslt.org/strings" class="calibre10">@</strong>
<a xmlns:str="http://exslt.org/strings" href="http://vimdoc.sourceforge.net/htmldoc/repeat.html#@">
<img alt="info" src="images/information.png" class="calibre21"/>​</a>). We can also use <span class="calibre17">@@</span>, which repeats the macro that was invoked most recently.
      </p>
<p id="N17100" class="calibre4">
        Here’s an example:
      </p>
<table class="simpletable">
<thead class="calibre23">
<tr class="calibre7">
<th class="hlines">Keystrokes</th>
<th class="hlines">Buffer Contents</th>
</tr>
</thead>
<tbody class="calibre6">
<tr class="calibre7">
<td class="calibre24">
<p class="last-para-in-cell">
<code class="cf">{start}</code>
</p>
</td>
<td class="calibre24">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix1" valign="top">
<span> </span>
</td>
<td class="codeline1" valign="top">
<div class="calibre32">
​<code class="calibre30">​var<span class="shade-fg-white"> </span>foo = 1;​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix1" valign="top">
<span> </span>
</td>
<td class="codeline1" valign="top">
<div class="calibre32">
​<code class="calibre30">​bar = 'a'​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix1" valign="top">
<span> </span>
</td>
<td class="codeline1" valign="top">
<div class="calibre32">
​<code class="calibre30">​foobar = foo + bar​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">j</span>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​var foo = 1;​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​bar<span class="shade-fg-white"> </span>= 'a'​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​foobar = foo + bar​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">@a</span>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​var foo = 1;​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​var<span class="shade-fg-white"> </span>bar = 'a';​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​foobar = foo + bar​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">j@@</span>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​var foo = 1;​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​var bar = 'a';​</code>​</div>
</td>
</tr>
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​var<span class="shade-fg-white"> </span>foobar = foo + bar;​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
</tbody>
</table>
<p id="N17182" class="calibre4">
        We’ve executed the macro that we just recorded, repeating the same two changes for each of the subsequent lines. Note that we use <span class="calibre17">@a</span> on the first line and then <span class="calibre17">@@</span> to replay the same macro on the next line.
      </p>
<p id="N1718B" class="calibre4">
        In this example, we played the macro back by running <span class="calibre17">j@a</span> (and subsequently <span class="calibre17">j@@</span>). Superficially, this has some resemblance to the Dot Formula. It involves one keystroke to move (<span class="calibre17">j</span>) and two to act (<span class="calibre17">@a</span>). Not bad, but there’s room for improvement.
      </p>
<p id="N1719A" class="calibre4">
        We have a couple of techniques at our disposal for executing a macro multiple times. The setup differs slightly for each technique, but more importantly, they react differently on encountering an error. I’ll explain the differences by way of a comparison with Christmas tree lights.
      </p>
<p id="N1719D" class="calibre4">
        If you buy a cheap set of party lights, the chances are that they will be wired in series. If one bulb blows, they all go out. If you buy a premium set, they’re more likely to be wired in parallel. That means any bulb can go out, and the rest will be unaffected.
      </p>
<p id="N171A0" class="calibre4">
        I’ve borrowed the expressions <span class="calibre5">in series</span> and <span class="calibre5">in parallel</span> from the field of electronics to differentiate between two techniques for executing a macro multiple times. The technique for executing a macro in series is brittle. Like cheap Christmas tree lights, it breaks easily. The technique for executing a macro in parallel is more fault tolerant.
		</p>
<h4 class="calibre20">Execute the Macro in Series</h4>
<p id="N171B0" class="calibre4">
        Picture a robotic arm and a conveyor belt containing a series of items for the robot to manipulate (<a xmlns:str="http://exslt.org/strings" href="#fig.robots">Figure 4, ​<em class="calibre5">Vim's macros make quick work of repetitive tasks</em>​</a>). Recording a macro is like programming the robot to do a single unit of work. As a final step, we instruct the robot to move the conveyor belt and bring the next item within reach. In this manner, we can have a single robot carry out a series of repetitive tasks on similar items.
      </p>
<div class="figure" id="fig.robots">
<div class="calibre1">
<img xmlns:str="http://exslt.org/strings" src="images/robots.png" alt="images/robots.png" class="calibre21"/>
</div>
<div class="figurecaption">
<hr class="calibre37"/>Figure 4. Vim’s macros make quick work of repetitive tasks</div>
</div>
<p id="N171C7" class="calibre4">
        One consequence of this approach is that if the robot encounters any surprises, it sounds an alarm and aborts the operation. Even if items on the conveyor belt still need to be manipulated, the work stops.
      </p>
<h4 class="calibre20">Execute the Macro in Parallel</h4>
<p id="N171CE" class="calibre4">
          When we execute the macro in parallel, it’s as though we’ve dispensed with the conveyor belt entirely. Instead, we deploy an assemblage of robots,<a id="FNPTR-19" href="f_0102.html#FOOTNOTE-19">[19]</a> all programmed to do the same simple task. Each is given a single job to do. If it succeeds, very well. If it fails, no matter.
        </p>
<p id="N171DC" class="calibre4">
          Under the hood, Vim always executes macros sequentially, no matter which of these two techniques we use. The term <span class="calibre5">in parallel</span> is intended to draw an analogy with the robustness of parallel circuits. It is not meant to suggest that Vim executes multiple changes concurrently.
        </p>
<p id="N171E2" class="calibre4">
          In <a xmlns:str="http://exslt.org/strings" href="f_0098.html#sec.macro.lines">Tip 67</a>, as well as <a xmlns:str="http://exslt.org/strings" href="f_0100.html#sec.macro.files">Tip 69</a>, we’ll see examples of a macro being executed both in series and in parallel.
        </p>
<script src="scripts/book_local.js" type="text/javascript" class="calibre2"/>
</div>

{% endraw %}

