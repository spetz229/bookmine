---
layout: page
title: "Practical Vim (for Kathryn Amaral)"
prev: f_0118.html
next: f_0120.html
book_path: books/drew-neil-practical-vim-edit-text-at-the-speed-of-thought-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>


<table class="arr-recipe" id="sec.search.iterate">
<tr class="calibre14">
<td class="arr-recipe-number">Tip 85</td>
<td class="arr-recipe-name">Create Complex Patterns by Iterating upon Search History</td>
</tr>
</table>
<p id="N19183" class="calibre4">
<span class="calibre5">
        Writing regular expressions is hard. We won’t get it right the first time, so the next best thing is to develop a frictionless workflow that allows us to develop a pattern by iteration. Being able to recall and edit previous items from our search history is the trick.
    </span>
</p>
<p id="N1919D" class="calibre4">
      In this example text, the prime symbol has been used as a quote mark:
    </p>
<table class="processedcode">
<tr class="calibre28">
<td colspan="2" class="calibre33">
<a href="http://media.pragprog.com/titles/dnvim/code/search/quoted-strings.txt">search/quoted-strings.txt</a>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains a 'quoted' word.​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains 'two' quoted 'words.'​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This 'string doesn't make things easy.'​</code>​</div>
</td>
</tr>
</table>
<p id="N191B3" class="calibre4">
	We want to compose a regular expression to match each quoted string. This will take a few tries, but when we get it right, we’ll run a substitute command to transform the text to use real double-quote symbols, like this:
    </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains a “quoted” word.​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains “two” quoted “words.”​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This “string doesn't make things easy.”​</code>​</div>
</td>
</tr>
</table>
<h3 class="calibre22">1: A Broad Match</h3>
<p id="N191D5" class="calibre4">
        Let’s begin with a crude search:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">/\v'.+'</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N191E5" class="calibre4">
        This matches a single <code class="cf">’</code> character, followed by any character one or more times, and terminates with a final <code class="cf">’</code> character. After executing this search command, our document looks like this:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains a <span class="shade-fg-black">’quoted’</span> word.​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains <span class="shade-fg-black">’two’ quoted ’words.’</span>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This <span class="shade-fg-black">’string doesn’t make things easy.’</span>​</code>​</div>
</td>
</tr>
</table>
<p id="N1920C" class="calibre4">
        The first line looks fine, but there’s a problem with line two. The <code class="cf">.+</code> item in the pattern performs a <span class="calibre5">greedy</span> match, meaning that it matches as many characters as possible. But we want to generate two separate matches on this line: one for each quoted word. Let’s go back to the drawing board.
      </p>
<h3 class="calibre22">2: Refinement</h3>
<p id="N1921C" class="calibre4">
        Instead of using the <code class="cf">.</code> symbol to match <span class="calibre5">any</span> character, let’s be a bit more specific. We actually want to match any character <span class="calibre5">except</span>
<code class="cf">’</code>, which can be done using <code class="cf">[^’]+</code>. We’ll refine our pattern to look like this instead:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">/\v'[^']+'</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1923F" class="calibre4">
        We don’t have to type this out from scratch. Instead, we can press <span class="calibre17">/&lt;Up&gt;</span>, which prepopulates the search field with the most recent pattern. We only have to make a small change, so we’ll use the <span class="calibre17">&lt;Left&gt;</span> and backspace keys to delete the <code class="cf">.</code> character from the pattern and then type in the replacement. When we execute the search, we’ll get the following matches:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains a <span class="shade-fg-black">’quoted’</span> word.​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains <span class="shade-fg-black">’two’</span> quoted <span class="shade-fg-black">’words.’</span>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This <span class="shade-fg-black">’string doesn’</span>t make things easy.'​</code>​</div>
</td>
</tr>
</table>
<p id="N1926F" class="calibre4">
        That’s an improvement. The first two lines match up just as we want them to, but line three raises a new issue. The <code class="cf">’</code> character is used here as an apostrophe, which shouldn’t terminate the match. We’ll have to refine our pattern some more.
      </p>
<h3 class="calibre22">3: Another Iteration</h3>
<p id="N19279" class="calibre4">
        Now we need to consider what differentiates an apostrophe from a closing quote mark. Here are a few examples: “won’t,” “don’t,” and “we’re.” In each case, the <code class="cf">’</code> character is followed immediately by a letter—not by a space or punctuation mark. We could update our pattern to allow <code class="cf">’</code> characters as long as they are followed by a word character. Here’s our next refinement:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">/\v'([^']|'\w)+'</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1928F" class="calibre4">
        This involves some fairly substantial changes. Not only do we have to type in the extra <code class="cf">’\w</code> item, we also have to wrap the two alternatives in parentheses and separate them with a pipe. It’s time to bring out the big guns.
      </p>
<p id="N19295" class="calibre4">
        Instead of pressing <span class="calibre17">/&lt;Up&gt;</span> to prefill the search field with our last pattern, let’s press <span class="calibre17">q/</span> to summon the command-line window. This acts more or less like a regular Vim buffer, but it’s prepopulated with our search history, one item per line (see <a xmlns:str="http://exslt.org/strings" href="f_0056.html#sec.commandline.window">​<em class="calibre5">Meet the Command-Line Window</em>​</a>). We can use the full power of Vim’s modal editing to amend the last pattern. 
      </p>
<p id="N192A5" class="calibre4">
        The following sequence of edits demonstrates how we might make this particular change. If you’re struggling to understand <span class="calibre17">c%</span>
<code class="cf">(&lt;C-r&gt;")&lt;Esc&gt;</code>, refer to <a xmlns:str="http://exslt.org/strings" href="f_0081.html#sec.parentheses.match">Tip 54</a>, and <a xmlns:str="http://exslt.org/strings" href="f_0035.html#sec.paste.from.insert">Tip 15</a>.
      </p>
<table class="simpletable">
<thead class="calibre23">
<tr class="calibre7">
<th class="hlines">Keystrokes</th>
<th class="hlines">Buffer Contents</th>
</tr>
</thead>
<tbody class="calibre6">
<tr class="calibre7">
<td class="calibre24">
<p class="last-para-in-cell">
<code class="cf">{start}</code>
</p>
</td>
<td class="calibre24">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix1" valign="top">
<span> </span>
</td>
<td class="codeline1" valign="top">
<div class="calibre32">
​<code class="calibre30">​<span class="shade-fg-white">\</span>v'[^']+'​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">f[</span>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​\v'<span class="shade-fg-white">[</span>^']+'​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">c%</span>
<code class="cf">(&lt;C-r&gt;")&lt;Esc&gt;</code>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​\v'([^']<span class="shade-fg-white">)</span>+'​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
<tr class="calibre7">
<td class="calibre26">
<p class="last-para-in-cell">
<span class="calibre17">i</span>
<code class="cf">|’\w&lt;Esc&gt;</code>
</p>
</td>
<td class="calibre26">
<table class="processedcode1">
<tr class="calibre31">
<td class="codeprefix2" valign="top">
<span> </span>
</td>
<td class="codeline2" valign="top">
<div class="calibre32">
​<code class="calibre30">​\v'([^']|'\<span class="shade-fg-white">w</span>)+'​</code>​</div>
</td>
</tr>
</table>
</td>
</tr>
</tbody>
</table>
<p id="N1931D" class="calibre4">
        When we’ve got the pattern looking how we want it, we just press the <span class="calibre17">&lt;CR&gt;</span> key to execute the search. The document should light up as follows:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains a <span class="shade-fg-black">’quoted’</span> word.​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains <span class="shade-fg-black">’two’</span> quoted <span class="shade-fg-black">’words.’</span>​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This <span class="shade-fg-black">’string doesn’t make things easy.’</span>​</code>​</div>
</td>
</tr>
</table>
<p id="N19346" class="calibre4">
        Score!
      </p>
<h3 class="calibre22">4: One Final Tweak</h3>
<p id="N1934D" class="calibre4">
        Our pattern matches in all the right places, but we need to make one final change before we can execute our substitute command. We want to capture everything inside the quotes by wrapping it in parentheses. This is our final pattern:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">/\v'(([^']|'\w)+)'</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1935D" class="calibre4">
        We could either run <span class="calibre17">/&lt;Up&gt;</span> and edit the search field, or we could run <span class="calibre17">q/</span> and make the change in the command-line window. Use whichever you feel is more appropriate.

        The search highlighting won’t look any different from the last time, but for each match, the text inside quotes will be assigned to the <code class="cf">\1</code> capture register. That means we can run the following substitute command:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:%s//“\1”/g</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N19376" class="calibre4">
        We can leave the search field blank, and Vim will reuse the last search command (for more details, skip ahead to <a xmlns:str="http://exslt.org/strings" href="f_0125.html#sec.substitute.lastpat">Tip 90</a>). Here’s the outcome from running this command:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains a “quoted” word.​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This string contains “two” quoted “words.”​</code>​</div>
</td>
</tr>
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​This “string doesn't make things easy.”​</code>​</div>
</td>
</tr>
</table>
<h3 class="calibre22">Discussion</h3>
<p id="N19392" class="calibre4">
        What we’ve done here is effectively identical to this:
      </p>
<table class="processedcode">
<tr class="calibre28">
<td class="codeprefix" valign="top">
<span>=&gt; </span>
</td>
<td class="codeline" valign="top">
<div class="calibre29">
​<code class="calibre30">​<strong class="prompt">:%s/\v'(([^']|'\w)+)'/“\1”/g</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N193A2" class="calibre4">
        Would you trust yourself to type that out correctly in one go?
      </p>
<p id="N193A5" class="calibre4">
        Don’t worry about getting a search pattern right the first time. Vim keeps our most recent search pattern two keystrokes away, so it’s easy to refine a pattern. Start with a broad match; then take as many steps as you need to focus on your target.
      </p>
<p id="N193A8" class="calibre4">
        Being able to edit the command line directly is great for simple edits. If we have the <code class="cf">‘incsearch’</code> setting enabled, then we get the added bonus of live feedback as we edit the command line. We lose this perk as soon as we call up the command-line window. But with the full power of Vim’s modal editing at our fingertips, this is a fair trade-off.
      </p>
<script src="scripts/book_local.js" type="text/javascript" class="calibre2"/>
</div>

{% endraw %}

