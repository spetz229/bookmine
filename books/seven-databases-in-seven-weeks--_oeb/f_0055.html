---
layout: page
title: "Seven Databases in Seven Weeks (for Greg Kennedy)"
prev: f_0054.html
next: f_0056.html
book_path: books/seven-databases-in-seven-weeks--_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

<h2 id="N1A028" class="calibre18">8.3 Day 2: Advanced Usage, Distribution</h2>
<p id="N1A02C" class="calibre5">
      Day 1 introduced us to Redis as a data structure server. Today we’ll build on that foundation by looking at some of the advanced functions provided by Redis, such as pipelining, the publish-subscribe model, system configuration, and replication. Beyond that, we’ll look at how to create a Redis cluster, store a lot of data quickly, and use an advanced technique introducing Bloom filters.
    </p>
<h3 id="sec.redisIsSimple" class="calibre20">A Simple Interface</h3>
<p id="N1A034" class="calibre5">
        At 20,000 lines of source code, Redis is a fairly simple project. But beyond code size, it has a simple interface that accepts the very strings we have been writing in the console.
      </p>
<h4 id="sec.telnet" class="calibre21">Telnet</h4>
<p id="N1A03C" class="calibre5">
          We can interact without the command-line interface by streaming commands through TCP on our own via telnet and terminating the command with a carriage return line feed (CRLF, or <code class="cf">\r\n</code>).
        </p>
<table class="processedcode">
<tr class="calibre24">
<td colspan="2" class="calibre34">
<a href="http://media.pragprog.com/titles/rwdata/code/redis/telnet.sh">redis/telnet.sh</a>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ telnet localhost 6379​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Trying 127.0.0.1...​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Connected to localhost.​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Escape character is <em class="string">'^]'</em>.​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">SET</strong> test hello​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span>① </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​+OK ​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​GET test​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span>② </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$5 ​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​hello​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​SADD stest 1 99​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span>③ </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​:2 ​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​SMEMBERS stest​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span>④ </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​*2 ​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$2​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​99​</code>​</div>
</td>
</tr>
</table>
<p id="N1A098" class="calibre5">
<span class="calibre35">Ctrl</span>-<span class="calibre35">]</span>
</p>
<p id="N1A09F" class="calibre5">
          We can see that our input is the same as we provided to the console, but the console cleaned up the responses a bit.
        </p>
<p id="N1A0A2" class="calibre5">①
          Redis streams the <code class="cf">OK</code> status prefixed by a <code class="cf">+</code> sign.
        </p>
<p id="N1A0AD" class="calibre5">②
          Before it returned the string <code class="cf1">hello</code>, it sent <code class="cf">$5</code>, which means “the following string is five characters.”
        </p>
<p id="N1A0B8" class="calibre5">③
          The number <code class="cf">2</code> after we add two set items to the test key is prefixed by <code class="cf">:</code> to represent an integer (two values were added successfully).
        </p>
<p id="N1A0C3" class="calibre5">④
          Finally, when we requested two items, the first line returned begins with an asterisk and the number 2—meaning there are two complex values about to be returned. The next two lines are just like the <code class="cf1">hello</code> string but contain the  string <code class="cf1">1</code>, followed by the string <code class="cf1">99</code>.
          </p>
<h4 id="sec.pipelining" class="calibre21">Pipelining</h4>
<p id="N1A0DC" class="calibre5">
          We can also stream our own strings one at a time by using the BSD netcat (<code class="cf">nc</code>) command, which you may find is already installed on many Unix machines. With netcat, we must specifically end a line with CRLF (telnet did this for us implicitly). We also sleep for a second after the echo command has finished to give some time for the Redis server to return. Some <code class="cf">nc</code> implementations have a <code class="cf">-q</code> option, thus negating the need for a sleep, but not all do, so feel free to try it.
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">(echo -en "ECHO hello\r\n"; sleep 1) | nc localhost 6379</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$5​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​hello​</code>​</div>
</td>
</tr>
</table>
<p id="N1A113" class="calibre5">
          We can take advantage of this level of control by <span class="calibre6">pipelining</span> our commands, or streaming multiple commands in a single request.
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">(echo -en "PING\r\nPING\r\nPING\r\n"; sleep 1) | nc localhost 6379</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​+PONG​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​+PONG​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​+PONG​</code>​</div>
</td>
</tr>
</table>
<p id="N1A131" class="calibre5">
          This can be far more efficient than pushing a single command at a time and should always be considered if it makes sense to do so—especially in transactions. Just be sure to end every command with <code class="cf">\r\n</code>, which is a required delimiter for the server.
          </p>
<h3 id="sec.publishSubscribe" class="calibre20">publish-subscribe</h3>
<p id="N1A148" class="calibre5">
        Yesterday we were able to implement a rudimentary blocking queue using the list datatype. We queued data that could be read by a blocking pop command. Using that queue, we made a very basic publish-subscribe model. Any number of messages could be pushed to this queue, and a single queue reader would pop messages as they were available. This is powerful but limited. Under many circumstances we want a slightly inverted behavior, where several subscribers want to read the announcements of a single publisher, as shown in Figure 37, <a href="#fig.redis.pubsub">​<em class="calibre6">A publisher sends a message to all subscribers</em>​</a>. Redis provides some specialized publish-subscribe (or pub-sub) commands.
      </p>
<div class="figure" id="fig.redis.pubsub">
<div class="calibre2">
<img xmlns:str="http://exslt.org/strings" src="images/redis-pubsub.png" alt="images/redis-pubsub.png" class="calibre27"/>
</div>
<div class="figurecaption">
<hr class="calibre28"/>Figure 37. A publisher sends a message to all subscribers.</div>
</div>
<p id="N1A15F" class="calibre5">
        Let’s improve on the commenting mechanism we made yesterday using blocking lists, by allowing a user to post a comment to multiple subscribers (as opposed to just one). We start with some subscribers that connect to a key, known as a <span class="calibre6">channel</span> in pub-sub nomenclature. Let’s start two more clients and subscribe to the comments channel. Subscribing will cause the CLI to block.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6379&gt; SUBSCRIBE comments​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Reading messages... (press Ctrl-C to quit)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​1) "subscribe"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​2) "comments"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​3) (integer) 1​</code>​</div>
</td>
</tr>
</table>
<p id="N1A17D" class="calibre5">
        With two subscribers, we can publish any string we want as a message to the <code class="cf">comments</code> channel. The <code class="cf">PUBLISH</code> command will return the integer 2, meaning two subscribers received it.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6379&gt; PUBLISH comments "Check out this shortcoded site! 7wks"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​(integer) 2​</code>​</div>
</td>
</tr>
</table>
<p id="N1A195" class="calibre5">
        Both of the subscribers will receive a <span class="calibre6">multibulk reply</span> (a list) of three items: the string “message,” the channel name, and the published message value.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​1) "message"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​2) "comments"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​3) "Check out this shortcoded site! 7wks"​</code>​</div>
</td>
</tr>
</table>
<p id="N1A1AD" class="calibre5">
        When your clients want to no longer receive correspondence, they can execute the <code class="cf">UNSUBSCRIBE comments</code> command to disconnect from the comments channel or simply <code class="cf">UNSUBSCRIBE</code> alone to disconnect from all channels. However, note in <code class="cf">redis-cli</code> that you will have to press <span class="calibre35">Ctrl</span>+<span class="calibre35">C</span> to break the connection.
      </p>
<h3 id="sec.serverInfo" class="calibre20">Server Info</h3>
<p id="N1A1C4" class="calibre5">
        Before getting into changing Redis’s system settings, it’s worth taking a quick look at the <code class="cf">INFO</code> command, since changing settings values will alter some of these values as well. <code class="cf">INFO</code> outputs a list of server data, including version, process ID, memory used, and uptime.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6379&gt; INFO​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis_version:2.4.5​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis_git_sha1:00000000​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis_git_dirty:0​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​arch_bits:64​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​multiplexing_api:kqueue​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​process_id:54046​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​uptime_in_seconds:4​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​uptime_in_days:0​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​lru_clock:1807217​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​…​</code>​</div>
</td>
</tr>
</table>
<p id="N1A20F" class="calibre5">
        You may want to revisit this command again in this chapter, because it provides a useful snapshot of this server’s global information and settings. It even provides information on durability, memory fragmentation, and replication server status.
        </p>
<h3 id="sec.redisConfig" class="calibre20">Redis Configuration</h3>
<p id="N1A223" class="calibre5">
        So far, we’ve only used Redis out of the box. Much of Redis’s power comes from its configurability, allowing you to tailor settings to your use case. The <code class="cf">redis.conf</code> file that comes with the distribution—found in <code class="cf">/etc/redis</code> on *nix systems—is fairly self-explanatory, so we’re  going to cover only a portion of the file.

        We’ll go through a few of the common settings in order.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​daemonize no​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​port 6379​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​loglevel verbose​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​logfile stdout​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​database 16​</code>​</div>
</td>
</tr>
</table>
<p id="N1A24E" class="calibre5">
        By default <code class="cf">daemonize</code> is set to <code class="cf1">no</code>, which is why the server always starts up in the foreground. This is nice for testing but not very production friendly. Changing this value to <code class="cf1">yes</code> will run the server in the background while setting the server’s process ID in a pid file.
      </p>
<p id="N1A25A" class="calibre5">
        The next line is the default port number for this server, port 6379. This can be especially useful when running multiple Redis servers on a single machine.
      </p>
<p id="N1A25D" class="calibre5">
<code class="cf">loglevel</code> defaults to <code class="cf">verbose</code>, but it’s good to set it to <code class="cf">notice</code> or <code class="cf">warning</code> in production. <code class="cf">logfile</code> outputs to stdout (standard output, the console), but a filename is necessary if you run in daemonize mode.
      </p>
<p id="N1A26E" class="calibre5">
<code class="cf">database</code> sets the number of Redis databases we have available. We saw how to switch between databases yesterday. If you plan to only ever use a single database namespace, it’s not a bad idea to set this to 1.
        </p>
<h4 id="sec.durability" class="calibre21">Durability</h4>
<p id="N1A27E" class="calibre5">
          Redis has a few persistence options. First is no persistence at all, which will simply keep all values in main memory. If you’re running a basic caching server, this is a reasonable choice since durability always increases latency.
        </p>
<p id="N1A286" class="calibre5">
          One of the things that sets Redis apart from other fast-access caches like memcached<a id="FNPTR-54" href="f_0057.html#FOOTNOTE-54">[54]</a> is its built-in support for storing values to disk. By default, key-value pairs are only occasionally saved. You can run the <code class="cf">LASTSAVE</code> command to get a Unix timestamp of the last time a Redis disk write succeeded, or you can read the <code class="cf">last_save_time</code> field from the server <code class="cf">INFO</code> output.
        </p>
<p id="N1A2B6" class="calibre5">
          You can force durability by executing the <code class="cf">SAVE</code> command (or <code class="cf">BGSAVE</code>, to asynchronously save in the background).
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6379&gt; SAVE​</code>​</div>
</td>
</tr>
</table>
<p id="N1A2CB" class="calibre5">
          If you read the redis-server log, you will see lines similar to this:
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[46421] 10 Oct 19:11:50 * Background saving started by pid 52123​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[52123] 10 Oct 19:11:50 * DB saved on disk​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[46421] 10 Oct 19:11:50 * Background saving terminated with success​</code>​</div>
</td>
</tr>
</table>
<p id="N1A2E0" class="calibre5">
          Another durability method is to alter the snapshotting settings in the configuration file.
        </p>
<p class="calibre5">
<strong id="sec.snapshotting" class="calibre32">Snapshotting</strong>
</p>
<p id="N1A2E8" class="calibre5">
            We can alter the rate of storage to disk by adding, removing, or altering one of the save fields. By default there are three, prefixed by the <code class="cf">save</code> keyword followed by a time in seconds and a minimum number of keys that must change before a write to disk occurs.
          </p>
<p id="N1A2F4" class="calibre5">
          For example, to trigger a save every 5 minutes (300 seconds) if any keys change at all, you would write the following:
          </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​save 300 1​</code>​</div>
</td>
</tr>
</table>
<p id="N1A302" class="calibre5">
          The configuration has a good set of defaults. The set means if 10,000 keys change, save in 60 seconds; if 10 keys change, save in 300 seconds, and any key changes will be saved in at least 900 seconds (15 minutes).
          </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​save 900 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​save 300 10​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​save 60 10000​</code>​</div>
</td>
</tr>
</table>
<p id="N1A316" class="calibre5">
            You can add as many or few save lines as necessary to specify precise thresholds.
            </p>
<p class="calibre5">
<strong id="sec.appendOnlyFile" class="calibre32">Append-Only File</strong>
</p>
<p id="N1A321" class="calibre5">
            Redis is <span class="calibre6">eventually durable</span> by default, in that it asynchronously writes values to disk in intervals defined by our save settings, or it is forced to write by client-initiated commands. This is acceptable for a second-level cache or session server but is insufficient for storing data you need to be durable, like financial data. If a Redis server crashes, our users might not appreciate having lost money.
           
          </p>
<p id="N1A334" class="calibre5">
            Redis provides an append-only file (<code class="cf">appendonly.aof</code>) that keeps a record of all write commands. This is like the write-ahead logging we saw in Chapter 4, <a href="f_0028.html#chp.hbase">​<em class="calibre6">HBase</em>​</a>. If the server crashes before a value is saved, it executes the commands on startup, restoring its state; <code class="cf">appendonly</code> must be enabled by setting it to <code class="cf">yes</code> in the <code class="cf">redis.conf</code> file.
          </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​appendonly yes​</code>​</div>
</td>
</tr>
</table>
<p id="N1A352" class="calibre5">
            Then we must decide how often a command is appended to the file. Setting <code class="cf">always</code> is the more durable, since every command is saved. It’s also slow, which often negates the reason people have for using Redis. By default <code class="cf">everysec</code> is enabled, which saves up and writes commands only once a second. This is a decent trade-off, since it’s fast enough, and worst case you’ll  lose only the last one second of data. Finally, <code class="cf">no</code> is an option, which just lets the OS handle flushing. It can be fairly infrequent, and you’re often better off skipping the append-only file altogether rather than choosing it.
          </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​# appendfsync always​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​appendfsync everysec​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​# appendfsync no​</code>​</div>
</td>
</tr>
</table>
<p id="N1A370" class="calibre5">
            Append-only has more detailed parameters, which may be worth reading about in the config file when you need to respond to specific production issues.
          </p>
<h4 id="sec.security" class="calibre21">Security</h4>
<p id="N1A378" class="calibre5">
          Although Redis is not natively built to be a fully secure server, you may run across the <code class="cf">requirepass</code> setting and <code class="cf">AUTH</code> command in the Redis documentation. These can be safely ignored, since they are merely a scheme for setting a plain-text password. Since a client can try nearly 100,000 passwords a second, it’s almost a moot point, beyond the fact that plain-text passwords are inherently unsafe anyway. If you want Redis security, you’re better off with a good firewall and SSH security.
        </p>
<p id="N1A387" class="calibre5">
          Interestingly, Redis provides command-level security through obscurity, by allowing you to hide or suppress commands. This will rename the <code class="cf">FLUSHALL</code> command (remove all keys from the system) into some hard-to-guess value like c283d93ac9528f986023793b411e4ba2:
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​rename-command FLUSHALL c283d93ac9528f986023793b411e4ba2​</code>​</div>
</td>
</tr>
</table>
<p id="N1A3A8" class="calibre5">
          If we attempt to execute <code class="cf">FLUSHALL</code> against this server, we’ll be hit with an error. The secret command works instead.
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6379&gt; FLUSHALL​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​(error) ERR unknown command 'FLUSHALL'​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6379&gt; c283d93ac9528f986023793b411e4ba2​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​OK​</code>​</div>
</td>
</tr>
</table>
<p id="N1A3C3" class="calibre5">
          Or better yet, we can disable the command entirely by setting it to a blank string.
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​rename-command FLUSHALL ""​</code>​</div>
</td>
</tr>
</table>
<p id="N1A3D2" class="calibre5">
          You can set any number of commands to a blank string, allowing you a modicum of customization over your command environment.
          </p>
<h4 id="sec.tweakingParameters" class="calibre21">Tweaking Parameters</h4>
<p id="N1A3DD" class="calibre5">
          There are several more advanced settings for speeding up slow query logs, encoding details, making latency tweaks, and importing external config files. Keep in mind, though, that if you run across some documentation about Redis virtual memory, you’re best to avoid it if possible. It’s been deprecated in Redis 2.4 and may be removed in future versions.
        </p>
<p id="N1A3E6" class="calibre5">
          To aid in testing your server configuration, Redis provides an excellent benchmarking tool. It connects locally to port 6379 by default and issues 10,000 requests using 50 parallel clients. We can execute 100,000 requests with the <code class="cf">-n</code> argument.
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">redis-benchmark -n 100000</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​====== PING (inline) ======​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  100000 requests completed in 3.05 seconds​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  50 parallel clients​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  3 bytes payload​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  keep alive: 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​5.03% &lt;= 1 milliseconds​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​98.44% &lt;= 2 milliseconds​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​99.92% &lt;= 3 milliseconds​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​100.00% &lt;= 3 milliseconds​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​32808.40 requests per second​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​…​</code>​</div>
</td>
</tr>
</table>
<p id="N1A41C" class="calibre5">
          Other commands are tested as well, like <code class="cf">SADD</code> and <code class="cf">LRANGE</code>; the more complex ones generally taking more time.
          </p>
<h3 id="sec.masterSlaveReplication" class="calibre20">Master-Slave Replication</h3>
<p id="N1A44E" class="calibre5">
        Just like other NoSQL databases we’ve seen (such as MongoDB and Neo4j), Redis supports master-slave replication. One server is the master by default if you don’t set it as a slave of anything. Data will be replicated to any number of slave servers.
        
      </p>
<p id="N1A45B" class="calibre5">
      Making slave servers is easy. We first need a copy of our <code class="cf">redis.conf</code> file.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">cp redis.conf redis-s1.conf</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A470" class="calibre5">
        The file will remain largely the same but with the following changes:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​port 6380​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​slaveof 127.0.0.1 6379​</code>​</div>
</td>
</tr>
</table>
<p id="N1A482" class="calibre5">
        If all went according to plan, you should see something similar to the following in the slave server’s log when you start it:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">redis-server redis-s1.conf</strong>​</code>​</div>
</td>
</tr>
</table>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[9003] 16 Oct 23:51:52 * Connecting to MASTER...​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[9003] 16 Oct 23:51:52 * MASTER &lt;-&gt; SLAVE sync started​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[9003] 16 Oct 23:51:52 * Non blocking connect for SYNC fired the event.​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[9003] 16 Oct 23:51:52 * MASTER &lt;-&gt; SLAVE sync: receiving 28 bytes from master​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[9003] 16 Oct 23:51:52 * MASTER &lt;-&gt; SLAVE sync: Loading DB in memory​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[9003] 16 Oct 23:51:52 * MASTER &lt;-&gt; SLAVE sync: Finished with success​</code>​</div>
</td>
</tr>
</table>
<p id="N1A4AF" class="calibre5">
        And you should see the string <code class="cf">1 slaves</code> output in the master log.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6379&gt; SADD meetings "StarTrek Pastry Chefs" "LARPers Intl."​</code>​</div>
</td>
</tr>
</table>
<p id="N1A4C1" class="calibre5">
        If we connect the command line to our slave, we should receive our meeting list.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6380&gt; SMEMBERS meetings​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​1) "StarTrek Pastry Chefs"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​2) "LARPers Intl."​</code>​</div>
</td>
</tr>
</table>
<p id="N1A4D5" class="calibre5">
        In production, you’ll generally want to implement replication for availability or backup purposes and thus have Redis slaves on different machines.
      </p>
<h3 id="sec.dataDump" class="calibre20">Data Dump</h3>
<p id="N1A4DD" class="calibre5">
      So far, we’ve talked a lot about how fast Redis is, but it’s hard to get a feel for it without playing with a bit more data.
      </p>
<p id="N1A4E6" class="calibre5">
      Let’s insert a large dataset into our Redis server. You can keep the slave running if you like, but a laptop or desktop might run quicker if you have just a single master server. We’re going to grab a list of more than 2.5 million published book titles, keyed by their International Standard Book Number (ISBN) from Freebase.com.<a id="FNPTR-55" href="f_0057.html#FOOTNOTE-55">[55]</a>
</p>
<p id="N1A4EE" class="calibre5">
        You’ll first need the <code class="cf">redis</code> Ruby gem.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">gem install redis</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A503" class="calibre5">
        There are several ways to go about inserting a large dataset, and they get progressively faster but more complex.
      </p>
<p id="N1A506" class="calibre5">
        The simplest method is to simply iterate through a list of data and execute <code class="cf">SET</code> for each value using the standard <code class="cf">redis-rb</code> client.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td colspan="2" class="calibre34">
<a href="http://media.pragprog.com/titles/rwdata/code/redis/isbn.rb">redis/isbn.rb</a>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​LIMIT = 1.0 / 0  <em class="comment"># 1.0/0 is Infinity in Ruby</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<em class="comment"># %w{rubygems hiredis redis/connection/hiredis}.each{|r| require r}</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<em class="string">%w{rubygems time redis}</em>.each{|r| require r}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$redis = Redis.new(:host =&gt; <em class="string">"127.0.0.1"</em>, :port =&gt; 6379)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$redis.flushall​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​count, start = 0, Time.now​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​File.open(ARGV[0]).each <strong class="prompt">do</strong> |line|​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  count += 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">next</strong> <strong class="prompt">if</strong> count == 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  isbn, _, _, title = line.split(<em class="string">"</em>\t<em class="string">"</em>)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">next</strong> <strong class="prompt">if</strong> isbn.empty? || title == <em class="string">"</em>\n<em class="string">"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  $redis.set(isbn, title.strip)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="comment"># set the LIMIT value if you do not wish to populate the entire dataset</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">break</strong> <strong class="prompt">if</strong> count &gt;= LIMIT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​puts <em class="string">"</em>#{count}<em class="string"> items in </em>#{Time.now - start}<em class="string"> seconds"</em>​</code>​</div>
</td>
</tr>
</table>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">ruby isbn.rb isbn.tsv</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​2456384 items in 266.690189 seconds​</code>​</div>
</td>
</tr>
</table>
<p id="N1A594" class="calibre5">
        If you want to speed up insertion and are not running JRuby, you can optionally install the <code class="cf">hiredis</code> gem. It’s a C driver that is considerably faster than the native Ruby driver. Then uncomment the <code class="cf">hiredis</code>
	 <code class="cf">require</code> line in order to load the driver. You may not see a large improvement for this type of CPU-bound operation, but we highly recommend <code class="cf">hiredis</code> for production Ruby use.
      </p>
<p id="N1A5A3" class="calibre5">
        You will see a big improvement with pipelining. Here we batch 1,000 lines at a time and pipeline their insertion. It reduced our insertion time by more than 300 percent.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td colspan="2" class="calibre34">
<a href="http://media.pragprog.com/titles/rwdata/code/redis/isbn_pipelined.rb">redis/isbn_pipelined.rb</a>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​BATCH_SIZE = 1000​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​LIMIT = 1.0 / 0  <em class="comment"># 1.0/0 is Infinity in Ruby</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<em class="comment"># %w{rubygems hiredis redis/connection/hiredis}.each{|r| require r}</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<em class="string">%w{rubygems time redis}</em>.each{|r| require r}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$redis = Redis.new(:host =&gt; <em class="string">"127.0.0.1"</em>, :port =&gt; 6379)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$redis.flushall​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<em class="comment"># set line data as a single batch update</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">def</strong> flush(batch)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  $redis.pipelined <strong class="prompt">do</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    batch.each <strong class="prompt">do</strong> |saved_line|​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      isbn, _, _, title = line.split(<em class="string">"</em>\t<em class="string">"</em>)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <strong class="prompt">next</strong> <strong class="prompt">if</strong> isbn.empty? || title == <em class="string">"</em>\n<em class="string">"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      $redis.set(isbn, title.strip)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  batch.clear​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​batch = []​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​count, start = 0, Time.now​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​File.open(ARGV[0]).each <strong class="prompt">do</strong> |line|​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  count += 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">next</strong> <strong class="prompt">if</strong> count == 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="comment"># push lines into an array</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  batch &lt;&lt; line​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="comment"># if the array grows to BATCH_SIZE, flush it</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">if</strong> batch.size == BATCH_SIZE​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    flush(batch)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    puts <em class="string">"</em>#{count-1}<em class="string"> items"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="comment"># set the LIMIT value if you do not wish to populate the entire dataset</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">break</strong> <strong class="prompt">if</strong> count &gt;= LIMIT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<em class="comment"># flush any remaining values</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​flush(batch)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​puts <em class="string">"</em>#{count-1}<em class="string"> items in </em>#{Time.now - start}<em class="string"> seconds"</em>​</code>​</div>
</td>
</tr>
</table>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">ruby isbn_pipelined.rb isbn.tsv</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​2666642 items in 79.312975 seconds​</code>​</div>
</td>
</tr>
</table>
<p id="N1A68A" class="calibre5">
        This reduces the number of Redis connections required, but building the pipelined dataset has some overhead of its own. You should experiment with different numbers of batched operations when pipelining in production.
      </p>
<p id="N1A68D" class="calibre5">
        As a side note to Ruby users, if your application is nonblocking via Event Machine, the Ruby driver can use em-synchrony via <code class="cf">EM::Protocols::Redis.connect</code>.
        </p>
<h3 id="sec.redisCluster" class="calibre20">Redis Cluster</h3>
<p id="N1A69B" class="calibre5">
        Beyond simple replication, many Redis clients provide an interface for building a simple ad hoc distributed Redis cluster. The Ruby client redis-rb supports a consistent-hashing managed cluster. You may recall consistent hashing from the Riak chapter, where nodes can be added and dropped without having to expire most keys. This is the same idea, only managed via a client rather than by the servers themselves.
      </p>
<p id="N1A6A4" class="calibre5">
        First we need another server. Unlike the master-slave setup, both of our servers will take the master (default) configuration. We copied the <code class="cf">redis.conf</code> file and changed the port to 6380. That’s all that’s required for the servers.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td colspan="2" class="calibre34">
<a href="http://media.pragprog.com/titles/rwdata/code/redis/isbn_cluster.rb">redis/isbn_cluster.rb</a>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​LIMIT = 10000​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<em class="string">%w{rubygems time redis}</em>.each{|r| require r}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​require <em class="string">'redis/distributed'</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$redis = Redis::Distributed.new([​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="string">"redis://localhost:6379/"</em>, <em class="string">"redis://localhost:6380/"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​])​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$redis.flushall​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​count, start = 0, Time.now​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​File.open(ARGV[0]).each <strong class="prompt">do</strong> |line|​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  count += 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">next</strong> <strong class="prompt">if</strong> count == 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  isbn, _, _, title = line.split(<em class="string">"</em>\t<em class="string">"</em>)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">next</strong> <strong class="prompt">if</strong> isbn.empty? || title == <em class="string">"</em>\n<em class="string">"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  $redis.set(isbn, title.strip)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="comment"># set the LIMIT value if you do not wish to populate the entire dataset</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">break</strong> <strong class="prompt">if</strong> count &gt;= LIMIT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​puts <em class="string">"</em>#{count}<em class="string"> items in </em>#{Time.now - start}<em class="string"> seconds"</em>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A726" class="calibre5">
        Bridging between two or more servers requires only some minor changes to our existing ISBN client. First we need to require the <code class="cf">redis/distributed</code> file from the redis gem.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​require 'redis/distributed'​</code>​</div>
</td>
</tr>
</table>
<p id="N1A737" class="calibre5">
        Then replace the Redis client with Redis::Distributed and pass in an array of server URIs. Each URI requires the <code class="cf">redis</code> scheme, server (localhost), and port.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$redis = Redis::Distributed.new([​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "redis://localhost:6379/",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "redis://localhost:6380/"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​])​</code>​</div>
</td>
</tr>
</table>
<p id="N1A751" class="calibre5">
        Running the client is the same as before.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ ruby isbn_cluster.rb isbn.tsv​</code>​</div>
</td>
</tr>
</table>
<p id="N1A75F" class="calibre5">
        But a lot more work is being done by the client, since it handles computing which keys are stored on which servers. You can validate that keys are stored on separate servers by attempting to retrieve the same ISBN key from each server through the CLI. Only one client will <code class="cf">GET</code> a value. But as long as you retrieve keys set through the same Redis::Distributed configuration, the client will access the values from the correct servers.
        </p>
<h3 id="sec.bloomfilters" class="calibre20">Bloom Filters</h3>
<p id="N1A76D" class="calibre5">
      Owning a unique term is an excellent strategy for making something easily findable online. If you were to write a book named <span class="calibre6">The Jabbyredis</span>, you would be fairly certain any search engine would link to you. Let’s write a script that lets someone quickly check whether a word is unique against all words used in all titles in the ISBN catalog. We can use a Bloom filter to test whether a word is used.
      </p>
<p id="N1A77D" class="calibre5">
      A Bloom filter is a probabilistic data structure that checks for the nonexistence of an item in a set, first covered in <a href="f_0031.html#hbase.bloom">​<em class="calibre6">Compression and Bloom Filters</em>​</a>. Although it can return a false positive, it cannot return a false negative. This is a useful when you need to quickly discover whether a value does not exist in a system.
      
      </p>
<p id="N1A783" class="calibre5">
      Bloom filters succeed at discovering nonexistence by converting a value to a very sparse sequence of bits and comparing that to a union of every value’s bits. In other words, when a new value is added, it is OR’d against the current Bloom filter bit sequence. When you want to check whether the value is already in the system, you perform an AND against the Bloom filter’s sequence. If the value has any true bits that aren’t also true in the Bloom filter’s corresponding buckets, then the value was never added. In other words, this value is definitely not in the Bloom filter. Following is a graphic representation of this concept.
        </p>
<div xmlns:str="http://exslt.org/strings" class="calibre2">
<img src="images/redis-bloomfilter.png" alt="images/redis-bloomfilter.png" class="calibre27"/>
</div>
<p id="N1A7BD" class="calibre5">
      Let’s write a program that loops through a bunch of ISBN book data, extracts and simplifies each book’s title works, and splits them into individual words. Each new word encountered is checked against the Bloom filter. If the Bloom filter returns false, meaning the word does not exist in our Bloom filter, then go ahead and add it. Just to follow along, we can output any new word that’s added.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ gem install bloomfilter-rb​</code>​</div>
</td>
</tr>
</table>
<table class="processedcode">
<tr class="calibre24">
<td colspan="2" class="calibre34">
<a href="http://media.pragprog.com/titles/rwdata/code/redis/isbn_bf.rb">redis/isbn_bf.rb</a>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<em class="comment"># LIMIT = 1.0 / 0  # 1.0/0 is Infinity in Ruby</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​LIMIT= 10000​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<em class="string">%w{rubygems time bloomfilter-rb}</em>.each{|r| require r}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​bloomfilter = BloomFilter::Redis.new(:size =&gt; 1000000)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$redis = Redis.new(:host =&gt; <em class="string">"127.0.0.1"</em>, :port =&gt; 6379)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$redis.flushall​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​count, start = 0, Time.now​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​File.open(ARGV[0]).each <strong class="prompt">do</strong> |line|​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  count += 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">next</strong> <strong class="prompt">if</strong> count == 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  _, _, _, title = line.split(<em class="string">"</em>\t<em class="string">"</em>)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">next</strong> <strong class="prompt">if</strong> title == <em class="string">"</em>\n<em class="string">"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  words = title.gsub(/[^\w\s]+/, <em class="string">''</em>).downcase​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="comment"># puts words</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  words = words.split(<em class="string">' '</em>)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  words.each <strong class="prompt">do</strong> |word|​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="comment"># skip any keyword already in the bloomfilter</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">next</strong> <strong class="prompt">if</strong> bloomfilter.include?(word)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="comment"># output the very unique word</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    puts word​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="comment"># add the new word to the bloomfilter</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    bloomfilter.insert(word)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="comment"># set the LIMIT value if you do not wish to populate the entire dataset</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">break</strong> <strong class="prompt">if</strong> count &gt;= LIMIT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​puts <em class="string">"Contains Jabbyredis? </em>#{bloomfilter.include?(<em class="string">'jabbyredis'</em>)}<em class="string">"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​puts <em class="string">"</em>#{count}<em class="string"> lines in </em>#{Time.now - start}<em class="string"> seconds"</em>​</code>​</div>
</td>
</tr>
</table>
<p id="N1A888" class="calibre5">
      Ruby wunderkind Ilya Grigorik created this Redis-backed Bloom filter, but the concepts are transferable to any language.
      </p>
<p id="N1A88B" class="calibre5">
      Running the client uses the same ISBN file but  needs only the book titles.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ ruby isbn_bf.rb isbn.tsv​</code>​</div>
</td>
</tr>
</table>
<p id="N1A899" class="calibre5">
      At the start of the output you should see plenty of common words, like <span class="calibre6">and</span> and <span class="calibre6">the</span>. Near the end of the set, the words become increasingly esoteric, like <span class="calibre6">unindustria</span>.
      </p>
<p id="N1A8A5" class="calibre5">
      The upside with this approach is the ability to detect duplicate words. The downside is that a few false positives will seep through—the Bloom filter may flag a word we have never seen before. This is why in a real-world use case you would perform some secondary check, such as a slower database query to a system of record, which should happen only a small percentage of the time, presuming a large enough filter size, which is computable.<a id="FNPTR-56" href="f_0057.html#FOOTNOTE-56">[56]</a>
</p>
<h4 class="calibre21">SETBIT and GETBIT</h4>
<p id="N1A8B7" class="calibre5">
        As we mentioned earlier, Bloom filters function by flipping certain bits in a sparse binary field. The Redis Bloom filter implementation we just used takes advantage of two relatively recent Redis commands that perform just such actions: <code class="cf">SETBIT</code> and <code class="cf">GETBIT</code>. 
        </p>
<p id="N1A8C0" class="calibre5">
        Like all Redis commands, <code class="cf">SETBIT</code> is fairly descriptive. The command sets a single bit (either 1 or 0) at a certain location in a bit sequence, starting from zero. It’s a common use case for high-performance multivariate flagging—it’s faster to flip a few bits than write a set of descriptive strings.
        </p>
<p id="N1A8C6" class="calibre5">
        If we want to keep track of the toppings on a hamburger, we can assign each type of topping to a bit position, such as ketchup = 0, mustard = 1, onion = 2, lettuce = 3. So, a hamburger with only mustard and onion could be represented as 0110 and set in the command line:
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6379&gt; SETBIT my_burger 1 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​(integer) 0​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6379&gt; SETBIT my_burger 2 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​(integer) 0​</code>​</div>
</td>
</tr>
</table>
<p id="N1A8DD" class="calibre5">
        Later, a process can check whether my burger should have lettuce or mustard. If zero is returned, the answer is false—one if true.
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6379&gt; GETBIT my_burger 3​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​(integer) 0​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​redis 127.0.0.1:6379&gt; GETBIT my_burger 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​(integer) 1​</code>​</div>
</td>
</tr>
</table>
<p id="N1A8F4" class="calibre5">
        The Bloom filter implementation takes advantage of this behavior by hashing a value as a multibit value. It calls <code class="cf">SETBIT X 1</code> for each on position in an <code class="cf">insert</code> (where X is the bit position) and verifies existence by calling <code class="cf">GETBIT X</code> on <code class="cf">include?</code>—returning false if any <code class="cf">GETBIT</code> position returns 0.
        </p>
<p id="N1A906" class="calibre5">
      Bloom filters are excellent for reducing unnecessary traffic to a slower underlying system, 
      be it a slower database, limited resource, or network request. If you have a slower database 
      of IP addresses and you want to track all new users to your site, you can use a Bloom filter 
      to first check whether the IP address exists in your system. If the Bloom filter returns false, 
      you know the IP address has yet to be added and can respond accordingly. If the Bloom filter 
      returns true, this IP address may or may not exist on the back end and requires a secondary 
      lookup to be sure. This is why computing the correct size is important—a well-sized Bloom filter 
      can reduce (but not eliminate) the error rate or the likelihood of a false positive.
      </p>
<h3 class="calibre20">Day 2 Wrap-Up</h3>
<p id="N1A92A" class="calibre5">
      Today we rounded out our Redis investigation by moving beyond simple operations into squeezing every last bit of speed out of a very fast system. Redis provides for fast and flexible data structure storage and simple manipulations as we saw in Day 1 but is equally adept at more complex behaviors by way of built-in publish-subscribe functions and bit operations. It’s also highly configurable, with many durability and replication settings that conform to whatever your needs may be. It also supports some nice third-party enhancements, like Bloom filters and clustering.
      </p>
<p id="N1A92D" class="calibre5">
      This also concludes major operations for the Redis data structure store. Tomorrow we’re going to do something a bit different, by using Redis as the cornerstone of a polyglot persistence setup along with CouchDB and Neo4j.
      </p>
<h4 class="calibre21">Day 2 Homework</h4>
<p class="calibre5">
<strong class="calibre32">Find</strong>
</p>
<p id="N1A938" class="calibre5">Find out what messaging patterns are, and discover how many Redis can implement.</p>
<p class="calibre5">
<strong class="calibre32">Do</strong>
</p>
<ol class="calibre33">
<li class="calibre23">
<p id="N1A942" class="calibre5">Run the ISBN populator script with all snapshotting and the append-only file turned off. Then try running with <code class="cf">appendfsync</code> set to <code class="cf">always</code>, marking the speed difference.</p>
</li>
<li class="calibre23">
<p id="N1A94C" class="calibre5">Using your favorite programming language’s web framework, try to build a simple URL-shortening service backed by Redis with an input box for the URL and a simple redirect based on the URL. Back it up with a Redis master-slave replicated cluster across multiple nodes as your back end.</p>
</li>
</ol>
<script src="scripts/book_local.js" type="text/javascript" class="calibre3"/>
</div>

{% endraw %}

