---
layout: page
title: "Seven Databases in Seven Weeks (for Greg Kennedy)"
prev: f_0023.html
next: f_0025.html
book_path: books/seven-databases-in-seven-weeks--_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

<h2 id="sec.day1" class="calibre18">3.2 Day 1: CRUD, Links, and MIMEs</h2>
<p id="N1252C" class="calibre5">
    You can download and install a build of Riak provided by Basho<a id="FNPTR-10" href="f_0027.html#FOOTNOTE-10">[10]</a> (the company that funds its development), but we actually prefer to build this one since you get some preconfigured examples. If you really don’t want to build it, just install a prebuilt version, and then grab the source code and extract the example dev servers. Erlang<a id="FNPTR-11" href="f_0027.html#FOOTNOTE-11">[11]</a> is also required to run Riak (R14B03 or greater).
  </p>
<p id="N12551" class="calibre5">
    Building Riak from source requires three things: Erlang, the source code, and general Unix build tools like Make. Installing Erlang is easy enough (you’ll also need Erlang for CouchDB in Chapter 6, <a href="f_0040.html#chp.couchdb">​<em class="calibre6">CouchDB</em>​</a>), though it can take a while. We get the Riak source from its repository (link available via the Basho website—if you don’t have Git or Mercurial installed, you can download a zipped package). All of the examples in this chapter were run on version 1.0.2.
  </p>
<p id="N12566" class="calibre5">
    The Riak creators played Santa Claus for us new users, slipping a cool toy into our stockings. In the same directory you built Riak, run this command:
  </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">make devrel</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N12578" class="calibre5">
    When complete, we find three example servers. Just fire them up:
  </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">dev/dev1/bin/riak start</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">dev/dev2/bin/riak start</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">dev/dev3/bin/riak start</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N12597" class="calibre5">
    If you have a server fail to start because a port is in use, don’t panic. You can change the dev1, dev2, or dev3 port by opening the offending server’s <code class="cf">etc/app.config</code> file and altering the line that looks like this to use another port:
  </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{http, [ {"127.0.0.1", 8091 } ]}​</code>​</div>
</td>
</tr>
</table>
<p id="N125A9" class="calibre5">
    We should now have three Erlang processes running named <code class="cf">beam.smp</code>, representing individual Riak nodes (server instances), unaware of each other’s presence. To create a cluster, we need to join the nodes using each server’s <code class="cf">riak-admin</code> command named <code class="cf">join</code> and point them to any other cluster node.
  </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">dev/dev2/bin/riak-admin join dev1@127.0.0.1</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N125C4" class="calibre5">
    It doesn’t really matter which servers we point them at—in Riak, all nodes are equal. Now that dev1 and dev2 are in a cluster, we can point dev3 at either one.
  </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">dev/dev3/bin/riak-admin join dev2@127.0.0.1</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N125D6" class="calibre5">
    Verify your servers are healthy by checking their stats in a web browser: <code class="cf">http://localhost:8091/stats</code>.  It may prompt you to download the file, which contains lots of information about the cluster.  It should look something like this (edited for readability):
  </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "vnode_gets":0,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "vnode_puts":0,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "vnode_index_reads":0,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  ...​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "connected_nodes":[​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="string">"dev2@127.0.0.1"</em>,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="string">"dev3@127.0.0.1"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  ],​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  ...​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "ring_members":[​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="string">"dev1@127.0.0.1"</em>,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="string">"dev2@127.0.0.1"</em>,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="string">"dev3@127.0.0.1"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  ],​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "ring_num_partitions":64,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "ring_ownership":​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="string">"[{'dev3@127.0.0.1',21},{'dev2@127.0.0.1',21},{'dev1@127.0.0.1',22}]"</em>,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  ...​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N12631" class="calibre5">
    We can see that all servers are equal participants in the ring by pinging the other servers for stats on ports 8092 (dev2) and 8093 (dev3). For now, we’ll stick with the stats from dev1.
  </p>
<p id="N12634" class="calibre5">
    Look for the <code class="cf1">ring_members</code> property—it should contain all our node names and will be the same for each server. Next, find the value for <code class="cf1">connected_nodes</code>.  This should be a list of the other servers in the ring. 
  </p>
<p id="N1263D" class="calibre5">
    We can change the values reported by <code class="cf1">connected_nodes</code> by stopping a node…
  </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">dev/dev2/bin/riak stop</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N12652" class="calibre5"></p>
<p id="N12654" class="calibre5">
    …and reloading the <code class="cf">/stats</code>. Notice that <code class="cf">dev2@127.0.0.1</code> is now gone from the <code class="cf1">connected_nodes</code> list. Start <code class="cf">dev2</code>, and it will rejoin itself to the <span class="calibre6">Riak ring</span> (we’ll discuss the ring on Day 2).
  </p>
<h3 id="sec.rESTisBEST" class="calibre20">REST Is Best (or Doing cURLs)</h3>
<p id="N1266E" class="calibre5">
<span class="initials">REST</span> stands for REpresentational State Transfer. It sounds like a mouthful of jargon, but it has become the <span class="calibre6">de facto</span> architecture of web applications, so it’s worth knowing. REST is a guideline for mapping resources to <span class="initials">URL</span>s and interacting with them using <span class="initials">CRUD</span> verbs: <code class="cf">POST</code> (Create), <code class="cf">GET</code> (Read), <code class="cf">PUT</code> (Update), and <code class="cf">DELETE</code> (Delete).
    </p>
<p id="N126B3" class="calibre5">
    If you don’t already have it installed, install the <span class="initials">HTTP</span> client program cURL. We use it as our REST interface, because it’s easy to specify verbs (like <code class="cf">GET</code> and <code class="cf">PUT</code>) and HTTP header information (like <code class="cf">Content-Type</code>). With the <code class="cf">curl</code> command, we speak directly to the Riak server’s HTTP REST interface without the need for an interactive console or, say, a Ruby driver.
    </p>
<p id="N126C5" class="calibre5">
      You can validate the <code class="cf">curl</code> command works with Riak by pinging a node.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:8091/ping</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​OK​</code>​</div>
</td>
</tr>
</table>
<p id="N126DD" class="calibre5">
      Let’s issue a bad query. <code class="cf">-I</code> tells cURL that we  want only the header response.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -I http://localhost:8091/riak/no_bucket/no_key</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​HTTP/1.1 404 Object Not Found​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Server: MochiWeb/1.1 WebMachine/1.7.3 (participate in the frantic)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Date: Thu, 04 Aug 2011 01:25:49 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: text/plain​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Length: 10​</code>​</div>
</td>
</tr>
</table>
<p id="N12701" class="calibre5">
      Since Riak leverages HTTP URLs and actions, it uses HTTP headers and error codes. The 404 response means the same as a 404 when you encounter a missing web page: nothing to see here. So, let’s <code class="cf">PUT</code> something in Riak. 
    </p>
<p id="N1270C" class="calibre5">
      The <code class="cf">-X PUT</code> parameter tells cURL that we want to perform an HTTP <code class="cf">PUT</code> action to store and retrieve on an explicit key. The <code class="cf">-H</code> attribute sets the following text as HTTP header information. In this case, we set the MIME content type to HTML. Everything passed to <code class="cf">-d</code> (also known as the body data) is what Riak will add as a new value.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -v -X PUT http://localhost:8091/riak/favs/db \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Content-Type: text/html" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -d "&lt;html&gt;&lt;body&gt;&lt;h1&gt;My new favorite DB is RIAK&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;"</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N12743" class="calibre5">
    If you navigate to <code class="cf">http://localhost:8091/riak/favs/db</code> in a browser, you’ll get a nice message from yourself.
    </p>
<h3 id="sec.itPUTs" class="calibre20">PUT the Value in the Bucket</h3>
<p id="N12757" class="calibre5">
    Riak is a key-value store, so it expects you to pass in a key to retrieve a value. Riak breaks up classes of keys into <span class="calibre6">buckets</span> to avoid key collisions—for example, a key for <code class="cf">java</code> the <span class="calibre6">language</span> will not collide with <code class="cf">java</code> the <span class="calibre6">drink</span>.
    </p>
<p id="N1277F" class="calibre5">
    We’re going to create a system to keep track of animals in a dog hotel. We’ll start by creating a bucket of <code class="cf">animals</code> that contain each furry guest’s details. The URL follows this pattern:
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​http://SERVER:PORT/riak/BUCKET/KEY​</code>​</div>
</td>
</tr>
</table>
<p id="N12790" class="calibre5">
       A straightforward way of populating a Riak bucket is to know your key in advance. We’ll first add <code class="cf1">Ace, The Wonder Dog</code> and give him the key <code class="cf">ace</code> with the value <code class="cf">{"nickname" : "The Wonder Dog", "breed" : "German Shepherd"}</code>. You don’t need to explicitly create a bucket—putting a first value into a bucket name will create that bucket.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -v -X PUT http://localhost:8091/riak/animals/ace \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Content-Type: application/json" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -d '{"nickname" : "The Wonder Dog", "breed" : "German Shepherd"}'</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N127B3" class="calibre5">
      Putting a new value returns a 204 code. The <code class="cf">-v</code> (verbose) attribute in the <code class="cf">curl</code> command outputs this header line.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​&lt; HTTP/1.1 204 No Content​</code>​</div>
</td>
</tr>
</table>
<p id="N127D3" class="calibre5">
      We can view our list of buckets that have been created.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -X GET http://localhost:8091/riak?buckets=true</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"buckets":["favs","animals"]}​</code>​</div>
</td>
</tr>
</table>
<p id="N127E8" class="calibre5">
      Optionally, you can return the set results with the <code class="cf">?returnbody=true</code> parameter, which we’ll test by adding another animal, Polly:
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -v -X PUT http://localhost:8091/riak/animals/polly?returnbody=true \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Content-Type: application/json" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -d '{"nickname" : "Sweet Polly Purebred", "breed" : "Purebred"}'</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N12805" class="calibre5">
    This time you’ll see a 200 code.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​&lt; HTTP/1.1 200 OK​</code>​</div>
</td>
</tr>
</table>
<p id="N12814" class="calibre5">
    If we aren’t picky about our key name, Riak will generate one when using <code class="cf">POST</code>.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -i -X POST http://localhost:8091/riak/animals \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Content-Type: application/json" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -d '{"nickname" : "Sergeant Stubby", "breed" : "Terrier"}'</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N12836" class="calibre5">
      The generated key will be in the header under Location—also note the 201 success code in the header.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​HTTP/1.1 201 Created​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Vary: Accept-Encoding​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Server: MochiWeb/1.1 WebMachine/1.7.3 (participate in the frantic)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Location: /riak/animals/6VZc2o7zKxq2B34kJrm1S0ma3PO​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Date: Tue, 05 Apr 2011 07:45:33 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: application/json​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Length: 0​</code>​</div>
</td>
</tr>
</table>
<p id="N1285C" class="calibre5">
      A <code class="cf">GET</code> request (cURL’s default if left unspecified) to that location will retrieve the value.  
      
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:8091/riak/animals/6VZc2o7zKxq2B34kJrm1S0ma3PO</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N12876" class="calibre5">
<code class="cf">DELETE</code> will remove it.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -i -X DELETE http://localhost:8091/riak/animals/6VZc2o7zKxq2B34kJrm1S0ma3PO</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​HTTP/1.1 204 No Content​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Vary: Accept-Encoding​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Server: MochiWeb/1.1 WebMachine/1.7.3 (participate in the frantic)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Date: Mon, 11 Apr 2011 05:08:39 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: application/x-www-form-urlencoded​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Length: 0​</code>​</div>
</td>
</tr>
</table>
<p id="N128A1" class="calibre5">
      DELETE won’t return any body, but the HTTP code will be 204 if successful. Otherwise, as you’d expect, it returns a 404.
    </p>
<p id="N128A4" class="calibre5">
      If we’ve forgotten any of our keys in a bucket, we can get them all with <code class="cf">keys=true</code>.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:8091/riak/animals?keys=true</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N128B9" class="calibre5">
      You can also get them as a stream with <code class="cf">keys=stream</code>, which can be a safer choice for huge datasets—it just keeps sending chunks of keys array objects and ends with an empty array.
  </p>
<h3 id="sec.links" class="calibre20">Links</h3>
<p id="N128CA" class="calibre5">
<code class="cf">Link</code>s are metadata that associate one key to other keys. The basic structure is this:
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Link: &lt;/riak/bucket/key&gt;; riaktag=\"whatever\"​</code>​</div>
</td>
</tr>
</table>
<p id="N128F4" class="calibre5">
      The key to where this value links is in pointy brackets (&lt;…&gt;), followed by a semicolon and then a tag describing how the link relates to this value (it can be whatever string we like).
    </p>
<h4 class="calibre21">Link Walking</h4>
<p id="N128FB" class="calibre5">
      Our little dog hotel has quite a few (large, comfortable, and humane) cages. To keep track of which animal is in what cage, we’ll use a link. Cage 1 <code class="cf">contains</code> Polly by linking to her key (this also creates a new bucket named <code class="cf">cages</code>). The cage is installed in room 101, so we set that value as JSON data.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -X PUT http://localhost:8091/riak/cages/1 \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Content-Type: application/json" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Link: &lt;/riak/animals/polly&gt;; riaktag=\"contains\"" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -d '{"room" : 101}'</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N12923" class="calibre5">
      Note that this link relationship is one-directional.  In effect, the cage we’ve just created knows that Polly is inside it, but no changes have been made to Polly.  We can confirm this by pulling up Polly’s data and checking that there have been no changes to the <code class="cf">Link</code> headers.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -i http://localhost:8091/riak/animals/polly</strong>​</code>​</div>
</td>
</tr>
</table>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​HTTP/1.1 200 OK​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​X-Riak-Vclock: a85hYGBgzGDKBVIcypz/fvrde/U5gymRMY+VwZw35gRfFgA=​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Vary: Accept-Encoding​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Server: MochiWeb/1.1 WebMachine/1.9.0 (participate in the frantic)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Link: &lt;/riak/animals&gt;; rel="up"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Last-Modified: Tue, 13 Dec 2011 17:53:59 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​ETag: "VD0ZAfOTsIHsgG5PM3YZW"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Date: Tue, 13 Dec 2011 17:54:51 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: application/json​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Length: 59​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"nickname" : "Sweet Polly Purebred", "breed" : "Purebred"}​</code>​</div>
</td>
</tr>
</table>
<p id="N12964" class="calibre5">
      You can have as many metadata <code class="cf">Link</code>s as necessary, separated by commas. We’ll put Ace in cage 2 and also point to cage 1 tagged with <code class="cf1">next_to</code> so we know that it’s nearby.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -X PUT http://localhost:8091/riak/cages/2 \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">-H "Content-Type: application/json" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">-H "Link:&lt;/riak/animals/ace&gt;;riaktag=\"contains\",</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  &lt;/riak/cages/1&gt;;riaktag=\"next_to\"" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-d '{"room" : 101}'​</code>​</div>
</td>
</tr>
</table>
<p id="N1298A" class="calibre5">
      What makes <code class="cf">Link</code>s special in Riak is <span class="calibre6">link walking</span> (and a more powerful variant, linked mapreduce queries, which we investigate tomorrow). Getting the linked data is achieved by appending a <span class="calibre6">link spec</span> to the URL that is structured like this: <code class="cf">/_,_,_</code>. The underscores (_) in the URL represent wildcards to each of the link criteria: bucket, tag, keep. We’ll explain those terms shortly. First let’s retrieve all links from cage 1.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:8091/riak/cages/1/_,_,_</strong>​</code>​</div>
</td>
</tr>
</table>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--4PYi9DW8iJK5aCvQQrrP7mh7jZs​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: multipart/mixed; boundary=Av1fawIA4WjypRlz5gHJtrRqklD​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--Av1fawIA4WjypRlz5gHJtrRqklD​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​X-Riak-Vclock: a85hYGBgzGDKBVIcypz/fvrde/U5gymRMY+VwZw35gRfFgA=​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Location: /riak/animals/polly​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: application/json​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Link: &lt;/riak/animals&gt;; rel="up"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Etag: VD0ZAfOTsIHsgG5PM3YZW​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Last-Modified: Tue, 13 Dec 2011 17:53:59 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"nickname" : "Sweet Polly Purebred", "breed" : "Purebred"}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--Av1fawIA4WjypRlz5gHJtrRqklD--​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--4PYi9DW8iJK5aCvQQrrP7mh7jZs--​</code>​</div>
</td>
</tr>
</table>
<p id="N129F2" class="calibre5">
      It returns a <code class="cf">multipart/mixed</code> dump of headers plus bodies of all linked keys/values. It’s also a headache to look at. Tomorrow we’ll find a more powerful way to get link-walked data that also happens to return nicer values—but today we’ll dig a bit more into this syntax.
    </p>
<p id="N129F8" class="calibre5">
      If you’re not familiar with reading the <code class="cf">multipart/mixed</code> MIME type, the <code class="cf">Content-Type</code> definition describes a boundary string, which denotes the beginning and end of some HTTP header and body data.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--BcOdSWMLuhkisryp0GidDLqeA64​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​some HTTP header and body data​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--BcOdSWMLuhkisryp0GidDLqeA64--​</code>​</div>
</td>
</tr>
</table>
<p id="N12A1F" class="calibre5">
      In our case, the data is what cage 1 links to: Polly Purebred. You may have noticed that the headers returned don’t actually display the link information. This is OK; that data is still stored under the linked-to key.
    </p>
<p id="N12A22" class="calibre5">
      When link walking, we can replace the underscores in the link spec to filter only values we want. Cage 2 has two links, so performing a link spec request will return both the animal Ace contained in the cage and the cage 1 <code class="cf">next_to</code> it.  To specify only following the <code class="cf">animals</code> bucket, replace the first underscore with the bucket name.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:8091/riak/cages/2/animals,_,_</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N12A3A" class="calibre5">
      Or follow the cages <span class="calibre6">next to</span> this one by populating the <code class="cf">tag</code> criteria.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:8091/riak/cages/2/_,next_to,_</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N12A52" class="calibre5">
      The final underscore—<code class="cf">keep</code>—accepts a 1 or 0. <code class="cf">keep</code> is useful when following second-order links, or links following other links, which you can do by just appending another link spec. Let’s follow the keys <code class="cf">next_to</code> cage 2, which will return cage 1. Next, we walk to the animals linked to cage 1. Since we set <code class="cf">keep</code> to 0, Riak will not return the intermediate step (the cage 1 data). It will return only Polly’s information, who is next to Ace’s cage.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:8091/riak/cages/2/_,next_to,0/animals,_,_</strong>​</code>​</div>
</td>
</tr>
</table>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--6mBdsboQ8kTT6MlUHg0rgvbLhzd​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: multipart/mixed; boundary=EZYdVz9Ox4xzR4jx1I2ugUFFiZh​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--EZYdVz9Ox4xzR4jx1I2ugUFFiZh​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​X-Riak-Vclock: a85hYGBgzGDKBVIcypz/fvrde/U5gymRMY+VwZw35gRfFgA=​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Location: /riak/animals/polly​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: application/json​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Link: &lt;/riak/animals&gt;; rel="up"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Etag: VD0ZAfOTsIHsgG5PM3YZW​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Last-Modified: Tue, 13 Dec 2011 17:53:59 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"nickname" : "Sweet Polly Purebred", "breed" : "Purebred"}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--EZYdVz9Ox4xzR4jx1I2ugUFFiZh--​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--6mBdsboQ8kTT6MlUHg0rgvbLhzd--​</code>​</div>
</td>
</tr>
</table>
<p id="N12AA3" class="calibre5">
      If we want Polly’s information and cage 1, set <code class="cf">keep</code> to 1.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:8091/riak/cages/2/_,next_to,1/_,_,_</strong>​</code>​</div>
</td>
</tr>
</table>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--PDVOEl7Rh1AP90jGln1mhz7x8r9​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: multipart/mixed; boundary=YliPQ9LPNEoAnDeAMiRkAjCbmed​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--YliPQ9LPNEoAnDeAMiRkAjCbmed​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​X-Riak-Vclock: a85hYGBgzGDKBVIcypz/fvrde/U5gymRKY+VIYo35gRfFgA=​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Location: /riak/cages/1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: application/json​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Link: &lt;/riak/animals/polly&gt;; riaktag="contains", &lt;/riak/cages&gt;; rel="up"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Etag: 6LYhRnMRrGIqsTmpE55PaU​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Last-Modified: Tue, 13 Dec 2011 17:54:34 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"room" : 101}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--YliPQ9LPNEoAnDeAMiRkAjCbmed--​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--PDVOEl7Rh1AP90jGln1mhz7x8r9​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: multipart/mixed; boundary=GS9J6KQLsI8zzMxJluDITfwiUKA​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--GS9J6KQLsI8zzMxJluDITfwiUKA​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​X-Riak-Vclock: a85hYGBgzGDKBVIcypz/fvrde/U5gymRMY+VwZw35gRfFgA=​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Location: /riak/animals/polly​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: application/json​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Link: &lt;/riak/animals&gt;; rel="up"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Etag: VD0ZAfOTsIHsgG5PM3YZW​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Last-Modified: Tue, 13 Dec 2011 17:53:59 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"nickname" : "Sweet Polly Purebred", "breed" : "Purebred"}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--GS9J6KQLsI8zzMxJluDITfwiUKA--​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--PDVOEl7Rh1AP90jGln1mhz7x8r9--​</code>​</div>
</td>
</tr>
</table>
<p id="N12B12" class="calibre5">
      This returns the objects in the path to the final result. In other words, <span class="calibre6">keep</span> the step.
      </p>
<h4 id="sec.beyondLinks" class="calibre21">Beyond Links</h4>
<p id="N12B20" class="calibre5">
        Along with <code class="cf">Link</code>s, you can store arbitrary metadata by using the <code class="cf">X-Riak-Meta-</code> header prefix. 
        If we wanted to keep track of the color of a cage but it wasn’t necessarily important in the day-to-day cage-managing tasks at hand, 
        we could mark cage 1 as having the color pink. Getting the URL’s header (the -I flag) will return your metadata name and value.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -X PUT http://localhost:8091/riak/cages/1 \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Content-Type: application/json" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "X-Riak-Meta-Color: Pink" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Link: &lt;/riak/animals/polly&gt;; riaktag=\"contains\"" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -d '{"room" : 101}'</strong>​</code>​</div>
</td>
</tr>
</table>
<h3 class="calibre20">MIME Types in Riak</h3>
<p id="N12B4C" class="calibre5">
      Riak stores everything as a binary-encoded value, just like normal HTTP. The MIME type gives the binary data context—we’ve been dealing only  with plain text up until now. MIME types are stored on the Riak server but are really just a flag to the client so that when it downloads the binary data, it knows how to render it.
    </p>
<p id="N12B55" class="calibre5">
      We’d like our dog hotel to keep images of our guests. We need only use the <code class="cf">data-binary</code> flag on the <code class="cf">curl</code> command to upload an image to the server and specify the MIME type as <code class="cf">image/jpeg</code>. We’ll add a link back to the <code class="cf">/animals/polly</code> key so we know who we are looking at.
    </p>
<p id="N12B64" class="calibre5">
First, create an image called <code class="cf">polly_image.jpg</code> and place it in the same directory you’ve been using to issue the <code class="cf">curl</code> commands.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -X PUT http://localhost:8091/riak/photos/polly.jpg \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Content-type: image/jpeg" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Link: &lt;/riak/animals/polly&gt;; riaktag=\"photo\"" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  --data-binary @polly_image.jpg</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N12B88" class="calibre5">
      Now visit the URL in a web browser, which will be delivered and rendered exactly as you’d expect any web client-server request to function.
    </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​http://localhost:8091/riak/photos/polly.jpg​</code>​</div>
</td>
</tr>
</table>
<p id="N12B97" class="calibre5">
      Since we pointed the image to <code class="cf">/animals/polly</code>, we could link walk from the image key <span class="calibre6">to</span> Polly but not vice versa. Unlike a relational database, there is no “has a” or “is a” rule concerning links. You link the direction you need to walk. If we believe our use case will require accessing image data from the <code class="cf">animals</code> bucket, a link should exist on that object instead (or in addition).
    </p>
<h3 id="sec.day1Recap" class="calibre20">Day 1 Wrap-Up</h3>
<p id="N12BAB" class="calibre5">
      We hope you’re seeing a glimmer of Riak’s potential as a flexible storage option. So far, we’ve covered only standard key-value practice with some links thrown in. When designing a Riak schema, think somewhere in between a caching system and PostgreSQL. You will break up your data into different logical classifications (buckets), and values can tacitly relate to each other. But you will not go so far as to normalize into fine components like you would in a relational database, since Riak performs no sense of relational joins to recompose values.
    </p>
<h4 class="calibre21">Day 1 Homework</h4>
<p class="calibre5">
<strong class="calibre32">Find</strong>
</p>
<ol class="calibre33">
<li class="calibre23">
<p id="N12BB9" class="calibre5">Bookmark the online Riak project documentation and discover the REST API documentation.</p>
</li>
<li class="calibre23">
<p id="N12BBD" class="calibre5">Find a good list of browser-supported MIME types.</p>
</li>
<li class="calibre23">
<p id="N12BC1" class="calibre5">Read the example Riak config <code class="cf">dev/dev1/etc/app.config</code>, and compare it to the other dev configurations.</p>
</li>
</ol>
<p class="calibre5">
<strong class="calibre32">Do</strong>
</p>
<ol class="calibre33">
<li class="calibre23">
<p id="N12BCE" class="calibre5">Using <code class="cf">PUT</code>, update <code class="cf">animals/polly</code> to have a Link pointing to <code class="cf">photos/polly.jpg</code>.</p>
</li>
<li class="calibre23">
<p id="N12BDB" class="calibre5">
<code class="cf">POST</code> a file of a MIME type we haven’t tried (such as <code class="cf">application/pdf</code>), find the generated key, and hit that URL from a web browser.</p>
</li>
<li class="calibre23">
<p id="N12BE4" class="calibre5">Create a new bucket type called <code class="cf1">medicines</code>, <code class="cf">PUT</code> a JPEG image value (with the proper MIME type) keyed as <code class="cf1">antibiotics</code>, and link to the animal Ace (poor, sick puppy).</p>
</li>
</ol>
<script src="scripts/book_local.js" type="text/javascript" class="calibre3"/>
</div>

{% endraw %}

