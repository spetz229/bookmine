---
layout: page
title: "Seven Databases in Seven Weeks (for Greg Kennedy)"
prev: f_0042.html
next: f_0044.html
book_path: books/seven-databases-in-seven-weeks--_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

<h2 id="N1700D" class="calibre18">6.3 Day 2: Creating and Querying Views</h2>
<p id="N17011" class="calibre5">
      In CouchDB, a <span class="calibre6">view</span> is a window into the documents contained in a database.  Views are the principal way that documents are accessed in all but trivial cases—like those individual CRUD operations we saw in Day 1.  Today, we’ll discover how to create the functions that make up a view.  We’ll also learn how to perform ad hoc queries against views using cURL. Finally, we’ll import music data, which will make the views more salient and demonstrate how to use couchrest, a popular Ruby library for working with CouchDB.
    </p>
<h3 class="calibre20">Accessing Documents Through Views</h3>
<p id="N1701B" class="calibre5">
        A view consists of mapper and reducer functions that are used to generate an ordered list of key-value pairs.  Both keys and values can be any valid JSON.  The simplest view is called <code class="cf">_all_docs</code>.  It is provided out of the box for all databases and contains an entry for each document in the database, keyed by its string <code class="cf">_id</code>.
      </p>
<p id="N17030" class="calibre5">
        To retrieve all the things in the database, issue a <code class="cf">GET</code> request for the <code class="cf">_all_docs</code> view.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:5984/music/_all_docs</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "total_rows":1,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "offset":0,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "rows":[{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "key":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "value":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "rev":"4-93a101178ba65f61ed39e60d70c9fd97"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  }]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N17069" class="calibre5">
        You can see in the previous output the one document we’ve created so far.  The response is a JSON object that contains an array of <code class="cf">rows</code>.  Each row is an object with three fields:
      </p>
<ul class="calibre22">
<li class="calibre23">
<p id="N17077" class="calibre5">
<code class="cf">id</code> is the document’s <code class="cf">_id</code>.</p>
</li>
<li class="calibre23">
<p id="N17080" class="calibre5">
<code class="cf">key</code> is the JSON key produced by the mapreduce functions.</p>
</li>
<li class="calibre23">
<p id="N17086" class="calibre5">
<code class="cf">value</code> is the associated JSON value, also produced through mapreduce.</p>
</li>
</ul>
<p id="N1708B" class="calibre5">
        In the case of <code class="cf">_all_docs</code>, the <code class="cf">id</code> and <code class="cf">key</code> fields match, but for custom views this will almost never be the case.
      </p>
<p id="N17097" class="calibre5">
      By default, views won’t include all of each document’s content in the <code class="cf">value</code> returned. To retrieve all of the document’s fields, add the <code class="cf">include_docs=true</code> URL parameter.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:5984/music/_all_docs?include_docs=true</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "total_rows":1,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "offset":0,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "rows":[{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "key":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "value":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "rev":"4-93a101178ba65f61ed39e60d70c9fd97"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    },​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "doc":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "_id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "_rev":"4-93a101178ba65f61ed39e60d70c9fd97",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "name":"The Beatles",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "albums":[{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "title":"Help!",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "year":1965​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      },{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "title":"Sgt. Pepper's Lonely Hearts Club Band",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "year":1967​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      },{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "title":"Abbey Road",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "year":1969​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      }]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  }]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N170FD" class="calibre5">
        Here you can see that the other properties <code class="cf">name</code> and <code class="cf">albums</code> have been added to the <code class="cf">value</code> object in the output.  With this basic structure in mind, let’s make our own views.
      </p>
<h3 class="calibre20">Writing Your First View</h3>
<div class="figure" id="fig.couchdb.futon.temporary.view">
<div class="calibre2">
<img xmlns:str="http://exslt.org/strings" src="images/couchdb-futon-temporary-view.png" alt="images/couchdb-futon-temporary-view.png" class="calibre27"/>
</div>
<div class="figurecaption">
<hr class="calibre28"/>Figure 28. CouchDB Futon: temporary view</div>
</div>
<p id="N1711E" class="calibre5">
        Now that we’ve gotten a rough overview of how views work, let’s try creating our own views.  To start, we’ll reproduce the behavior of the <code class="cf">_all_docs</code> view, and after that, we’ll make increasingly complex views to extract deeper information from our documents for indexing.
      </p>
<p id="N17130" class="calibre5">
        To execute a temporary view, open a browser to Futon<a id="FNPTR-40" href="f_0045.html#FOOTNOTE-40">[40]</a> as we did in Day 1.  Next open the <code class="cf">music</code> database by clicking the link.  In the upper-right corner of the music database’s page, choose “Temporary view...” from the View drop-down.  It should bring you to a page that resembles Figure 28, <a href="#fig.couchdb.futon.temporary.view">​<em class="calibre6">CouchDB Futon: temporary view</em>​</a>.
      </p>
<p id="N1713F" class="calibre5">
        The code in the left Map Function box should look like this:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​function(doc) {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  emit(null, doc);​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N17154" class="calibre5">
        If you click the  Run button underneath the map function, CouchDB will execute this function once for each document in the database, passing in that document as the <code class="cf">doc</code> parameter each time.  This will generate a table with a single row of results resembling the following:
      </p>
<table class="simpletable1">
<thead class="calibre29">
<tr class="calibre8">
<th class="hlines">
<p class="last-para-in-cell">Key</p>
</th>
<th class="hlines">
<p class="last-para-in-cell">Value</p>
</th>
</tr>
</thead>
<tbody class="calibre7">
<tr class="calibre8">
<td class="calibre30">
<p class="last-para-in-cell">
<code class="cf">null</code>
</p>
</td>
<td class="calibre30">
<p class="last-para-in-cell">
<code class="cf">{_id: "74c7a8d2a8548c8b97da748f43000ac4", _rev: "4-93a101178ba65f61ed39e60d70c9fd97", name: "The Beatles", albums: [{title: "Help!", year: 1965}, {title: "Sgt. Pepper’s Lonely Hearts Club Band", year: 1967}, {title: "Abbey Road", year: 1969}]}</code>
</p>
</td>
</tr>
</tbody>
</table>
<p id="N17172" class="calibre5">
        The secret to this output, and all views, is the <code class="cf">emit</code> function (this works just like the MongoDB function of the same name).  <code class="cf">emit</code> takes two arguments: the key and the value.  A given map function may call emit one time, many times, or no times for a given document.  In the previous case, the map function emits the key-value pair <code class="cf">null</code>/<code class="cf">doc</code>. As we see in the output table, the key is indeed <code class="cf">null</code>, and the value is the same object we saw in Day 1 when we requested it directly from cURL.
      </p>
<p id="N17184" class="calibre5">
        To make a mapper that achieves the same thing as <code class="cf">_all_docs</code>, we need to emit something a little different.  Recall that <code class="cf">_all_docs</code> emits the document’s <code class="cf">_id</code> field for the key and a simple object containing only the <code class="cf">_rev</code> field for the value.  With that in mind, change the Map Function code to the following, and then click Run.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​function(doc) {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  emit(doc._id, { rev: doc._rev });​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N171A5" class="calibre5">
        The output table should now resemble the following table, echoing the same key-value pair we saw earlier when enumerating records via <code class="cf">_all_docs</code>:
      </p>
<table class="simpletable1">
<thead class="calibre29">
<tr class="calibre8">
<th class="hlines">
<p class="last-para-in-cell">Key</p>
</th>
<th class="hlines">
<p class="last-para-in-cell">Value</p>
</th>
</tr>
</thead>
<tbody class="calibre7">
<tr class="calibre8">
<td class="calibre30">
<p class="last-para-in-cell">
<code class="cf">"74c7a8d2a8548c8b97da748f43000ac4"</code>
</p>
</td>
<td class="calibre30">
<p class="last-para-in-cell">
<code class="cf">{rev: "4-93a101178ba65f61ed39e60d70c9fd97"}</code>
</p>
</td>
</tr>
</tbody>
</table>
<p id="N171C3" class="calibre5">
        Note that you don’t have to use Futon to execute temporary views.  You may also send a <code class="cf">POST</code> request to the <code class="cf">_temp_view</code> handler.  In this case, you pass in your map function as a JSON object in the request body.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -X POST \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  http://localhost:5984/music/_temp_view \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Content-Type: application/json" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -d '{"map":"function(doc){emit(doc._id,{rev:doc._rev});}"}'</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "total_rows":1,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "offset":0,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "rows":[{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "key":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "value":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "rev":"4-93a101178ba65f61ed39e60d70c9fd97"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  }]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N1720B" class="calibre5">
        The response is now identical to what we’d expect from <code class="cf">_all_docs</code>.  But what happens when we add the <code class="cf">include_docs=true</code> parameter?  Let’s find out!
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -X POST \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  http://localhost:5984/music/_temp_view?include_docs=true \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Content-Type: application/json" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -d '{"map":"function(doc){emit(doc._id,{rev:doc._rev});}"}'</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "total_rows":1,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "offset":0,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "rows":[{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "key":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "value":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "rev":"4-93a101178ba65f61ed39e60d70c9fd97"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    },​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "doc":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "_id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "_rev":"4-93a101178ba65f61ed39e60d70c9fd97",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "name":"The Beatles",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "albums":[...]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  }]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N17262" class="calibre5">
        This time, instead of integrating additional fields into the <code class="cf">value</code> object, a separate property called <code class="cf">doc</code> is added to the row result containing the full document.
      </p>
<p id="N1726B" class="calibre5">
        A custom view may emit any value, even <code class="cf">null</code>.	Providing a separate <code class="cf">doc</code> property prevents problems that might otherwise arise with combining the row value with the document.  Next, let’s see how to save a view so that CouchDB can index the results.
        </p>
<h3 class="calibre20">Saving a View as a Design Document</h3>
<p id="N1727E" class="calibre5">
        When CouchDB executes a temporary view, it must execute the provided map function for <span class="calibre6">each and every document</span> in the database.  This is extremely resource-intensive, chewing up a lot of processing power, and it’s slow.  You should use temporary views only for development purposes.  For production, you should store your views in <span class="calibre6">design documents</span>.
      </p>
<p id="N1729E" class="calibre5">
        A design document is a real document in the database, just like the Beatles document we created earlier.  As such, it can show up in views and be replicated to other CouchDB servers in the usual fashion.  To save a temporary view as a design document in Futon, click the  Save As... button, and then fill in the Design Document and View Name fields.
      </p>
<p id="N172A1" class="calibre5">
        Design documents always have IDs that start with <code class="cf">_design/</code> and contain one or more views.  The view name distinguishes this view from others housed in the same design document.  Deciding which views belong in which design documents is largely application-specific and subject to taste.  As a general rule, you should group views  based on what they do relative to your data.  We’ll see examples of this as we create more interesting views.
      </p>
<h3 class="calibre20">Finding Artists by Name</h3>
<p id="N172AB" class="calibre5">
        Now that we’ve covered the basics of view creation, let’s develop an application-specific view.  Recall that our <code class="cf">music</code> database stores artist information, including a <code class="cf">name</code> field that contains the band’s name.  Using the normal <code class="cf">GET</code> access pattern or the <code class="cf">_all_docs</code> view, we can access documents by their <code class="cf">_id</code> values, but we’re more interested in looking up bands by name.
      </p>
<p id="N172C2" class="calibre5">
        In other words, today we can look up the document with <code class="cf">_id</code> equal to <code class="cf">74c7a8d2a8548c8b97da748f43000ac4</code>, but how do we find the document with <code class="cf">name</code> equal to <code class="cf1">The Beatles</code>?  For this, we need a view.  In Futon, head back to the Temporary View page,  enter the following Map Function code, and click Run.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td colspan="2" class="calibre34">
<a href="http://media.pragprog.com/titles/rwdata/code/couchdb/artists_by_name_mapper.js">couchdb/artists_by_name_mapper.js</a>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">function</strong>(doc) {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">if</strong> (<em class="string">'name'</em> <strong class="prompt">in</strong> doc) {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    emit(doc.name, doc._id);​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N172F5" class="calibre5">
        This function checks whether the current document has a <code class="cf">name</code> field and, if so, emits the name and document <code class="cf">_id</code> as the relevant key-value pair.  This should produce a table like this:
      </p>
<table class="simpletable1">
<thead class="calibre29">
<tr class="calibre8">
<th class="hlines">
<p class="last-para-in-cell">Key</p>
</th>
<th class="hlines">
<p class="last-para-in-cell">Value</p>
</th>
</tr>
</thead>
<tbody class="calibre7">
<tr class="calibre8">
<td class="calibre30">
<p class="last-para-in-cell">
<code class="cf">"The Beatles"</code>
</p>
</td>
<td class="calibre30">
<p class="last-para-in-cell">
<code class="cf">"74c7a8d2a8548c8b97da748f43000ac4"</code>
</p>
</td>
</tr>
</tbody>
</table>
<p id="N17316" class="calibre5">
        Click the  Save As... button; then for Design Document, enter <code class="cf1">artists</code> and for View Name enter <code class="cf1">by_name</code>.  Click Save  to persist the change.
      </p>
<h3 class="calibre20">Finding Albums by Name</h3>
<p id="N17323" class="calibre5">
        Finding artists by name is pretty useful, but we can do more.  This time, let’s make a view that lets us find albums.  This will be the first example where the map function will emit more than one result per document.
      </p>
<p id="N17326" class="calibre5">
        Again return to the Temporary View page; then enter the following mapper:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td colspan="2" class="calibre34">
<a href="http://media.pragprog.com/titles/rwdata/code/couchdb/albums_by_name_mapper.js">couchdb/albums_by_name_mapper.js</a>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">function</strong>(doc) {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">if</strong> (<em class="string">'name'</em> <strong class="prompt">in</strong> doc &amp;&amp; <em class="string">'albums'</em> <strong class="prompt">in</strong> doc) {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    doc.albums.forEach(<strong class="prompt">function</strong>(album){​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <strong class="prompt">var</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        key = album.title || album.name,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        value = { by: doc.name, album: album };​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      emit(key, value);​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    });​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N17367" class="calibre5">
        This function checks whether the current document has a <code class="cf">name</code> field and an <code class="cf">albums</code> field.  
        If so, it emits a key-value pair for each album where the key is the album’s title or name and the value is a 
        compound object containing the artist’s name and the original album object. It produces a table like this:
      </p>
<table class="simpletable1">
<thead class="calibre29">
<tr class="calibre8">
<th class="hlines">
<p class="last-para-in-cell">Key</p>
</th>
<th class="hlines">
<p class="last-para-in-cell">Value</p>
</th>
</tr>
</thead>
<tbody class="calibre7">
<tr class="calibre8">
<td class="calibre30">
<p class="last-para-in-cell">
<code class="cf">"Abbey Road"</code>
</p>
</td>
<td class="calibre30">
<p class="last-para-in-cell">
<code class="cf">{by: "The Beatles", album: {title: "Abbey Road", year: 1969}}</code>
</p>
</td>
</tr>
<tr class="calibre8">
<td class="calibre31">
<p class="last-para-in-cell">
<code class="cf">"Help!"</code>
</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">
<code class="cf">{by: "The Beatles", album: {title: "Help!", year: 1965}}</code>
</p>
</td>
</tr>
<tr class="calibre8">
<td class="calibre31">
<p class="last-para-in-cell">
<code class="cf">"Sgt. Pepper’s Lonely Hearts Club Band"</code>
</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">
<code class="cf">{by: "The Beatles", album: {title: "Sgt. Pepper’s Lonely Hearts Club Band", year: 1967}}</code>
</p>
</td>
</tr>
</tbody>
</table>
<p id="N1739E" class="calibre5">
        Just like we did with the Artists By Name view, click the  Save As...  button.  This time, for Design Document, enter <code class="cf1">albums</code>, and for View Name enter <code class="cf1">by_name</code>.  Click  Save to persist the change.  Now let’s see how to query these documents.
        </p>
<h3 class="calibre20">Querying Our Custom Artist and Album Views</h3>
<p id="N173B4" class="calibre5">
        Now that we have a couple of custom design documents saved, let’s jump back to the command line and query them with the <code class="cf">curl</code> command.  We’ll start with the Artists By Name view.  On the command line, execute the following:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:5984/music/_design/artists/_view/by_name</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "total_rows":1,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "offset":0,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "rows":[{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "key":"The Beatles",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "value":"74c7a8d2a8548c8b97da748f43000ac4"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  }]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N173F2" class="calibre5">
        To query a view, construct the path <code class="cf">/&lt;database_name&gt;/</code>
<code class="cf">_design/</code>
<code class="cf">&lt;design_doc&gt;/</code>
<code class="cf">_view/</code>
<code class="cf">&lt;view_name&gt;</code>, replacing the parts as appropriate.  In our case, we’re querying the <code class="cf">by_name</code> view in the <code class="cf">artists</code> design document of the <code class="cf">music</code> database.  No surprise here that the output includes our one document, keyed by the band name.
      </p>
<p id="N17411" class="calibre5">
        Next, let’s try to find Albums By Name:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:5984/music/_design/albums/_view/by_name</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "total_rows":3,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "offset":0,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "rows":[{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "key":"Abbey Road",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "value":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "by":"The Beatles",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "album":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "title":"Abbey Road",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "year":1969​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  },{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "key":"Help!",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "value":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "by":"The Beatles",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "album":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "title":"Help!",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "year":1965​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  },{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "key":"Sgt. Pepper's Lonely Hearts Club Band",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "value":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "by":"The Beatles",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "album":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "title":"Sgt. Pepper's Lonely Hearts Club Band",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        "year":1967​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  }]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N1748C" class="calibre5">
        CouchDB will ensure that the records are presented in alphanumerical order by the emitted keys.  In effect, this is the indexing that CouchDB offers.  When designing your views, it’s important to pick emitted keys that will make sense when ordered.

        Requesting a view in this fashion returns the whole set, but what if we want just a subset?  One way to do that is to use the <code class="cf">key</code> URL parameter.  When you specify a key, only rows with that exact key are returned.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl 'http://localhost:5984/music/_design/albums/_view/by_name?key="Help!"'</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "total_rows":3,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "offset":1,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "rows":[{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "key":"Help!",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "value":{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "by":"The Beatles",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "album":{"title":"Help!","year":1965}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  }]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N174C5" class="calibre5">
        Notice the <code class="cf">total_rows</code> and <code class="cf">offset</code> fields in the response.  The <code class="cf">total_rows</code> field counts the total number of records in the view, not just the subset returned for this request.  The <code class="cf">offset</code> field tells us how far into that full set the first record presented appears.  Based on these two numbers and the length of the <code class="cf">rows</code>, we can calculate how many more records there are in the view on both sides.
      </p>
<p id="N174DC" class="calibre5">
        Requests for views can be sliced a few other ways beyond the <code class="cf">keys</code> parameter, but to really see them in action, we’re going to need more data.
        </p>
<h3 class="calibre20">Importing Data Into CouchDB Using Ruby</h3>
<p id="N174E9" class="calibre5">
        Importing data is a recurring problem that you’ll face no matter what database you end up using.  CouchDB is no exception here.  In this section, we’ll use Ruby to import structured data into our <code class="cf">music</code> database.  Through this you’ll see how to perform bulk imports into CouchDB, and it’ll also give us a nice pool of data to work with when we create more advanced views.
      </p>
<p id="N174FB" class="calibre5">
        We’ll use music data from Jamendo.com,<a id="FNPTR-41" href="f_0045.html#FOOTNOTE-41">[41]</a> a site devoted to hosting freely licensed music.  Jamendo provides all their artist, album, and track data in a structured XML format, making it ideal for importing into a document-oriented database like CouchDB.
      </p>
<p id="N1750A" class="calibre5">
        Head over to Jamendo’s NewDatabaseDumps page<a id="FNPTR-42" href="f_0045.html#FOOTNOTE-42">[42]</a> and download <code class="cf">dbdump_</code>
<code class="cf">artistalbumtrack.xml.gz</code>.<a id="FNPTR-43" href="f_0045.html#FOOTNOTE-43">[43]</a>  
        The zipped file is only about 15MB.  To parse Jamendo’s XML file, we’ll use the <code class="cf">libxml-ruby</code> gem.
      </p>
<p id="N17524" class="calibre5">
        Rather than writing our own Ruby-CouchDB driver or issuing HTTP requests directly, we’ll use a popular Ruby gem called <code class="cf">couchrest</code> that wraps these calls into a convenient Ruby API.  We’ll be using only a few methods from the API, but if you want to continue using this driver for your own projects, the documentation is quite good.<a id="FNPTR-44" href="f_0045.html#FOOTNOTE-44">[44]</a>
</p>
<p id="N1752F" class="calibre5">
        On the command line, install the necessary gems:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">gem install libxml-ruby couchrest</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N17541" class="calibre5">
        Just like we did for Wikipedia data in Chapter 4, <a href="f_0028.html#chp.hbase">​<em class="calibre6">HBase</em>​</a>, we’ll use a SAX-style parser to process documents sequentially for insert as they’re streamed in through standard input.  Here’s the code:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td colspan="2" class="calibre34">
<a href="http://media.pragprog.com/titles/rwdata/code/couchdb/import_from_jamendo.rb">couchdb/import_from_jamendo.rb</a>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span>① </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​require <em class="string">'rubygems'</em> ​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​require <em class="string">'libxml'</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​require <em class="string">'couchrest'</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​include LibXML​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span>② </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">class</strong> JamendoCallbacks ​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  include XML::SaxParser::Callbacks​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span>③ </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">def</strong> initialize() ​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    @db = CouchRest.database!(<em class="string">"http://localhost:5984/music"</em>)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    @count = 0​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    @max = 100 <em class="comment"># maximum number to insert</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    @stack = []​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    @artist = nil​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    @album = nil​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    @track = nil​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    @tag = nil​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    @buffer = nil​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span>④ </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">def</strong> on_start_element(element, attributes) ​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">case</strong> element​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">when</strong> <em class="string">'artist'</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @artist = { :albums =&gt; [] }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @stack.push @artist​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">when</strong> <em class="string">'album'</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @album = { :tracks =&gt; [] }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @artist[:albums].push @album​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @stack.push @album​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">when</strong> <em class="string">'track'</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @track = { :tags =&gt; [] }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @album[:tracks].push @track​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @stack.push @track​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">when</strong> <em class="string">'tag'</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @tag = {}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @track[:tags].push @tag​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @stack.push @tag​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">when</strong> <em class="string">'Artists'</em>, <em class="string">'Albums'</em>, <em class="string">'Tracks'</em>, <em class="string">'Tags'</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <em class="comment"># ignore</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">else</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @buffer = []​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span>⑤ </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">def</strong> on_characters(chars) ​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    @buffer &lt;&lt; chars <strong class="prompt">unless</strong> @buffer.nil?​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span>⑥ </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">def</strong> on_end_element(element) ​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">case</strong> element​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">when</strong> <em class="string">'artist'</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @stack.pop​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @artist[<em class="string">'_id'</em>] = @artist[<em class="string">'id'</em>] <em class="comment"># reuse Jamendo's artist id for doc _id</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @artist[:random] = rand​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @db.save_doc(@artist, false, true)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      @count += 1​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <strong class="prompt">if</strong> !@max.nil? &amp;&amp; @count &gt;= @max​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        on_end_document​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <strong class="prompt">if</strong> @count % 500 == 0​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        puts <em class="string">"  </em>#{@count}<em class="string"> records inserted"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">when</strong> <em class="string">'album'</em>, <em class="string">'track'</em>, <em class="string">'tag'</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      top = @stack.pop​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      top[:random] = rand​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">when</strong> <em class="string">'Artists'</em>, <em class="string">'Albums'</em>, <em class="string">'Tracks'</em>, <em class="string">'Tags'</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <em class="comment"># ignore</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">else</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <strong class="prompt">if</strong> @stack[-1] &amp;&amp; @buffer​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        @stack[-1][element] = @buffer.join.force_encoding(<em class="string">'utf-8'</em>)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​        @buffer = nil​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">def</strong> on_end_document()​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    puts <em class="string">"TOTAL: </em>#{@count}<em class="string"> records inserted"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    exit(1)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">end</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span>⑦ </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​parser = XML::SaxParser.io(ARGF) ​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​parser.callbacks = JamendoCallbacks.new​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​parser.parse​</code>​</div>
</td>
</tr>
</table>
<dl class="calibre39">
<dt class="calibre2">①</dt>
<dd class="calibre40">
<p id="N176F8" class="calibre5">
            To kick things off, we bring in the <code class="cf">rubygems</code> module and the specific gems that we need.
          </p>
</dd>
<dt class="calibre2">②</dt>
<dd class="calibre40">
<p id="N17704" class="calibre5">
            The standard way to use LibXML is by defining a callbacks class.  Here we define a <code class="cf">JamendoCallbacks</code> class to encapsulate our SAX handlers for various events.
          </p>
</dd>
<dt class="calibre2">③</dt>
<dd class="calibre40">
<p id="N17710" class="calibre5">
            The first thing our class does during initialization is connect to our local CouchDB server using the CouchRest API and then create the <code class="cf">music</code> database (if it doesn’t exist already).  After that, it sets up some instance variables for storing state information during the parse.  Note that if you set the <code class="cf">@max</code> parameter to <code class="cf">nil</code>, all documents will be imported, not just the first 100.
          </p>
</dd>
<dt class="calibre2">④</dt>
<dd class="calibre40">
<p id="N17722" class="calibre5">
            Once parsing has started, the <code class="cf">on_start_element</code> method will handle any opening tags.  Here we watch for certain especially interesting tags like <code class="cf">&lt;artist&gt;</code>, <code class="cf">&lt;album&gt;</code>, <code class="cf">&lt;track&gt;</code>, and <code class="cf">&lt;tag&gt;</code>.  We specifically ignore certain container elements—<code class="cf">&lt;Artists&gt;</code>, <code class="cf">&lt;Albums&gt;</code>, <code class="cf">&lt;Tracks&gt;</code>, and <code class="cf">&lt;Tags&gt;</code>—and treat all others as properties to be set on the nearest container items.
          </p>
</dd>
<dt class="calibre2">⑤</dt>
<dd class="calibre40">
<p id="N17746" class="calibre5">
            Whenever the parser encounters character data, we buffer it to be added as a property to the current container element (the end of <code class="cf">@stack</code>).
          </p>
</dd>
<dt class="calibre2">⑥</dt>
<dd class="calibre40">
<p id="N17752" class="calibre5">
            Much of the interesting stuff happens in the <code class="cf">on_end_element</code> method.  Here, we close out the current container element by popping it off the stack.  If the tag closes an <code class="cf">&lt;artist&gt;</code> element, we take the opportunity to save off the document in CouchDB with the <code class="cf">@db.save_doc</code> method.  For any container element, we also add a <code class="cf">random</code> property containing a freshly generated random number.  We’ll use this later when selecting a random track, album, or artist.
          </p>
</dd>
<dt class="calibre2">⑦</dt>
<dd class="calibre40">
<p id="N17767" class="calibre5">
            Ruby’s <code class="cf">ARGF</code> stream combines standard input and any files specified on the command line. We feed this into LibXML and specify an instance of our <code class="cf">JamendoCallbacks</code> class to handle the tokens—start tags, end tags, and character data—as they’re encountered. 
          </p>
</dd>
</dl>
<p id="N17770" class="calibre5">
        To run the script, pipe the unzipped XML content into the import script:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">zcat dbdump_artistalbumtrack.xml.gz | ruby import_from_jamendo.rb</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​TOTAL: 100 records inserted​</code>​</div>
</td>
</tr>
</table>
<p id="N17785" class="calibre5">
        When the import has finished, drop back down to the command line, and we’ll see how our views look.  First let’s pull up a few artists.  The <code class="cf">limit</code> URL parameter specifies that we want only that number of documents in the response (or less).
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:5984/music/_design/artists/_view/by_name?limit=5</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"total_rows":100,"offset":0,"rows":[​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"370255","key":"\"\"ATTIC\"\"","value":"370255"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"353262","key":"10centSunday","value":"353262"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"367150","key":"abdielyromero","value":"367150"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"276","key":"AdHoc","value":"276"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"364713","key":"Adversus","value":"364713"}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​]}​</code>​</div>
</td>
</tr>
</table>
<p id="N177AF" class="calibre5">
        The previous request  started at the very beginning of the list of artists.  To jump to the middle, we can use the <code class="cf">startkey</code> parameter:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:5984/music/_design/artists/_view/by_name?\</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">limit=5\&amp;startkey=%22C%22</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"total_rows":100,"offset":16,"rows":[​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"340296","key":"CalexB","value":"340296"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"353888","key":"carsten may","value":"353888"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"272","key":"Chroma","value":"272"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"351138","key":"Compartir D\u00f3na Gustet","value":"351138"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"364714","key":"Daringer","value":"364714"}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​]}​</code>​</div>
</td>
</tr>
</table>
<p id="N177DD" class="calibre5">
        Previously, we started with artists whose names began with <span class="calibre6">C</span>.  Specifying an <code class="cf">endkey</code> provides another way to limit the returned content.  Here we specify that we want artists only between <span class="calibre6">C</span> and <span class="calibre6">D</span>:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:5984/music/_design/artists/_view/by_name?\</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">startkey=%22C%22\&amp;endkey=%22D%22</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"total_rows":100,"offset":16,"rows":[​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"340296","key":"CalexB","value":"340296"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"353888","key":"carsten may","value":"353888"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"272","key":"Chroma","value":"272"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"351138","key":"Compartir D\u00f3na Gustet","value":"351138"}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​]}​</code>​</div>
</td>
</tr>
</table>
<p id="N17811" class="calibre5">
        To get the rows in reverse order, use the <code class="cf">descending</code> URL parameter.  Be sure to reverse your <code class="cf">startkey</code> and <code class="cf">endkey</code> as well.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:5984/music/_design/artists/_view/by_name?\</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">startkey=%22D%22\&amp;endkey=%22C%22\&amp;descending=true</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"total_rows":100,"offset":16,"rows":[​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"351138","key":"Compartir D\u00f3na Gustet","value":"351138"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"272","key":"Chroma","value":"272"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"353888","key":"carsten may","value":"353888"},​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"id":"340296","key":"CalexB","value":"340296"}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​]}​</code>​</div>
</td>
</tr>
</table>
<p id="N17842" class="calibre5">
       A number of other URL parameters are available for modifying view requests, but these are the most common and are  the ones you’ll reach for most often.  Some of the URL parameters have to do with grouping, which comes from the reducer part of CouchDB mapreduce views.  We’ll explore these tomorrow.
        </p>
<h3 class="calibre20">Day 2 Wrap-Up</h3>
<p id="N1784F" class="calibre5">
        Today we covered some good ground.  We learned how to create basic views in CouchDB and save them into design documents.  We explored different ways of querying views to get subsets of the indexed content.  Using Ruby and a popular gem called <code class="cf">couchrest</code>, we imported structured data and used it to support our views.  Leading into tomorrow, we’ll expand on these ideas by creating more advanced views by adding reducers and then move on to other APIs that CouchDB supports.
      </p>
<h4 class="calibre21">Day 2 Homework</h4>
<p class="calibre5">
<strong class="calibre32">Find</strong>
</p>
<ol class="calibre33">
<li class="calibre23">
<p id="N17860" class="calibre5">We’ve seen that the <code class="cf">emit</code> method can output keys that are strings.  What other types of values does it support?  What happens when you emit an array of values as a key?</p>
</li>
<li class="calibre23">
<p id="N17867" class="calibre5">Find a list of available URL parameters (like <code class="cf">limit</code> and <code class="cf">startkey</code>) that can be appended to view requests and what they do.</p>
</li>
</ol>
<p class="calibre5">
<strong class="calibre32">Do</strong>
</p>
<ol class="calibre33">
<li class="calibre23">
<p id="N17877" class="calibre5">The import script <code class="cf">import_from_jamendo.rb</code> assigned a random number to each artist by adding a property called <code class="cf">random</code>.  Create a mapper function that will emit key-value pairs where the key is the random number and the value is the band’s name.  Save this in a new design document named <code class="cf">_design/random</code> with the view name <code class="cf">artist</code>.</p>
</li>
<li class="calibre23">
<p id="N17887" class="calibre5">Craft a cURL request that will retrieve a random artist.</p>
<p id="N1788A" class="calibre5">
<span class="calibre6">Hint: You’ll need to use the <code class="cf">startkey</code> parameter, and you can produce a random number on the command line via <code class="cf">‘ruby -e ’puts rand’‘</code>.</span>
</p>
</li>
<li class="calibre23">
<p id="N17895" class="calibre5">The import script also added a <code class="cf">random</code> property for each album, track, and tag.  Create three additional views in the <code class="cf">_design/random</code> design document with the view names <code class="cf">album</code>, <code class="cf">track</code>, and <code class="cf">tag</code> to match the earlier <code class="cf">artist</code> view.</p>
</li>
</ol>
<script src="scripts/book_local.js" type="text/javascript" class="calibre3"/>
</div>

{% endraw %}

