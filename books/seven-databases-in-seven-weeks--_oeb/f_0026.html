---
layout: page
title: "Seven Databases in Seven Weeks (for Greg Kennedy)"
prev: f_0025.html
next: f_0027.html
book_path: books/seven-databases-in-seven-weeks--_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

<h2 id="sec.day3" class="calibre18">3.4 Day 3: Resolving Conflicts and Extending Riak</h2>
<p id="N134F3" class="calibre5">
    Today we delve into some of the edges of Riak. We’ve seen how Riak is a simple key-value database across a cluster of servers. When dealing with multiple nodes, data conflicts can occur, and sometimes we have to resolve them. Riak provides a mechanism to sort out which writes happened most recently by way of vector clocks and sibling resolution.
  </p>
<p id="N134F6" class="calibre5">
     We’ll also see how we can validate incoming data by way of pre- and post-commit hooks. We’ll extend Riak into our own personal search engine with Riak search (with the SOLR interface) and faster queries with secondary indexing.
  </p>
<h3 id="sec.resolvingConflicts" class="calibre20">Resolving Conflicts with Vector Clocks</h3>
<p id="N134FE" class="calibre5">
      A <span class="calibre6">vector clock</span>
<a id="FNPTR-19" href="f_0027.html#FOOTNOTE-19">[19]</a> is a token that distributed systems like Riak use to keep the order of conflicting key-value updates intact. It’s important to keep track of which updates happen in what order, since several clients may connect to different servers, and while one client updates one server, another client updates another server (you can’t control which server you write to).
    </p>
<p id="N1351F" class="calibre5">
      You may think “just timestamp the values and let the last value win,” but in a server cluster this  works only if all server clocks are perfectly synchronous. Riak makes no such requirement, since keeping clocks synchronized is at best difficult and in many cases an impossible requirement. Using a centralized clock system would be anathema to the Riak philosophy, since it presents a single point of failure.
    </p>
<p id="N1352C" class="calibre5">
      Vector clocks help by tagging each key-value event (create, update, or delete) with which client made the change, in which order. This way, the clients, or application developer, can decide who wins in the case of conflict. If you are familiar with version control systems like Git  or Subversion, this is not dissimilar to resolving version conflicts when two people change the same file.
    </p>
<h4 id="sec.vectorClocksinTheory" class="calibre21">Vector Clocks in Theory</h4>
<p id="N13537" class="calibre5">
        Let’s say that your dog hotel is doing well so you must start being more selective of the clientele. To help make the best decision, you’ve gathered a panel of three animal experts to help decide which new dogs are a good fit. They give each dog a score from 1 (not a good fit) to 4 (a perfect candidate). All of these panelists—named Bob, Jane, and Rakshith—must reach a unanimous decision. 
      </p>
<p id="N13545" class="calibre5">
        Each panelist has their own client connecting to a database server, and each client stamps a unique client ID onto each request. This client ID is used to build the vector clock, as well as keep track of the last updating client in the object header. Let’s look at a simple pseudocode example and later try the example in Riak.
      </p>
<p id="N13548" class="calibre5">
        Bob creates the object first, with a respectable score of 3 for a new puppy named Bruiser. The vector clock encodes his name and the version 1.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​vclock: bob[1]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​value:  {score : 3}​</code>​</div>
</td>
</tr>
</table>
<p id="N13559" class="calibre5">
        Jane pulls this record and gives Bruiser a score of 2. The vclock created for her update succeeded Bob’s, so her version 1 is added to the end of the vector.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​vclock: bob[1], jane[1]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​value:  {score : 2}​</code>​</div>
</td>
</tr>
</table>
<p id="N1356A" class="calibre5">
        Simultaneously, Rakshith pulled the version that Bob created but not Jane’s. He loved Bruiser and set a score of 4. Just like Jane’s, his client name is appended to the end of the vector clock as version 1.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​vclock: bob[1], rakshith[1]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​value:  {score : 4}​</code>​</div>
</td>
</tr>
</table>
<p id="N1357B" class="calibre5">
        Later that day, Jane (as the panel chair) rechecks the scores. Since Rakshith’s update vector did not occur after Jane’s but rather alongside hers, the updates are in conflict and need to be resolved. She receives both values, and it’s up to her to resolve them.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​vclock: bob[1], jane[1]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​value:  {score : 2}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​---​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​vclock: bob[1], rakshith[1]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​value:  {score : 4}​</code>​</div>
</td>
</tr>
</table>
<p id="N13595" class="calibre5">
        She chooses a middle value so updates the score to 3.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​vclock: bob[1], rakshith[1], jane[2]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​value:  {score : 3}​</code>​</div>
</td>
</tr>
</table>
<p id="N135A6" class="calibre5">
        Having been resolved, anyone who pulls a request after this point will get this most recent value.
        </p>
<h4 id="sec.vectorClocksinPractice" class="calibre21">Vector Clocks in Practice</h4>
<p id="N135B1" class="calibre5">
        Let’s run through the previous example scenario using Riak.
      </p>
<p id="N135B4" class="calibre5">
        For this example we want to see all conflicting versions so we can resolve them manually. Let’s keep multiple versions by setting the <code class="cf">allow_mult</code> property on the <code class="cf">animals</code> bucket. Any key with multiple values are called <span class="calibre6">sibling</span> values.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -X PUT http://localhost:8091/riak/animals \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -H "Content-Type: application/json" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -d '{"props":{"allow_mult":true}}'​</code>​</div>
</td>
</tr>
</table>
<p id="N135D7" class="calibre5">
        Here, Bob puts Bruiser in the system with his chosen score of 3 and a client ID of <code class="cf1">bob</code>.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -i -X PUT http://localhost:8091/riak/animals/bruiser \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -H "X-Riak-ClientId: bob" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -H "Content-Type: application/json" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -d '{"score" : 3}'​</code>​</div>
</td>
</tr>
</table>
<p id="N135F1" class="calibre5">
        Jane and Rakshith both pull Bruiser’s data that Bob created (you’ll have much more header information; we’re just showing the vector clock here). 
      </p>
<p id="N135F4" class="calibre5">
        Note that Riak encoded Bob’s vclock, but under the covers it’s a client and a version (and timestamp, so yours will be different from the one shown).
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -i http://localhost:8091/riak/animals/bruiser?return_body=true​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​X-Riak-Vclock: a85hYGBgzGDKBVIs7NtEXmUwJTLmsTI8FMs5zpcFAA==​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"score" : 3}​</code>​</div>
</td>
</tr>
</table>
<p id="N1360A" class="calibre5">
        Jane makes her update to score 2 and includes the most recent vector clock she received from Bob’s version. This is a signal to Riak that her value is an update of Bob’s version.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -i -X PUT http://localhost:8091/riak/animals/bruiser \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -H "X-Riak-ClientId: jane" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -H "X-Riak-Vclock: a85hYGBgzGDKBVIs7NtEXmUwJTLmsTI8FMs5zpcFAA==" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -H "Content-Type: application/json" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -d '{"score" : 2}'​</code>​</div>
</td>
</tr>
</table>
<p id="N13624" class="calibre5">
        Since Jane and Rakshith pulled Bob’s data at the same time, he also submits an update (of score 4) using Bob’s vector clock.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -i -X PUT http://localhost:8091/riak/animals/bruiser \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -H "X-Riak-ClientId: rakshith" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -H "X-Riak-Vclock: a85hYGBgzGDKBVIs7NtEXmUwJTLmsTI8FMs5zpcFAA==" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -H "Content-Type: application/json" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -d '{"score" : 4}'​</code>​</div>
</td>
</tr>
</table>
<p id="N13641" class="calibre5">
        When Jane rechecks the score, she sees not a value, as expected, but rather an HTTP code for multiple choices and a body containing two “sibling” values.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl http://localhost:8091/riak/animals/bruiser?return_body=true​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Siblings:​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​637aZSiky628lx1YrstzH5​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​7F85FBAIW8eiD9ubsBAeVk​</code>​</div>
</td>
</tr>
</table>
<p id="N13658" class="calibre5">
        Riak stored these versions in a multipart format, so she can retrieve the entire object by accepting that MIME type.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -i http://localhost:8091/riak/animals/bruiser?return_body=true \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  -H "Accept: multipart/mixed"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​HTTP/1.1 300 Multiple Choices​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​X-Riak-Vclock: a85hYGBgyWDKBVHs20Re...OYn9XY4sskQUA​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: multipart/mixed; boundary=1QwWn1ntX3gZmYQVBG6mAZRVXlu​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Length: 409​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--1QwWn1ntX3gZmYQVBG6mAZRVXlu​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: application/json​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Etag: 637aZSiky628lx1YrstzH5​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"score" : 4}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--1QwWn1ntX3gZmYQVBG6mAZRVXlu​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: application/json​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Etag: 7F85FBAIW8eiD9ubsBAeVk​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"score" : 2}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​--1QwWn1ntX3gZmYQVBG6mAZRVXlu--​</code>​</div>
</td>
</tr>
</table>
<p id="N13698" class="calibre5">
        Notice that the “siblings” shown earlier are HTTP etags (which Riak called vtags) to specific values.
        As a side note, you can use the vtag parameter in the URL to retrieve only that version: 
        <code class="cf">curl http://localhost:8091/riak/animals/bruiser?vtag=7F85FBAIW8eiD9ubsBAeVk</code> will return <code class="cf">{"score" : 2}</code>.
        Jane’s job now is to use this information to make a reasonable update. 
        She decides to average the two scores and update to 3, using the vector clock given to resolve the conflict.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -i -X PUT http://localhost:8091/riak/animals/bruiser?return_body=true \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-H "X-Riak-ClientId: jane" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-H "X-Riak-Vclock: a85hYGBgyWDKBVHs20Re...OYn9XY4sskQUA" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-H "Content-Type: application/json" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-d '{"score" : 3}'​</code>​</div>
</td>
</tr>
</table>
<p id="N136BE" class="calibre5">
        Now when Bob and Rakshith retrieve <code class="cf">bruiser</code>’s information, they’ll get the resolved score.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -i http://localhost:8091/riak/animals/bruiser?return_body=true​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​HTTP/1.1 200 OK​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​X-Riak-Vclock: a85hYGBgyWDKBVHs20Re...CpQmAkonCcHFM4CAA==​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"score" : 3}​</code>​</div>
</td>
</tr>
</table>
<p id="N136DA" class="calibre5">
        Any future requests will receive score 3.
        </p>
<h4 id="sec.timeKeepsonGrowing" class="calibre21">Time Keeps on Growing</h4>
<p id="N136EB" class="calibre5">
        You may have noticed that the vector clock keeps growing as more clients update values. This is a fundamental problem with vector clocks, which the Riak developers understood. They extended vector clocks to be “pruned” over time, thus keeping their size small. The rate at which Riak prunes old vector clock values are bucket properties, which can be viewed (along with all other properties) by reading the bucket.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl http://localhost:8091/riak/animals​</code>​</div>
</td>
</tr>
</table>
<p id="N13714" class="calibre5">
        You’ll see some of the following properties, which dictate how Riak will prune the clock before it gets too large.
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​"small_vclock":10,"big_vclock":50,"young_vclock":20,"old_vclock":86400​</code>​</div>
</td>
</tr>
</table>
<p id="N13722" class="calibre5">
<code class="cf1">small_vclock</code> and <code class="cf1">big_vclock</code> determine the minimum and maximum length of the vector, while <code class="cf1">young_vclock</code> and <code class="cf1">old_vclock</code> describe the minimum and maximum age of a vclock before pruning happens.
      </p>
<p id="N13730" class="calibre5">
        You can read more about vector clocks and pruning online.<a id="FNPTR-20" href="f_0027.html#FOOTNOTE-20">[20]</a>
</p>
<h4 id="sec.prePostCommitHooks" class="calibre21">Pre/Post-commit Hooks</h4>
<p id="N1373D" class="calibre5">
        Riak can transform data before or after saving an object, by way of hooks. Pre- and post-commit hooks are simply JavaScript (or Erlang) functions that get executed before or after a commit occurs. Pre-commit functions can modify the incoming object in some way (and even cause it to fail), while post-commits can respond to a successful commit (such as writing to a log or sending an email to something).
      </p>
<p id="N1374A" class="calibre5">
        Each server has an <code class="cf">app.config</code> file, which needs to reference the location of any custom JavaScript code. First open your file for server dev1, under <code class="cf">dev/dev1/etc/app.config</code>, and find the line containing <code class="cf">js_source_dir</code>. Replace it with any directory path you want (note that the line may be commented out with a % character, so uncomment it first by removing the character). Our line looks like this:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{js_source_dir, "~/riak/js_source"},​</code>​</div>
</td>
</tr>
</table>
<p id="N13761" class="calibre5">
        You’ll need to make this change in triplicate, once for each dev server.
      </p>
<p id="N13764" class="calibre5">
        Let’s create a validator that runs pre-commit to parse incoming data, ensures that a score exists, and ensures that the score is between 1 and 4. If any of those criteria fail, an error will be thrown, and our validator will return the JSON object containing only <code class="cf">{"fail" : message}</code>, where <code class="cf">message</code> is whatever we want to relay to the user. If the data is as expected, you need  return only the object, and Riak will store the value.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td colspan="2" class="calibre34">
<a href="http://media.pragprog.com/titles/rwdata/code/riak/my_validators.js">riak/my_validators.js</a>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">function</strong> good_score(object) {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">try</strong> {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="comment">/* from the Riak object, pull data and parse it as JSON */</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">var</strong> data = JSON.parse( object.values[0].data );​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="comment">/* if score is not found, fail here */</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">if</strong>( !data.score || data.score === <em class="string">''</em> ) {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <strong class="prompt">throw</strong>( <em class="string">'Score is required'</em> );​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="comment">/* if score is not within range, fail here */</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">if</strong>( data.score &lt; 1 || data.score &gt; 4 ) {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      <strong class="prompt">throw</strong>( <em class="string">'Score must be from 1 to 4'</em> );​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  } <strong class="prompt">catch</strong>( message ) {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <em class="comment">/* Riak expects the following JSON if a failure occurs */</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    <strong class="prompt">return</strong> { "fail" : message };​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="comment">/* No problems found, so continue */</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <strong class="prompt">return</strong> object;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N137E0" class="calibre5">
        Store this file in the <code class="cf">js_source_dir</code> directory you set. Since we’re making core server changes, we need to restart all of the development servers using the <code class="cf">restart</code> argument.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">dev/dev1/bin/riak restart</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">dev/dev2/bin/riak restart</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">dev/dev3/bin/riak restart</strong>​</code>​</div>
</td>
</tr>
</table>
<p id="N1380E" class="calibre5">
        Riak will scan for any files ending in <code class="cf">.js</code> and load those into memory. You can now set a bucket’s <code class="cf">precommit</code> property to use the JavaScript <span class="calibre6">function</span> name (not the filename).
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​curl -X PUT http://localhost:8091/riak/animals \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-H "content-type:application/json" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-d '{"props":{"precommit":[{"name" : "good_score"}]}}'​</code>​</div>
</td>
</tr>
</table>
<p id="N13830" class="calibre5">
        Let’s test our new hook by setting a score greater than 4. Our pre-commit hook enforces that a score must be from 1 to 4, so the following will fail:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​curl -i -X PUT http://localhost:8091/riak/animals/bruiser \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-H "Content-Type: application/json" -d '{"score" : 5}'​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​HTTP/1.1 403 Forbidden​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: text/plain​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Length: 25​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Score must be 1 to 4​</code>​</div>
</td>
</tr>
</table>
<p id="N1384F" class="calibre5">
        You’ll get a 403 Forbidden code, as well as a plain-text error message that was returned under the “fail” field. If you <code class="cf">GET</code> the <code class="cf">bruiser</code> value, its score remains 3. Try setting the score to 2, and you’ll have more success.
      </p>
<p id="N13859" class="calibre5">
        Post-commit is similar to pre-commit but happens after the commit is successful. We’re skipping it here, since you can  write postcommit hooks only in Erlang. If you’re an Erlang developer, the online docs can help guide you through installing your own modules. In fact, you can write Erlang mapreduce functions, too. But our Riak journey continues to other prebuilt modules and extensions.
        </p>
<h3 id="sec.extendingRiak" class="calibre20">Extending Riak</h3>
<p id="N13867" class="calibre5">
      Riak ships with several extensions that are turned off by default yet add new behaviors you may find useful.
    </p>
<h4 id="sec.searchingRiak" class="calibre21">Searching Riak</h4>
<p id="N1386F" class="calibre5">
      Riak search scans data inside your Riak cluster and builds an inverted index against it. You may recall the term <span class="calibre6">inverted index</span> from the PostgreSQL chapter (the GIN index stands for Generalized Inverted Index). Just like GIN, the Riak index exists to make many varieties of string searching fast and efficient but in a distributed manner.
      </p>
<p id="N13881" class="calibre5">
      Using Riak search requires enabling it in your <code class="cf">app.config</code> files and setting the Riak search config to <code class="cf">enabled, true</code>.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​%% Riak Search Config​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{riak_search, [​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  %% To enable Search functionality set this 'true'.​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  {enabled, true}​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​]},​</code>​</div>
</td>
</tr>
</table>
<p id="N138A1" class="calibre5">
       If you’re familiar with search engine solutions such as Lucene, this part should be a cakewalk. If not, it’s easy to get the hang of it.
      </p>
<p id="N138B3" class="calibre5">
        We need to let the search know when we change values in the database by way of a pre-commit hook. You can install <code class="cf">riak_search_kv_hook</code>, Erlang module’s <code class="cf">precommit</code> function, in a new <code class="cf">animals</code> bucket with the following command:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -X PUT http://localhost:8091/riak/animals \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-H "Content-Type: application/json" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-d '{"props":{"precommit":​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[{"mod": "riak_search_kv_hook","fun":"precommit"}]}}'​</code>​</div>
</td>
</tr>
</table>
<p id="N138D3" class="calibre5">
        Calling <code class="cf">curl http://localhost:8091/riak/animals</code> will show that the hook has been added to the <code class="cf">animals</code> bucket’s <code class="cf">precommit</code> property. Now, when you put data that is encoded as JSON or XML into the <code class="cf">animals</code> bucket, Riak search will index the field names and values. Let’s upload a few animals.
        </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -X PUT http://localhost:8091/riak/animals/dragon \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-H "Content-Type: application/json" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-d '{"nickname" : "Dragon", "breed" : "Briard", "score" : 1 }'​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -X PUT http://localhost:8091/riak/animals/ace \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-H "Content-Type: application/json" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-d '{"nickname" : "The Wonder Dog", "breed" : "German Shepherd", "score" : 3 }'​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -X PUT http://localhost:8091/riak/animals/rtt \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-H "Content-Type: application/json" \​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-d '{"nickname" : "Rin Tin Tin", "breed" : "German Shepherd", "score" : 4 }'​</code>​</div>
</td>
</tr>
</table>
<p id="N1390B" class="calibre5">
      There are several options for querying this data, but let’s use Riak’s HTTP Solr interface (which implements the Apache Solr<a id="FNPTR-21" href="f_0027.html#FOOTNOTE-21">[21]</a> search interface). To search <code class="cf">/animals</code>, we access <code class="cf">/solr</code>, followed by the bucket name <code class="cf">/animals</code> and the <code class="cf">/select</code> command. The parameters specify the search terms.

      Here we select any <code class="cf1">breed</code> that contains the word <code class="cf1">Shepherd</code>.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl http://localhost:8091/solr/animals/select?q=breed:Shepherd​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​&lt;?xml version="1.0" encoding="UTF-8"?&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​&lt;response&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  &lt;lst name="responseHeader"&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    &lt;int name="status"&gt;0&lt;/int&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    &lt;int name="QTime"&gt;1&lt;/int&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    &lt;lst name="params"&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="indent"&gt;on&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="start"&gt;0&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="q"&gt;breed:Shepherd&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="q.op"&gt;or&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="df"&gt;value&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="wt"&gt;standard&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="version"&gt;1.1&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="rows"&gt;2&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    &lt;/lst&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  &lt;/lst&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  &lt;result name="response" numFound="2" start="0" maxScore="0.500000"&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    &lt;doc&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="id"&gt;ace&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="breed"&gt;German Shepherd&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="nickname"&gt;The Wonder Dog&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="score"&gt;3&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    &lt;/doc&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    &lt;doc&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="id"&gt;rtt&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="breed"&gt;German Shepherd&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="nickname"&gt;Rin Tin Tin&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      &lt;str name="score"&gt;4&lt;/str&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    &lt;/doc&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  &lt;/result&gt;​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​&lt;/response&gt;​</code>​</div>
</td>
</tr>
</table>
<p id="N13997" class="calibre5">
      If you prefer that the query returns JSON, add the parameter <code class="cf">wt=json</code>. You can combine multiple parameters in the query by separating them with a space (or %20 in URL-encoded form) and setting the <code class="cf">q.op</code> parameter with the value <code class="cf">and</code>. To find a breed with a nickname containing the word <span class="calibre6">rin</span> and a breed of shepherd, perform the following:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl http://localhost:8091/solr/animals/select\​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​?wt=json&amp;q=nickname:rin%20breed:shepherd&amp;q.op=and​</code>​</div>
</td>
</tr>
</table>
<p id="N139BF" class="calibre5">
      Riak search allows for more colorful query syntaxes, such as wildcards (using * to match multiple characters and using ? to match one character), though only at the end of the term. The query <code class="cf">nickname:Drag*</code> would match Dragon, but <code class="cf">nickname:*ragon</code> would not match.

      Range searches are also nice options:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​nickname:[dog TO drag]​</code>​</div>
</td>
</tr>
</table>
<p id="N139F1" class="calibre5">
      More-complex queries based on boolean operators, grouping, and proximity searches are available. Beyond that, you can specify custom data encodings, create custom indexes, and even choose between them when you search. You can find other URL parameters in the following table:
      </p>
<table class="simpletable1">
<thead class="calibre29">
<tr class="calibre8">
<th class="hlines">
<p class="last-para-in-cell">Param</p>
</th>
<th class="hlines">
<p class="last-para-in-cell">Description</p>
</th>
<th class="hlines">
<p class="last-para-in-cell">Default</p>
</th>
</tr>
</thead>
<tbody class="calibre7">
<tr class="calibre8">
<td class="calibre30">
<p class="last-para-in-cell">q</p>
</td>
<td class="calibre30">
<p class="last-para-in-cell">The given query string</p>
</td>
<td class="calibre30">
<p class="last-para-in-cell"></p>
</td>
</tr>
<tr class="calibre8">
<td class="calibre31">
<p class="last-para-in-cell">q.op</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">Query terms are either <code class="cf">and</code> or <code class="cf">or</code>
</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">
<code class="cf">or</code>
</p>
</td>
</tr>
<tr class="calibre8">
<td class="calibre31">
<p class="last-para-in-cell">sort</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">Field name to sort by</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">none</p>
</td>
</tr>
<tr class="calibre8">
<td class="calibre31">
<p class="last-para-in-cell">start</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">The first object in the matching list to return</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">0</p>
</td>
</tr>
<tr class="calibre8">
<td class="calibre31">
<p class="last-para-in-cell">rows</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">The max number of results to return</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">20</p>
</td>
</tr>
<tr class="calibre8">
<td class="calibre31">
<p class="last-para-in-cell">wt</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">Output either <code class="cf">xml</code> or <code class="cf">json</code>
</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">
<code class="cf">xml</code>
</p>
</td>
</tr>
<tr class="calibre8">
<td class="calibre31">
<p class="last-para-in-cell">index</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell">Specifies the index to use</p>
</td>
<td class="calibre31">
<p class="last-para-in-cell"></p>
</td>
</tr>
</tbody>
</table>
<p id="N13A89" class="calibre5">
        There is plenty more to learn about the Riak search extension, far more than we can reasonably cover here. Ideally you’ve gotten a feel for its power. It’s a clear choice if you plan to provide search functionality for a large web application, but it also deserves a second look if you need a lot of simple ad hoc querying.
      </p>
<h4 id="sec.indexingRiak" class="calibre21">Indexing Riak</h4>
<p id="N13A91" class="calibre5">
      As of version 1.0, Riak supports secondary indexes. These are similar to the indexes we saw in PostgreSQL but with a slight twist. Rather than indexing on a specific column or columns of data, Riak allows you to index on metadata attached to the header of the object.
      </p>
<p id="N13AA6" class="calibre5">
      Once again, we must make a change to the <code class="cf">app.config</code> file. Switch the storage back end from bitcask to eLevelDB, as shown here, and then restart the servers:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{riak_kv, [​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  %% Storage_backend specifies the Erlang module defining the​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  %% storage mechanism that will be used on this node.​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  {storage_backend, riak_kv_eleveldb_backend},​</code>​</div>
</td>
</tr>
</table>
<p id="N13AC0" class="calibre5">
      eLevelDB is an Erlang implementation of the Google key-value store called LevelDB.<a id="FNPTR-22" href="f_0027.html#FOOTNOTE-22">[22]</a> This new back-end implementation allowed for secondary indexing in Riak to take place. 
      </p>
<p id="N13AC9" class="calibre5">
      With our system ready to go, we can index any object with any number of header tags known as an <span class="calibre6">index entries</span> that define how an object is indexed. The field names begin with <code class="cf">x-riak-index-</code> and end with either <code class="cf">_int</code> or <code class="cf">_bin</code> for integer or binary (anything not an integer) values, respectively.
      </p>
<p id="N13AD8" class="calibre5">
      To add Blue II, the Butler Bulldogs mascot, we’d like to index by the university name that this dog is a mascot for (<code class="cf">butler</code>), as well as the version number (Blue 2 is the second bulldog mascot).
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl -X PUT http://localhost:8098/riak/animals/blue​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-H "x-riak-index-mascot_bin: butler"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-H "x-riak-index-version_int: 2"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​-d '{"nickname" : "Blue II", "breed" : "English Bulldog"}'​</code>​</div>
</td>
</tr>
</table>
<p id="N13AF2" class="calibre5">
      You may have noticed that the indexes have nothing to do with the value stored in the key. This is actually a powerful feature, since it allows us to index data orthogonal to any data we may store. If you want to store a video as a value, you may still index it.
      </p>
<p id="N13AF5" class="calibre5">
      Getting the value by the index is fairly straightforward.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ curl http://localhost:8098/riak/animals/index/mascot_bin/butler​</code>​</div>
</td>
</tr>
</table>
<p id="N13B03" class="calibre5">
      Though secondary indexing in Riak is a big step in the right direction, it still has a way to go. If you want to index dates, for example, you must store a string that can be sorted in order—such as <code class="cf">"YYYYMMDD"</code>. Storing any floating digits requires to you first multiply the float by some significant precision multiple of 10 and then store it as an integer—such as 1.45 * 100 == 145. Your client is responsible for doing this conversion. But between mapreduce, Riak search, and now secondary indexing, Riak is providing many tools to loosen up the classic constraints of the key-value store design by other means of value access beyond simple keys.
      </p>
<h3 id="sec.day3Recap" class="calibre20">Day 3 Wrap-Up</h3>
<p id="N13B17" class="calibre5">
      We finished Riak with some of its more advanced concepts: how to deal with version conflicts by using vector clocks and how to ensure or modify incoming data with commit hooks. We also dug into using a couple Riak extensions: activating Riak search and indexing data to allow for a little more query flexibility. 
    </p>
<p id="N13B1A" class="calibre5">
      Using these concepts along with mapreduce from Day 2 and <code class="cf">Link</code>s from Day 1, you can  create a flexible combination of tools far beyond your standard key-value store.
    </p>
<h4 class="calibre21">Day 3 Homework</h4>
<p class="calibre5">
<strong class="calibre32">Find</strong>
</p>
<ol class="calibre33">
<li class="calibre23">
<p id="N13B2B" class="calibre5">Find the Riak function contrib list repository (hint: it’s in GitHub).</p>
</li>
<li class="calibre23">
<p id="N13B2F" class="calibre5">Read more about vector clocks.</p>
</li>
<li class="calibre23">
<p id="N13B33" class="calibre5">Learn to create your own index configuration.</p>
</li>
</ol>
<p class="calibre5">
<strong class="calibre32">Do</strong>
</p>
<ol class="calibre33">
<li class="calibre23">
<p id="N13B3D" class="calibre5">Create your own index that defines the <code class="cf">animals</code> schema. Specifically, set the <code class="cf">score</code> field to integer type, and query it as a range.</p>
</li>
<li class="calibre23">
<p id="N13B47" class="calibre5">
            Start up a small cluster of three servers (such as three laptops or EC2<a id="FNPTR-23" href="f_0027.html#FOOTNOTE-23">[23]</a> instances), and install Riak on each. Set up the servers as a cluster. Install the Google stock dataset, located on the Basho website.<a id="FNPTR-24" href="f_0027.html#FOOTNOTE-24">[24]</a>
</p>
</li>
</ol>
<script src="scripts/book_local.js" type="text/javascript" class="calibre3"/>
</div>

{% endraw %}

