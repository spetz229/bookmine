---
layout: page
title: "Seven Databases in Seven Weeks (for Greg Kennedy)"
prev: f_0041.html
next: f_0043.html
book_path: books/seven-databases-in-seven-weeks--_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

<h2 id="N16BF4" class="calibre18">6.2 Day 1: CRUD, Futon, and cURL Redux</h2>
<p id="N16BF8" class="calibre5">
      Today we’re going to kick-start our CouchDB exploration by using CouchDB’s friendly Futon web interface to perform basic CRUD operations.  After that, we’ll revisit cURL—which we used to communicate with Riak in Chapter 3, <a href="f_0022.html#chp.riak">​<em class="calibre6">Riak</em>​</a>—to make REST calls.  All libraries and drivers for CouchDB end up sending REST requests under the hood, so it makes sense to start by understanding how they work.
    </p>
<h3 class="calibre20">Getting Comfortable with Futon</h3>
<div class="figure" id="fig.couchdb.futon.overview">
<div class="calibre2">
<img xmlns:str="http://exslt.org/strings" src="images/couchdb-futon-overview.png" alt="images/couchdb-futon-overview.png" class="calibre27"/>
</div>
<div class="figurecaption">
<hr class="calibre28"/>Figure 24. CouchDB Futon: Overview page</div>
</div>
<p id="N16C19" class="calibre5">
        CouchDB comes with a useful web interface called Futon.  Once you have CouchDB installed and running, open a web browser to <code class="cf">http://localhost:5984/_utils/</code>.  This will open the Overview page pictured in Figure 24, <a href="#fig.couchdb.futon.overview">​<em class="calibre6">CouchDB Futon: Overview page</em>​</a>.
      </p>
<div class="figure" id="fig.couchdb.futon.create.document">
<div class="calibre2">
<img xmlns:str="http://exslt.org/strings" src="images/couchdb-futon-create-document.png" alt="images/couchdb-futon-create-document.png" class="calibre27"/>
</div>
<div class="figurecaption">
<hr class="calibre28"/>Figure 25. CouchDB Futon: creating a document</div>
</div>
<p id="N16C2D" class="calibre5">
        Before we can start working with documents, we need to create a database to house them.  We’re going to create a database to store musicians along with their album and track data.  Click the  Create Database...  button.  In the pop-up, enter <code class="cf1">music</code> and click Create.  This will redirect you automatically to the database’s page.  From here, we can create new documents or open existing ones.
      </p>
<p id="N16C33" class="calibre5">
        On the music database’s page, click the New Document  button. This will take you to a new page that looks like Figure 25, <a href="#fig.couchdb.futon.create.document">​<em class="calibre6">CouchDB Futon: creating a document</em>​</a>.
      </p>
<div class="sidebar">
<div class="sidebar-title">Welcome to Admin Party!</div>
<div class="calibre2">
<p id="N16C3C" class="calibre5">
          In Futon, you may notice the warning at the bottom of the right column explaining that everyone is an admin.  Were this destined to become a production server, your next step would be to click the “Fix this” link and create an admin user to restrict who can do what.  In our case, leaving it open is fine for now and will make our other tasks easier.
        </p>
</div>
</div>
<p id="N16C3F" class="calibre5">
        Just as in MongoDB, a document consists of a JSON object containing key-value pairs called <span class="calibre6">fields</span>.  All documents in CouchDB have an <code class="cf">_id</code> field, which must be unique and can never be changed.  You can specify an <code class="cf">_id</code> explicitly, but if you don’t, CouchDB will generate one for you.  In our case, the default is fine, so click Save Document to finish.
      </p>
<p id="N16C4B" class="calibre5">
        Immediately after saving the document, CouchDB will assign it an additional field called <code class="cf">_rev</code>.  The <code class="cf">_rev</code> field will get a new value every time the document changes.  The format for the revision string consists of an integer followed by a dash and then a pseudorandom unique string.  The integer at the beginning denotes the numerical revision—in this case <code class="cf">1</code>.
      </p>
<p id="N16C5C" class="calibre5">
        Field names that begin with an underscore have special meaning to CouchDB, and <code class="cf">_id</code> and <code class="cf">_rev</code> are particularly important.  To update or delete an existing document, you must provide <span class="calibre6">both</span> an <code class="cf">_id</code> and the matching <code class="cf">_rev</code>.  If either of these do not match, CouchDB will reject the operation.  This is how it prevents conflicts—by ensuring only the most recent document revisions are modified.
      </p>
<p id="N16C78" class="calibre5">
        There are no transactions or locking in CouchDB.  To modify an existing record, you first read it out, taking note of the <code class="cf">_id</code> and <code class="cf">_rev</code>.  Then, you request an update by providing the full document, including the <code class="cf">_id</code> and <code class="cf">_rev</code>.  All operations are first come, first served.  By requiring a matching <code class="cf">_rev</code>, CouchDB ensures that the document you think you’re modifying hasn’t been altered behind your back while you weren’t looking.
      </p>
<p id="N16C99" class="calibre5">
        With the document page still open, click the Add Field button.  In the Field column, enter <code class="cf1">name</code>, and in the Value column, enter <code class="cf1">The Beatles</code>.  Click the green check mark next to the value to ensure it sticks, and then click the Save Document button.  Notice how the <code class="cf">_rev</code> field now begins with <code class="cf">2</code>.
      </p>
<p id="N16CA8" class="calibre5">
        CouchDB is not limited to storing string values.  It can handle any JSON structure nested to any depth.  Click the Add Field button again.  This time, set Field to <code class="cf1">albums</code>, and for Value enter the following (this is not an exhaustive list):
      </p>
<div class="figure" id="fig.couchdb.futon.array.value">
<div class="calibre2">
<img xmlns:str="http://exslt.org/strings" src="images/couchdb-futon-array-value.png" alt="images/couchdb-futon-array-value.png" class="calibre27"/>
</div>
<div class="figurecaption">
<hr class="calibre28"/>Figure 26. CouchDB Futon: document with an array value</div>
</div>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="string">"Help!"</em>,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="string">"Sgt. Pepper's Lonely Hearts Club Band"</em>,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  <em class="string">"Abbey Road"</em>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​]​</code>​</div>
</td>
</tr>
</table>
<p id="N16D05" class="calibre5">
        After you click Save Document, it should look like Figure 26, <a href="#fig.couchdb.futon.array.value">​<em class="calibre6">CouchDB Futon: document with an array value</em>​</a>.
      </p>
<div class="figure" id="fig.couchdb.futon.deep.values">
<div class="calibre2">
<img xmlns:str="http://exslt.org/strings" src="images/couchdb-futon-deep-values.png" alt="images/couchdb-futon-deep-values.png" class="calibre27"/>
</div>
<div class="figurecaption">
<hr class="calibre28"/>Figure 27. CouchDB Futon: document with deep nested values</div>
</div>
<p id="N16D20" class="calibre5">
        There’s more relevant information about an album than just its name, so let’s add some.  Modify the <code class="cf">albums</code> field and replace the value you just set with this:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​[{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "title": <em class="string">"Help!"</em>,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "year": 1965​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​},{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "title": <em class="string">"Sgt. Pepper's Lonely Hearts Club Band"</em>,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "year": 1967​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​},{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "title": <em class="string">"Abbey Road"</em>,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "year": 1969​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}]​</code>​</div>
</td>
</tr>
</table>
<p id="N16D56" class="calibre5">
        After you save the document, this time you should be able to expand the <code class="cf">albums</code> value to expose the nested documents underneath.  It should resemble Figure 27, <a href="#fig.couchdb.futon.deep.values">​<em class="calibre6">CouchDB Futon: document with deep nested values</em>​</a>.
      </p>
<p id="N16D6A" class="calibre5">
        Clicking the Delete Document button would do what you might expect; it would remove the document from the <code class="cf">music</code> database.  But don’t do it just yet.  Instead, let’s drop down to the command line and take a look at how to communicate with CouchDB over REST.
      </p>
<h3 class="calibre20">Performing RESTful CRUD Operations with cURL</h3>
<p id="N16D74" class="calibre5">
        All communication with CouchDB is REST-based, and this means issuing commands over HTTP.  CouchDB isn’t the first database we’ve talked about with this quality.  Riak—covered in Chapter 3, <a href="f_0022.html#chp.riak">​<em class="calibre6">Riak</em>​</a>—also relies on REST for all client communication.  And like we did with Riak, we can communicate with CouchDB using the command-line tool cURL.
      </p>
<p id="N16D84" class="calibre5">
        Here we’ll perform some basic CRUD operations before moving on to the topic of views.  To start, open a command prompt and run the following:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:5984/</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"couchdb":"Welcome","version":"1.1.1"}​</code>​</div>
</td>
</tr>
</table>
<p id="N16D99" class="calibre5">
        Issuing <code class="cf">GET</code> requests (cURL’s default) retrieves information about the thing indicated in the URL.  Accessing the root as you just did merely informs you that CouchDB is up and running and what version is installed.  Next let’s get some information about the <code class="cf">music</code> database we created earlier (output formatted here for readability):
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:5984/music/</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "db_name":"music",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "doc_count":1,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "doc_del_count":0,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "update_seq":4,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "purge_seq":0,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "compact_running":false,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "disk_size":16473,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "instance_start_time":"1326845777510067",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "disk_format_version":5,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "committed_update_seq":4​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N16DE1" class="calibre5">
        This returns some information about how many documents are in the database, how long the server has been up, and how many operations have been performed.
      </p>
<h3 class="calibre20">Reading a Document with GET</h3>
<p id="N16DEB" class="calibre5">
        To retrieve a specific document, append its <code class="cf">_id</code> to the database URL like so:
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl http://localhost:5984/music/74c7a8d2a8548c8b97da748f43000ac4</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "_id":"74c7a8d2a8548c8b97da748f43000ac4",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "_rev":"4-93a101178ba65f61ed39e60d70c9fd97",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "name":"The Beatles",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "albums": [​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    {​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "title":"Help!",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "year":1965​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    },{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "title":"Sgt. Pepper's Lonely Hearts Club Band",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "year":1967​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    },{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "title":"Abbey Road",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​      "year":1969​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    }​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  ]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N16E38" class="calibre5">
        In CouchDB, issuing <code class="cf">GET</code> requests is always safe.  CouchDB won’t make any changes to documents as the result of a <code class="cf">GET</code>.  To make changes, you have to use other HTTP commands like <code class="cf">PUT</code>, <code class="cf">POST</code>, and <code class="cf">DELETE</code>.
      </p>
<h3 class="calibre20">Creating a Document with POST</h3>
<p id="N16E53" class="calibre5">
        To create a new document, use <code class="cf">POST</code>.  Make sure to specify a Content-Type header with the value <code class="cf1">application/json</code>; otherwise, CouchDB will refuse the request.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -i -X POST "http://localhost:5984/music/" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt"> -H "Content-Type: application/json" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt"> -d '{ "name": "Wings" }'</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​HTTP/1.1 201 Created​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Server: CouchDB/1.1.1 (Erlang OTP/R14B03)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Location: http://localhost:5984/music/74c7a8d2a8548c8b97da748f43000f1b​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Date: Wed, 18 Jan 2012 00:37:51 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: text/plain;charset=utf-8​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Length: 95​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Cache-Control: must-revalidate​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "ok":true,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "id":"74c7a8d2a8548c8b97da748f43000f1b",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "rev":"1-2fe1dd1911153eb9df8460747dfe75a0"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N16EAB" class="calibre5">
        The HTTP response code <code class="cf">201 Created</code> tells us that our creation request was successful.  The body of the response contains a JSON object with useful information such as the <code class="cf">_id</code> and <code class="cf">_rev</code> values.
      </p>
<h3 class="calibre20">Updating a Document with PUT</h3>
<p id="N16EC4" class="calibre5">
        The <code class="cf">PUT</code> command is used to update an existing document or create a new one with a specific <code class="cf">_id</code>.  Just like <code class="cf">GET</code>, the URL for a <code class="cf">PUT</code> URL consists of the database URL followed by the document’s <code class="cf">_id</code>.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -i -X PUT \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  "http://localhost:5984/music/74c7a8d2a8548c8b97da748f43000f1b" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "Content-Type: application/json" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -d '{</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "_id": "74c7a8d2a8548c8b97da748f43000f1b",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "_rev": "1-2fe1dd1911153eb9df8460747dfe75a0",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "name": "Wings",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​    "albums": ["Wild Life", "Band on the Run", "London Town"]​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  }'​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​HTTP/1.1 201 Created​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Server: CouchDB/1.1.1 (Erlang OTP/R14B03)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Location: http://localhost:5984/music/74c7a8d2a8548c8b97da748f43000f1b​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Etag: "2-17e4ce41cd33d6a38f04a8452d5a860b"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Date: Wed, 18 Jan 2012 00:43:39 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: text/plain;charset=utf-8​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Length: 95​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Cache-Control: must-revalidate​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "ok":true,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "id":"74c7a8d2a8548c8b97da748f43000f1b",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "rev":"2-17e4ce41cd33d6a38f04a8452d5a860b"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N16F2F" class="calibre5">
        Unlike MongoDB, in which you modify documents <span class="calibre6">in place</span>, with CouchDB you always overwrite the entire document to make any change.  The Futon web interface we saw earlier may have made it look like you could modify a single field in isolation, but behind the scenes it was rerecording the whole document when you hit Save.
      </p>
<p id="N16F35" class="calibre5">
        As we mentioned earlier, both the <code class="cf">_id</code> and <code class="cf">_rev</code> fields must exactly match the document being updated, or the operation will fail.  To see how, try executing the same <code class="cf">PUT</code> operation again.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​HTTP/1.1 409 Conflict​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Server: CouchDB/1.1.1 (Erlang OTP/R14B03)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Date: Wed, 18 Jan 2012 00:44:12 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: text/plain;charset=utf-8​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Length: 58​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Cache-Control: must-revalidate​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{"error":<em class="string">"conflict"</em>,"reason":<em class="string">"Document update conflict."</em>}​</code>​</div>
</td>
</tr>
</table>
<p id="N16F67" class="calibre5">
        You’ll get an HTTP <code class="cf">409 Conflict</code> response with a JSON object describing the problem. This is how CouchDB enforces consistency.
      </p>
<h3 class="calibre20">Removing a Document with DELETE</h3>
<p id="N16F74" class="calibre5">
        Finally, we can use the <code class="cf">DELETE</code> operation to remove a document from the database.
      </p>
<table class="processedcode">
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​$ <strong class="prompt">curl -i -X DELETE \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  "http://localhost:5984/music/74c7a8d2a8548c8b97da748f43000f1b" \</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​<strong class="prompt">  -H "If-Match: 2-17e4ce41cd33d6a38f04a8452d5a860b"</strong>​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​HTTP/1.1 200 OK​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Server: CouchDB/1.1.1 (Erlang OTP/R14B03)​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Etag: "3-42aafb7411c092614ce7c9f4ab79dc8b"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Date: Wed, 18 Jan 2012 00:45:36 GMT​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Type: text/plain;charset=utf-8​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Content-Length: 95​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​Cache-Control: must-revalidate​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​{​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "ok":true,​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "id":"74c7a8d2a8548c8b97da748f43000f1b",​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​  "rev":"3-42aafb7411c092614ce7c9f4ab79dc8b"​</code>​</div>
</td>
</tr>
<tr class="calibre24">
<td class="codeprefix" valign="top">
<span> </span>
</td>
<td class="codeline" valign="top">
<div class="calibre25">
​<code class="calibre26">​}​</code>​</div>
</td>
</tr>
</table>
<p id="N16FC1" class="calibre5">
        The <code class="cf">DELETE</code> operation will supply a new revision number, even though the document is gone. It’s worth noting that the document wasn’t really removed from disk, but rather a new empty document was appended, flagging the document as deleted. Just like with an update, CouchDB does not modify documents in place. But for all intents and purposes, it’s deleted.
      </p>
<h3 class="calibre20">Day 1 Wrap-Up</h3>
<p id="N16FCB" class="calibre5">
        Now that we’ve learned how to do basic CRUD operations in Futon and cURL, we’re about ready to move onto more advanced topics.  In Day 2 we’ll dig into creating indexed <span class="calibre6">views</span>, which will provide other avenues for retrieving documents than just specifying them by their <code class="cf">_id</code> values.
      </p>
<h4 class="calibre21">Day 1 Homework</h4>
<p class="calibre5">
<strong class="calibre32">Find</strong>
</p>
<ol class="calibre33">
<li class="calibre23">
<p id="N16FDF" class="calibre5">Find the CouchDB HTTP Document API documentation online.</p>
</li>
<li class="calibre23">
<p id="N16FE3" class="calibre5">We’ve already used <code class="cf">GET</code>, <code class="cf">POST</code>, <code class="cf">PUT</code>, and <code class="cf">DELETE</code>.  What other HTTP commands are supported?</p>
</li>
</ol>
<p class="calibre5">
<strong class="calibre32">Do</strong>
</p>
<ol class="calibre33">
<li class="calibre23">
<p id="N16FF9" class="calibre5">Use cURL to <code class="cf">PUT</code> a new document into the music database with a specific <code class="cf">_id</code> of your choice.</p>
</li>
<li class="calibre23">
<p id="N17003" class="calibre5">Use <code class="cf">curl</code> to create a new database with a name of your choice, and then delete that database also via cURL.</p>
</li>
<li class="calibre23">
<p id="N1700A" class="calibre5">Again using cURL, create a new document that contains a text document as an attachment.  Lastly, craft and execute a cURL request that will return just that document’s attachment.</p>
</li>
</ol>
<script src="scripts/book_local.js" type="text/javascript" class="calibre3"/>
</div>

{% endraw %}

