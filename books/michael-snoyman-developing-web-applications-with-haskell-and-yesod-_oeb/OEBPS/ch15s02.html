---
layout: page
title: "Developing Web Applications with Haskell and Yesod"
prev: OEBPS/ch15.html
next: OEBPS/ch15s03.html
book_path: books/michael-snoyman-developing-web-applications-with-haskell-and-yesod-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="book" title="File Structure"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="I_sect14_d1e7346" class="calibre1"></a>File Structure</h1></div></div></div><p class="calibre7"></p><p class="calibre7">The scaffolded site is built as a fully cabalized Haskell package. In addition to
   source files, config files, templates, and static files are produced as well.</p><div class="book" title="Cabal File"><div class="book"><div class="book"><div class="book"><h2 class="title4"><a id="id3092395" class="calibre1"></a>Cabal File</h2></div></div></div><p class="calibre7"></p><p class="calibre7">Whether directly using <em class="calibre4">cabal</em>, or indirectly using
          <em class="calibre4">yesod devel</em>, building your code will always go through
        the cabal file. If you open the file, you’ll see there are both library and executable
        blocks. Only one of these is built at a time, depending on the value of the <code class="literal">library-only</code> flag. If <code class="literal">library-only</code> is turned on, then the library is built, which is how <em class="calibre4">yesod devel</em> calls your app. Otherwise, the executable is
        built.</p><p class="calibre7">The <code class="literal">library-only</code> flag should only be used by
        <em class="calibre4">yesod devel</em>; you should never be explicitly passing it into
        <em class="calibre4">cabal</em>. There is an additional flag, <code class="literal">dev</code>, that
      allows cabal to build an executable, but turns on some of the same features as
      the library-only flag, i.e., no optimizations and reload versions of the Shakespearean
      template functions.</p><p class="calibre7">In general, you will build as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre7">When developing, use <em class="calibre4">yesod devel</em> exclusively.</p></li><li class="listitem"><p class="calibre7">When building a production build, perform <em class="calibre4">cabal clean
          &amp;&amp; cabal configure &amp;&amp; cabal build</em>. This will produce an
        optimized executable in your <em class="calibre4">dist</em> folder.</p><div class="tip" title="Note"><h3 class="title3">Note</h3><p class="calibre7">In the past we
          had a <code class="literal">-fproduction</code> flag. If you produced a scaffolded site in the past,
          you may have to use this flag to get a production build.</p></div></li></ul></div><p class="calibre7">You’ll also notice that we specify all language extensions in the cabal file. The
      extensions are specified <span class="firstname"><em class="calibre4">twice</em></span>: once for the executable, and once for the
      library. If you add any extensions to the list, add it to both places.</p><p class="calibre7">You might be surprised to see the <code class="literal">NoImplicitPrelude</code> extension. We turn this
      on since the site includes its own module, <code class="literal">Import</code>, with a few changes to the
      Prelude that make working with Yesod a little more convenient.</p><p class="calibre7">The last thing to note is the exported-modules list. If you add any modules to your
      application, you <span class="bold"><strong class="bold">must</strong></span> update this list to get yesod devel to work correctly.
      Unfortunately, neither Cabal nor GHC will give you a warning if you forgot to make this
      update, and instead you’ll get a very scary-looking error message from yesod devel.</p><div class="tip" title="Note"><h3 class="title3">Note</h3><p class="calibre7">One of our planned improvements to <em class="calibre4">yesod devel</em> is to check if
        there are any missing modules.</p></div></div><div class="book" title="Routes and Entities"><div class="book"><div class="book"><div class="book"><h2 class="title4"><a id="id3092571" class="calibre1"></a>Routes and Entities</h2></div></div></div><p class="calibre7"></p><p class="calibre7">Multiple times in this book, you’ve seen a comment like “We’re declaring our routes/entities
   with quasiquotes for convenience. In a production site, you should use an external file.” The
   scaffolding uses such an external file.</p><p class="calibre7">Routes are defined in <em class="calibre4">config/routes</em>, and entities in
    <em class="calibre4">config/models</em>. They have the exact same syntax as the quasiquoting
   you’ve seen throughout the book, and <em class="calibre4">yesod devel</em> knows to automatically
   recompile the appropriate modules when these files change.</p><p class="calibre7">The <em class="calibre4">models</em> files is referenced by <code class="literal">Model.hs</code>. You are free to declare whatever you like in this file, but here are some
   guidelines:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre7">Any data types used in <em class="calibre4">entities</em>
    <span class="bold"><strong class="bold">must</strong></span> be imported/declared in <em class="calibre4">Model.hs</em>, above the <code class="literal">persistFile</code> call.</p></li><li class="listitem"><p class="calibre7">Helper utilities should either be declared in <code class="literal">Import.hs</code>
    or, if very model-centric, in a file within the <code class="literal">Model</code> folder and
    imported into <em class="calibre4">Import.hs</em>.</p></li></ul></div></div><div class="book" title="Foundation and Application Modules"><div class="book"><div class="book"><div class="book"><h2 class="title4"><a id="id3092673" class="calibre1"></a>Foundation and Application Modules</h2></div></div></div><p class="calibre7"></p><p class="calibre7">The <code class="literal">mkYesod</code> function, which we have used throughout
        the book, declares a few things:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre7">Route type</p></li><li class="listitem"><p class="calibre7">Route render function</p></li><li class="listitem"><p class="calibre7">Dispatch function</p></li></ul></div><p class="calibre7">The dispatch function refers to all of the handler functions. Therefore, all of those
        must either be defined in the same file as the dispatch function, or be imported by the
        dispatch function.</p><p class="calibre7">Meanwhile, the handler functions will almost certainly refer to the route type. Therefore,
    <span class="firstname"><em class="calibre4">they</em></span> must be either in the same file where the route type is defined, or must import that
   file. If you follow the logic here, your entire application must essentially live in a single
   file!</p><p class="calibre7">Clearly, this isn’t what we want. So instead of using <code class="literal">mkYesod</code>, the scaffolding site uses a decomposed version of the function.
          <code class="literal">Foundation</code> calls <code class="literal">mkYesodData</code>, which declares the route type and render function. Since it does
        not declare the dispatch function, the handler functions need not be in scope. <code class="literal">Import.hs</code> imports <code class="literal">Foundation.hs</code>, and all the handler modules import <code class="literal">Import.hs</code>.</p><p class="calibre7">In <code class="literal">Application.hs</code>, we call <code class="literal">mkYesodDispatch</code>, which creates our
   dispatch function. For this to work, all handler functions must be in scope, so be sure to add an
   import statement for any new handler modules you create.</p><p class="calibre7">Other than that, <em class="calibre4">Application.hs</em> is pretty simple. It provides
   two functions: <code class="literal">withDevelAppPort</code> is used by <em class="calibre4">yesod
    devel</em> to launch your app, and <code class="literal">getApplication</code> is used by the
   executable to launch.</p><p class="calibre7"><em class="calibre4">Foundation.hs</em> is much more exciting. It:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre7">Declares your foundation data type</p></li><li class="listitem"><p class="calibre7">Declares a number of instances, such as <code class="literal">Yesod</code>,
     <code class="literal">YesodAuth</code>, and <code class="literal">YesodPersist</code></p></li><li class="listitem"><p class="calibre7">Imports the messages files. If you look for the line starting with <code class="literal">mkMessage</code>, you will see that it specifies the folder
            containing the messages (<em class="calibre4">messages</em>) and the default
            language (en, for English)</p></li></ul></div><p class="calibre7">This is the right file for adding extra instances for your foundation, such as
    <code class="literal">YesodAuthEmail</code> or <code class="literal">YesodBreadcrumbs</code>.</p><p class="calibre7">We’ll be referring back to this file later, as we discussed some of the special
   implementations of <code class="literal">Yesod</code> typeclass methods.</p></div><div class="book" title="Import"><div class="book"><div class="book"><div class="book"><h2 class="title4"><a id="id3092882" class="calibre1"></a>Import</h2></div></div></div><p class="calibre7"></p><p class="calibre7">The <code class="literal">Import</code> module was born out of a few commonly recurring
   patterns.</p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre7">I want to define some helper functions (maybe the <code class="literal">&lt;&gt; = mappend</code> operator)
    to be used by all handlers.</p></li><li class="listitem"><p class="calibre7">I’m always adding the same five import statements (<code class="literal">Data.Text</code>,
     <code class="literal">Control.Applicative</code>, etc) to every handler module.</p></li><li class="listitem"><p class="calibre7">I want to make sure I never use some evil function (<code class="literal">head</code>,
     <code class="literal">readFile</code>, ...) from <code class="literal">Prelude</code>.</p><div class="tip" title="Note"><h3 class="title3">Note</h3><p class="calibre7">Yes, evil is
     hyperbole. If you’re wondering why I listed those functions as bad: <code class="literal">head</code> is partial, and throws exceptions on an empty list, and <code class="literal">readFile</code> uses lazy I/O, which doesn’t close file handles quickly enough. Also,
      <code class="literal">readFile</code> uses <code class="literal">String</code> instead of
     <code class="literal">Text</code>.</p></div></li></ul></div><p class="calibre7">The solution is to turn on the <code class="literal">NoImplicitPrelude</code> language extension,
   re-export the parts of <code class="literal">Prelude</code> we want, add in all the other stuff we want,
   define our own functions as well, and then import this file in all handlers.</p></div><div class="book" title="Handler Modules"><div class="book"><div class="book"><div class="book"><h2 class="title4"><a id="id3093001" class="calibre1"></a>Handler Modules</h2></div></div></div><p class="calibre7"></p><p class="calibre7">Handler modules should go inside the <em class="calibre4">Handler</em> folder. The site
   template includes one module: <em class="calibre4">Handler/Root.hs</em>. How you split up your handler
   functions into individual modules is your decision, but a good rule of thumb is:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre7">Different methods for the same route should go in the same file, e.g., <code class="literal">getBlogR</code> and <code class="literal">postBlogR</code>.</p></li><li class="listitem"><p class="calibre7">Related routes can also usually go in the same file, e.g.,
     <code class="literal">getPeopleR</code> and <code class="literal">getPersonR</code>.</p></li></ul></div><p class="calibre7">Of course, it’s entirely up to you. When you add a new handler file, make sure you do the
   following:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre7">Add it to version control (you <span class="firstname"><em class="calibre4">are</em></span> using version control, right?).</p></li><li class="listitem"><p class="calibre7">Add it to the cabal file.</p></li><li class="listitem"><p class="calibre7">Add it to the <em class="calibre4">Application.hs</em> file.</p></li><li class="listitem"><p class="calibre7">Put a module statement at the top, and an <code class="literal">import Import</code> line below it.</p></li></ul></div><div class="tip" title="Note"><h3 class="title3">Note</h3><p class="calibre7">One of the planned improvements to the <em class="calibre4">yesod</em> executable is to automate
   these four steps.</p></div></div></div></div>

{% endraw %}

