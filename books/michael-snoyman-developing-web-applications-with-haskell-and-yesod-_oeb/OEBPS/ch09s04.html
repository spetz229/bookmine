---
layout: page
title: "Developing Web Applications with Haskell and Yesod"
prev: OEBPS/ch09s03.html
next: OEBPS/ch09s05.html
book_path: books/michael-snoyman-developing-web-applications-with-haskell-and-yesod-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="book" title="Messages"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="I_sect19_d1e4684" class="calibre1"></a>Messages</h1></div></div></div><p class="calibre7">One usage of sessions previously alluded to is messages. They come to solve a common
            problem in web development: the user performs a <code class="literal">POST</code> request, the web
            app makes a change, and then the web app wants to <span class="firstname"><em class="calibre4">simultaneously</em></span> redirect
            the user to a new page and send the user a success message. (This is known as
            Post/Redirect/Get.)</p><p class="calibre7">Yesod provides a pair of functions to make this very easy:
            <code class="literal">setMessage</code> stores a value in the session, and
            <code class="literal">getMessage</code> both reads the value most recently put into
            the session, and clears the old value so it does not accidently get
            displayed twice.</p><p class="calibre7">It is recommended to have a call to <code class="literal">getMessage</code> in <code class="literal">defaultLayout</code> so that any available message is shown to a user
            immediately, without having to remember to add <code class="literal">getMessage</code> calls to
            every handler.</p><a id="I_programlisting9_d1e4714" class="firstname"></a><pre class="programlistinghaskell"><code class="cm">{-# LANGUAGE OverloadedStrings, TypeFamilies, TemplateHaskell,</code>
<code class="cm">             QuasiQuotes, MultiParamTypeClasses #-}</code>
<code class="kr">import</code> <code class="nn">Yesod</code>

<code class="kr">data</code> <code class="kt">Messages</code> <code class="ow">=</code> <code class="kt">Messages</code>

<code class="nf">mkYesod</code> <code class="s">"Messages"</code> <code class="p">[</code><code class="n">parseRoutes</code><code class="o">|</code>
<code class="o">/</code> <code class="kt">RootR</code> <code class="kt">GET</code>
<code class="o">/</code><code class="n">set</code><code class="o">-</code><code class="n">message</code> <code class="kt">SetMessageR</code> <code class="kt">POST</code>
<code class="o">|</code><code class="p">]</code>

<code class="kr">instance</code> <code class="kt">Yesod</code> <code class="kt">Messages</code> <code class="kr">where</code>
    <code class="n">defaultLayout</code> <code class="n">widget</code> <code class="ow">=</code> <code class="kr">do</code>
        <code class="n">pc</code> <code class="ow">&lt;-</code> <code class="n">widgetToPageContent</code> <code class="n">widget</code>
        <code class="n">mmsg</code> <code class="ow">&lt;-</code> <code class="n">getMessage</code>
        <code class="n">hamletToRepHtml</code> <code class="p">[</code><code class="n">hamlet</code><code class="o">|</code>
<code class="o">$</code><code class="n">doctype</code> <code class="mi">5</code>
<code class="o">&lt;</code><code class="n">html</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="n">head</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="n">title</code><code class="o">&gt;#</code><code class="p">{</code><code class="n">pageTitle</code> <code class="n">pc</code><code class="p">}</code>
        <code class="o">^</code><code class="p">{</code><code class="n">pageHead</code> <code class="n">pc</code><code class="p">}</code>
    <code class="o">&lt;</code><code class="n">body</code><code class="o">&gt;</code>
        <code class="o">$</code><code class="n">maybe</code> <code class="n">msg</code> <code class="ow">&lt;-</code> <code class="n">mmsg</code>
            <code class="o">&lt;</code><code class="n">p</code><code class="o">&gt;</code><code class="kt">Your</code> <code class="n">message</code> <code class="n">was</code><code class="kt">:</code> <code class="o">#</code><code class="p">{</code><code class="n">msg</code><code class="p">}</code>
        <code class="o">^</code><code class="p">{</code><code class="n">pageBody</code> <code class="n">pc</code><code class="p">}</code>
<code class="o">|</code><code class="p">]</code>

<code class="kr">instance</code> <code class="kt">RenderMessage</code> <code class="kt">Messages</code> <code class="kt">FormMessage</code> <code class="kr">where</code>
    <code class="n">renderMessage</code> <code class="kr">_</code> <code class="kr">_</code> <code class="ow">=</code> <code class="n">defaultFormMessage</code>

<code class="nf">getRootR</code> <code class="ow">::</code> <code class="kt">Handler</code> <code class="kt">RepHtml</code>
<code class="nf">getRootR</code> <code class="ow">=</code> <code class="n">defaultLayout</code> <code class="p">[</code><code class="n">whamlet</code><code class="o">|</code>
<code class="o">&lt;</code><code class="n">form</code> <code class="n">method</code><code class="ow">=</code><code class="n">post</code> <code class="n">action</code><code class="o">=@</code><code class="p">{</code><code class="kt">SetMessageR</code><code class="p">}</code><code class="o">&gt;</code>
    <code class="kt">My</code> <code class="n">message</code> <code class="n">is</code><code class="kt">:</code> <code class="o">#</code>
    <code class="o">&lt;</code><code class="n">input</code> <code class="kr">type</code><code class="ow">=</code><code class="n">text</code> <code class="n">name</code><code class="ow">=</code><code class="n">message</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="n">input</code> <code class="kr">type</code><code class="ow">=</code><code class="n">submit</code><code class="o">&gt;</code>
<code class="o">|</code><code class="p">]</code>

<code class="nf">postSetMessageR</code> <code class="ow">::</code> <code class="kt">Handler</code> <code class="nb">()</code>
<code class="nf">postSetMessageR</code> <code class="ow">=</code> <code class="kr">do</code>
    <code class="n">msg</code> <code class="ow">&lt;-</code> <code class="n">runInputPost</code> <code class="o">$</code> <code class="n">ireq</code> <code class="n">textField</code> <code class="s">"message"</code>
    <code class="n">setMessage</code> <code class="o">$</code> <code class="n">toHtml</code> <code class="n">msg</code>
    <code class="n">redirect</code> <code class="kt">RootR</code>

<code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="nf">main</code> <code class="ow">=</code> <code class="n">warpDebug</code> <code class="mi">3000</code> <code class="kt">Messages</code>
</pre><div class="figure"><a id="messages-x-4" class="firstname"></a><div class="book"><div class="book"><a id="I_mediaobject9_d1e4719" class="firstname"></a><img src="httpatomoreillycomsourceoreillyimages1137533.png" alt="Initial page load, no message" class="calibre5"/></div></div><p class="title7">Figure 9-1. Initial page load, no message</p></div><div class="figure"><a id="messages-x-6" class="firstname"></a><div class="book"><div class="book"><a id="I_mediaobject9_d1e4727" class="firstname"></a><img src="httpatomoreillycomsourceoreillyimages1137535.png" alt="New message entered in text box" class="calibre5"/></div></div><p class="title7">Figure 9-2. New message entered in text box</p></div><div class="figure"><a id="messages-x-8" class="firstname"></a><div class="book"><div class="book"><a id="I_mediaobject9_d1e4735" class="firstname"></a><img src="httpatomoreillycomsourceoreillyimages1137537.png" alt="After form submit, message appears at top of page" class="calibre5"/></div></div><p class="title7">Figure 9-3. After form submit, message appears at top of page</p></div><div class="figure"><a id="messages-x-10" class="firstname"></a><div class="book"><div class="book"><a id="I_mediaobject9_d1e4743" class="firstname"></a><img src="httpatomoreillycomsourceoreillyimages1137539.png" alt="After refresh, the message is cleared" class="calibre5"/></div></div><p class="title7">Figure 9-4. After refresh, the message is cleared</p></div></div></div>

{% endraw %}

