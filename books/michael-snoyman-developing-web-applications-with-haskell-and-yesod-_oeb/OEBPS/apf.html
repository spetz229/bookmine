---
layout: page
title: "Developing Web Applications with Haskell and Yesod"
prev: OEBPS/apes06.html
next: OEBPS/apfs02.html
book_path: books/michael-snoyman-developing-web-applications-with-haskell-and-yesod-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="book" title="Appendix F. xml-conduit"><div class="book"><div class="book"><div class="book"><h1 class="title1"><a id="I_appendix_d1e11277" class="calibre1"></a>Appendix F. xml-conduit</h1></div></div></div><p class="calibre7">Many developers cringe at the thought of dealing with XML files. XML has the reputation of
   having a complicated data model, with obfuscated libraries and huge layers of complexity sitting
   between you and your goal. I’d like to posit that a lot of that pain is actually a language and
   library issue, not inherent to XML.</p><p class="calibre7">Once again, Haskell’s type system allows us to easily break down the problem to its most basic
   form. The <code class="function">xml-types</code> package neatly deconstructs the XML data model (both a
   streaming and DOM-based approach) into some simple ADTs. Haskell’s standard immutable data
   structures make it easier to apply transforms to documents, and a simple set of functions makes
   parsing and rendering a breeze.</p><p class="calibre7">We’re going to be covering the <code class="function">xml-conduit</code> package.
        Under the surface, this package uses a lot of the approaches Yesod in general utilizes for
        high performance: <code class="function">blaze-builder</code>, <code class="function">text</code>, <code class="function">conduit</code>, and
            <code class="function">attoparsec</code>. But from a user perspective, it
        provides everything from the simplest APIs (<code class="literal">readFile</code>/<code class="literal">writeFile</code>) through full control
        of XML event streams.</p><p class="calibre7">In addition to <code class="literal">xml-conduit</code>, there are a few related packages that
   come into play, like <code class="function">xml-hamlet</code> and <code class="function">xml2html</code>. We’ll cover both how to use all these packages, and when they should be
   used.</p><div class="book" title="Synopsis"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="I_sect1_d1e11322" class="calibre1"></a>Synopsis</h1></div></div></div><p class="calibre7"></p><div class="example"><a id="conceptId-x-3" class="firstname"></a><p class="title6">Example F-1. Input XML file</p><div class="book"><pre class="programlisting1">&lt;document title="My Title"&gt;
    &lt;para&gt;This is a paragraph. It has &lt;em&gt;emphasized&lt;/em&gt; and &lt;strong&gt;strong&lt;/strong&gt; words.&lt;/para&gt;
    &lt;image href="myimage.png"/&gt;
&lt;/document&gt;</pre></div></div><div class="example"><a id="conceptId-x-6" class="firstname"></a><p class="title6">Example F-2. Haskell code</p><div class="book"><pre class="programlistinghaskell"><code class="cm">{-# LANGUAGE QuasiQuotes #-}</code>
<code class="cm">{-# LANGUAGE OverloadedStrings #-}</code>
<code class="kr">import</code> <code class="nn">Prelude</code> <code class="kr">hiding</code> <code class="p">(</code><code class="nf">readFile</code><code class="p">,</code> <code class="nf">writeFile</code><code class="p">)</code>
<code class="kr">import</code> <code class="nn">Text.XML</code>
<code class="kr">import</code> <code class="nn">Text.Hamlet.XML</code>

<code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="nf">main</code> <code class="ow">=</code> <code class="kr">do</code>
    <code class="cm">-- readFile will throw any parse errors as runtime exceptions</code>
    <code class="cm">-- def uses the default settings</code>
    <code class="kt">Document</code> <code class="n">prologue</code> <code class="n">root</code> <code class="n">epilogue</code> <code class="ow">&lt;-</code> <code class="n">readFile</code> <code class="n">def</code> <code class="s">"input.xml"</code>

    <code class="cm">-- root is the root element of the document, let's modify it</code>
    <code class="kr">let</code> <code class="n">root'</code> <code class="ow">=</code> <code class="n">transform</code> <code class="n">root</code>

    <code class="cm">-- And now we write out. Let's indent our output</code>
    <code class="n">writeFile</code> <code class="n">def</code>
        <code class="p">{</code> <code class="n">rsPretty</code> <code class="ow">=</code> <code class="kt">True</code>
        <code class="p">}</code> <code class="s">"output.html"</code> <code class="o">$</code> <code class="kt">Document</code> <code class="n">prologue</code> <code class="n">root'</code> <code class="n">epilogue</code>

<code class="cm">-- We'll turn out &lt;document&gt; into an XHTML document</code>
<code class="nf">transform</code> <code class="ow">::</code> <code class="kt">Element</code> <code class="ow">-&gt;</code> <code class="kt">Element</code>
<code class="nf">transform</code> <code class="p">(</code><code class="kt">Element</code> <code class="n">_name</code> <code class="n">attrs</code> <code class="n">children</code><code class="p">)</code> <code class="ow">=</code> <code class="kt">Element</code> <code class="s">"html"</code> <code class="kt">[]</code> <code class="p">[</code><code class="n">xml</code><code class="o">|</code>
<code class="o">&lt;</code><code class="n">head</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="n">title</code><code class="o">&gt;</code>
        <code class="o">$</code><code class="n">maybe</code> <code class="n">title</code> <code class="ow">&lt;-</code> <code class="n">lookup</code> <code class="s">"title"</code> <code class="n">attrs</code>
            <code class="o">\#</code><code class="p">{</code><code class="n">title</code><code class="p">}</code>
        <code class="o">$</code><code class="n">nothing</code>
            <code class="kt">Untitled</code> <code class="kt">Document</code>
<code class="o">&lt;</code><code class="n">body</code><code class="o">&gt;</code>
    <code class="o">$</code><code class="n">forall</code> <code class="n">child</code> <code class="ow">&lt;-</code> <code class="n">children</code>
        <code class="o">^</code><code class="p">{</code><code class="n">goNode</code> <code class="n">child</code><code class="p">}</code>
<code class="o">|</code><code class="p">]</code>

<code class="nf">goNode</code> <code class="ow">::</code> <code class="kt">Node</code> <code class="ow">-&gt;</code> <code class="p">[</code><code class="kt">Node</code><code class="p">]</code>
<code class="nf">goNode</code> <code class="p">(</code><code class="kt">NodeElement</code> <code class="n">e</code><code class="p">)</code> <code class="ow">=</code> <code class="p">[</code><code class="kt">NodeElement</code> <code class="o">$</code> <code class="n">goElem</code> <code class="n">e</code><code class="p">]</code>
<code class="nf">goNode</code> <code class="p">(</code><code class="kt">NodeContent</code> <code class="n">t</code><code class="p">)</code> <code class="ow">=</code> <code class="p">[</code><code class="kt">NodeContent</code> <code class="n">t</code><code class="p">]</code>
<code class="nf">goNode</code> <code class="p">(</code><code class="kt">NodeComment</code> <code class="kr">_</code><code class="p">)</code> <code class="ow">=</code> <code class="kt">[]</code> <code class="cm">-- hide comments</code>
<code class="nf">goNode</code> <code class="p">(</code><code class="kt">NodeInstruction</code> <code class="kr">_</code><code class="p">)</code> <code class="ow">=</code> <code class="kt">[]</code> <code class="cm">-- and hide processing instructions too</code>

<code class="cm">-- convert each source element to its XHTML equivalent</code>
<code class="nf">goElem</code> <code class="ow">::</code> <code class="kt">Element</code> <code class="ow">-&gt;</code> <code class="kt">Element</code>
<code class="nf">goElem</code> <code class="p">(</code><code class="kt">Element</code> <code class="s">"para"</code> <code class="n">attrs</code> <code class="n">children</code><code class="p">)</code> <code class="ow">=</code>
    <code class="kt">Element</code> <code class="s">"p"</code> <code class="n">attrs</code> <code class="o">$</code> <code class="n">concatMap</code> <code class="n">goNode</code> <code class="n">children</code>
<code class="nf">goElem</code> <code class="p">(</code><code class="kt">Element</code> <code class="s">"em"</code> <code class="n">attrs</code> <code class="n">children</code><code class="p">)</code> <code class="ow">=</code>
    <code class="kt">Element</code> <code class="s">"i"</code> <code class="n">attrs</code> <code class="o">$</code> <code class="n">concatMap</code> <code class="n">goNode</code> <code class="n">children</code>
<code class="nf">goElem</code> <code class="p">(</code><code class="kt">Element</code> <code class="s">"strong"</code> <code class="n">attrs</code> <code class="n">children</code><code class="p">)</code> <code class="ow">=</code>
    <code class="kt">Element</code> <code class="s">"b"</code> <code class="n">attrs</code> <code class="o">$</code> <code class="n">concatMap</code> <code class="n">goNode</code> <code class="n">children</code>
<code class="nf">goElem</code> <code class="p">(</code><code class="kt">Element</code> <code class="s">"image"</code> <code class="n">attrs</code> <code class="n">_children</code><code class="p">)</code> <code class="ow">=</code>
    <code class="kt">Element</code> <code class="s">"img"</code> <code class="p">(</code><code class="n">map</code> <code class="n">fixAttr</code> <code class="n">attrs</code><code class="p">)</code> <code class="kt">[]</code> <code class="cm">-- images can't have children</code>
  <code class="kr">where</code>
    <code class="n">fixAttr</code> <code class="p">(</code><code class="s">"href"</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code> <code class="ow">=</code> <code class="p">(</code><code class="s">"src"</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code>
    <code class="n">fixAttr</code> <code class="n">x</code> <code class="ow">=</code> <code class="n">x</code>
<code class="nf">goElem</code> <code class="p">(</code><code class="kt">Element</code> <code class="n">name</code> <code class="n">attrs</code> <code class="n">children</code><code class="p">)</code> <code class="ow">=</code>
    <code class="cm">-- don't know what to do, just pass it through...</code>
    <code class="kt">Element</code> <code class="n">name</code> <code class="n">attrs</code> <code class="o">$</code> <code class="n">concatMap</code> <code class="n">goNode</code> <code class="n">children</code>
</pre></div></div><div class="example"><a id="conceptId-x-9" class="firstname"></a><p class="title6">Example F-3. Output XHTML</p><div class="book"><pre class="programlisting1">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;
            My Title
        &lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;p&gt;
            This is a paragraph. It has 
            &lt;i&gt;
                emphasized
            &lt;/i&gt;
            and 
            &lt;b&gt;
                strong
            &lt;/b&gt;
            words.
        &lt;/p&gt;
        &lt;img src="myimage.png"/&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre></div></div></div></div></div>

{% endraw %}

