---
layout: page
title: "Developing Web Applications with Haskell and Yesod"
prev: OEBPS/ch09s04.html
next: OEBPS/ch09s06.html
book_path: books/michael-snoyman-developing-web-applications-with-haskell-and-yesod-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="book" title="Ultimate Destination"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="I_sect19_d1e4748" class="calibre1"></a>Ultimate Destination</h1></div></div></div><p class="calibre7">Not to be confused with a horror film, this concept is used internally in <code class="function">yesod-auth</code>. Suppose a user requests a page that requires
      authentication. If the user is not yet logged in, you need to send him/her to the login page.
      A well-designed web app will then <span class="firstname"><em class="calibre4">send them back to the first page they
        requested</em></span>. That’s what we call the ultimate destination.</p><p class="calibre7"><code class="literal">redirectUltDest</code> sends the user to the ultimate destination set
            in his/her session, clearing that value from the session. It takes a default destination
            as well, in case there is no destination set. For setting the session, there are three
                options:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre7"><code class="literal">setUltDest</code> sets the destination to the given URL.</p></li><li class="listitem"><p class="calibre7"><code class="literal">setUltDestCurrent</code> sets the destination to the currently
                    requested URL.</p></li><li class="listitem"><p class="calibre7"><code class="literal">setUltDestReferer</code> sets the destination based on the
                        <code class="literal">Referer</code> header (the page that led the user to the current
                    page).</p></li></ul></div><p class="calibre7">Let’s look at a small sample app. It will allow the user to set his/her name in the
      session, and then tell the user his/her name from another route. If the name hasn’t been set
      yet, the user will be redirected to the set name page, with an ultimate destination set to
      come back to the current page.</p><a id="I_programlisting9_d1e4784" class="firstname"></a><pre class="programlistinghaskell"><code class="cm">{-# LANGUAGE OverloadedStrings, TypeFamilies, TemplateHaskell,</code>
<code class="cm">             QuasiQuotes, MultiParamTypeClasses #-}</code>
<code class="kr">import</code> <code class="nn">Yesod</code>

<code class="kr">data</code> <code class="kt">UltDest</code> <code class="ow">=</code> <code class="kt">UltDest</code>

<code class="nf">mkYesod</code> <code class="s">"UltDest"</code> <code class="p">[</code><code class="n">parseRoutes</code><code class="o">|</code>
<code class="o">/</code> <code class="kt">RootR</code> <code class="kt">GET</code>
<code class="o">/</code><code class="n">setname</code> <code class="kt">SetNameR</code> <code class="kt">GET</code> <code class="kt">POST</code>
<code class="o">/</code><code class="n">sayhello</code> <code class="kt">SayHelloR</code> <code class="kt">GET</code>
<code class="o">|</code><code class="p">]</code>

<code class="kr">instance</code> <code class="kt">Yesod</code> <code class="kt">UltDest</code>

<code class="kr">instance</code> <code class="kt">RenderMessage</code> <code class="kt">UltDest</code> <code class="kt">FormMessage</code> <code class="kr">where</code>
    <code class="n">renderMessage</code> <code class="kr">_</code> <code class="kr">_</code> <code class="ow">=</code> <code class="n">defaultFormMessage</code>

<code class="nf">getRootR</code> <code class="ow">=</code> <code class="n">defaultLayout</code> <code class="p">[</code><code class="n">whamlet</code><code class="o">|</code>
<code class="o">&lt;</code><code class="n">p</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="n">a</code> <code class="n">href</code><code class="o">=@</code><code class="p">{</code><code class="kt">SetNameR</code><code class="p">}</code><code class="o">&gt;</code><code class="kt">Set</code> <code class="n">your</code> <code class="n">name</code>
<code class="o">&lt;</code><code class="n">p</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="n">a</code> <code class="n">href</code><code class="o">=@</code><code class="p">{</code><code class="kt">SayHelloR</code><code class="p">}</code><code class="o">&gt;</code><code class="kt">Say</code> <code class="n">hello</code>
<code class="o">|</code><code class="p">]</code>

<code class="cm">-- Display the set name form</code>
<code class="nf">getSetNameR</code> <code class="ow">=</code> <code class="n">defaultLayout</code> <code class="p">[</code><code class="n">whamlet</code><code class="o">|</code>
<code class="o">&lt;</code><code class="n">form</code> <code class="n">method</code><code class="ow">=</code><code class="n">post</code><code class="o">&gt;</code>
    <code class="kt">My</code> <code class="n">name</code> <code class="n">is</code> <code class="o">#</code>
    <code class="o">&lt;</code><code class="n">input</code> <code class="kr">type</code><code class="ow">=</code><code class="n">text</code> <code class="n">name</code><code class="ow">=</code><code class="n">name</code><code class="o">&gt;</code>
    <code class="o">.</code> <code class="o">#</code>
    <code class="o">&lt;</code><code class="n">input</code> <code class="kr">type</code><code class="ow">=</code><code class="n">submit</code> <code class="n">value</code><code class="ow">=</code><code class="s">"Set name"</code><code class="o">&gt;</code>
<code class="o">|</code><code class="p">]</code>

<code class="cm">-- Retrieve the submitted name from the user</code>
<code class="nf">postSetNameR</code> <code class="ow">::</code> <code class="kt">Handler</code> <code class="nb">()</code>
<code class="nf">postSetNameR</code> <code class="ow">=</code> <code class="kr">do</code>
    <code class="cm">-- Get the submitted name and set it in the session</code>
    <code class="n">name</code> <code class="ow">&lt;-</code> <code class="n">runInputPost</code> <code class="o">$</code> <code class="n">ireq</code> <code class="n">textField</code> <code class="s">"name"</code>
    <code class="n">setSession</code> <code class="s">"name"</code> <code class="n">name</code>

    <code class="cm">-- After we get a name, redirect to the ultimate destination.</code>
    <code class="cm">-- If no destination is set, default to the homepage</code>
    <code class="n">redirectUltDest</code> <code class="kt">RootR</code>

<code class="nf">getSayHelloR</code> <code class="ow">=</code> <code class="kr">do</code>
    <code class="cm">-- Lookup the name value set in the session</code>
    <code class="n">mname</code> <code class="ow">&lt;-</code> <code class="n">lookupSession</code> <code class="s">"name"</code>
    <code class="kr">case</code> <code class="n">mname</code> <code class="kr">of</code>
        <code class="kt">Nothing</code> <code class="ow">-&gt;</code> <code class="kr">do</code>
            <code class="cm">-- No name in the session, set the current page as</code>
            <code class="cm">-- the ultimate destination and redirect to the</code>
            <code class="cm">-- SetName page</code>
            <code class="n">setUltDestCurrent</code>
            <code class="n">setMessage</code> <code class="s">"Please tell me your name"</code>
            <code class="n">redirect</code> <code class="kt">SetNameR</code>
        <code class="kt">Just</code> <code class="n">name</code> <code class="ow">-&gt;</code> <code class="n">defaultLayout</code> <code class="p">[</code><code class="n">whamlet</code><code class="o">|</code>
<code class="o">&lt;</code><code class="n">p</code><code class="o">&gt;</code><code class="kt">Welcome</code> <code class="o">#</code><code class="p">{</code><code class="n">name</code><code class="p">}</code>
<code class="o">|</code><code class="p">]</code>

<code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="nf">main</code> <code class="ow">=</code> <code class="n">warpDebug</code> <code class="mi">3000</code> <code class="kt">UltDest</code>
</pre></div></div>

{% endraw %}

