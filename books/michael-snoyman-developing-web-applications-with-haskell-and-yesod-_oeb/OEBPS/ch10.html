---
layout: page
title: "Developing Web Applications with Haskell and Yesod"
prev: OEBPS/ch09s06.html
next: OEBPS/ch10s02.html
book_path: books/michael-snoyman-developing-web-applications-with-haskell-and-yesod-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="calibre8"></div><div class="book" title="Chapter 10. Persistent"><div class="book"><div class="book"><div class="book"><div class="calibre8"></div><h1 class="title1"><a id="I_chapter10_d1e4793" class="calibre1"></a>Chapter 10. Persistent</h1></div></div></div><p class="calibre7">Forms deal with the boundary between the user and the application. Another boundary we need
    to deal with is between the application and the storage layer. Whether it be a SQL database, a
    YAML file, or a binary blob, odds are you have to work to get your storage layer to accept your
    application data types. Persistent is Yesod’s answer to data storage—a type-safe, universal
    data store interface for Haskell. </p><p class="calibre7">Haskell has many different database bindings available. However, most of these have little
    knowledge of a schema and therefore do not provide useful static guarantees. They also force
    database-dependent APIs and data types on the programmer. Haskellers have attempted a more
    revolutionary route of creating Haskell-specific data stores to get around these flaws that
    allow one to easily store any Haskell type. These options are great for certain use cases, but
    they constrain one to the storage techniques provided by the library, do not interface well with
    other languages, and the flexibility can also mean one must write reams of code for querying
    data. In contrast, Persistent allows us to choose among existing databases that are highly tuned
    for different data storage use cases, interoperate with other programming languages, and to use
    a safe and productive query interface. </p><p class="calibre7">Persistent follows the guiding principles of type safety and concise, declarative syntax. Some other nice features are:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre7">Database-agnostic. There is first-class support for PostgreSQL, SQLite, and MongoDB,
        with experimental CouchDB and MySQL support in the works.</p></li><li class="listitem"><p class="calibre7">By being non-relational in nature, we simultaneously are able to support a wider number of storage layers and are not constrained by some of the performance bottlenecks incurred through joins.</p></li><li class="listitem"><p class="calibre7">A major source of frustration in dealing with SQL databases is changes to the schema. Persistent can automatically perform database migrations.</p></li></ul></div><div class="book" title="Synopsis"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="I_sect110_d1e4819" class="calibre1"></a>Synopsis</h1></div></div></div><a id="I_programlisting10_d1e4822" class="firstname"></a><pre class="programlistinghaskell"><code class="cm">{-# LANGUAGE QuasiQuotes, TemplateHaskell, TypeFamilies, OverloadedStrings #-}</code>
<code class="cm">{-# LANGUAGE GADTs, FlexibleContexts #-}</code>
<code class="kr">import</code> <code class="nn">Database.Persist</code>
<code class="kr">import</code> <code class="nn">Database.Persist.Sqlite</code>
<code class="kr">import</code> <code class="nn">Database.Persist.TH</code>
<code class="kr">import</code> <code class="nn">Control.Monad.IO.Class</code> <code class="p">(</code><code class="nf">liftIO</code><code class="p">)</code>

<code class="nf">share</code> <code class="p">[</code><code class="n">mkPersist</code> <code class="n">sqlSettings</code><code class="p">,</code> <code class="n">mkMigrate</code> <code class="s">"migrateAll"</code><code class="p">]</code> <code class="p">[</code><code class="n">persist</code><code class="o">|</code>
<code class="kt">Person</code>
    <code class="n">name</code> <code class="kt">String</code>
    <code class="n">age</code> <code class="kt">Int</code> <code class="kt">Maybe</code>
<code class="kt">BlogPost</code>
    <code class="n">title</code> <code class="kt">String</code>
    <code class="n">authorId</code> <code class="kt">PersonId</code>
<code class="o">|</code><code class="p">]</code>

<code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="nf">main</code> <code class="ow">=</code> <code class="n">withSqliteConn</code> <code class="s">":memory:"</code> <code class="o">$</code> <code class="n">runSqlConn</code> <code class="o">$</code> <code class="kr">do</code>
    <code class="n">runMigration</code> <code class="n">migrateAll</code>

    <code class="n">johnId</code> <code class="ow">&lt;-</code> <code class="n">insert</code> <code class="o">$</code> <code class="kt">Person</code> <code class="s">"John Doe"</code> <code class="o">$</code> <code class="kt">Just</code> <code class="mi">35</code>
    <code class="n">janeId</code> <code class="ow">&lt;-</code> <code class="n">insert</code> <code class="o">$</code> <code class="kt">Person</code> <code class="s">"Jane Doe"</code> <code class="kt">Nothing</code>

    <code class="n">insert</code> <code class="o">$</code> <code class="kt">BlogPost</code> <code class="s">"My fr1st p0st"</code> <code class="n">johnId</code>
    <code class="n">insert</code> <code class="o">$</code> <code class="kt">BlogPost</code> <code class="s">"One more for good measure"</code> <code class="n">johnId</code>

    <code class="n">oneJohnPost</code> <code class="ow">&lt;-</code> <code class="n">selectList</code> <code class="p">[</code><code class="kt">BlogPostAuthorId</code> <code class="o">==.</code> <code class="n">johnId</code><code class="p">]</code> <code class="p">[</code><code class="kt">LimitTo</code> <code class="mi">1</code><code class="p">]</code>
    <code class="n">liftIO</code> <code class="o">$</code> <code class="n">print</code> <code class="p">(</code><code class="n">oneJohnPost</code> <code class="ow">::</code> <code class="p">[</code><code class="kt">Entity</code> <code class="kt">BlogPost</code><code class="p">])</code>

    <code class="n">john</code> <code class="ow">&lt;-</code> <code class="n">get</code> <code class="n">johnId</code>
    <code class="n">liftIO</code> <code class="o">$</code> <code class="n">print</code> <code class="p">(</code><code class="n">john</code> <code class="ow">::</code> <code class="kt">Maybe</code> <code class="kt">Person</code><code class="p">)</code>

    <code class="n">delete</code> <code class="n">janeId</code>
    <code class="n">deleteWhere</code> <code class="p">[</code><code class="kt">BlogPostAuthorId</code> <code class="o">==.</code> <code class="n">johnId</code><code class="p">]</code>
</pre></div></div></div>

{% endraw %}

