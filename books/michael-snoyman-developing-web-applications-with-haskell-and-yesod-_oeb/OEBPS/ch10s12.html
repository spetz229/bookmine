---
layout: page
title: "Developing Web Applications with Haskell and Yesod"
prev: OEBPS/ch10s11.html
next: OEBPS/ch10s13.html
book_path: books/michael-snoyman-developing-web-applications-with-haskell-and-yesod-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="book" title="Integration with Yesod"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="I_sect110_d1e5895" class="calibre1"></a>Integration with Yesod</h1></div></div></div><p class="calibre7">So you’ve been convinced of the power of Persistent. How do you integrate it with your
      Yesod application? If you use the scaffolding, most of the work is done for you already. But
      as we normally do, we’ll build up everything manually here to point out how it works under the
      surface.</p><p class="calibre7">The <code class="function">yesod-persistent</code> package provides the meeting
      point between Persistent and Yesod. It provides the <code class="literal">YesodPersist</code> typeclass, which standardizes access to the database via the
        <code class="literal">runDB</code> method. Let’s see this in action.</p><a id="I_programlisting10_d1e5911" class="firstname"></a><pre class="programlistinghaskell"><code class="cm">{-# LANGUAGE QuasiQuotes, TypeFamilies, GeneralizedNewtypeDeriving, FlexibleContexts #-}</code>
<code class="cm">{-# LANGUAGE TemplateHaskell, OverloadedStrings, GADTs, MultiParamTypeClasses #-}</code>
<code class="kr">import</code> <code class="nn">Yesod</code>
<code class="kr">import</code> <code class="nn">Database.Persist.Sqlite</code>

<code class="cm">-- Define our entities as usual</code>
<code class="nf">share</code> <code class="p">[</code><code class="n">mkPersist</code> <code class="n">sqlSettings</code><code class="p">,</code> <code class="n">mkMigrate</code> <code class="s">"migrateAll"</code><code class="p">]</code> <code class="p">[</code><code class="n">persist</code><code class="o">|</code>
<code class="kt">Person</code>
    <code class="n">firstName</code> <code class="kt">String</code>
    <code class="n">lastName</code> <code class="kt">String</code>
    <code class="n">age</code> <code class="kt">Int</code> <code class="kt">Gt</code> <code class="kt">Desc</code>
<code class="o">|</code><code class="p">]</code>

<code class="cm">-- We keep our connection pool in the foundation. At program initialization, we</code>
<code class="cm">-- create our initial pool, and each time we need to perform an action we check</code>
<code class="cm">-- out a single connection from the pool.</code>
<code class="kr">data</code> <code class="kt">PersistTest</code> <code class="ow">=</code> <code class="kt">PersistTest</code> <code class="kt">ConnectionPool</code>

<code class="cm">-- We'll create a single route, to access a person. It's a very common</code>
<code class="cm">-- occurrence to use an Id type in routes.</code>
<code class="nf">mkYesod</code> <code class="s">"PersistTest"</code> <code class="p">[</code><code class="n">parseRoutes</code><code class="o">|</code>
<code class="o">/</code><code class="n">person</code><code class="o">/#</code><code class="kt">PersonId</code> <code class="kt">PersonR</code> <code class="kt">GET</code>
<code class="o">|</code><code class="p">]</code>

<code class="cm">-- Nothing special here</code>
<code class="kr">instance</code> <code class="kt">Yesod</code> <code class="kt">PersistTest</code>

<code class="cm">-- Now we need to define a YesodPersist instance, which will keep track of</code>
<code class="cm">-- which backend we're using and how to run an action.</code>
<code class="kr">instance</code> <code class="kt">YesodPersist</code> <code class="kt">PersistTest</code> <code class="kr">where</code>
    <code class="kr">type</code> <code class="kt">YesodPersistBackend</code> <code class="kt">PersistTest</code> <code class="ow">=</code> <code class="kt">SqlPersist</code>

    <code class="n">runDB</code> <code class="n">action</code> <code class="ow">=</code> <code class="kr">do</code>
        <code class="kt">PersistTest</code> <code class="n">pool</code> <code class="ow">&lt;-</code> <code class="n">getYesod</code>
        <code class="n">runSqlPool</code> <code class="n">action</code> <code class="n">pool</code>

<code class="cm">-- We'll just return the show value of a person, or a 404 if the Person doesn't</code>
<code class="cm">-- exist.</code>
<code class="nf">getPersonR</code> <code class="ow">::</code> <code class="kt">PersonId</code> <code class="ow">-&gt;</code> <code class="kt">Handler</code> <code class="kt">RepPlain</code>
<code class="nf">getPersonR</code> <code class="n">personId</code> <code class="ow">=</code> <code class="kr">do</code>
    <code class="n">person</code> <code class="ow">&lt;-</code> <code class="n">runDB</code> <code class="o">$</code> <code class="n">get404</code> <code class="n">personId</code>
    <code class="n">return</code> <code class="o">$</code> <code class="kt">RepPlain</code> <code class="o">$</code> <code class="n">toContent</code> <code class="o">$</code> <code class="n">show</code> <code class="n">person</code>

<code class="nf">openConnectionCount</code> <code class="ow">::</code> <code class="kt">Int</code>
<code class="nf">openConnectionCount</code> <code class="ow">=</code> <code class="mi">10</code>

<code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="nf">main</code> <code class="ow">=</code> <code class="n">withSqlitePool</code> <code class="s">"test.db3"</code> <code class="n">openConnectionCount</code> <code class="o">$</code> <code class="nf">\</code><code class="n">pool</code> <code class="ow">-&gt;</code> <code class="kr">do</code>
    <code class="n">runSqlPool</code> <code class="p">(</code><code class="n">runMigration</code> <code class="n">migrateAll</code><code class="p">)</code> <code class="n">pool</code>
    <code class="n">runSqlPool</code> <code class="p">(</code><code class="n">insert</code> <code class="o">$</code> <code class="kt">Person</code> <code class="s">"Michael"</code> <code class="s">"Snoyman"</code> <code class="mi">26</code><code class="p">)</code> <code class="n">pool</code>
    <code class="n">warpDebug</code> <code class="mi">3000</code> <code class="o">$</code> <code class="kt">PersistTest</code> <code class="n">pool</code>
</pre><p class="calibre7">There are two important pieces here for general use. <code class="literal">runDB</code> is used to run a DB action from within a <code class="literal">Handler</code>. Within the <code class="literal">runDB</code>, you can use any of
      the functions we’ve spoken about so far, such as <code class="literal">insert</code> and
        <code class="literal">selectList</code>.</p><div class="tip" title="Note"><h3 class="title3">Note</h3><p class="calibre7">The type of <code class="literal">runDB</code> is <code class="literal">runDB :: YesodDB sub master a -&gt; GHandler
                sub master a</code>. <code class="literal">YesodDB</code> is defined
            as:<a id="I_programlisting10_d1e5942" class="firstname"></a></p><pre class="programlisting"><code class="kr">type</code> <code class="kt">YesodDB</code> <code class="n">sub</code> <code class="n">master</code> <code class="ow">=</code> <code class="kt">YesodPersistBackend</code> <code class="n">master</code> <code class="p">(</code><code class="kt">GHandler</code> <code class="n">sub</code> <code class="n">master</code><code class="p">)</code>
</pre><p class="calibre7">Since
            it is built on top of the <code class="literal">YesodPersistBackend</code> associated type, it uses
            the appropriate database backend based on the current site.</p></div><p class="calibre7">The other new feature is <code class="literal">get404</code>. It works just like
        <code class="literal">get</code>, but instead of returning a <code class="literal">Nothing</code> when a result can’t be found, it returns a 404 message page. The <code class="literal">getPersonR</code> function is a very common approach used in real-world
      Yesod applications: <code class="literal">get404</code> a value and then return a
      response based on it.</p></div></div>

{% endraw %}

