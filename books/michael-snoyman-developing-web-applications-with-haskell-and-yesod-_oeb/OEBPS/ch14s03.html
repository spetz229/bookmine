---
layout: page
title: "Developing Web Applications with Haskell and Yesod"
prev: OEBPS/ch14s02.html
next: OEBPS/ch14s04.html
book_path: books/michael-snoyman-developing-web-applications-with-haskell-and-yesod-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="book" title="Email"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="I_sect13_d1e7146" class="calibre1"></a>Email</h1></div></div></div><p class="calibre7"></p><p class="calibre7">For many use cases, third-party authentication of email will be sufficient. Occasionally,
            you’ll want users to actually create passwords on your site. The scaffolded site does
            not include this setup, because:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre7">In order to securely accept passwords, you need to be running over SSL. Many users are not
    serving their sites over SSL.</p></li><li class="listitem"><p class="calibre7">While the email backend properly salts and hashes passwords, a compromised database could
    still be problematic. Again, we make no assumptions that Yesod users are following secure
    deployment practices.</p></li><li class="listitem"><p class="calibre7">You need to have a working system for sending email. Many web servers these days are
                not equipped to deal with all of the spam protection measures used by mail
                    servers.</p><div class="tip" title="Note"><h3 class="title3">Note</h3><p class="calibre7">The example below will use the system’s built-in <em class="calibre4">sendmail</em>
                            executable. If you would like to avoid the hassle of dealing with an
                            email server yourself, you can use Amazon SES. There is a package called
                                <code class="function">mime-mail-ses</code>, which provides a
                            drop-in replacement for the sendmail code used below. This is the
                            approach we use on the Haskellers.com site.</p></div></li></ul></div><p class="calibre7">But assuming you are able to meet these demands, and you want to have a separate password
            login specifically for your site, Yesod offers a built-in backend. It requires quite a
            bit of code to set up, since it needs to store passwords securely in the database and
            send a number of different emails to users
            (account
            verification, password retrieval, etc.).</p><p class="calibre7">Let’s have a look at a site that provides email authentication, storing passwords in a
            Persistent SQLite database.</p><a id="I_programlisting3_d1e7179" class="firstname"></a><pre class="programlistinghaskell"><code class="cm">{-# LANGUAGE OverloadedStrings, TypeFamilies, QuasiQuotes, GADTs,</code>
<code class="cm">             TemplateHaskell, MultiParamTypeClasses, FlexibleContexts #-}</code>
<code class="kr">import</code> <code class="nn">Yesod</code>
<code class="kr">import</code> <code class="nn">Yesod.Auth</code>
<code class="kr">import</code> <code class="nn">Yesod.Auth.Email</code>
<code class="kr">import</code> <code class="nn">Database.Persist.Sqlite</code>
<code class="kr">import</code> <code class="nn">Database.Persist.TH</code>
<code class="kr">import</code> <code class="nn">Data.Text</code> <code class="p">(</code><code class="kt">Text</code><code class="p">)</code>
<code class="kr">import</code> <code class="nn">Network.Mail.Mime</code>
<code class="kr">import</code> <code class="kr">qualified</code> <code class="nn">Data.Text.Lazy.Encoding</code>
<code class="kr">import</code> <code class="nn">Text.Shakespeare.Text</code> <code class="p">(</code><code class="nf">stext</code><code class="p">)</code>
<code class="kr">import</code> <code class="nn">Text.Blaze.Renderer.Utf8</code> <code class="p">(</code><code class="nf">renderHtml</code><code class="p">)</code>
<code class="kr">import</code> <code class="nn">Text.Hamlet</code> <code class="p">(</code><code class="nf">shamlet</code><code class="p">)</code>
<code class="kr">import</code> <code class="nn">Data.Maybe</code> <code class="p">(</code><code class="nf">isJust</code><code class="p">)</code>
<code class="kr">import</code> <code class="nn">Control.Monad</code> <code class="p">(</code><code class="nf">join</code><code class="p">)</code>

<code class="nf">share</code> <code class="p">[</code><code class="n">mkPersist</code> <code class="n">sqlSettings</code><code class="p">,</code> <code class="n">mkMigrate</code> <code class="s">"migrateAll"</code><code class="p">]</code> <code class="p">[</code><code class="n">persist</code><code class="o">|</code>
<code class="kt">User</code>
    <code class="n">email</code> <code class="kt">Text</code>
    <code class="n">password</code> <code class="kt">Text</code> <code class="kt">Maybe</code> <code class="cm">-- Password may not be set yet</code>
    <code class="n">verkey</code> <code class="kt">Text</code> <code class="kt">Maybe</code> <code class="cm">-- Used for resetting passwords</code>
    <code class="n">verified</code> <code class="kt">Bool</code>
    <code class="kt">UniqueUser</code> <code class="n">email</code>
<code class="o">|</code><code class="p">]</code>

<code class="kr">data</code> <code class="kt">MyEmailApp</code> <code class="ow">=</code> <code class="kt">MyEmailApp</code> <code class="kt">Connection</code>

<code class="nf">mkYesod</code> <code class="s">"MyEmailApp"</code> <code class="p">[</code><code class="n">parseRoutes</code><code class="o">|</code>
<code class="o">/</code> <code class="kt">RootR</code> <code class="kt">GET</code>
<code class="o">/</code><code class="n">auth</code> <code class="kt">AuthR</code> <code class="kt">Auth</code> <code class="n">getAuth</code>
<code class="o">|</code><code class="p">]</code>

<code class="kr">instance</code> <code class="kt">Yesod</code> <code class="kt">MyEmailApp</code> <code class="kr">where</code>
    <code class="cm">-- Emails will include links, so be sure to include an approot so that</code>
    <code class="cm">-- the links are valid!</code>
    <code class="n">approot</code> <code class="ow">=</code> <code class="kt">ApprootStatic</code> <code class="s">"http://localhost:3000"</code>

<code class="kr">instance</code> <code class="kt">RenderMessage</code> <code class="kt">MyEmailApp</code> <code class="kt">FormMessage</code> <code class="kr">where</code>
    <code class="n">renderMessage</code> <code class="kr">_</code> <code class="kr">_</code> <code class="ow">=</code> <code class="n">defaultFormMessage</code>

<code class="cm">-- Set up Persistent</code>
<code class="kr">instance</code> <code class="kt">YesodPersist</code> <code class="kt">MyEmailApp</code> <code class="kr">where</code>
    <code class="kr">type</code> <code class="kt">YesodPersistBackend</code> <code class="kt">MyEmailApp</code> <code class="ow">=</code> <code class="kt">SqlPersist</code>
    <code class="n">runDB</code> <code class="n">f</code> <code class="ow">=</code> <code class="kr">do</code>
        <code class="kt">MyEmailApp</code> <code class="n">conn</code> <code class="ow">&lt;-</code> <code class="n">getYesod</code>
        <code class="n">runSqlConn</code> <code class="n">f</code> <code class="n">conn</code>

<code class="kr">instance</code> <code class="kt">YesodAuth</code> <code class="kt">MyEmailApp</code> <code class="kr">where</code>
    <code class="kr">type</code> <code class="kt">AuthId</code> <code class="kt">MyEmailApp</code> <code class="ow">=</code> <code class="kt">UserId</code>

    <code class="n">loginDest</code> <code class="kr">_</code> <code class="ow">=</code> <code class="kt">RootR</code>
    <code class="n">logoutDest</code> <code class="kr">_</code> <code class="ow">=</code> <code class="kt">RootR</code>
    <code class="n">authPlugins</code> <code class="kr">_</code> <code class="ow">=</code> <code class="p">[</code><code class="n">authEmail</code><code class="p">]</code>

    <code class="cm">-- Need to find the UserId for the given email address.</code>
    <code class="n">getAuthId</code> <code class="n">creds</code> <code class="ow">=</code> <code class="n">runDB</code> <code class="o">$</code> <code class="kr">do</code>
        <code class="n">x</code> <code class="ow">&lt;-</code> <code class="n">insertBy</code> <code class="o">$</code> <code class="kt">User</code> <code class="p">(</code><code class="n">credsIdent</code> <code class="n">creds</code><code class="p">)</code> <code class="kt">Nothing</code> <code class="kt">Nothing</code> <code class="kt">False</code>
        <code class="n">return</code> <code class="o">$</code> <code class="kt">Just</code> <code class="o">$</code>
            <code class="kr">case</code> <code class="n">x</code> <code class="kr">of</code>
                <code class="kt">Left</code> <code class="p">(</code><code class="kt">Entity</code> <code class="n">userid</code> <code class="kr">_</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">userid</code> <code class="cm">-- newly added user</code>
                <code class="kt">Right</code> <code class="n">userid</code> <code class="ow">-&gt;</code> <code class="n">userid</code> <code class="cm">-- existing user</code>

    <code class="n">authHttpManager</code> <code class="ow">=</code> <code class="ne">error</code> <code class="s">"Email doesn't need an HTTP manager"</code>

<code class="cm">-- Here's all of the email-specific code</code>
<code class="kr">instance</code> <code class="kt">YesodAuthEmail</code> <code class="kt">MyEmailApp</code> <code class="kr">where</code>
    <code class="kr">type</code> <code class="kt">AuthEmailId</code> <code class="kt">MyEmailApp</code> <code class="ow">=</code> <code class="kt">UserId</code>

    <code class="n">addUnverified</code> <code class="n">email</code> <code class="n">verkey</code> <code class="ow">=</code>
        <code class="n">runDB</code> <code class="o">$</code> <code class="n">insert</code> <code class="o">$</code> <code class="kt">User</code> <code class="n">email</code> <code class="kt">Nothing</code> <code class="p">(</code><code class="kt">Just</code> <code class="n">verkey</code><code class="p">)</code> <code class="kt">False</code>

    <code class="n">sendVerifyEmail</code> <code class="n">email</code> <code class="kr">_</code> <code class="n">verurl</code> <code class="ow">=</code>
        <code class="n">liftIO</code> <code class="o">$</code> <code class="n">renderSendMail</code> <code class="p">(</code><code class="n">emptyMail</code> <code class="o">$</code> <code class="kt">Address</code> <code class="kt">Nothing</code> <code class="s">"noreply"</code><code class="p">)</code>
            <code class="p">{</code> <code class="n">mailTo</code> <code class="ow">=</code> <code class="p">[</code><code class="kt">Address</code> <code class="kt">Nothing</code> <code class="n">email</code><code class="p">]</code>
            <code class="p">,</code> <code class="n">mailHeaders</code> <code class="ow">=</code>
                <code class="p">[</code> <code class="p">(</code><code class="s">"Subject"</code><code class="p">,</code> <code class="s">"Verify your email address"</code><code class="p">)</code>
                <code class="p">]</code>
            <code class="p">,</code> <code class="n">mailParts</code> <code class="ow">=</code> <code class="p">[[</code><code class="n">textPart</code><code class="p">,</code> <code class="n">htmlPart</code><code class="p">]]</code>
            <code class="p">}</code>
      <code class="kr">where</code>
        <code class="n">textPart</code> <code class="ow">=</code> <code class="kt">Part</code>
            <code class="p">{</code> <code class="n">partType</code> <code class="ow">=</code> <code class="s">"text/plain; charset=utf-8"</code>
            <code class="p">,</code> <code class="n">partEncoding</code> <code class="ow">=</code> <code class="kt">None</code>
            <code class="p">,</code> <code class="n">partFilename</code> <code class="ow">=</code> <code class="kt">Nothing</code>
            <code class="p">,</code> <code class="n">partContent</code> <code class="ow">=</code> <code class="kt">Data</code><code class="o">.</code><code class="kt">Text</code><code class="o">.</code><code class="kt">Lazy</code><code class="o">.</code><code class="kt">Encoding</code><code class="o">.</code><code class="n">encodeUtf8</code> <code class="p">[</code><code class="n">stext</code><code class="o">|</code>
<code class="kt">Please</code> <code class="n">confirm</code> <code class="n">your</code> <code class="n">email</code> <code class="n">address</code> <code class="n">by</code> <code class="n">clicking</code> <code class="n">on</code> <code class="n">the</code> <code class="n">link</code> <code class="n">below</code><code class="o">.</code>

<code class="o">\#</code><code class="p">{</code><code class="n">verurl</code><code class="p">}</code>

<code class="kt">Thank</code> <code class="n">you</code>
<code class="o">|</code><code class="p">]</code>
            <code class="p">,</code> <code class="n">partHeaders</code> <code class="ow">=</code> <code class="kt">[]</code>
            <code class="p">}</code>
        <code class="n">htmlPart</code> <code class="ow">=</code> <code class="kt">Part</code>
            <code class="p">{</code> <code class="n">partType</code> <code class="ow">=</code> <code class="s">"text/html; charset=utf-8"</code>
            <code class="p">,</code> <code class="n">partEncoding</code> <code class="ow">=</code> <code class="kt">None</code>
            <code class="p">,</code> <code class="n">partFilename</code> <code class="ow">=</code> <code class="kt">Nothing</code>
            <code class="p">,</code> <code class="n">partContent</code> <code class="ow">=</code> <code class="n">renderHtml</code> <code class="p">[</code><code class="n">shamlet</code><code class="o">|</code>
<code class="o">&lt;</code><code class="n">p</code><code class="o">&gt;</code><code class="kt">Please</code> <code class="n">confirm</code> <code class="n">your</code> <code class="n">email</code> <code class="n">address</code> <code class="n">by</code> <code class="n">clicking</code> <code class="n">on</code> <code class="n">the</code> <code class="n">link</code> <code class="n">below</code><code class="o">.</code>
<code class="o">&lt;</code><code class="n">p</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="n">a</code> <code class="n">href</code><code class="o">=#</code><code class="p">{</code><code class="n">verurl</code><code class="p">}</code><code class="o">&gt;#</code><code class="p">{</code><code class="n">verurl</code><code class="p">}</code>
<code class="o">&lt;</code><code class="n">p</code><code class="o">&gt;</code><code class="kt">Thank</code> <code class="n">you</code>
<code class="o">|</code><code class="p">]</code>
            <code class="p">,</code> <code class="n">partHeaders</code> <code class="ow">=</code> <code class="kt">[]</code>
            <code class="p">}</code>
    <code class="n">getVerifyKey</code> <code class="ow">=</code> <code class="n">runDB</code> <code class="o">.</code> <code class="n">fmap</code> <code class="p">(</code><code class="n">join</code> <code class="o">.</code> <code class="n">fmap</code> <code class="n">userVerkey</code><code class="p">)</code> <code class="o">.</code> <code class="n">get</code>
    <code class="n">setVerifyKey</code> <code class="n">uid</code> <code class="n">key</code> <code class="ow">=</code> <code class="n">runDB</code> <code class="o">$</code> <code class="n">update</code> <code class="n">uid</code> <code class="p">[</code><code class="kt">UserVerkey</code> <code class="o">=.</code> <code class="kt">Just</code> <code class="n">key</code><code class="p">]</code>
    <code class="n">verifyAccount</code> <code class="n">uid</code> <code class="ow">=</code> <code class="n">runDB</code> <code class="o">$</code> <code class="kr">do</code>
        <code class="n">mu</code> <code class="ow">&lt;-</code> <code class="n">get</code> <code class="n">uid</code>
        <code class="kr">case</code> <code class="n">mu</code> <code class="kr">of</code>
            <code class="kt">Nothing</code> <code class="ow">-&gt;</code> <code class="n">return</code> <code class="kt">Nothing</code>
            <code class="kt">Just</code> <code class="n">u</code> <code class="ow">-&gt;</code> <code class="kr">do</code>
                <code class="n">update</code> <code class="n">uid</code> <code class="p">[</code><code class="kt">UserVerified</code> <code class="o">=.</code> <code class="kt">True</code><code class="p">]</code>
                <code class="n">return</code> <code class="o">$</code> <code class="kt">Just</code> <code class="n">uid</code>
    <code class="n">getPassword</code> <code class="ow">=</code> <code class="n">runDB</code> <code class="o">.</code> <code class="n">fmap</code> <code class="p">(</code><code class="n">join</code> <code class="o">.</code> <code class="n">fmap</code> <code class="n">userPassword</code><code class="p">)</code> <code class="o">.</code> <code class="n">get</code>
    <code class="n">setPassword</code> <code class="n">uid</code> <code class="n">pass</code> <code class="ow">=</code> <code class="n">runDB</code> <code class="o">$</code> <code class="n">update</code> <code class="n">uid</code> <code class="p">[</code><code class="kt">UserPassword</code> <code class="o">=.</code> <code class="kt">Just</code> <code class="n">pass</code><code class="p">]</code>
    <code class="n">getEmailCreds</code> <code class="n">email</code> <code class="ow">=</code> <code class="n">runDB</code> <code class="o">$</code> <code class="kr">do</code>
        <code class="n">mu</code> <code class="ow">&lt;-</code> <code class="n">getBy</code> <code class="o">$</code> <code class="kt">UniqueUser</code> <code class="n">email</code>
        <code class="kr">case</code> <code class="n">mu</code> <code class="kr">of</code>
            <code class="kt">Nothing</code> <code class="ow">-&gt;</code> <code class="n">return</code> <code class="kt">Nothing</code>
            <code class="kt">Just</code> <code class="p">(</code><code class="kt">Entity</code> <code class="n">uid</code> <code class="n">u</code><code class="p">)</code> <code class="ow">-&gt;</code> <code class="n">return</code> <code class="o">$</code> <code class="kt">Just</code> <code class="kt">EmailCreds</code>
                <code class="p">{</code> <code class="n">emailCredsId</code> <code class="ow">=</code> <code class="n">uid</code>
                <code class="p">,</code> <code class="n">emailCredsAuthId</code> <code class="ow">=</code> <code class="kt">Just</code> <code class="n">uid</code>
                <code class="p">,</code> <code class="n">emailCredsStatus</code> <code class="ow">=</code> <code class="n">isJust</code> <code class="o">$</code> <code class="n">userPassword</code> <code class="n">u</code>
                <code class="p">,</code> <code class="n">emailCredsVerkey</code> <code class="ow">=</code> <code class="n">userVerkey</code> <code class="n">u</code>
                <code class="p">}</code>
    <code class="n">getEmail</code> <code class="ow">=</code> <code class="n">runDB</code> <code class="o">.</code> <code class="n">fmap</code> <code class="p">(</code><code class="n">fmap</code> <code class="n">userEmail</code><code class="p">)</code> <code class="o">.</code> <code class="n">get</code>

<code class="nf">getRootR</code> <code class="ow">::</code> <code class="kt">Handler</code> <code class="kt">RepHtml</code>
<code class="nf">getRootR</code> <code class="ow">=</code> <code class="kr">do</code>
    <code class="n">maid</code> <code class="ow">&lt;-</code> <code class="n">maybeAuthId</code>
    <code class="n">defaultLayout</code> <code class="p">[</code><code class="n">whamlet</code><code class="o">|</code>
<code class="o">&lt;</code><code class="n">p</code><code class="o">&gt;</code><code class="kt">Your</code> <code class="n">current</code> <code class="n">auth</code> <code class="kt">ID:</code> <code class="o">#</code><code class="p">{</code><code class="n">show</code> <code class="n">maid</code><code class="p">}</code>
<code class="o">$</code><code class="n">maybe</code> <code class="kr">_</code> <code class="ow">&lt;-</code> <code class="n">maid</code>
    <code class="o">&lt;</code><code class="n">p</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="n">a</code> <code class="n">href</code><code class="o">=@</code><code class="p">{</code><code class="kt">AuthR</code> <code class="kt">LogoutR</code><code class="p">}</code><code class="o">&gt;</code><code class="kt">Logout</code>
<code class="o">$</code><code class="n">nothing</code>
    <code class="o">&lt;</code><code class="n">p</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="n">a</code> <code class="n">href</code><code class="o">=@</code><code class="p">{</code><code class="kt">AuthR</code> <code class="kt">LoginR</code><code class="p">}</code><code class="o">&gt;</code><code class="kt">Go</code> <code class="n">to</code> <code class="n">the</code> <code class="n">login</code> <code class="n">page</code>
<code class="o">|</code><code class="p">]</code>

<code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="nf">main</code> <code class="ow">=</code> <code class="n">withSqliteConn</code> <code class="s">"email.db3"</code> <code class="o">$</code> <code class="nf">\</code><code class="n">conn</code> <code class="ow">-&gt;</code> <code class="kr">do</code>
    <code class="n">runSqlConn</code> <code class="p">(</code><code class="n">runMigration</code> <code class="n">migrateAll</code><code class="p">)</code> <code class="n">conn</code>
    <code class="n">warpDebug</code> <code class="mi">3000</code> <code class="o">$</code> <code class="kt">MyEmailApp</code> <code class="n">conn</code>
</pre></div></div>

{% endraw %}

