---
layout: page
title: "Developing Web Applications with Haskell and Yesod"
prev: OEBPS/ch13s02.html
next: OEBPS/ch13s04.html
book_path: books/michael-snoyman-developing-web-applications-with-haskell-and-yesod-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="book" title="Example: Database-Driven Navbar"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="I_sect12_d1e6838" class="calibre1"></a>Example: Database-Driven Navbar</h1></div></div></div><p class="calibre7">Let’s put some of this new knowledge into action. We want to create a <code class="literal">Widget</code> that generates its output based on the contents of
            the database. Previously, our approach would have been to load up the data in a <code class="literal">Handler</code>, and then pass that data into a <code class="literal">Widget</code>. Now, we’ll do the loading of data in the <code class="literal">Widget</code> itself. This is a boon for modularity, as this
                <code class="literal">Widget</code> can be used in any <code class="literal">Handler</code> we want, without any need to pass in the database
            contents.</p><a id="I_programlisting2_d1e6865" class="firstname"></a><pre class="programlistinghaskell"><code class="cm">{-# LANGUAGE OverloadedStrings, TypeFamilies, TemplateHaskell, FlexibleContexts,</code>
<code class="cm">             QuasiQuotes, TypeFamilies, MultiParamTypeClasses, GADTs #-}</code>
<code class="kr">import</code> <code class="nn">Yesod</code>
<code class="kr">import</code> <code class="nn">Database.Persist.Sqlite</code>
<code class="kr">import</code> <code class="nn">Data.Text</code> <code class="p">(</code><code class="kt">Text</code><code class="p">)</code>
<code class="kr">import</code> <code class="nn">Data.Time</code>

<code class="nf">share</code> <code class="p">[</code><code class="n">mkPersist</code> <code class="n">sqlSettings</code><code class="p">,</code> <code class="n">mkMigrate</code> <code class="s">"migrateAll"</code><code class="p">]</code> <code class="p">[</code><code class="n">persist</code><code class="o">|</code>
<code class="kt">Link</code>
    <code class="n">title</code> <code class="kt">Text</code>
    <code class="n">url</code> <code class="kt">Text</code>
    <code class="n">added</code> <code class="kt">UTCTime</code>
<code class="o">|</code><code class="p">]</code>

<code class="kr">data</code> <code class="kt">LinksExample</code> <code class="ow">=</code> <code class="kt">LinksExample</code> <code class="kt">ConnectionPool</code>

<code class="nf">mkYesod</code> <code class="s">"LinksExample"</code> <code class="p">[</code><code class="n">parseRoutes</code><code class="o">|</code>
<code class="o">/</code> <code class="kt">RootR</code> <code class="kt">GET</code>
<code class="o">/</code><code class="n">add</code><code class="o">-</code><code class="n">link</code> <code class="kt">AddLinkR</code> <code class="kt">POST</code>
<code class="o">|</code><code class="p">]</code>

<code class="kr">instance</code> <code class="kt">Yesod</code> <code class="kt">LinksExample</code>

<code class="kr">instance</code> <code class="kt">RenderMessage</code> <code class="kt">LinksExample</code> <code class="kt">FormMessage</code> <code class="kr">where</code>
    <code class="n">renderMessage</code> <code class="kr">_</code> <code class="kr">_</code> <code class="ow">=</code> <code class="n">defaultFormMessage</code>

<code class="kr">instance</code> <code class="kt">YesodPersist</code> <code class="kt">LinksExample</code> <code class="kr">where</code>
    <code class="kr">type</code> <code class="kt">YesodPersistBackend</code> <code class="kt">LinksExample</code> <code class="ow">=</code> <code class="kt">SqlPersist</code>
    <code class="n">runDB</code> <code class="n">db</code> <code class="ow">=</code> <code class="kr">do</code>
        <code class="kt">LinksExample</code> <code class="n">pool</code> <code class="ow">&lt;-</code> <code class="n">getYesod</code>
        <code class="n">runSqlPool</code> <code class="n">db</code> <code class="n">pool</code>

<code class="nf">getRootR</code> <code class="ow">::</code> <code class="kt">Handler</code> <code class="kt">RepHtml</code>
<code class="nf">getRootR</code> <code class="ow">=</code> <code class="n">defaultLayout</code> <code class="p">[</code><code class="n">whamlet</code><code class="o">|</code>
<code class="o">&lt;</code><code class="n">form</code> <code class="n">method</code><code class="ow">=</code><code class="n">post</code> <code class="n">action</code><code class="o">=@</code><code class="p">{</code><code class="kt">AddLinkR</code><code class="p">}</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="n">p</code><code class="o">&gt;</code>
        <code class="kt">Add</code> <code class="n">a</code> <code class="n">new</code> <code class="n">link</code> <code class="n">to</code> <code class="o">#</code>
        <code class="o">&lt;</code><code class="n">input</code> <code class="kr">type</code><code class="ow">=</code><code class="n">url</code> <code class="n">name</code><code class="ow">=</code><code class="n">url</code> <code class="n">value</code><code class="ow">=</code><code class="n">http</code><code class="kt">://&gt;</code>
        <code class="nf">\</code> <code class="n">titled</code> <code class="o">#</code>
        <code class="o">&lt;</code><code class="n">input</code> <code class="kr">type</code><code class="ow">=</code><code class="n">text</code> <code class="n">name</code><code class="ow">=</code><code class="n">title</code><code class="o">&gt;</code>
        <code class="nf">\</code> <code class="o">#</code>
        <code class="o">&lt;</code><code class="n">input</code> <code class="kr">type</code><code class="ow">=</code><code class="n">submit</code> <code class="n">value</code><code class="ow">=</code><code class="s">"Add link"</code><code class="o">&gt;</code>
<code class="o">&lt;</code><code class="n">h2</code><code class="o">&gt;</code><code class="kt">Existing</code> <code class="n">links</code>
<code class="o">^</code><code class="p">{</code><code class="n">existingLinks</code><code class="p">}</code>
<code class="o">|</code><code class="p">]</code>

<code class="nf">existingLinks</code> <code class="ow">::</code> <code class="kt">Widget</code>
<code class="nf">existingLinks</code> <code class="ow">=</code> <code class="kr">do</code>
    <code class="n">links</code> <code class="ow">&lt;-</code> <code class="n">lift</code> <code class="o">$</code> <code class="n">runDB</code> <code class="o">$</code> <code class="n">selectList</code> <code class="kt">[]</code> <code class="p">[</code><code class="kt">LimitTo</code> <code class="mi">5</code><code class="p">,</code> <code class="kt">Desc</code> <code class="kt">LinkAdded</code><code class="p">]</code>
    <code class="p">[</code><code class="n">whamlet</code><code class="o">|</code>
<code class="o">&lt;</code><code class="n">ul</code><code class="o">&gt;</code>
    <code class="o">$</code><code class="n">forall</code> <code class="kt">Entity</code> <code class="kr">_</code> <code class="n">link</code> <code class="ow">&lt;-</code> <code class="n">links</code>
        <code class="o">&lt;</code><code class="n">li</code><code class="o">&gt;</code>
            <code class="o">&lt;</code><code class="n">a</code> <code class="n">href</code><code class="o">=#</code><code class="p">{</code><code class="n">linkUrl</code> <code class="n">link</code><code class="p">}</code><code class="o">&gt;#</code><code class="p">{</code><code class="n">linkTitle</code> <code class="n">link</code><code class="p">}</code>
<code class="o">|</code><code class="p">]</code>

<code class="nf">postAddLinkR</code> <code class="ow">::</code> <code class="kt">Handler</code> <code class="nb">()</code>
<code class="nf">postAddLinkR</code> <code class="ow">=</code> <code class="kr">do</code>
    <code class="n">url</code> <code class="ow">&lt;-</code> <code class="n">runInputPost</code> <code class="o">$</code> <code class="n">ireq</code> <code class="n">urlField</code> <code class="s">"url"</code>
    <code class="n">title</code> <code class="ow">&lt;-</code> <code class="n">runInputPost</code> <code class="o">$</code> <code class="n">ireq</code> <code class="n">textField</code> <code class="s">"title"</code>
    <code class="n">now</code> <code class="ow">&lt;-</code> <code class="n">liftIO</code> <code class="n">getCurrentTime</code>
    <code class="n">runDB</code> <code class="o">$</code> <code class="n">insert</code> <code class="o">$</code> <code class="kt">Link</code> <code class="n">title</code> <code class="n">url</code> <code class="n">now</code>
    <code class="n">setMessage</code> <code class="s">"Link added"</code>
    <code class="n">redirect</code> <code class="kt">RootR</code>

<code class="nf">main</code> <code class="ow">::</code> <code class="kt">IO</code> <code class="nb">()</code>
<code class="nf">main</code> <code class="ow">=</code> <code class="n">withSqlitePool</code> <code class="s">"links.db3"</code> <code class="mi">10</code> <code class="o">$</code> <code class="nf">\</code><code class="n">pool</code> <code class="ow">-&gt;</code> <code class="kr">do</code>
    <code class="n">runSqlPool</code> <code class="p">(</code><code class="n">runMigration</code> <code class="n">migrateAll</code><code class="p">)</code> <code class="n">pool</code>
    <code class="n">warpDebug</code> <code class="mi">3000</code> <code class="o">$</code> <code class="kt">LinksExample</code> <code class="n">pool</code>
</pre><p class="calibre7">Pay attention in particular to the <code class="literal">existingLinks</code> function.
            Notice how all we needed to do was apply <code class="literal">lift</code> to a normal
            database action. And from within <code class="literal">getRootR</code>, we treated <code class="literal">existingLinks</code> like any ordinary <code class="literal">Widget</code>,
            no special parameters at all. See the figure for the output of this app.</p><div class="book"><div class="figure"><a id="navbar-x-14" class="firstname"></a><div class="book"><div class="book"><a id="I_mediaobject2_d1e6887" class="firstname"></a><img src="httpatomoreillycomsourceoreillyimages1137541.png" alt="Screenshot of the navbar" class="calibre5"/></div></div><p class="title7">Figure 13-1. Screenshot of the navbar</p></div></div></div></div>

{% endraw %}

