---
layout: page
title: "Understanding the Linux Kernel, 3rd Edition"
prev: understandlk-APP-B-SECT-2.html
next: understandlk-APP-B-SECT-4.html
book_path: books/understanding-the-linux-kernel-rd-edition_oeb/
---
{% include JB/setup %}
{% raw %}
<div>


<a name="understandlk-APP-B-SECT-3"></a>
<h3 class="docSection1Title">B.3. Linking and Unlinking Modules</h3><a name="IDX-APP-B-0064"></a>
<a name="IDX-APP-B-0065"></a>
<a name="IDX-APP-B-0066"></a>
<a name="IDX-APP-B-0067"></a>
<a name="IDX-APP-B-0068"></a>
<a name="IDX-APP-B-0069"></a>
<a name="IDX-APP-B-0070"></a>
<p class="docText1">A user can link a module into the running kernel by executing the <i class="docEmphasis">insmod</i> external program. This program performs the following operations:</p>
<div class="calibre44"><ol class="docList1" type="1"><li class="calibre12"><div class="calibre45"><p class="docList">Reads from the command line the name of the module to be linked.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Locates the file containing the module's object code in the system directory tree. The file is usually placed in some subdirectory below <i class="docEmphasis">/lib/modules</i>.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Reads from disk the file containing the module's object code.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Invokes the <tt class="calibre25">init_module( )</tt> system call, passing to it the address of the User Mode buffer containing the module's object code, the length of the object code, and the User Mode memory area containing the parameters of the <i class="docEmphasis">insmod</i> program.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Terminates.</p></div></li></ol></div>
<p class="docText1">The <tt class="calibre25">sys_init_module( )</tt> service routine does all the real work; it performs the following main operations:</p>
<div class="calibre44"><ol class="docList1" type="1"><li class="calibre12"><div class="calibre45"><p class="docList">Checks whether the user is allowed to link the module (the current process must have the <tt class="calibre25">CAP_SYS_MODULE</tt> capability). In every situation where one is adding functionality to a kernel, which has access to all data and processes on the system, security is a paramount concern.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Allocates a temporary memory area for the module's object code; then, copies into this memory area the data in the User Mode buffer passed as first parameter of the system call.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Checks that the data in the memory area effectively represents a module's ELF object; otherwise, returns an error code.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Allocates a memory area for the parameters passed to the <i class="docEmphasis">insmod</i> program, and fills it with the data in the User Mode buffer whose address was passed as third parameter of the system call.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Walks the <tt class="calibre25">modules</tt> list to verify that the module is not already linked. The check is done by comparing the names of the modules (<tt class="calibre25">name</tt> field in the <tt class="calibre25">module</tt> objects).</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Allocates a memory area for the core executable code of the module, and fills it with the contents of the relevant sections of the module.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Allocates a memory area for the initialization code of the module, and fills it with the contents of the relevant sections of the module.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Determines the address of the <tt class="calibre25">module</tt> object for the new module. An image of this object is included in the <tt class="calibre25">gnu.linkonce.this_module</tt> section of the text segment of the module's ELF file. The <tt class="calibre25">module</tt> object is thus included in the memory area filled in step 6.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Stores in the <tt class="calibre25">module_code</tt> and <tt class="calibre25">module_init</tt> fields of the <tt class="calibre25">module</tt> object the addresses of the memory areas allocated in steps 6 and 7.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Initializes the <tt class="calibre25">modules_which_use_me</tt> list in the <tt class="calibre25">module</tt> object, and sets to zero all module's reference counters except the counter of the executing CPU, which is set to one.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Sets the <tt class="calibre25">license_gplok</tt> flag in the <tt class="calibre25">module</tt> object according to the type of license specified in the module object.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Using the kernel symbol tables and the module symbol tables, relocates the module's object code. This means replacing all occurrences of external and global symbols with the corresponding logical address offsets.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Initializes the <tt class="calibre25">syms</tt> and <tt class="calibre25">gpl_syms</tt> fields of the <tt class="calibre25">module</tt> object so that they point to the in-memory tables of symbols exported by the module.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">The exception table of the module (see the section "<a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-10-SECT-4.html#understandlk-CHP-10-SECT-4.4">The Exception Tables</a>" in <a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-10.html#understandlk-CHP-10">Chapter 10</a>) is contained in the <tt class="calibre25">_ _ex_table</tt> section of the module's ELF file, thus it was copied into the memory area allocated in step 6: stores its address in the <tt class="calibre25">extable</tt> field of the <tt class="calibre25">module</tt> object.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Parses the arguments of the <i class="docEmphasis">insmod</i> program, and sets the value of the corresponding module variables accordingly.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Registers the kobject included in the <tt class="calibre25">mkobj</tt> field of the <tt class="calibre25">module</tt> object so that a new sub-directory for the module appears in the <i class="docEmphasis">module</i> directory of the <i class="docEmphasis">sysfs</i><a name="IDX-APP-B-0071"></a> 
 special filesystem (see the section "<a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-13-SECT-2.html#understandlk-CHP-13-SECT-2.2">Kobjects</a>" in <a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-13.html#understandlk-CHP-13">Chapter 13</a>).</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Frees the temporary memory area allocated in step 2.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Adds the <tt class="calibre25">module</tt> object in the <tt class="calibre25">modules</tt> list.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Sets the state of the module to <tt class="calibre25">MODULE_STATE_COMING</tt>.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">If defined, executes the <tt class="calibre25">init</tt> method of the <tt class="calibre25">module</tt> object.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Sets the state of the module to <tt class="calibre25">MODULE_STATE_LIVE</tt>.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Terminates by returning zero (success).</p></div></li></ol></div>
<p class="docText1">To unlink a module, a user invokes the <i class="docEmphasis">rmmod</i> external program, which performs the following operations:</p>
<div class="calibre44"><ol class="docList1" type="1"><li class="calibre12"><div class="calibre45"><p class="docList">Reads from the command line the name of the module to be unlinked.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Opens the <i class="docEmphasis">/proc/modules</i> file, which lists all modules linked into the kernel, and checks that the module to be removed is effectively linked.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Invokes the <tt class="calibre25">delete_module( )</tt><a name="IDX-APP-B-0072"></a> 
 system call passing to it the name of the module.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Terminates.</p></div></li></ol></div>
<p class="docText1">In turn, the <tt class="calibre25">sys_delete_module( )</tt> service routine performs the following main operations:</p>
<div class="calibre44"><ol class="docList1" type="1"><li class="calibre12"><div class="calibre45"><p class="docList">Checks whether the user is allowed to unlink the module (the current process must have the <tt class="calibre25">CAP_SYS_MODULE</tt> capability).</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Copies the module's name in a kernel buffer.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Walks the <tt class="calibre25">modules</tt> list to find the <tt class="calibre25">module</tt> object of the module.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Checks the <tt class="calibre25">modules_which_use_me</tt> dependency list of the module; if it is not empty, the function returns an error code.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Checks the state of the module; if it is not <tt class="calibre25">MODULE_STATE_LIVE</tt>, returns an error code.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">If the module has a custom <tt class="calibre25">init</tt> method, the function checks that it has also a custom <tt class="calibre25">exit</tt> method; if no <tt class="calibre25">exit</tt> method is defined, the module should not be unloaded, thus returns an exit code.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">To avoid race conditions, stops the activities of all CPUs in the system, except the CPU executing the <tt class="calibre25">sys_delete_module( )</tt> service routine.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Sets the state of the module to <tt class="calibre25">MODULE_STATE_GOING</tt>.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">If the sum of all reference counters of the module is greater than zero, returns an error code.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">If defined, executes the <tt class="calibre25">exit</tt> method of the module.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Removes the <tt class="calibre25">module</tt> object from the <tt class="calibre25">modules</tt> list, and de-registers the module from the <i class="docEmphasis">sysfs</i> special filesystem.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Removes the <tt class="calibre25">module</tt> object from the dependency lists of the modules that it was using.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Frees the memory areas that contain the module's executable code, the <tt class="calibre25">module</tt> object, and the various symbol and exception tables.</p></div></li><li class="calibre12"><div class="calibre45"><p class="docList">Returns zero (success).</p></div></li></ol></div>

<br class="calibre7"/>

</div>

{% endraw %}

