---
layout: page
title: "Understanding the Linux Kernel, 3rd Edition"
prev: understandlk-CHP-12-SECT-2.html
next: understandlk-CHP-12-SECT-4.html
book_path: books/understanding-the-linux-kernel-rd-edition_oeb/
---
{% include JB/setup %}
{% raw %}
<div>


<a name="understandlk-CHP-12-SECT-3"></a>
<h3 class="docSection1Title" id="534871-896">12.3. Filesystem Types</h3><a name="IDX-CHP-12-3114"></a>
<p class="docText1">The Linux kernel supports many different types of<a name="IDX-CHP-12-3115"></a> 
 filesystems. In the following, we introduce a few special types of filesystems that play an important role in the internal design of the Linux kernel.</p>
<p class="docText1">Next, we'll discuss filesystem registrationthat is, the basic operation that must be performed, usually during system initialization, before using a filesystem type. Once a filesystem is registered, its specific functions are available to the kernel, so that type of filesystem can be mounted on the system's directory tree.</p>
<a name="understandlk-CHP-12-SECT-3.1"></a>
<h4 class="docSection2Title">12.3.1. Special Filesystems</h4>
<p class="docText1">While network and disk-based filesystems enable the user to handle information stored outside the kernel, special filesystems<a name="IDX-CHP-12-3116"></a> 
 may provide an easy way for system programs and administrators to manipulate the data structures of the kernel and to implement special features of the operating system. <a class="pcalibre5 docLink pcalibre1" href="#understandlk-CHP-12-TABLE-8">Table 12-8</a> lists the most common special filesystems used in Linux; for each of them, the table reports its suggested mount point and a short description.</p>
<p class="docText1">Notice that a few filesystems have no fixed mount point (keyword "any" in the table). These filesystems can be freely mounted and used by the users. Moreover, some other special filesystems do not have a mount point at all (keyword "none" in the table). They are not for user interaction, but the kernel can use them to easily reuse some of the VFS layer code; for instance, we'll see in <a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-19.html#understandlk-CHP-19">Chapter 19</a> that, thanks to the <span class="docEmphasis">pipefs</span><a name="IDX-CHP-12-3117"></a> 
 special filesystem, pipes can be treated in the same way as FIFO files.</p>
<a name="understandlk-CHP-12-TABLE-8"></a><p class="calibre14"><table cellspacing="0" frame="hsides" rules="all" cellpadding="4" width="100%" class="calibre15"><caption class="calibre33"><h5 class="docFigureTitle">Table 12-8. Most common special filesystems</h5></caption><colgroup class="calibre16"><col class="calibre17"/><col class="calibre17"/><col class="calibre17"/></colgroup><thead class="calibre18"><tr class="calibre34"><th class="thead" scope="col"><p class="docText1"><span class="calibre5">Name</span></p></th><th class="thead" scope="col"><p class="docText1"><span class="calibre5">Mount point</span></p></th><th class="thead" scope="col"><p class="docText1"><span class="calibre5">Description</span></p></th></tr></thead><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">bdev</span><a name="IDX-CHP-12-3118"></a>
</p></td><td class="docTableCell"><p class="docText2">none</p></td><td class="docTableCell"><p class="docText2">Block devices (see <a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-13.html#understandlk-CHP-13">Chapter 13</a>)</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">binfmt_misc</span><a name="IDX-CHP-12-3119"></a>
</p></td><td class="docTableCell"><p class="docText2">any</p></td><td class="docTableCell"><p class="docText2">Miscellaneous executable formats (see <a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-20.html#understandlk-CHP-20">Chapter 20</a>)</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">devpts</span><a name="IDX-CHP-12-3120"></a>
</p></td><td class="docTableCell"><p class="docText2"><span class="docEmphasis">/dev/pts</span></p></td><td class="docTableCell"><p class="docText2">Pseudoterminal support (Open Group's Unix98 standard)</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">eventpollfs</span><a name="IDX-CHP-12-3121"></a>
</p></td><td class="docTableCell"><p class="docText2">none</p></td><td class="docTableCell"><p class="docText2">Used by the efficient event polling mechanism</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">futexfs</span><a name="IDX-CHP-12-3122"></a>
</p></td><td class="docTableCell"><p class="docText2">none</p></td><td class="docTableCell"><p class="docText2">Used by the futex (Fast Userspace Locking) mechanism</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">pipefs</span></p></td><td class="docTableCell"><p class="docText2">none</p></td><td class="docTableCell"><p class="docText2">Pipes (see <a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-19.html#understandlk-CHP-19">Chapter 19</a>)</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">proc</span><a name="IDX-CHP-12-3123"></a>
</p></td><td class="docTableCell"><p class="docText2"><span class="docEmphasis">/proc</span></p></td><td class="docTableCell"><p class="docText2">General access point to kernel data structures</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">rootfs</span><a name="IDX-CHP-12-3124"></a>
</p></td><td class="docTableCell"><p class="docText2">none</p></td><td class="docTableCell"><p class="docText2">Provides an empty root directory for the bootstrap phase</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">shm</span><a name="IDX-CHP-12-3125"></a>
</p></td><td class="docTableCell"><p class="docText2">none</p></td><td class="docTableCell"><p class="docText2">IPC-shared memory regions (see <a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-19.html#understandlk-CHP-19">Chapter 19</a>)</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">mqueue</span><a name="IDX-CHP-12-3126"></a>
</p></td><td class="docTableCell"><p class="docText2">any</p></td><td class="docTableCell"><p class="docText2">Used to implement POSIX message queues<a name="IDX-CHP-12-3127"></a> 
 (see <a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-19.html#understandlk-CHP-19">Chapter 19</a>)</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">sockfs</span><a name="IDX-CHP-12-3128"></a>
</p></td><td class="docTableCell"><p class="docText2">none</p></td><td class="docTableCell"><p class="docText2">Sockets</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">sysfs</span><a name="IDX-CHP-12-3129"></a>
</p></td><td class="docTableCell"><p class="docText2"><span class="docEmphasis">/sys</span></p></td><td class="docTableCell"><p class="docText2">General access point to system data (see <a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-13.html#understandlk-CHP-13">Chapter 13</a>)</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">tmpfs</span><a name="IDX-CHP-12-3130"></a>
</p></td><td class="docTableCell"><p class="docText2">any</p></td><td class="docTableCell"><p class="docText2">Temporary files (kept in RAM unless swapped)</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><span class="docEmphasis">usbfs</span><a name="IDX-CHP-12-3131"></a>
</p></td><td class="docTableCell"><p class="docText2"><span class="docEmphasis">/proc/bus/usb</span></p></td><td class="docTableCell"><p class="docText2">USB devices</p></td></tr></table></p><br class="calibre7"/>
<p class="docText1">Special filesystems are not bound to physical block devices. However, the kernel assigns to each mounted special filesystem a fictitious block device that has the value 0 as major number and an arbitrary value (different for each special filesystem) as a minor number. The <tt class="calibre25">set_anon_super( )</tt> function is used to initialize superblocks of special filesystems; this function essentially gets an unused minor number <tt class="calibre25">dev</tt> and sets the <tt class="calibre25">s_dev</tt> field of the new superblock with major number 0 and minor number <tt class="calibre25">dev</tt>. Another function called <tt class="calibre25">kill_anon_super( )</tt> removes the superblock of a special filesystem. The <tt class="calibre25">unnamed_dev_idr</tt> variable includes pointers to auxiliary structures that record the minor numbers currently in use. Although some kernel designers dislike the fictitious block device identifiers, they help the kernel to handle special filesystems and regular ones in a uniform way.</p>
<p class="docText1">We'll see a practical example of how the kernel defines and initializes a special filesystem in the later section "<a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-12-SECT-4.html#understandlk-CHP-12-SECT-4.3">Mounting a Generic Filesystem</a>."</p>
<a name="understandlk-CHP-12-SECT-3.2"></a>
<h4 class="docSection2Title">12.3.2. Filesystem Type Registration</h4><a name="IDX-CHP-12-3132"></a>
<a name="IDX-CHP-12-3133"></a>
<a name="IDX-CHP-12-3134"></a>
<a name="IDX-CHP-12-3135"></a>
<p class="docText1">Often, the user configures Linux to recognize all the filesystems needed when compiling the kernel for his system. But the code for a filesystem actually may either be included in the kernel image or dynamically loaded as a module (see <a class="pcalibre5 docLink pcalibre1" href="understandlk-APP-B.html#understandlk-APP-B">Appendix B</a>). The VFS must keep track of all filesystem types whose code is currently included in the kernel. It does this by performing <span class="docEmphasis">filesystem type registration</span><a name="IDX-CHP-12-3136"></a>
<a name="IDX-CHP-12-3137"></a> 
.</p>
<p class="docText1">Each registered filesystem is represented as a <tt class="calibre25">file_system_type</tt> object whose fields are illustrated in <a class="pcalibre5 docLink pcalibre1" href="#understandlk-CHP-12-TABLE-9">Table 12-9</a>.</p>
<a name="understandlk-CHP-12-TABLE-9"></a><p class="calibre14"><table cellspacing="0" frame="hsides" rules="all" cellpadding="4" width="100%" class="calibre15"><caption class="calibre33"><h5 class="docFigureTitle">Table 12-9. The fields of the file_system_type object</h5></caption><colgroup class="calibre16"><col class="calibre17"/><col class="calibre17"/><col class="calibre17"/></colgroup><thead class="calibre18"><tr class="calibre34"><th class="thead" scope="col"><p class="docText1"><span class="calibre5">Type</span></p></th><th class="thead" scope="col"><p class="docText1"><span class="calibre5">Field</span></p></th><th class="thead" scope="col"><p class="docText1"><span class="calibre5">Description</span></p></th></tr></thead><tr class="calibre2"><td class="docTableCell"><p class="docText2"><tt class="calibre25">const char *</tt></p></td><td class="docTableCell"><p class="docText2"><tt class="calibre25">name</tt></p></td><td class="docTableCell"><p class="docText2">Filesystem name</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><tt class="calibre25">int</tt></p></td><td class="docTableCell"><p class="docText2"><tt class="calibre25">fs_flags</tt></p></td><td class="docTableCell"><p class="docText2">Filesystem type flags</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><tt class="calibre25">struct super_block * (*)( )</tt></p></td><td class="docTableCell"><p class="docText2"><tt class="calibre25">get_sb</tt></p></td><td class="docTableCell"><p class="docText2">Method for reading a superblock</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2">void (*)( )</p></td><td class="docTableCell"><p class="docText2">kill_sb</p></td><td class="docTableCell"><p class="docText2">Method for removing a superblock</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><tt class="calibre25">struct module *</tt></p></td><td class="docTableCell"><p class="docText2"><tt class="calibre25">owner</tt></p></td><td class="docTableCell"><p class="docText2">Pointer to the module implementing the filesystem (see <a class="pcalibre5 docLink pcalibre1" href="understandlk-APP-B.html#understandlk-APP-B">Appendix B</a>)</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><tt class="calibre25">struct file_system_type *</tt></p></td><td class="docTableCell"><p class="docText2"><tt class="calibre25">next</tt></p></td><td class="docTableCell"><p class="docText2">Pointer to the next element in the list of filesystem types</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><tt class="calibre25">struct list_head</tt></p></td><td class="docTableCell"><p class="docText2"><tt class="calibre25">fs_supers</tt></p></td><td class="docTableCell"><p class="docText2">Head of a list of superblock objects having the same filesystem type</p></td></tr></table></p><br class="calibre7"/>
<p class="docText1">All filesystem-type objects are inserted into a singly linked list. The <tt class="calibre25">file_systems</tt> variable points to the first item, while the <tt class="calibre25">next</tt> field of the structure points to the next item in the list. The <tt class="calibre25">file_systems_lock</tt> read/write spin lock protects the whole list against concurrent accesses.</p>
<p class="docText1">The <tt class="calibre25">fs_supers</tt> field represents the head (first dummy element) of a list of superblock objects corresponding to mounted filesystems of the given type. The backward and forward links of a list element are stored in the <tt class="calibre25">s_instances</tt> field of the superblock object.</p>
<p class="docText1">The <tt class="calibre25">get_sb</tt> field points to the filesystem-type-dependent function that allocates a new superblock object and initializes it (if necessary, by reading a disk). The <tt class="calibre25">kill_sb</tt> field points to the function that destroys a superblock.</p>
<p class="docText1">The <tt class="calibre25">fs_flags</tt> field stores several flags, which are listed in <a class="pcalibre5 docLink pcalibre1" href="#understandlk-CHP-12-TABLE-10">Table 12-10</a>.</p>
<a name="understandlk-CHP-12-TABLE-10"></a><p class="calibre14"><table cellspacing="0" frame="hsides" rules="all" cellpadding="4" width="100%" class="calibre15"><caption class="calibre33"><h5 class="docFigureTitle">Table 12-10. The filesystem type flags</h5></caption><colgroup class="calibre16"><col class="calibre17"/><col class="calibre17"/></colgroup><thead class="calibre18"><tr class="calibre34"><th class="thead" scope="col"><p class="docText1"><span class="calibre5">Name</span></p></th><th class="thead" scope="col"><p class="docText1"><span class="calibre5">Description</span></p></th></tr></thead><tr class="calibre2"><td class="docTableCell"><p class="docText2"><tt class="calibre25">FS_REQUIRES_DEV</tt></p></td><td class="docTableCell"><p class="docText2">Every filesystem of this type must be located on a physical disk device.</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><tt class="calibre25">FS_BINARY_MOUNTDATA</tt></p></td><td class="docTableCell"><p class="docText2">The filesystem uses binary mount data.</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><tt class="calibre25">FS_REVAL_DOT</tt></p></td><td class="docTableCell"><p class="docText2">Always revalidate the "." and ".." paths in the dentry cache (for network filesystems).</p></td></tr><tr class="calibre2"><td class="docTableCell"><p class="docText2"><tt class="calibre25">FS_ODD_RENAME</tt></p></td><td class="docTableCell"><p class="docText2">"Rename" operations are "move" operations (for network filesystems).</p></td></tr></table></p><br class="calibre7"/>
<p class="docText1">During system initialization, the <tt class="calibre25">register_filesystem( )</tt> function is invoked for every filesystem specified at compile time; the function inserts the corresponding <tt class="calibre25">file_system_type</tt> object into the filesystem-type list.</p>
<p class="docText1">The <tt class="calibre25">register_filesystem( )</tt> function is also invoked when a module implementing a filesystem is loaded. In this case, the filesystem may also be unregistered (by invoking the <tt class="calibre25">unregister_filesystem( )</tt> function) when the module is unloaded.</p>
<p class="docText1">The <tt class="calibre25">get_fs_type( )</tt> function, which receives a filesystem name as its parameter, scans the list of registered filesystems looking at the <tt class="calibre25">name</tt> field of their descriptors, and returns a pointer to the corresponding <tt class="calibre25">file_system_type</tt> object, if it is present.</p>

<br class="calibre7"/>

</div>

{% endraw %}

