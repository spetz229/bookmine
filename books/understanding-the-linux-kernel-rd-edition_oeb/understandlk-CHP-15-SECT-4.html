---
layout: page
title: "Understanding the Linux Kernel, 3rd Edition"
prev: understandlk-CHP-15-SECT-3.html
next: understandlk-CHP-16.html
book_path: books/understanding-the-linux-kernel-rd-edition_oeb/
---
{% include JB/setup %}
{% raw %}
<div>


<a name="understandlk-CHP-15-SECT-4"></a>
<h3 class="docSection1Title">15.4. The sync( ), fsync( ), and fdatasync( ) System Calls</h3><a name="IDX-CHP-15-3877"></a>
<a name="IDX-CHP-15-3878"></a>
<a name="IDX-CHP-15-3879"></a>
<p class="docText1">In this section, we examine briefly the three system calls available to user applications to flush dirty buffers to disk:</p>
<dl class="docText1"><dt class="calibre7"><br class="calibre7"/><p class="calibre14"><span class="docPubcolor"><span class="docPubcolor"><span class="docMonofont">sync( )</span></span></span></p></dt>
<dd class="calibre20"><p class="docList">Allows a process to flush all dirty buffers to disk</p></dd><dt class="calibre7"><br class="calibre7"/><p class="calibre14"><span class="docPubcolor"><span class="docPubcolor"><span class="docMonofont">fsync( )</span></span></span></p></dt>
<dd class="calibre20"><p class="docList">Allows a process to flush all blocks that belong to a specific open file to disk</p></dd><dt class="calibre7"><br class="calibre7"/><p class="calibre14"><span class="docPubcolor"><span class="docPubcolor"><span class="docMonofont">fdatasync( )</span></span></span></p></dt>
<dd class="calibre20"><p class="docList">Very similar to <tt class="calibre25">fsync( )</tt>, but doesn't flush the inode block of the file</p></dd></dl>
<a name="understandlk-CHP-15-SECT-4.1"></a>
<h4 class="docSection2Title">15.4.1. The sync ( ) System Call</h4>
<p class="docText1">The service routine <tt class="calibre25">sys_sync( )</tt> of the <tt class="calibre25">sync( )</tt><a name="IDX-CHP-15-3880"></a> 
 system call invokes a series of auxiliary functions:</p>
<pre class="calibre27">
    wakeup_bdflush(0);
    sync_inodes(0);
    sync_supers( );
    sync_filesystems(0);
    sync_filesystems(1);
    sync_inodes(1);</pre><br class="calibre7"/>
<p class="docText1">As described in the previous section, <tt class="calibre25">wakeup_bdflush( )</tt> starts a <i class="docEmphasis">pdflush</i><a name="IDX-CHP-15-3881"></a> 
 kernel thread, which flushes to disk all dirty pages contained in the page cache.</p>
<p class="docText1">The <tt class="calibre25">sync_inodes( )</tt> function scans the list of superblocks looking for dirty inodes to be flushed; it acts on a <tt class="calibre25">wait</tt> parameter that specifies whether it must wait until flushing has been performed or not. The function scans the superblocks of all currently mounted filesystems; for each superblock containing dirty inodes, <tt class="calibre25">sync_inodes( )</tt> first invokes <tt class="calibre25">sync_sb_inodes( )</tt> to flush the corresponding dirty pages (we described this function earlier in the section "<a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-15-SECT-3.html#understandlk-CHP-15-SECT-3.2">Looking for Dirty Pages To Be Flushed</a>"), then invokes <tt class="calibre25">sync_blockdev( )</tt> to explicitly flush the dirty buffer pages owned by the block device that includes the superblock. This is done because the <tt class="calibre25">write_inode</tt> superblock method of many disk-based filesystems simply marks the block buffer corresponding to the disk inode as dirty; the <tt class="calibre25">sync_blockdev( )</tt> function makes sure that the updates made by <tt class="calibre25">sync_sb_inodes( )</tt> are effectively written to disk.</p>
<p class="docText1">The <tt class="calibre25">sync_supers( )</tt> function writes the dirty superblocks to disk, if necessary, by using the proper <tt class="calibre25">write_super</tt> superblock operations. Finally, the <tt class="calibre25">sync_filesystems( )</tt> executes the <tt class="calibre25">sync_fs</tt> superblock method for all writable filesystems. This method is simply a hook offered to a filesystem in case it needs to perform some peculiar operation at each sync; this method is only used by journaling filesystems<a name="IDX-CHP-15-3882"></a> 
 such as Ext3 (see <a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-18.html#understandlk-CHP-18">Chapter 18</a>).</p>
<p class="docText1">Notice that <tt class="calibre25">sync_inodes( )</tt> and <tt class="calibre25">sync_filesystems( )</tt> are invoked twice, once with the <tt class="calibre25">wait</tt> parameter equal to 0 and the second time with the parameter equal to 1. This is done on purpose: first, they quickly flush to disk the unlocked inodes; next, they wait for each locked inode to become unlocked and finish writing them one by one.</p>
<a name="understandlk-CHP-15-SECT-4.2"></a>
<h4 class="docSection2Title">15.4.2. The fsync ( ) and fdatasync ( ) System Calls</h4><a name="IDX-CHP-15-3883"></a>
<a name="IDX-CHP-15-3884"></a>
<a name="IDX-CHP-15-3885"></a>
<a name="IDX-CHP-15-3886"></a>
<a name="IDX-CHP-15-3887"></a>
<a name="IDX-CHP-15-3888"></a>
<a name="IDX-CHP-15-3889"></a>
<a name="IDX-CHP-15-3890"></a>
<a name="IDX-CHP-15-3891"></a>
<a name="IDX-CHP-15-3892"></a>
<a name="IDX-CHP-15-3893"></a>
<p class="docText1">The <tt class="calibre25">fsync( )</tt> system call forces the kernel to write to disk all dirty buffers that belong to the file specified by the <tt class="calibre25">fd</tt> file descriptor parameter (including the buffer containing its inode, if necessary). The corresponding service routine derives the address of the file object and then invokes the <tt class="calibre25">fsync</tt> method. Usually, this method ends up invoking the <tt class="calibre25">_ _writeback_single_inode( )</tt> function to write back both the dirty pages associated with the selected inode and the inode itself (see the section "<a class="pcalibre5 docLink pcalibre1" href="understandlk-CHP-15-SECT-3.html#understandlk-CHP-15-SECT-3.2">Looking for Dirty Pages To Be Flushed</a>" earlier in this chapter).</p>
<p class="docText1">The <tt class="calibre25">fdatasync( )</tt> system call is very similar to <tt class="calibre25">fsync( )</tt>, but writes to disk only the buffers that contain the file's data, not those that contain inode information. Because Linux 2.6 does not have a specific file method for <tt class="calibre25">fdatasync( )</tt>, this system call uses the <tt class="calibre25">fsync</tt> method and is thus identical to <tt class="calibre25">fsync( )</tt>.</p>

<br class="calibre7"/>

</div>

{% endraw %}

