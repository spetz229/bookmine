---
layout: page
title: "Real World Haskell, 1st Edition"
prev: I_sect114_d1e32163.html
next: monads_state_split_000.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"><a href="21061538.html" class="calibre13"><img src="btn_next_.gif" alt="Next" border="0" class="calibre26"/></a> 
           
          <span class="calibre9"><a target="_self" href="I_sect114_d1e32163.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="monads_state_split_000.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="monads_do" class="calibre27" id="monads_do"></a><h3 id="643999-869" class="docSection1Title">14.12. Desugaring of do Blocks</h3><a name="x_zY" class="calibre27" id="x_zY"></a><p class="docText">Haskell's<a name="I_indexterm14_d1e32561" class="calibre27" id="I_indexterm14_d1e32561"></a><a name="I_indexterm14_d1e32562" class="calibre27" id="I_indexterm14_d1e32562"></a><a name="I_indexterm14_d1e32563" class="calibre27" id="I_indexterm14_d1e32563"></a> <tt class="calibre34">do</tt> syntax is an
    example<a name="I_indexterm14_d1e32572" class="calibre27" id="I_indexterm14_d1e32572"></a> of <span class="docEmphasis">syntactic sugar</span>: it provides an
    alternative way of writing monadic code, without using <i class="docEmphasis">(&gt;&gt;=)</i> and anonymous functions.
    <span class="docEmphasis">Desugaring</span> is the translation of syntactic sugar back
    to the core language.</p><a name="x_AZ" class="calibre27" id="x_AZ"></a><p class="docText">The rules for desugaring a <tt class="calibre34">do</tt> block are easy to follow. We can think of a
    compiler as applying these rules mechanically and repeatedly to a <tt class="calibre34">do</tt> block until no more <tt class="calibre34">do</tt> keywords remain.</p><a name="x_BZ" class="calibre27" id="x_BZ"></a><p class="docText">A <tt class="calibre34">do</tt> keyword followed
    by a single action is translated to that action by itself:</p><pre class="calibre39">-- file: ch14/Do.hs            -- file: ch14/Do.hs 
doNotation1 =                  translated1 =
    do act                         act</pre><br class="calibre48"/>
<a name="x_CZ" class="calibre27" id="x_CZ"></a><p class="docText">A <tt class="calibre34">do</tt> keyword followed
    by more than one action is translated to the first action, then <i class="docEmphasis">(&gt;&gt;)</i>, followed by a <tt class="calibre34">do</tt> keyword and the remaining actions. When we
    apply this rule repeatedly, the entire <tt class="calibre34">do</tt> block ends up chained together by
    applications of <i class="docEmphasis">(&gt;&gt;)</i>:</p><pre class="calibre39">-- file: ch14/Do.hs            -- file: ch14/Do.hs
doNotation2 =                  translated2 =
    do act1                        act1 &gt;&gt;
       act2                        do act2
       {- ... etc. -}                 {- ... etc. -}
       actN                           actN

                              finalTranslation2 =
                                  act1 &gt;&gt;
                                  act2 &gt;&gt;
                                  {- ... etc. -}
                                  actN</pre><br class="calibre48"/>
<a name="x_DZ" class="calibre27" id="x_DZ"></a><p class="docText">The <tt class="calibre34">&lt;-</tt>
    notation<a name="I_indexterm14_d1e32628" class="calibre27" id="I_indexterm14_d1e32628"></a> has a translation that's worth paying close attention to.
    On the left of the <tt class="calibre34">&lt;-</tt> is a normal
    Haskell pattern. This can be a single variable or something more
    complicated, but a guard expression is not allowed:</p><pre class="calibre39">-- file: ch14/Do.hs            -- file: ch14/Do.hs
doNotation3 =                  translated3 =
    do pattern &lt;- act1             let f pattern = do act2
       act2                                           let f pattern = do act2
       {- ... etc. -}                                 actN
       actN                            f _     = fail "..."
                                   in act1 &gt;&gt;= f</pre><br class="calibre48"/>
<a name="x_EZ" class="calibre27" id="x_EZ"></a><p class="docText">This pattern is translated into a <tt class="calibre34">let</tt> binding that declares a local function with
    a unique name (we're just using <span class="docMonofont">f</span> as an example). The
    action on the right of the <tt class="calibre34">&lt;-</tt> is
    then chained with this function using <i class="docEmphasis">(&gt;&gt;=)</i>.</p><a name="x_FZ" class="calibre27" id="x_FZ"></a><p class="docText">What's noteworthy about this translation is that if the
    pattern match fails, the local function calls the monad's <i class="docEmphasis">fail</i> implementation. Here's an example using
    the Maybe monad:</p><pre class="calibre39">-- file: ch14/Do.hs
robust :: [a] -&gt; Maybe a
robust xs = do (_:x:_) &lt;- Just xs
               return x</pre><br class="calibre48"/>
<a name="x_GZ" class="calibre27" id="x_GZ"></a><p class="docText">The <i class="docEmphasis">fail</i>
    implementation in the Maybe monad simply returns
    <tt class="calibre34">Nothing</tt>. If the pattern match in the preceding function
    fails, we thus get <tt class="calibre34">Nothing</tt> as our result:</p><pre class="calibre39">ghci&gt; <b class="calibre40">robust [1,2,3]</b>
Just 2
ghci&gt; <b class="calibre40">robust [1]</b>
Nothing</pre><a name="x_HZ" class="calibre27" id="x_HZ"></a><p class="docText">Finally, when we write a <tt class="calibre34">let</tt> expression in a <tt class="calibre34">do</tt> block, we can omit the <a name="I_indexterm14_d1e32695" class="calibre27" id="I_indexterm14_d1e32695"></a><a name="I_indexterm14_d1e32698" class="calibre27" id="I_indexterm14_d1e32698"></a>usual <tt class="calibre34">in</tt> keyword.
    Subsequent actions in the block must be lined up with the <tt class="calibre34">let</tt> keyword:</p><pre class="calibre39">-- file: ch14/Do.hs            -- file: ch14/Do.hs
doNotation4 =                  translated4 =
    do let val1 = expr1            let val1 = expr1
           val2 = expr2                val2 = expr2
           {- ... etc. -}              valN = exprN
           valN = exprN            in do act1
       act1                              act2
       act2                              {- ... etc. -}
       {- ... etc. -}                    actN       
       actN</pre><br class="calibre48"/>
<a name="monads_dod1e33045" class="calibre27" id="monads_dod1e33045"></a><h4 id="title-IDAQOASD" class="docSection1Title">14.12.1. Monads as a Programmable Semicolon</h4><a name="x_IZ" class="calibre27" id="x_IZ"></a><p class="docText">Earlier in <a class="docLink" href="deftypes_offside.html#deftypes_block">Section 3.10.2</a>, we
      mentioned that layout is the norm<a name="I_indexterm14_d1e32717" class="calibre27" id="I_indexterm14_d1e32717"></a> in Haskell, but it's not <span class="docEmphasis">required</span>.
      We can write a <tt class="calibre34">do</tt> block using
      explicit structure instead of layout:</p><pre class="calibre39">-- file: ch14/Do.hs            -- file: ch14/Do.hs
semicolon = do                 semicolonTranslated =
  {                                act1 &gt;&gt;
    act1;                          let f val1 = let val2 = expr1
    val1 &lt;- act2;                               in actN
    let { val2 = expr1 };              f _ = fail "..."
    actN;                          in act2 &gt;&gt;= f
  }</pre><br class="calibre48"/>
<a name="x_JZ" class="calibre27" id="x_JZ"></a><p class="docText">Even though this use of explicit structure is rare, the
      fact that it uses semicolons to separate expressions has given rise to
      an apt slogan: monads are a kind of "<span class="docEmphasis">programmable</span> semicolon," because the
      behaviors of <i class="docEmphasis">(&gt;&gt;)</i> and
      <i class="docEmphasis">(&gt;&gt;=)</i> are different in each
      <span class="docEmphasis">monad</span>.</p><a name="monads_do_avoid" class="calibre27" id="monads_do_avoid"></a><h4 id="title-IDACQASD" class="docSection1Title">14.12.2. Why Go Sugar-Free?</h4><a name="x_KZ" class="calibre27" id="x_KZ"></a><p class="docText">When we write <i class="docEmphasis">(&gt;&gt;=)</i> <a name="I_indexterm14_d1e32751" class="calibre27" id="I_indexterm14_d1e32751"></a>explicitly in our code, it reminds us that we're stitching
      functions together using combinators, not simply sequencing
      actions.</p><a name="x_LZ" class="calibre27" id="x_LZ"></a><p class="docText">As long as you feel like a novice with monads, we think
      you should prefer to explicitly write <i class="docEmphasis">(&gt;&gt;=)</i> over the syntactic sugar of
      <tt class="calibre34">do</tt> notation. The repeated
      reinforcement of what's really happening seems, for many programmers, to
      help keep things clear. (It can be easy for an imperative programmer to
      relax a little too much from exposure to the IO monad and
      assume that a <tt class="calibre34">do</tt> block means nothing
      more than a simple sequence of actions.)</p><a name="x_MZ" class="calibre27" id="x_MZ"></a><p class="docText">Once you're feeling more familiar with monads, you can
      choose whichever style seems more appropriate for writing a particular
      function. Indeed, when you read other people's monadic code, you'll see
      that it's unusual, but by no means rare, to mix
      <span class="docEmphasis">both</span> <tt class="calibre34">do</tt> notation
      and <i class="docEmphasis">(&gt;&gt;=)</i> in a single
      function.</p><a name="x_iG1" class="calibre27" id="x_iG1"></a><p class="docText">The <i class="docEmphasis">(=&lt;&lt;)</i>
      function<a name="I_indexterm14_d1e32785" class="calibre27" id="I_indexterm14_d1e32785"></a> shows up frequently whether or not we use <tt class="calibre34">do</tt> notation. It is a flipped version of
      <i class="docEmphasis">(&gt;&gt;=)</i>:</p><pre class="calibre39">ghci&gt; <b class="calibre40">:type (&gt;&gt;=)</b>
(&gt;&gt;=) :: (Monad m) =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
ghci&gt; <b class="calibre40">:type (=&lt;&lt;)</b>
(=&lt;&lt;) :: (Monad m) =&gt; (a -&gt; m b) -&gt; m a -&gt; m b</pre><a name="x_jG1" class="calibre27" id="x_jG1"></a><p class="docText">It comes in handy if we want to compose monadic
      functions in the usual Haskell right-to-left style:</p><pre class="calibre39">-- file: ch14/CartesianProduct.hs
wordCount = print . length . words =&lt;&lt; getContents</pre><br class="calibre48"/>
<ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"><a href="21061538.html" class="calibre2"><img src="btn_next_.gif" alt="Next" border="0" class="calibre31"/></a> 
           
          <span class="calibre33"><a target="_self" href="I_sect114_d1e32163.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="monads_state_split_000.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

