---
layout: page
title: "Real World Haskell, 1st Edition"
prev: I_sect114_d1e30814.html
next: I_sect114_d1e30935.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"> 
           
          <span class="calibre9"><a target="_self" href="I_sect114_d1e30814.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="I_sect114_d1e30935.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="I_sect114_d1e30852" class="calibre27" id="I_sect114_d1e30852"></a><h3 id="title-IDACSFIL" class="docSection1Title">14.2. Revisiting Earlier Code Examples</h3><a name="I_sect114_d1e30852d1e31191" class="calibre27" id="I_sect114_d1e30852d1e31191"></a><h4 id="title-IDAGSFIL" class="docSection1Title">14.2.1. Maybe Chaining</h4><a name="x_bW" class="calibre27" id="x_bW"></a><p class="docText">Let's take another look at the <i class="docEmphasis">parseP5</i> function that we wrote in <a class="docLink" href="binary_split_000.html#binary">Chapter 10</a>:</p><pre class="calibre39">-- file: ch10/PNM.hs
matchHeader :: L.ByteString -&gt; L.ByteString -&gt; Maybe L.ByteString

-- "nat" here is short for "natural number"
getNat :: L.ByteString -&gt; Maybe (Int, L.ByteString)

getBytes :: Int -&gt; L.ByteString
         -&gt; Maybe (L.ByteString, L.ByteString)

parseP5 s =
  case matchHeader (L8.pack "P5") s of
    Nothing -&gt; Nothing
    Just s1 -&gt;
      case getNat s1 of
        Nothing -&gt; Nothing
        Just (width, s2) -&gt;
          case getNat (L8.dropWhile isSpace s2) of
            Nothing -&gt; Nothing
            Just (height, s3) -&gt;
              case getNat (L8.dropWhile isSpace s3) of
                Nothing -&gt; Nothing
                Just (maxGrey, s4)
                  | maxGrey &gt; 255 -&gt; Nothing
                  | otherwise -&gt;
                      case getBytes 1 s4 of
                        Nothing -&gt; Nothing
                        Just (_, s5) -&gt;
                          case getBytes (width * height) s5 of
                            Nothing -&gt; Nothing
                            Just (bitmap, s6) -&gt;
                              Just (Greymap width height maxGrey bitmap, s6)</pre><br class="calibre48"/>
<a name="x_cW" class="calibre27" id="x_cW"></a><p class="docText">When we introduced this function, it threatened to march
      off the right side of the page if it got much more complicated. We
      brought the staircasing under control using<a name="I_indexterm14_d1e30869" class="calibre27" id="I_indexterm14_d1e30869"></a> the <i class="docEmphasis">(&gt;&gt;?)</i>
      function:</p><pre class="calibre39">-- file: ch10/PNM.hs
(&gt;&gt;?) :: Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
Nothing &gt;&gt;? _ = Nothing
Just v  &gt;&gt;? f = f v</pre><br class="calibre48"/>
<a name="x_dW" class="calibre27" id="x_dW"></a><p class="docText">We carefully chose the type of <i class="docEmphasis">(&gt;&gt;?)</i> to let us chain together
      functions that return a Maybe value. So long as the result
      type of one function matches the parameter of the next, we can chain
      functions returning Maybe together indefinitely. The body
      of <i class="docEmphasis">(&gt;&gt;?)</i> hides the details of
      whether the chain of functions we build is short-circuited somewhere,
      due to one returning <tt class="calibre34">Nothing</tt>, or whenever it is completely
      evaluated.</p><a name="I_sect114_d1e30852d1e31231" class="calibre27" id="I_sect114_d1e30852d1e31231"></a><h4 id="title-IDA2TFIL" class="docSection1Title">14.2.2. Implicit State</h4><a name="x_eW" class="calibre27" id="x_eW"></a><p class="docText">Useful as <i class="docEmphasis">(&gt;&gt;?)</i> was<a name="I_indexterm14_d1e30903" class="calibre27" id="I_indexterm14_d1e30903"></a> for cleaning up the structure of <i class="docEmphasis">parseP5</i>, we had to incrementally consume
      pieces of a string as we parsed it. This forced us to pass the current
      value of the string down our chain of Maybes, wrapped up in
      a tuple. Each function in the chain put a result into one element of the
      tuple and the unconsumed remainder of the string into the other:</p><pre class="calibre39">-- file: ch10/PNM.hs
parseP5_take2 :: L.ByteString -&gt; Maybe (Greymap, L.ByteString)
parseP5_take2 s =
    matchHeader (L8.pack "P5") s      &gt;&gt;?
    \s -&gt; skipSpace ((), s)           &gt;&gt;?
    (getNat . snd)                    &gt;&gt;?
    skipSpace                         &gt;&gt;?
    \(width, s) -&gt;   getNat s         &gt;&gt;?
    skipSpace                         &gt;&gt;?
    \(height, s) -&gt;  getNat s         &gt;&gt;?
    \(maxGrey, s) -&gt; getBytes 1 s     &gt;&gt;?
    (getBytes (width * height) . snd) &gt;&gt;?
    \(bitmap, s) -&gt; Just (Greymap width height maxGrey bitmap, s)

skipSpace :: (a, L.ByteString) -&gt; Maybe (a, L.ByteString)
skipSpace (a, s) = Just (a, L8.dropWhile isSpace s)</pre><br class="calibre48"/>
<a name="x_fW" class="calibre27" id="x_fW"></a><p class="docText">Once again, we were faced with a pattern of repeated
      behavior: consume some string, return a result, and return the remaining
      string for the next function to consume. However, this pattern was more
      insidious. If we wanted to pass another piece of information down the
      chain, we'd have to modify nearly every element of the chain, turning
      each two-tuple into a three-tuple!</p><a name="x_gW" class="calibre27" id="x_gW"></a><p class="docText">We addressed this by moving the responsibility for
      managing the current piece of string out of the individual functions in
      the chain, and into the function that we used to chain them
      together:</p><pre class="calibre39">-- file: ch10/Parse.hs
(==&gt;) :: Parse a -&gt; (a -&gt; Parse b) -&gt; Parse b

firstParser ==&gt; secondParser  =  Parse chainedParser
  where chainedParser initState   =
          case runParse firstParser initState of
            Left errMessage -&gt;
                Left errMessage
            Right (firstResult, newState) -&gt;
                runParse (secondParser firstResult) newState</pre><br class="calibre48"/>
<a name="x_hW" class="calibre27" id="x_hW"></a><p class="docText">We also hid the details of the parsing state in the
      ParseState type. Even the <i class="docEmphasis">getState</i> and <i class="docEmphasis">putState</i> functions don't inspect the parsing
      state, so any modification to ParseState will have no
      effect on any existing code.</p>
<a href="21061538.html" class="calibre2"><img src="pixel.gif" alt="" border="0" class="calibre31"/></a><ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"> 
           
          <span class="calibre33"><a target="_self" href="I_sect114_d1e30814.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="I_sect114_d1e30935.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

