---
layout: page
title: "Real World Haskell, 1st Edition"
prev: I_sect126_d1e50018.html
next: I_sect126_d1e50755.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"> 
           
          <span class="calibre9"><a target="_self" href="I_sect126_d1e50018.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="I_sect126_d1e50755.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="I_sect126_d1e50419" class="calibre27" id="I_sect126_d1e50419"></a><h3 id="title-IDAHVIOB" class="docSection1Title">26.9. Creating a Cabal Package</h3><a name="x_v81" class="calibre27" id="x_v81"></a><p class="docText">We have created a moderately complicated library, with
    four public modules and one internal module. To turn this into a package
    that we can easily redistribute, we create a <i class="docEmphasis">rwh-bloomfilter.cabal</i> file.</p><a name="x_w81" class="calibre27" id="x_w81"></a><p class="docText">Cabal allows us to describe several libraries in a single
    package. A <i class="docEmphasis">.cabal</i> file begins with
    information that is common to all of the libraries, which is followed by a
    distinct section for each library:</p><pre class="calibre39">Name:               rwh-bloomfilter
Version:            0.1
License:            BSD3
License-File:       License.txt
Category:           Data
Stability:          experimental
Build-Type:         Simple</pre><br class="calibre48"/>
<a name="x_x81" class="calibre27" id="x_x81"></a><p class="docText">As we are bundling some C code with our library, we tell
    Cabal about our C source files:</p><pre class="calibre39">Extra-Source-Files: cbits/lookup3.c cbits/lookup3.h</pre><br class="calibre48"/>
<a name="x_y81" class="calibre27" id="x_y81"></a><p class="docText">The <tt class="calibre34">exTRa-source-files</tt> directive has no
    effect on a build: it directs Cabal to bundle some extra files if we run
    <i class="docEmphasis">runhaskell Setup sdist</i> to create a
    source tarball for <span class="docEmphasis">redistribution</span>.</p><p class="calibre37"><table border="0" cellspacing="0" cellpadding="1" width="90%" class="calibre41"><tr class="calibre16"><td class="v3"><table width="100%" border="0" cellspacing="0" cellpadding="6" class="calibre42"><tr class="calibre16"><td width="60" valign="top" class="v3"><img src="tip_yellow.gif" alt="" class="calibre43"/></td><td valign="top" class="v3"><p class="docNormalTitle">Property names are case-insensitive</p><a name="x_z81" class="calibre27" id="x_z81"></a><p class="docText">When reading a property (the text before a
      "<tt class="calibre34">:</tt>" character), Cabal
      ignores case, so it treats <tt class="calibre34">extra-source-files</tt> and
      <tt class="calibre34">ExTRa-Source-Files</tt> the same.</p></td></tr></table></td></tr></table></p><br class="calibre48"/><a name="I_sect126_d1e50419d1e50738" class="calibre27" id="I_sect126_d1e50419d1e50738"></a><h4 id="title-IDAAXIOB" class="docSection1Title">26.9.1. Dealing with Different Build Setups</h4><a name="x_A91" class="calibre27" id="x_A91"></a><p class="docText">Prior to 2007, the standard Haskell libraries were
      organized in a handful of large packages, of which the biggest was named
      <tt class="calibre34">base</tt>. This organization tied many unrelated libraries
      together, so the Haskell community split the <tt class="calibre34">base</tt> package
      up into a number of more modular libraries. For instance, the array
      types migrated from <tt class="calibre34">base</tt> into a package named
      <tt class="calibre34">array</tt>.</p><a name="x_B91" class="calibre27" id="x_B91"></a><p class="docText">A Cabal package needs to specify the other packages
      that it needs to have present in order to build. This makes it possible
      for Cabal's command-line interface to automatically download and build a
      package's dependencies, if necessary. We would like our code to work
      with as many versions of <span class="docMonofont">GHC</span>
      as possible, regardless of whether they have the modern layout of
      <tt class="calibre34">base</tt> and numerous other packages. We thus need to be able
      to specify that we depend on the <tt class="calibre34">array</tt> package if it is
      present, and <tt class="calibre34">base</tt> alone otherwise.</p><a name="x_C91" class="calibre27" id="x_C91"></a><p class="docText">Cabal <a name="I_indexterm26_d1e50497" class="calibre27" id="I_indexterm26_d1e50497"></a>provides a generic <span class="docEmphasis">configurations</span>
      feature, which we can use to selectively enable parts of a <i class="docEmphasis">.cabal</i> file. A build configuration is
      controlled by a Boolean-valued <span class="docEmphasis">flag</span>. If it is
      <tt class="calibre34">true</tt>, the text following an <tt class="calibre34">if flag</tt> directive
      is used; otherwise, the text following the associated <tt class="calibre34">else</tt>
      is used:</p><pre class="calibre39">Cabal-Version:      &gt;= 1.2

Flag split-base
  Description: Has the base package been split up?
  Default: True

Flag bytestring-in-base
  Description: Is ByteString in the base or bytestring package?
  Default: False</pre><br class="calibre48"/>
<ul class="calibre18"><li class="calibre19"><p class="docText">The configurations feature was introduced in
          version 1.2 of Cabal, so we specify that our package cannot be built
          with an older version.</p></li><li class="calibre19"><p class="docText">The meaning of the <tt class="calibre34">split-base</tt> flag
          <a name="I_indexterm26_d1e50532" class="calibre27" id="I_indexterm26_d1e50532"></a><a name="I_indexterm26_d1e50535" class="calibre27" id="I_indexterm26_d1e50535"></a>should be self-explanatory.</p></li><li class="calibre19"><p class="docText">The <tt class="calibre34">bytestring-in-base</tt> flag deals with
          a more torturous history. When the <tt class="calibre34">bytestring</tt> package
          was first created, it was bundled with <span class="docMonofont">GHC</span> 6.4 and kept separate from the
          <tt class="calibre34">base</tt> package. In <span class="docMonofont">GHC</span> 6.6, it was incorporated into the
          <tt class="calibre34">base</tt> package, but it became independent again when the
          <tt class="calibre34">base</tt> package was split before the release of
          <span class="docMonofont">GHC</span> 6.8.1.</p></li></ul><a name="x_G91" class="calibre27" id="x_G91"></a><p class="docText">These flags are usually invisible to people building a
      package, because Cabal handles them automatically. Before we explain
      what happens, it will help to see the beginning of the
      <tt class="calibre34">Library</tt> section of our <i class="docEmphasis">.cabal</i>
      file:</p><pre class="calibre39">Library
  if flag(bytestring-in-base)
    -- bytestring was in base-2.0 and 2.1.1
    Build-Depends: base &gt;= 2.0 &amp;&amp; &lt; 2.2
  else
    -- in base 1.0 and 3.0, bytestring is a separate package
    Build-Depends: base &lt; 2.0 || &gt;= 3, bytestring &gt;= 0.9

  if flag(split-base)
    Build-Depends: base &gt;= 3.0, array
  else
    Build-Depends: base &lt; 3.0</pre><br class="calibre48"/>
<a name="x_H91" class="calibre27" id="x_H91"></a><p class="docText">Cabal creates a package description with the default
      values of the flags (a missing default is assumed to be
      <tt class="calibre34">TRue</tt>). If that configuration can be built (e.g., because
      all of the needed package versions are available), it will be used.
      Otherwise, Cabal tries different combinations of flags until it either
      finds a configuration that it can build or exhausts the
      alternatives.</p><a name="x_I91" class="calibre27" id="x_I91"></a><p class="docText">For example, if we were to begin with both
      <tt class="calibre34">split-base</tt> and <tt class="calibre34">bytestring-in-base</tt> set to
      <tt class="calibre34">TRue</tt>, Cabal would select the following package
      dependencies:</p><pre class="calibre39">Build-Depends: base &gt;= 2.0 &amp;&amp; &lt; 2.2
Build-Depends: base &gt;= 3.0, array</pre><br class="calibre48"/>
<a name="x_J91" class="calibre27" id="x_J91"></a><p class="docText">The <tt class="calibre34">base</tt> package cannot simultaneously be
      newer than <tt class="calibre34">3.0</tt> and older than <tt class="calibre34">2.2</tt>, so Cabal
      would reject this configuration as inconsistent. For a modern version of
      <span class="docMonofont">GHC</span>, after a few attempts, it
      would discover this configuration that will indeed build:</p><pre class="calibre39">-- in base 1.0 and 3.0, bytestring is a separate package
Build-Depends: base &lt; 2.0 || &gt;= 3, bytestring &gt;= 0.9
Build-Depends: base &gt;= 3.0, array</pre><br class="calibre48"/>
<a name="x_K91" class="calibre27" id="x_K91"></a><p class="docText">When we run <tt class="calibre34">runhaskell Setup
      configure</tt>, we can manually specify the values of flags via the
      <i class="docEmphasis">--flag</i> option, though we will rarely need to do so in
      practice.</p><a name="I_sect126_d1e50419d1e50894" class="calibre27" id="I_sect126_d1e50419d1e50894"></a><h4 id="title-IDAA2IOB" class="docSection1Title">26.9.2. Compilation Options and Interfacing to C</h4><a name="x_L91" class="calibre27" id="x_L91"></a><p class="docText">Continuing<a name="I_indexterm26_d1e50625" class="calibre27" id="I_indexterm26_d1e50625"></a> with our <i class="docEmphasis">.cabal</i>
      file, we fill out the remaining details of the Haskell side of our
      library. If we enable profiling when we build, we want all of our
      top-level functions to show up in any profiling output:</p><pre class="calibre39">  GHC-Prof-Options: -auto-all</pre><br class="calibre48"/>
<a name="x_M91" class="calibre27" id="x_M91"></a><p class="docText">The <tt class="calibre34">Other-Modules</tt> property <a name="I_indexterm26_d1e50639" class="calibre27" id="I_indexterm26_d1e50639"></a>lists Haskell modules that are private to the library.
      Such modules will be invisible to code that uses this package.</p><a name="x_N91" class="calibre27" id="x_N91"></a><p class="docText">When we build this package with <span class="docMonofont">GHC</span>, Cabal will pass the options
      from<a name="I_indexterm26_d1e50648" class="calibre27" id="I_indexterm26_d1e50648"></a> the <tt class="calibre34">GHC-Options</tt> property to the
      compiler.</p><a name="x_O91" class="calibre27" id="x_O91"></a><p class="docText">The <i class="docEmphasis">-O2</i> option makes <span class="docMonofont">GHC</span> optimize<a name="I_indexterm26_d1e50663" class="calibre27" id="I_indexterm26_d1e50663"></a> our code aggressively. Code compiled without optimization
      is very slow, so we should always use <i class="docEmphasis">-O2</i> for
      production code.</p><a name="x_P91" class="calibre27" id="x_P91"></a><p class="docText">To help ourselves write cleaner code, we usually add
      the <i class="docEmphasis">-Wall</i> option, <a name="I_indexterm26_d1e50675" class="calibre27" id="I_indexterm26_d1e50675"></a>which enables all of <span class="docMonofont">GHC</span>'s warnings. This will cause
      <span class="docMonofont">GHC</span> to issue complaints if it
      encounters potential problems, such as overlapping patterns; function
      parameters that are not used; and a myriad of other potential stumbling
      blocks. While it is often safe to ignore these warnings, we generally
      prefer to fix up our code to eliminate them. The small added effort
      usually yields code that is easier to read and maintain.</p><a name="x_Q91" class="calibre27" id="x_Q91"></a><p class="docText">When we compile with <i class="docEmphasis">-fvia-C</i>,
      <span class="docMonofont">GHC</span> <a name="I_indexterm26_d1e50693" class="calibre27" id="I_indexterm26_d1e50693"></a>will generate C code and use the system's C compiler to
      compile it, instead of going straight to assembly language as it usually
      does. This slows compilation down, but sometimes the C compiler can
      further improve <span class="docMonofont">GHC</span>'s
      optimized code, so it can be worthwhile.</p><a name="x_R91" class="calibre27" id="x_R91"></a><p class="docText">We include <i class="docEmphasis">-fvia-C</i> here mainly to
      show how to compile using this option:</p><pre class="calibre39">  C-Sources:        cbits/lookup3.c
  CC-Options:       -O3
  Include-Dirs:     cbits
  Includes:         lookup3.h
  Install-Includes: lookup3.h</pre><br class="calibre48"/>
<a name="x_S91" class="calibre27" id="x_S91"></a><p class="docText">For the <tt class="calibre34">C-Sources</tt> property, we need only
      to list files that must be compiled into our library. The
      <tt class="calibre34">CC-Options</tt> property contains options for the C compiler
      (<i class="docEmphasis">-O3</i> specifies a high level of optimization). Because
      our FFI bindings for the Jenkins hash functions refer to the <i class="docEmphasis">lookup3.h</i> header file, we need to tell Cabal
      where to find the header file. We must also tell it to
      <span class="docEmphasis">install</span> the header file
      (<tt class="calibre34">Install-Includes</tt>); otherwise, client code will fail to
      find the header file when we try to build it.</p><p class="calibre37"><table border="0" cellspacing="0" cellpadding="1" width="90%" class="calibre41"><tr class="calibre16"><td class="v3"><table width="100%" border="0" cellspacing="0" cellpadding="6" class="calibre42"><tr class="calibre16"><td width="60" valign="top" class="v3"><img src="tip_yellow.gif" alt="" class="calibre43"/></td><td valign="top" class="v3"><p class="docNormalTitle">The value of -fvia-C with the FFI</p><a name="x_T91" class="calibre27" id="x_T91"></a><p class="docText">Compiling with <i class="docEmphasis">-fvia-C</i> has a useful
        safety benefit when we write<a name="I_indexterm26_d1e50737" class="calibre27" id="I_indexterm26_d1e50737"></a> FFI bindings. If we mention a header file in an FFI
        declaration (e.g., <tt class="calibre34">foreign import "string.h memcpy")</tt>, the
        C compiler will typecheck the generated Haskell code and ensure that
        its invocation of the C function is consistent with the C function's
        prototype in the header file.</p><a name="x_U91" class="calibre27" id="x_U91"></a><p class="docText">If we do not use <i class="docEmphasis">-fvia-C</i>, we lose
        that additional layer of safety, making it easy to let simple C type
        errors slip into our Haskell code. As an example, on most 64-bit
        machines, a CInt is 32 bits wide, and a
        CSize is 64 bits wide. If we accidentally use one type to
        describe a parameter for an FFI binding when we should use the other,
        we are likely to cause data corruption or a crash.</p></td></tr></table></td></tr></table></p><br class="calibre48"/>
<a href="21061538.html" class="calibre2"><img src="pixel.gif" alt="" border="0" class="calibre31"/></a><ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"> 
           
          <span class="calibre33"><a target="_self" href="I_sect126_d1e50018.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="I_sect126_d1e50755.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

