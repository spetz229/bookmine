---
layout: page
title: "Real World Haskell, 1st Edition"
prev: I_sect114_d1e31817.html
next: I_sect114_d1e32163.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"><a href="21061538.html" class="calibre13"><img src="btn_next_.gif" alt="Next" border="0" class="calibre26"/></a> 
           
          <span class="calibre9"><a target="_self" href="I_sect114_d1e31817.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="I_sect114_d1e32163.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="I_sect114_d1e31941" class="calibre27" id="I_sect114_d1e31941"></a><h3 id="title-IDAT51M" class="docSection1Title">14.10. The Maybe Monad</h3><a name="x_QY" class="calibre27" id="x_QY"></a><p class="docText">The Maybe type is very nearly the simplest
    instance of <tt class="calibre34">Monad</tt>. It represents a computation that might not
    produce a result:</p><pre class="calibre39">-- file: ch14/Maybe.hs
instance Monad Maybe where
    Just x &gt;&gt;= k  =  k x
    Nothing &gt;&gt;= _ =  Nothing

    Just _ &gt;&gt; k   =  k
    Nothing &gt;&gt; _  =  Nothing

    return x      =  Just x

    fail _        =  Nothing</pre><br class="calibre48"/>
<a name="x_RY" class="calibre27" id="x_RY"></a><p class="docText">If, when we chain together a number of computations over
    Maybe using <i class="docEmphasis">(&gt;&gt;=)</i>
    or <i class="docEmphasis">(&gt;&gt;)</i>, any of them returns
    <tt class="calibre34">Nothing</tt>, we don't evaluate any of the remaining <span class="docEmphasis">computations</span>.</p><a name="x_SY" class="calibre27" id="x_SY"></a><p class="docText">Note, though, that the chain is not completely
    short-circuited. Each <i class="docEmphasis">(&gt;&gt;=)</i> or
    <i class="docEmphasis">(&gt;&gt;)</i> in the chain will still
    match a <tt class="calibre34">Nothing</tt> on its left and produce a <i class="docEmphasis">Nothing</i> on its right, all the way to the end.
    It's easy to forget this point: when a computation in the chain fails, the
    subsequent production, chaining, and consumption of <tt class="calibre34">Nothing</tt>
    values are cheap at runtime, but they're not free.</p><a name="I_sect114_d1e31941d1e32324" class="calibre27" id="I_sect114_d1e31941d1e32324"></a><h4 id="title-IDALB2M" class="docSection1Title">14.10.1. Executing the Maybe Monad</h4><a name="x_TY" class="calibre27" id="x_TY"></a><p class="docText">A function suitable for executing the Maybe
      monad is <i class="docEmphasis">maybe</i>. (Remember that
      "executing" a monad involves evaluating it and returning a
      result that's had the monad's type wrapper removed.)</p><pre class="calibre39">-- file: ch14/Maybe.hs
maybe :: b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
maybe n _ Nothing  = n
maybe _ f (Just x) = f x</pre><br class="calibre48"/>
<a name="x_UY" class="calibre27" id="x_UY"></a><p class="docText">Its first parameter is the value to return if the result
      is <tt class="calibre34">Nothing</tt>. The second is a function to apply to a result
      wrapped in the <tt class="calibre34">Just</tt> constructor; the result of that
      application is then returned.</p><a name="x_VY" class="calibre27" id="x_VY"></a><p class="docText">Since the Maybe type is so simple, it's
      about as common to simply pattern match on a Maybe value as
      it is to call <i class="docEmphasis">maybe</i>. Each one is
      more readable in different circumstances.</p><a name="I_sect114_d1e31941d1e32359" class="calibre27" id="I_sect114_d1e31941d1e32359"></a><h4 id="title-IDAQC2M" class="docSection1Title">14.10.2. Maybe at Work, and Good API Design</h4><a name="x_WY" class="calibre27" id="x_WY"></a><p class="docText">Here's an example of Maybe in use as a
      monad. Given a customer's name, we want to find the billing address of
      her mobile phone carrier:</p><pre class="calibre39">-- file: ch14/Carrier.hs
import qualified Data.Map as M

type PersonName = String
type PhoneNumber = String
type BillingAddress = String
data MobileCarrier = Honest_Bobs_Phone_Network
                   | Morrisas_Marvelous_Mobiles
                   | Petes_Plutocratic_Phones
                     deriving (Eq, Ord)

findCarrierBillingAddress :: PersonName
                          -&gt; M.Map PersonName PhoneNumber
                          -&gt; M.Map PhoneNumber MobileCarrier
                          -&gt; M.Map MobileCarrier BillingAddress
                          -&gt; Maybe BillingAddress</pre><br class="calibre48"/>
<a name="x_XY" class="calibre27" id="x_XY"></a><p class="docText">Our first version is the dreaded ladder of code marching
      off the right of the screen, with many boilerplate <tt class="calibre34">case</tt> expressions:</p><pre class="calibre39">-- file: ch14/Carrier.hs
variation1 person phoneMap carrierMap addressMap =
    case M.lookup person phoneMap of
      Nothing -&gt; Nothing
      Just number -&gt;
          case M.lookup number carrierMap of
            Nothing -&gt; Nothing
            Just carrier -&gt; M.lookup carrier addressMap</pre><br class="calibre48"/>
<a name="x_YY" class="calibre27" id="x_YY"></a><p class="docText">The <tt class="calibre34">Data.Map</tt> module's <i class="docEmphasis">lookup</i> function has a monadic return
      type:</p><pre class="calibre39">ghci&gt; <b class="calibre40">:module +Data.Map</b>ghci&gt; <b class="calibre40">:type Data.Map.lookup</b>
Data.Map.lookup :: (Ord k, Monad m) =&gt; k -&gt; Map k a -&gt; m a</pre><a name="x_ZY" class="calibre27" id="x_ZY"></a><p class="docText">In other words, if the given key is present in the map,
      <i class="docEmphasis">lookup</i> injects it into the monad
      using <tt class="calibre34">return</tt>. Otherwise, it calls
      <i class="docEmphasis">fail</i>. This is an interesting piece
      of API design, though one that we think was a poor choice:</p><ul class="calibre18"><li class="calibre19"><p class="docText">On the positive side, the behaviors of success and
          failure are automatically customized to our needs, based on the
          monad from which we're calling <i class="docEmphasis">lookup</i>. Better yet, <i class="docEmphasis">lookup</i> itself doesn't know or care what
          those behaviors are.</p><p class="docText">The <tt class="calibre34">case</tt>
          expressions just shown typecheck because we're comparing the result
          of <i class="docEmphasis">lookup</i> against values of
          type Maybe.</p></li><li class="calibre19"><p class="docText">The hitch is, of course, that using <i class="docEmphasis">fail</i> in the wrong monad throws a
          bothersome exception. We have already warned against the use of
          <i class="docEmphasis">fail</i>, so we will not repeat
          ourselves here.</p></li></ul><a name="x_eG1" class="calibre27" id="x_eG1"></a><p class="docText">In practice, <span class="docEmphasis">everyone</span> uses
      Maybe as the result type for <i class="docEmphasis">lookup</i>. The result type of such a
      conceptually simple function provides generality where it is not needed:
      <i class="docEmphasis">lookup</i> should have been written to
      return Maybe.</p><a name="x_fG1" class="calibre27" id="x_fG1"></a><p class="docText">Let's set aside the API question and deal with the
      ugliness of our code. We can make more sensible use of
      Maybe's status as a monad:</p><pre class="calibre39">-- file: ch14/Carrier.hs
variation2 person phoneMap carrierMap addressMap = do
  number &lt;- M.lookup person phoneMap
  carrier &lt;- M.lookup number carrierMap
  address &lt;- M.lookup carrier addressMap
  return address</pre><br class="calibre48"/>
<a name="x_bY" class="calibre27" id="x_bY"></a><p class="docText">If any of these lookups fails, the definitions of
      <i class="docEmphasis">(&gt;&gt;=)</i> and <i class="docEmphasis">(&gt;&gt;)</i> mean that the result of the
      function as a whole will be <tt class="calibre34">Nothing</tt>, just as it was for our
      first attempt that used <tt class="calibre34">case</tt>
      explicitly.</p><a name="x_cY" class="calibre27" id="x_cY"></a><p class="docText">This version is much tidier, but the <tt class="calibre34">return</tt> isn't necessary. Stylistically, it
      makes the code look more regular, and perhaps more familiar to the eyes
      of an imperative programmer, but behaviorally it's redundant. Here's an
      equivalent piece of code:</p><pre class="calibre39">-- file: ch14/Carrier.hs
variation2a person phoneMap carrierMap addressMap = do
  number &lt;- M.lookup person phoneMap
  carrier &lt;- M.lookup number carrierMap
  M.lookup carrier addressMap</pre><br class="calibre48"/>
<a name="x_dY" class="calibre27" id="x_dY"></a><p class="docText">When we introduced maps, we mentioned in <a class="docLink" href="I_sect112_d1e28385.html#barcode_map_partial">Section 12.9.2.2</a> that the type signatures of functions
      in the <tt class="calibre34">Data.Map</tt> module often make them awkward to partially
      apply. The <i class="docEmphasis">lookup</i> function is a
      good example. If we <i class="docEmphasis">flip</i> its
      arguments, we can write the function body as a one-liner:</p><pre class="calibre39">-- file: ch14/Carrier.hs
variation3 person phoneMap carrierMap addressMap =
    lookup phoneMap person &gt;&gt;= lookup carrierMap &gt;&gt;= lookup addressMap
  where lookup = flip M.lookup</pre><br class="calibre48"/>
<ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"><a href="21061538.html" class="calibre2"><img src="btn_next_.gif" alt="Next" border="0" class="calibre31"/></a> 
           
          <span class="calibre33"><a target="_self" href="I_sect114_d1e31817.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="I_sect114_d1e32163.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

