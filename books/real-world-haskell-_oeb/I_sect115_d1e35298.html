---
layout: page
title: "Real World Haskell, 1st Edition"
prev: I_sect115_d1e35180.html
next: I_sect115_d1e35473_split_000.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"> 
           
          <span class="calibre9"><a target="_self" href="I_sect115_d1e35180.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="I_sect115_d1e35473_split_000.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="I_sect115_d1e35298" class="calibre27" id="I_sect115_d1e35298"></a><h3 id="title-IDALDUON" class="docSection1Title">15.7. A Return to Automated Deriving</h3><a name="x_Gs" class="calibre27" id="x_Gs"></a><p class="docText">Now that we know about the Reader monad,
    let's use it to create an instance of our MonadSupply
    typeclass. To keep our example simple, we'll violate the spirit of
    MonadSupply here: our <i class="docEmphasis">next</i> action will always return the same value,
    instead of always returning a different one.</p><a name="x_Hs" class="calibre27" id="x_Hs"></a><p class="docText">It would be a bad idea to directly make the
    Reader type an instance of the MonadSupply
    class, because then <span class="docEmphasis">any</span> Reader could act
    as a MonadSupply. This would usually not make any
    sense.</p><a name="x_Is" class="calibre27" id="x_Is"></a><p class="docText">Instead, we create a <tt class="calibre34">newtype</tt> based on
    Reader. The <tt class="calibre34">newtype</tt> hides the fact that we're
    using Reader internally. We must now make our type an
    instance of both of the typeclasses we care about. With the
    <tt class="calibre34">GeneralizedNewtypeDeriving</tt><a name="I_indexterm15_d1e35348" class="calibre27" id="I_indexterm15_d1e35348"></a> extension enabled, <span class="docMonofont">GHC</span> will do most of the hard work for
    us:</p><pre class="calibre39">-- file: ch15/SupplyInstance.hs
newtype MySupply e a = MySupply { runMySupply :: Reader e a }
    deriving (Monad)

instance MonadSupply e (MySupply e) where
    next = MySupply $ do
             v &lt;- ask
             return (Just v)

    -- more concise:
    -- next = MySupply (Just `liftM` ask)</pre><br class="calibre48"/>
<a name="x_Js" class="calibre27" id="x_Js"></a><p class="docText">Notice that we must make our type an instance of
    MonadSupply e, not MonadSupply. If we omit the
    type variable, the compiler will complain.</p><a name="x_Ks" class="calibre27" id="x_Ks"></a><p class="docText">To try out our MySupply type, we'll first
    create a simple function that should work with any
    MonadSupply instance:</p><pre class="calibre39">-- file: ch15/SupplyInstance.hs
xy :: (Num s, MonadSupply s m) =&gt; m s
xy = do
  Just x &lt;- next
  Just y &lt;- next
  return (x * y)</pre><br class="calibre48"/>
<a name="x_Ls" class="calibre27" id="x_Ls"></a><p class="docText">If we use this with our Supply monad and
    <i class="docEmphasis">randomsIO</i> function, we get a
    different answer every time, as we expect:</p><pre class="calibre39">ghci&gt; <b class="calibre40">(fst . runSupply xy) `fmap` randomsIO</b>
3155268008533561605104245047686121354
ghci&gt; <b class="calibre40">(fst . runSupply xy) `fmap` randomsIO</b>
1764220767702892260034822063450517650</pre><a name="x_Ms" class="calibre27" id="x_Ms"></a><p class="docText">Because our MySupply monad has two layers of
    <tt class="calibre34">newtype</tt> wrapping, we can write a custom execution function
    for it to make it easier to use:</p><pre class="calibre39">-- file: ch15/SupplyInstance.hs
runMS :: MySupply i a -&gt; i -&gt; a
runMS = runReader . runMySupply</pre><br class="calibre48"/>
<a name="x_Ns" class="calibre27" id="x_Ns"></a><p class="docText">When we apply our <i class="docEmphasis">xy</i>
    action using this execution function, we get the same answer every time.
    Our code remains the same, but because we are executing it in a different
    implementation of MonadSupply, its behavior has
    changed:</p><pre class="calibre39">ghci&gt; <b class="calibre40">runMS xy 2</b>
4
ghci&gt; <b class="calibre40">runMS xy 2</b>
4</pre><a name="x_Os" class="calibre27" id="x_Os"></a><p class="docText">Like our MonadSupply typeclass and
    Supply monad, almost all of the common Haskell monads are
    built with a split between interface and implementation. For example, the
    <i class="docEmphasis">get</i> and <i class="docEmphasis">put</i> functions that we introduced as
    "belonging to" the State monad are actually
    methods of the MonadState typeclass; the State
    type is an instance of this class.</p><a name="x_Ps" class="calibre27" id="x_Ps"></a><p class="docText">Similarly, the standard Reader monad is an
    instance of the MonadReader typeclass, which specifies the
    <i class="docEmphasis">ask</i> method.</p><a name="x_Qs" class="calibre27" id="x_Qs"></a><p class="docText">While the separation of interface and implementation that
    we discussed is appealing for its architectural cleanliness, it has
    important practical applications that will become clearer later. When we
    start combining monads in <a class="docLink" href="monadtrans_split_000.html#monadtrans">Chapter 18</a>, we will save a
    lot of effort through the use of <tt class="calibre34">GeneralizedNewtypeDeriving</tt>
    and typeclasses.</p>
<a href="21061538.html" class="calibre2"><img src="pixel.gif" alt="" border="0" class="calibre31"/></a><ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"> 
           
          <span class="calibre33"><a target="_self" href="I_sect115_d1e35180.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="I_sect115_d1e35473_split_000.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

