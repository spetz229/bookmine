---
layout: page
title: "Real World Haskell, 1st Edition"
prev: fp_readability.html
next: library_split_000.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"> 
           
          <span class="calibre9"><a target="_self" href="fp_readability.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="library_split_000.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="fp_seq" class="calibre27" id="fp_seq"></a><h3 id="title-IDAHZ1VD" class="docSection1Title">4.12. Space Leaks and Strict Evaluation</h3><a name="x_PD1" class="calibre27" id="x_PD1"></a><p class="docText">The <i class="docEmphasis">foldl</i>
    function<a name="ch04-spaceleaks" class="calibre27" id="ch04-spaceleaks"></a><a name="ch04-evaluationstrict" class="calibre27" id="ch04-evaluationstrict"></a><a name="ch04-strictevaluation" class="calibre27" id="ch04-strictevaluation"></a> that we discussed earlier is not the only place where space
    leaks can happen in Haskell code. We will use it to illustrate how
    nonstrict evaluation can sometimes be problematic and how to solve the
    difficulties that can arise.</p><p class="calibre37"><table border="0" cellspacing="0" cellpadding="1" width="90%" class="calibre41"><tr class="calibre16"><td class="v3"><table width="100%" border="0" cellspacing="0" cellpadding="6" class="calibre42"><tr class="calibre16"><td width="60" valign="top" class="v3"><img src="tip_yellow.gif" alt="" class="calibre43"/></td><td valign="top" class="v3"><p class="docNormalTitle">Do you need to know all of this right now?</p><a name="x_QD1" class="calibre27" id="x_QD1"></a><p class="docText">It is perfectly reasonable to skip this section until
      you encounter a space leak "in the wild." Provided you use
      <i class="docEmphasis">foldr</i> if you are generating a list,
      and <i class="docEmphasis">foldl'</i> instead of <i class="docEmphasis">foldl</i> otherwise, space leaks are unlikely to
      bother you in practice for a while.</p></td></tr></table></td></tr></table></p><br class="calibre48"/><a name="fp_seqd1e12586" class="calibre27" id="fp_seqd1e12586"></a><h4 id="title-IDAX01VD" class="docSection1Title">4.12.1. Avoiding Space Leaks with seq</h4><a name="x_RD1" class="calibre27" id="x_RD1"></a><p class="docText">We refer to an expression that is not evaluated lazily
      as <span class="docEmphasis">strict</span>, so <i class="docEmphasis">foldl'</i> is a strict left fold. It bypasses
      Haskell's usual nonstrict evaluation through the use of a
      special<a name="ch04-seq" class="calibre27" id="ch04-seq"></a> function named <i class="docEmphasis">seq</i>:</p><pre class="calibre39">-- file: ch04/Fold.hs
foldl' _    zero []     = zero
foldl' step zero (x:xs) =
    let new = step zero x
    in  new `seq` foldl' step new xs</pre><br class="calibre48"/>
<a name="x_SD1" class="calibre27" id="x_SD1"></a><p class="docText">This <i class="docEmphasis">seq</i> function
      has a peculiar type, hinting that it is not playing by the usual
      rules:</p><pre class="calibre39">ghci&gt; <b class="calibre40">:type seq</b>
seq :: a -&gt; t -&gt; t
</pre><a name="x_TD1" class="calibre27" id="x_TD1"></a><p class="docText">It operates as follows: when a <i class="docEmphasis">seq</i> expression is evaluated, it forces its
      first argument to be evaluated, and then returns its second argument. It
      doesn't actually do anything with the first argument. <i class="docEmphasis">seq</i> exists solely as a way to force that
      value to be evaluated. Let's walk through a brief application to see
      what happens:</p><pre class="calibre39">-- file: ch04/Fold.hs
foldl' (+) 1 (2:[])</pre><br class="calibre48"/>
<a name="x_UD1" class="calibre27" id="x_UD1"></a><p class="docText">This expands as follows:</p><pre class="calibre39">-- file: ch04/Fold.hs
let new = 1 + 2
in new `seq` foldl' (+) new []</pre><br class="calibre48"/>
<a name="x_VD1" class="calibre27" id="x_VD1"></a><p class="docText">The use of <i class="docEmphasis">seq</i>
      forcibly evaluates <span class="docMonofont">new</span> to <tt class="calibre34">3</tt> and returns
      its second argument:</p><pre class="calibre39">-- file: ch04/Fold.hs
foldl' (+) 3 []</pre><br class="calibre48"/>
<a name="x_WD1" class="calibre27" id="x_WD1"></a><p class="docText">We end up with the following result:</p><pre class="calibre39">-- file: ch04/Fold.hs
3</pre><br class="calibre48"/>
<a name="x_XD1" class="calibre27" id="x_XD1"></a><p class="docText">Thanks to <i class="docEmphasis">seq</i>,
      there are no thunks in sight.</p><a name="fp_seqd1e12654" class="calibre27" id="fp_seqd1e12654"></a><h4 id="title-IDAU31VD" class="docSection1Title">4.12.2. Learning to Use seq</h4><a name="x_YD1" class="calibre27" id="x_YD1"></a><p class="docText">Without some direction, there is an element of mystery
      to using <i class="docEmphasis">seq</i> effectively. Here are
      some useful rules for using it well.</p><a name="x_ZD1" class="calibre27" id="x_ZD1"></a><p class="docText">To have any effect, a <i class="docEmphasis">seq</i> expression must be the first thing
      evaluated in an expression:</p><pre class="calibre39">-- file: ch04/Fold.hs
-- incorrect: seq is hidden by the application of someFunc
-- since someFunc will be evaluated first, seq may occur too late
hiddenInside x y = someFunc (x `seq` y)

-- incorrect: a variation of the above mistake
hiddenByLet x y z = let a = x `seq` someFunc y
                    in anotherFunc a z

-- correct: seq will be evaluated first, forcing evaluation of x
onTheOutside x y = x `seq` someFunc y</pre><br class="calibre48"/>
<a name="x_aD1" class="calibre27" id="x_aD1"></a><p class="docText">To strictly evaluate several values, chain applications
      of <i class="docEmphasis">seq</i> together:</p><pre class="calibre39">-- file: ch04/Fold.hs
chained x y z = x `seq` y `seq` someFunc z</pre><br class="calibre48"/>
<a name="x_bD1" class="calibre27" id="x_bD1"></a><p class="docText">A common mistake is to try to use <i class="docEmphasis">seq</i> with two unrelated expressions:</p><pre class="calibre39">-- file: ch04/Fold.hs
badExpression step zero (x:xs) =
    seq (step zero x)
        (badExpression step (step zero x) xs)</pre><br class="calibre48"/>
<a name="x_cD1" class="calibre27" id="x_cD1"></a><p class="docText">Here, the apparent intention is to evaluate <tt class="calibre34">step
      zero x</tt> strictly. Since the expression is duplicated in the body
      of the function, strictly evaluating the first instance of it will have
      no effect on the second. The use of <tt class="calibre34">let</tt> from the definition of <i class="docEmphasis">foldl'</i> just shows illustrates how to achieve
      this effect correctly.</p><a name="x_dD1" class="calibre27" id="x_dD1"></a><p class="docText">When evaluating an expression, <i class="docEmphasis">seq</i> stops as soon as it reaches a
      constructor. For simple types such as numbers, this means that it will
      evaluate them completely. Algebraic data types are a different story.
      Consider the value <tt class="calibre34">(1+2):(3+4):[]</tt>. If we apply <i class="docEmphasis">seq</i> to this, it will evaluate the
      <tt class="calibre34">(1+2)</tt> thunk. Since it will stop when it reaches the first
      <tt class="calibre34">(:)</tt> constructor, it will have no effect on the second
      thunk. The same is true for tuples: <tt class="calibre34">seq ((1+2),(3+4)) True</tt>
      will do nothing to the thunks inside the pair, since it immediately hits
      the pair's constructor.</p><a name="x_eD1" class="calibre27" id="x_eD1"></a><p class="docText">If necessary, we can use normal functional programming
      techniques to work around these limitations:</p><pre class="calibre39">-- file: ch04/Fold.hs
strictPair (a,b) = a `seq` b `seq` (a,b)

strictList (x:xs) = x `seq` x : strictList xs
strictList []     = []</pre><br class="calibre48"/>
<a name="x_fD1" class="calibre27" id="x_fD1"></a><p class="docText">It is important to understand that <i class="docEmphasis">seq</i> isn't free: it has to perform a check at
      runtime to see if an expression has been evaluated. Use it sparingly.
      For instance, while our <i class="docEmphasis">strictPair</i>
      function evaluates the contents of a pair up to the first constructor,
      it adds the overheads of pattern matching, two applications of <i class="docEmphasis">seq</i>, and the construction of a new tuple. If
      we were to measure its performance in the inner loop of a benchmark, we
      might find that it slows down the program.</p><a name="x_gD1" class="calibre27" id="x_gD1"></a><p class="docText">Aside from its performance cost if overused, <i class="docEmphasis">seq</i> is not a miracle cure-all for memory
      consumption problems. Just because you <span class="docEmphasis">can</span> evaluate
      something strictly doesn't mean you <span class="docEmphasis">should</span>.
      Careless use of <i class="docEmphasis">seq</i> may do nothing
      at all, move existing space leaks around, or introduce new leaks.</p><a name="x_hD1" class="calibre27" id="x_hD1"></a><p class="docText">The best guides to whether <i class="docEmphasis">seq</i> is necessary, and how well it is working,
      are performance measurement and profiling, which we will cover in <a class="docLink" href="profiling_split_000.html#profiling">Chapter 25</a>. From a base of empirical<a name="I_indexterm4_d1e12691" class="calibre27" id="I_indexterm4_d1e12691"></a>
      measurement, you will develop a reliable sense of when <i class="docEmphasis">seq</i> is most <a name="I_indexterm4_d1e12696" class="calibre27" id="I_indexterm4_d1e12696"></a><a name="I_indexterm4_d1e12697" class="calibre27" id="I_indexterm4_d1e12697"></a><a name="I_indexterm4_d1e12699" class="calibre27" id="I_indexterm4_d1e12699"></a><a name="I_indexterm4_d1e12700" class="calibre27" id="I_indexterm4_d1e12700"></a>useful.</p>
<a href="21061538.html" class="calibre2"><img src="pixel.gif" alt="" border="0" class="calibre31"/></a><ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"> 
           
          <span class="calibre33"><a target="_self" href="fp_readability.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="library_split_000.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

