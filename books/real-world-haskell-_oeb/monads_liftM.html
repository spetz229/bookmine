---
layout: page
title: "Real World Haskell, 1st Edition"
prev: monads_logger.html
next: I_sect114_d1e31773.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"> 
           
          <span class="calibre9"><a target="_self" href="monads_logger.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="I_sect114_d1e31773.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="monads_liftM" class="calibre27" id="monads_liftM"></a><h3 id="title-IDAI53SI" class="docSection1Title">14.7. Mixing Pure and Monadic Code</h3><a name="x_oX" class="calibre27" id="x_oX"></a><p class="docText">Based on the code we've seen so far, monads seem to have a
    substantial shortcoming: the type constructor that wraps a monadic value
    makes it tricky to use a normal, pure function on a value trapped inside a
    monadic wrapper. Here's a simple illustration of the apparent problem.
    Let's say we have a trivial piece of code that runs in the
    Logger monad and returns a string:</p><pre class="calibre39">        ghci&gt; 
        <b class="calibre40">let m = return "foo" :: Logger String</b></pre><a name="x_pX" class="calibre27" id="x_pX"></a><p class="docText">If we want to find out the length of that string, we can't
    simply call <i class="docEmphasis">length</i>. The string is
    wrapped, so the types don't match up:</p><pre class="calibre39">ghci&gt; <b class="calibre40">length m</b>

&lt;interactive&gt;:1:7:
    Couldn't match expected type `[a]'
           against inferred type `Logger String'
    In the first argument of `length', namely `m'
    In the expression: length m
    In the definition of `it': it = length m
</pre><a name="x_qX" class="calibre27" id="x_qX"></a><p class="docText">So far, to work around this, we've something like the
    following:</p><pre class="calibre39">ghci&gt; <b class="calibre40">:type   m &gt;&gt;= \s -&gt; return (length s)</b>
m &gt;&gt;= \s -&gt; return (length s) :: Logger Int
</pre><a name="x_rX" class="calibre27" id="x_rX"></a><p class="docText">We use <i class="docEmphasis">(&gt;&gt;=)</i> to
    unwrap the string, and then write a small anonymous function that calls
    <i class="docEmphasis">length</i> and rewraps the result using
    <i class="docEmphasis">return</i>.</p><a name="x_sX" class="calibre27" id="x_sX"></a><p class="docText">This need crops up often in Haskell code. You won't be
    surprised to learn that a shorthand already exists: we use the
    <span class="docEmphasis">lifting</span> technique that we introduced for functors in
    <a class="docLink" href="binary_functor.html#binary_functor">Section 10.5</a>. Lifting a pure function into a functor
    usually involves unwrapping the value inside the functor, calling the
    function on it, and rewrapping the result with the same
    constructor.</p><a name="x_tX" class="calibre27" id="x_tX"></a><p class="docText">We do exactly the same thing with a monad. Because the
    <tt class="calibre34">Monad</tt> typeclass already provides the <i class="docEmphasis">(&gt;&gt;=)</i> and <tt class="calibre34">return</tt> functions that know how to unwrap and
    wrap a value, the<a name="I_indexterm14_d1e31663" class="calibre27" id="I_indexterm14_d1e31663"></a> <i class="docEmphasis">liftM</i> function doesn't
    need to know any details of a monad's implementation:</p><pre class="calibre39">-- file: ch14/Logger.hs
liftM :: (Monad m) =&gt; (a -&gt; b) -&gt; m a -&gt; m b
liftM f m = m &gt;&gt;= \i -&gt;
            return (f i)</pre><br class="calibre48"/>
<a name="x_uX" class="calibre27" id="x_uX"></a><p class="docText">When we declare a type to be an instance of the
    <tt class="calibre34">Functor</tt> typeclass, we have to write our own version of
    <i class="docEmphasis">fmap</i> specially tailored to that type.
    By contrast, <i class="docEmphasis">liftM</i> doesn't need to
    know anything of a monad's internals, because they're abstracted by
    <i class="docEmphasis">(&gt;&gt;=)</i> and <tt class="calibre34">return</tt>. We<a name="I_indexterm14_d1e31691" class="calibre27" id="I_indexterm14_d1e31691"></a><a name="I_indexterm14_d1e31696" class="calibre27" id="I_indexterm14_d1e31696"></a> need to write it only once, with the appropriate type
    constraint.</p><a name="x_vX" class="calibre27" id="x_vX"></a><p class="docText">The <i class="docEmphasis">liftM</i> function is
    predefined for us in the standard <tt class="calibre34">Control.Monad</tt>
    module.</p><a name="x_wX" class="calibre27" id="x_wX"></a><p class="docText">To see how <i class="docEmphasis">liftM</i> can
    help readability, we'll compare two otherwise identical pieces of code.
    First, we'll look at the familiar kind that does not use <i class="docEmphasis">liftM</i>:</p><pre class="calibre39">-- file: ch14/Logger.hs
charClass_wordy (']':cs) =
    globToRegex' cs &gt;&gt;= \ds -&gt;
    return (']':ds)
charClass_wordy (c:cs) =
    charClass_wordy cs &gt;&gt;= \ds -&gt;
    return (c:ds)</pre><br class="calibre48"/>
<a name="x_xX" class="calibre27" id="x_xX"></a><p class="docText">Now we can eliminate the <i class="docEmphasis">(&gt;&gt;=)</i> and anonymous function cruft with
    <i class="docEmphasis">liftM</i>:</p><pre class="calibre39">-- file: ch14/Logger.hs
charClass (']':cs) = (']':) `liftM` globToRegex' cs
charClass (c:cs) = (c:) `liftM` charClass cs</pre><br class="calibre48"/>
<a name="x_yX" class="calibre27" id="x_yX"></a><p class="docText">As with <i class="docEmphasis">fmap</i>, we
    often use <i class="docEmphasis">liftM</i> in infix form. An
    easy way to read such an expression is "apply the pure function on the
    left to the result of the monadic action on the right."</p><a name="x_zX" class="calibre27" id="x_zX"></a><p class="docText">The <i class="docEmphasis">liftM</i> function is
    so useful that <tt class="calibre34">Control.Monad</tt> defines several variants, which
    combine longer chains of actions. We can see one in the last clause of our
    <i class="docEmphasis">globToRegex'</i> function:</p><pre class="calibre39">-- file: ch14/Logger.hs
globToRegex' (c:cs) = liftM2 (++) (escape c) (globToRegex' cs)

escape :: Char -&gt; Logger String
escape c
    | c `elem` regexChars = record "escape" &gt;&gt; return ['\\',c]
    | otherwise           = return [c]
  where regexChars = "\\+()^$.{}]|"</pre><br class="calibre48"/>
<a name="x_AY" class="calibre27" id="x_AY"></a><p class="docText">The <i class="docEmphasis">liftM2</i> function
    that we use here is defined as follows:</p><pre class="calibre39">-- file: ch14/Logger.hs
liftM2 :: (Monad m) =&gt; (a -&gt; b -&gt; c) -&gt; m a -&gt; m b -&gt; m c
liftM2 f m1 m2 =
    m1 &gt;&gt;= \a -&gt;
    m2 &gt;&gt;= \b -&gt;
    return (f a b)</pre><br class="calibre48"/>
<a name="x_BY" class="calibre27" id="x_BY"></a><p class="docText">It executes the first action, then the second, and then
    combines their results using the pure function <span class="docMonofont">f</span>, and
    wraps that result. In addition to <i class="docEmphasis">liftM2</i>, the variants in <tt class="calibre34">Control.Monad</tt> go up to <i class="docEmphasis">liftM5</i>.</p>
<ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"> 
           
          <span class="calibre33"><a target="_self" href="monads_logger.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="I_sect114_d1e31773.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

