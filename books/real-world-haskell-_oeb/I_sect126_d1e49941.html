---
layout: page
title: "Real World Haskell, 1st Edition"
prev: I_sect126_d1e49851.html
next: I_sect126_d1e50018.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"><a href="21061538.html" class="calibre13"><img src="btn_next_.gif" alt="Next" border="0" class="calibre26"/></a> 
           
          <span class="calibre9"><a target="_self" href="I_sect126_d1e49851.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="I_sect126_d1e50018.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="I_sect126_d1e49941" class="calibre27" id="I_sect126_d1e49941"></a><h3 id="643999-842" class="docSection1Title">26.7. The Immutable API</h3><a name="x_J81" class="calibre27" id="x_J81"></a><p class="docText">Our interface to the immutable Bloom filter has the same
    structure as the mutable API:</p><pre class="calibre39">-- file: ch26/BloomFilter.hs
module BloomFilter
    (
      Bloom
    , length
    , elem
    , notElem
    , fromList
    ) where

import BloomFilter.Internal
import BloomFilter.Mutable (insert, new)
import Data.Array.ST (runSTUArray)
import Data.Array.IArray ((!), bounds)
import Data.Word (Word32)
import Prelude hiding (elem, length, notElem)

length :: Bloom a -&gt; Int
length = fromIntegral . len

len :: Bloom a -&gt; Word32
len = succ . snd . bounds . blmArray

elem :: a -&gt; Bloom a -&gt; Bool
elt `elem` filt   = all test (blmHash filt elt)
  where test hash = blmArray filt ! (hash `mod` len filt)

notElem :: a -&gt; Bloom a -&gt; Bool
elt `notElem` filt = not (elt `elem` filt)</pre><br class="calibre48"/>
<a name="x_K81" class="calibre27" id="x_K81"></a><p class="docText">We provide an easy-to-use means to create an immutable
    Bloom filter, via a <i class="docEmphasis">fromList</i>
    function. This hides the ST monad from our users so that they
    see only the immutable type:</p><pre class="calibre39">-- file: ch26/BloomFilter.hs
fromList :: (a -&gt; [Word32])    -- family of hash functions to use
         -&gt; Word32             -- number of bits in filter
         -&gt; [a]                -- values to populate with
         -&gt; Bloom a
fromList hash numBits values =
    B hash . runSTUArray $
      do mb &lt;- new hash numBits
         mapM_ (insert mb) values
         return (mutArray mb)</pre><br class="calibre48"/>
<a name="x_L81" class="calibre27" id="x_L81"></a><p class="docText">The key to this function is <i class="docEmphasis">runSTUArray</i>. We mentioned earlier that in order
    to return an immutable array from the ST monad, we must
    freeze a mutable array. The <i class="docEmphasis">runSTUArray</i> function combines execution with
    freezing. Given an action that returns an STUArray, it
    executes the action using <i class="docEmphasis">runST</i>;
    freezes the STUArray that it returns; and returns that as a
    UArray.</p><a name="x_M81" class="calibre27" id="x_M81"></a><p class="docText">The <tt class="calibre34">MArray</tt> typeclass provides a <i class="docEmphasis">freeze</i> function that we could use instead, but
    <i class="docEmphasis">runSTUArray</i> is both more convenient
    and more efficient. The efficiency lies in the fact that <i class="docEmphasis">freeze</i> must copy the underlying data from the
    STUArray to the new UArray, in order to ensure
    that subsequent modifications of the STUArray cannot affect
    the contents of the UArray. Thanks to the type system,
    <i class="docEmphasis">runSTUArray</i> can guarantee that an
    STUArray is no longer accessible when it uses it to create a
    UArray. It can thus share the underlying contents between the
    two arrays, avoiding the copy.</p>
<ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"><a href="21061538.html" class="calibre2"><img src="btn_next_.gif" alt="Next" border="0" class="calibre31"/></a> 
           
          <span class="calibre33"><a target="_self" href="I_sect126_d1e49851.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="I_sect126_d1e50018.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

