---
layout: page
title: "Real World Haskell, 1st Edition"
prev: I_sect128_d1e51806.html
next: I_sect128_d1e51917.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"> 
           
          <span class="calibre9"><a target="_self" href="I_sect128_d1e51806.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="I_sect128_d1e51917.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="I_sect128_d1e51835" class="calibre27" id="I_sect128_d1e51835"></a><h3 id="title-IDAY53NB" class="docSection1Title">28.2. Some Simple Examples</h3><a name="x_pL1" class="calibre27" id="x_pL1"></a><p class="docText">In a multiplayer role playing game, a player's character
    will have some state such as health, possessions, and money. To explore
    the world of STM, let's start with a few simple functions and types based
    around working with some character state for a game. We will refine our
    code as we learn more about the API.</p><a name="x_qL1" class="calibre27" id="x_qL1"></a><p class="docText">The STM API is provided by the <tt class="calibre34">stm</tt> package,
    and its modules are in the <tt class="calibre34">Control.Concurrent.STM</tt> hierarchy:</p><pre class="calibre39">-- file: ch28/GameInventory.hs
{-# LANGUAGE GeneralizedNewtypeDeriving #-}

import Control.Concurrent.STM
import Control.Monad

data Item = Scroll
          | Wand
          | Banjo
            deriving (Eq, Ord, Show)

newtype Gold = Gold Int
    deriving (Eq, Ord, Show, Num)

newtype HitPoint = HitPoint Int
    deriving (Eq, Ord, Show, Num)

type Inventory = TVar [Item]
type Health = TVar HitPoint
type Balance = TVar Gold

data Player = Player {
      balance :: Balance,
      health :: Health,
      inventory :: Inventory
    }</pre><br class="calibre48"/>
<a name="x_rL1" class="calibre27" id="x_rL1"></a><p class="docText">The TVar parameterized type is a mutable
    variable that we can read or write inside an <i class="docEmphasis">atomically</i> block. For simplicity, we represent
    a player's inventory as a list of items. Notice, too, that we use
    <tt class="calibre34">newtype</tt> declarations so that we cannot accidentally confuse
    wealth with health.</p><a name="x_sL1" class="calibre27" id="x_sL1"></a><p class="docText">To perform a basic transfer of money from one
    Balance to another, all we have to do is adjust the values in
    each TVar:</p><pre class="calibre39">-- file: ch28/GameInventory.hs
basicTransfer qty fromBal toBal = do
  fromQty &lt;- readTVar fromBal
  toQty   &lt;- readTVar toBal
  writeTVar fromBal (fromQty - qty)
  writeTVar toBal   (toQty + qty)</pre><br class="calibre48"/>
<a name="x_tL1" class="calibre27" id="x_tL1"></a><p class="docText">Let's write a small function to try this out:</p><pre class="calibre39">-- file: ch28/GameInventory.hs
transferTest = do
  alice &lt;- newTVar (12 :: Gold)
  bob   &lt;- newTVar 4
  basicTransfer 3 alice bob
  liftM2 (,) (readTVar alice) (readTVar bob)</pre><br class="calibre48"/>
<a name="x_uL1" class="calibre27" id="x_uL1"></a><p class="docText">If we run this in <i class="docEmphasis">ghci</i>, it behaves as we should expect:</p><pre class="calibre39">ghci&gt; <b class="calibre40">:load GameInventory</b>
[1 of 1] Compiling Main             ( GameInventory.hs, interpreted )
Ok, modules loaded: Main.
ghci&gt; <b class="calibre40">atomically transferTest</b>
Loading package array-0.1.0.0 ... linking ... done.
Loading package stm-2.1.1.1 ... linking ... done.
(Gold 9,Gold 7)</pre><a name="x_vL1" class="calibre27" id="x_vL1"></a><p class="docText">The properties of atomicity and isolation guarantee that
    if another thread sees a change in <tt class="calibre34">bob</tt>'s balance, they will
    also be able to see the modification of <tt class="calibre34">alice</tt>'s
    balance.</p><a name="x_wL1" class="calibre27" id="x_wL1"></a><p class="docText">Even in a concurrent program, we strive to keep as much
    of our code as possible purely functional. This makes our code easier to
    reason about and to test. It also gives the underlying STM engine less
    work to do, since the data involved is not transactional. Here's a pure
    function that removes an item from the list we use to represent a player's
    inventory:</p><pre class="calibre39">-- file: ch28/GameInventory.hs
removeInv :: Eq a =&gt; a -&gt; [a] -&gt; Maybe [a]
removeInv x xs =
    case takeWhile (/= x) xs of
      (_:ys) -&gt; Just ys
      []     -&gt; Nothing</pre><br class="calibre48"/>
<a name="x_xL1" class="calibre27" id="x_xL1"></a><p class="docText">The result uses Maybe so that we can tell
    whether the item was actually present in the player's inventory.</p><a name="x_yL1" class="calibre27" id="x_yL1"></a><p class="docText">Here is a transactional function to give an item to
    another player, slightly complicated by the need to determine whether the
    donor actually <span class="docEmphasis">has</span> the item in question:</p><pre class="calibre39">-- file: ch28/GameInventory.hs
maybeGiveItem item fromInv toInv = do
  fromList &lt;- readTVar fromInv
  case removeInv item fromList of
    Nothing      -&gt; return False
    Just newList -&gt; do
      writeTVar fromInv newList
      destItems &lt;- readTVar toInv
      writeTVar toInv (item : destItems)
      return True</pre><br class="calibre48"/>
<a href="21061538.html" class="calibre2"><img src="pixel.gif" alt="" border="0" class="calibre31"/></a><ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"> 
           
          <span class="calibre33"><a target="_self" href="I_sect128_d1e51806.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="I_sect128_d1e51917.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

