---
layout: page
title: "Real World Haskell, 1st Edition"
prev: I_sect128_d1e51917.html
next: I_sect128_d1e52076.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"> 
           
          <span class="calibre9"><a target="_self" href="I_sect128_d1e51917.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="I_sect128_d1e52076.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="I_sect128_d1e51989" class="calibre27" id="I_sect128_d1e51989"></a><h3 id="title-IDANY4AD" class="docSection1Title">28.4. Retrying a Transaction</h3><a name="x_DM1" class="calibre27" id="x_DM1"></a><p class="docText">The API of our <i class="docEmphasis">maybeGiveItem</i> function is somewhat awkward. It
    gives an item only if the character actually possesses it, which is
    reasonable, but by returning a Bool, it complicates the code
    of its callers. Here is an item sale function that has to look at the
    result of <i class="docEmphasis">maybeGiveItem</i> to decide
    what to do next:</p><pre class="calibre39">-- file: ch28/GameInventory.hs
maybeSellItem :: Item -&gt; Gold -&gt; Player -&gt; Player -&gt; STM Bool
maybeSellItem item price buyer seller = do
  given &lt;- maybeGiveItem item (inventory seller) (inventory buyer)
  if given
    then do
      basicTransfer price (balance buyer) (balance seller)
      return True
    else return False</pre><br class="calibre48"/>
<a name="x_EM1" class="calibre27" id="x_EM1"></a><p class="docText">Not only do we have to check whether the item was given,
    we have to propagate an indication of success back to our caller. The
    complexity thus cascades outwards.</p><a name="x_FM1" class="calibre27" id="x_FM1"></a><p class="docText">There is a more elegant way to handle transactions that
    cannot succeed. The STM API provides a <i class="docEmphasis">retry</i> action that will immediately terminate an
    <i class="docEmphasis">atomically</i> block that cannot proceed.
    As the name suggests, when this occurs, execution of the block is
    restarted from scratch, with any previous modifications unperformed. Here
    is a rewrite of <i class="docEmphasis">maybeGiveItem</i> to use
    <i class="docEmphasis">retry</i>:</p><pre class="calibre39">-- file: ch28/GameInventory.hs
giveItem :: Item -&gt; Inventory -&gt; Inventory -&gt; STM ()

giveItem item fromInv toInv = do
  fromList &lt;- readTVar fromInv
  case removeInv item fromList of
    Nothing -&gt; retry
    Just newList -&gt; do
      writeTVar fromInv newList
      readTVar toInv &gt;&gt;= writeTVar toInv . (item :)</pre><br class="calibre48"/>
<a name="x_GM1" class="calibre27" id="x_GM1"></a><p class="docText">Our <i class="docEmphasis">basicTransfer</i>
    from earlier had a different kind of flaw: it did not check the sender's
    balance to see if she had sufficient money to transfer. We can use
    <i class="docEmphasis">retry</i> to correct this, while keeping
    the function's type the same:</p><pre class="calibre39">-- file: ch28/GameInventory.hs
transfer :: Gold -&gt; Balance -&gt; Balance -&gt; STM ()

transfer qty fromBal toBal = do
  fromQty &lt;- readTVar fromBal
  when (qty &gt; fromQty) $
    retry
  writeTVar fromBal (fromQty - qty)
  readTVar toBal &gt;&gt;= writeTVar toBal . (qty +)</pre><br class="calibre48"/>
<a name="x_HM1" class="calibre27" id="x_HM1"></a><p class="docText">Now that we are using <i class="docEmphasis">retry</i>, our item sale function becomes
    dramatically simpler:</p><pre class="calibre39">-- file: ch28/GameInventory.hs
sellItem :: Item -&gt; Gold -&gt; Player -&gt; Player -&gt; STM ()
sellItem item price buyer seller = do
  giveItem item (inventory seller) (inventory buyer)
  transfer price (balance buyer) (balance seller)</pre><br class="calibre48"/>
<a name="x_IM1" class="calibre27" id="x_IM1"></a><p class="docText">Its behavior is slightly different from our earlier
    function. Instead of immediately returning <tt class="calibre34">False</tt> if the seller doesn't have the item, it
    will block (if necessary) until both the seller has the item and the buyer
    has enough money to pay for it.</p><a name="x_JM1" class="calibre27" id="x_JM1"></a><p class="docText">The beauty of STM lies in the cleanliness of the code it
    lets us write. We can take two functions that work correctly, and use them
    to create a third that will also behave itself, all with minimal
    effort.</p><a name="I_sect128_d1e51989d1e52311" class="calibre27" id="I_sect128_d1e51989d1e52311"></a><h4 id="title-IDAA14AD" class="docSection1Title">28.4.1. What Happens When We Retry?</h4><a name="x_KM1" class="calibre27" id="x_KM1"></a><p class="docText">The <i class="docEmphasis">retry</i> function
      doesn't just make our code cleaner—its underlying behavior seems nearly
      magical. When we call it, it doesn't restart our transaction
      immediately. Instead, it blocks our thread until one or more of the
      variables that we touched before calling <i class="docEmphasis">retry</i> is changed by another thread.</p><a name="x_LM1" class="calibre27" id="x_LM1"></a><p class="docText">For instance, if we invoke <i class="docEmphasis">transfer</i> with insufficient funds, <i class="docEmphasis">retry</i> will <span class="docEmphasis">automatically
      wait</span> until our balance changes before it starts the <i class="docEmphasis">atomically</i> block again. The same happens with
      our new <i class="docEmphasis">giveItem</i> function: if the
      sender doesn't currently have the item in his inventory, the thread will
      block until he does.</p>
<ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"> 
           
          <span class="calibre33"><a target="_self" href="I_sect128_d1e51917.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="I_sect128_d1e52076.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

