---
layout: page
title: "Real World Haskell, 1st Edition"
prev: I_sect118_d1e39658_split_002.html
next: monadtrans_maybet_split_000.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"><a href="21061538.html" class="calibre13"><img src="btn_next_.gif" alt="Next" border="0" class="calibre26"/></a> 
           
          <span class="calibre9"><a target="_self" href="I_sect118_d1e39658_split_000.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="monadtrans_maybet_split_000.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="I_sect118_d1e39964" class="calibre27" id="I_sect118_d1e39964"></a><h3 id="643999-814" class="docSection1Title">18.5. Moving Down the Stack</h3><a name="x_wt" class="calibre27" id="x_wt"></a><p class="docText">So<a name="I_indexterm18_d1e39969" class="calibre27" id="I_indexterm18_d1e39969"></a><a name="I_indexterm18_d1e39970" class="calibre27" id="I_indexterm18_d1e39970"></a> far, our uses of monad
    transformers have been simple, and the plumbing of the <tt class="calibre34">mtl</tt>
    library has allowed us to avoid the details of how a stack of monads is
    constructed. Indeed, we already know enough about monad transformers to
    simplify many common programming tasks.</p><a name="x_xt" class="calibre27" id="x_xt"></a><p class="docText">There are a few useful ways in which we can depart from
    the comfort of <tt class="calibre34">mtl</tt>. Most often, a custom monad sits at the
    bottom of the stack, or a custom monad transformer lies somewhere within
    the stack. To understand the potential difficulty, let's look at an
    example.</p><a name="x_yt" class="calibre27" id="x_yt"></a><p class="docText">Suppose we have a custom monad transformer,
    CustomT:</p><pre class="calibre39">-- file: ch18/CustomT.hs
newtype CustomT m a = ...</pre><br class="calibre48"/>
<a name="x_zt" class="calibre27" id="x_zt"></a><p class="docText">In the framework that <tt class="calibre34">mtl</tt> provides, each
    monad transformer in the stack makes the API of a lower level available by
    providing instances of a host of typeclasses. We could follow this pattern
    and write a number of boilerplate instances:</p><pre class="calibre39">-- file: ch18/CustomT.hs
instance MonadReader r m =&gt; MonadReader r (CustomT m) where
    ...

instance MonadIO m =&gt; MonadIO (CustomT m) where
    ...</pre><br class="calibre48"/>
<a name="x_Au" class="calibre27" id="x_Au"></a><p class="docText">If the underlying monad was an instance of
    MonadReader, we would write a MonadReader
    instance for CustomT in which each function in the API passes
    through to the corresponding function in the underlying instance. This
    would allow higher-level code to only care that the stack as a whole is an
    instance of MonadReader, without knowing or caring about
    which layer provides the <span class="docEmphasis">real</span> implementation.</p><a name="x_Bu" class="calibre27" id="x_Bu"></a><p class="docText">Instead of relying on all of these typeclass instances to
    work for us behind the scenes, we can be explicit. The
    MonadTrans typeclass defines a useful <a name="I_indexterm18_d1e40016" class="calibre27" id="I_indexterm18_d1e40016"></a>function named <i class="docEmphasis">lift</i>:</p><pre class="calibre39">ghci&gt; <b class="calibre40">:m +Control.Monad.Trans</b>ghci&gt; <b class="calibre40">:info MonadTrans</b>
class MonadTrans t where lift :: (Monad m) =&gt; m a -&gt; t m a
  	-- Defined in Control.Monad.Trans</pre><a name="x_Cu" class="calibre27" id="x_Cu"></a><p class="docText">This function takes a monadic action from one layer down
    the stack, and turns it—in other words, <span class="docEmphasis">lifts</span> it—into
    an action in the current monad transformer. Every monad transformer is an
    instance of MonadTrans.</p><a name="x_Du" class="calibre27" id="x_Du"></a><p class="docText">We use the name <i class="docEmphasis">lift</i>
    based on its similarity of purpose <a name="I_indexterm18_d1e40048" class="calibre27" id="I_indexterm18_d1e40048"></a><a name="I_indexterm18_d1e40051" class="calibre27" id="I_indexterm18_d1e40051"></a>to <i class="docEmphasis">fmap</i> and<a name="I_indexterm18_d1e40058" class="calibre27" id="I_indexterm18_d1e40058"></a> <i class="docEmphasis">liftM</i>. In each case,
    we hoist something from a lower level of the type system to the level
    we're currently working in. The different options are described
    here:</p><dl class="docList1"><dt class="calibre48"><br class="calibre48"/><p class="calibre37"><span class="docPubcolor">
<i class="docEmphasis">fmap</i>
</span></p></dt><dd class="calibre49"><p class="docText">Elevates a pure function to the level of functors</p></dd><dt class="calibre48"><br class="calibre48"/><p class="calibre37"><span class="docPubcolor">
<i class="docEmphasis">liftM</i>
</span></p></dt><dd class="calibre49"><p class="docText">Takes a pure function to the level of monads</p></dd><dt class="calibre48"><br class="calibre48"/><p class="calibre37"><span class="docPubcolor">
<i class="docEmphasis">lift</i>
</span></p></dt><dd class="calibre49"><p class="docText">Raises a monadic action from one level beneath in the
          transformer stack to the current one</p></dd></dl><a name="x_Hu" class="calibre27" id="x_Hu"></a><p class="docText">Let's revisit the App monad stack we defined
    earlier (before we wrapped it with a <tt class="calibre34">newtype</tt>):</p><pre class="calibre39">-- file: ch18/UglyStack.hs
type App = ReaderT AppConfig (StateT AppState IO)</pre><br class="calibre48"/>
<a name="x_Iu" class="calibre27" id="x_Iu"></a><p class="docText">If we want to access the AppState carried by
    the StateT, we would usually rely on <tt class="calibre34">mtl</tt>'s
    typeclasses and instances to handle the plumbing for us:</p><pre class="calibre39">-- file: ch18/UglyStack.hs
implicitGet :: App AppState
implicitGet = get</pre><br class="calibre48"/>
<a name="x_Ju" class="calibre27" id="x_Ju"></a><p class="docText">The <i class="docEmphasis">lift</i> function
    lets us achieve the same effect, by lifting <i class="docEmphasis">get</i> from StateT into
    ReaderT:</p><pre class="calibre39">-- file: ch18/UglyStack.hs
explicitGet :: App AppState
explicitGet = lift get</pre><br class="calibre48"/>
<a name="x_Ku" class="calibre27" id="x_Ku"></a><p class="docText">Obviously, when we can let <tt class="calibre34">mtl</tt> do this work
    for us, we end up with cleaner code, but this is not always
    possible.</p><a name="I_sect118_d1e39964d1e40459" class="calibre27" id="I_sect118_d1e39964d1e40459"></a><h4 id="title-IDAWIHBD" class="docSection1Title">18.5.1. When Explicit Lifting Is Necessary</h4><a name="x_Lu" class="calibre27" id="x_Lu"></a><p class="docText">One case in which we <span class="docEmphasis">must</span> use
      <i class="docEmphasis">lift</i> is when we create a monad
      transformer stack in which instances of the same typeclass appear at
      multiple levels:</p><pre class="calibre39">-- file: ch18/StackStack.hs
type Foo = StateT Int (State String)</pre><br class="calibre48"/>
<a name="x_Mu" class="calibre27" id="x_Mu"></a><p class="docText">If we try to use the <i class="docEmphasis">put</i> action of the MonadState
      typeclass<a name="I_indexterm18_d1e40152" class="calibre27" id="I_indexterm18_d1e40152"></a>, the instance we will get is that of StateT
      Int, because it's at the top of the stack:</p><pre class="calibre39">-- file: ch18/StackStack.hs
outerPut :: Int -&gt; Foo ()
outerPut = put</pre><br class="calibre48"/>
<a name="x_Nu" class="calibre27" id="x_Nu"></a><p class="docText">In this case, the only way we can access the underlying
      State monad's <i class="docEmphasis">put</i> is
      through use of <i class="docEmphasis">lift</i>:</p><pre class="calibre39">-- file: ch18/StackStack.hs
innerPut :: String -&gt; Foo ()
innerPut = lift . put</pre><br class="calibre48"/>
<a name="x_Ou" class="calibre27" id="x_Ou"></a><p class="docText">Sometimes, we need to access a monad more than one level
      down the stack, in which case we must compose calls to <i class="docEmphasis">lift</i>. Each composed use of <i class="docEmphasis">lift</i> gives us access to one deeper
      level:</p><pre class="calibre39">-- file: ch18/StackStack.hs
type Bar = ReaderT Bool Foo

barPut :: String -&gt; Bar ()
barPut = lift . lift . put</pre><br class="calibre48"/>
<a name="x_Pu" class="calibre27" id="x_Pu"></a><p class="docText">When we need to use <i class="docEmphasis">lift</i>, it can be good style to write wrapper
      functions that do the lifting for us, as just shown, and to use those.
      The alternative of sprinkling explicit uses of <i class="docEmphasis">lift</i> throughout our code tends to look messy.
      Worse, it hardwires the details of the layout of our monad stack into
      our code, which will complicate any subsequent <span class="docEmphasis">modifications</span>.</p>
<ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"><a href="21061538.html" class="calibre2"><img src="btn_next_.gif" alt="Next" border="0" class="calibre31"/></a> 
           
          <span class="calibre33"><a target="_self" href="I_sect118_d1e39658_split_000.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="monadtrans_maybet_split_000.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

