---
layout: page
title: "Real World Haskell, 1st Edition"
prev: I_sect118_d1e39551.html
next: I_sect118_d1e39658_split_001.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"><a href="21061538.html" class="calibre13"><img src="btn_next_.gif" alt="Next" border="0" class="calibre26"/></a> 
           
          <span class="calibre9"><a target="_self" href="I_sect118_d1e39551.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="I_sect118_d1e39964.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="I_sect118_d1e39658" class="calibre27" id="I_sect118_d1e39658"></a><h3 id="643999-956" class="docSection1Title">18.4. Stacking Multiple Monad Transformers</h3><a name="x_Zt" class="calibre27" id="x_Zt"></a><p class="docText">As we<a name="ch18-stack001" class="calibre27" id="ch18-stack001"></a><a name="ch18-stackmultiple" class="calibre27" id="ch18-stackmultiple"></a><a name="ch18-monadsstacking" class="calibre27" id="ch18-monadsstacking"></a> have already mentioned, when we stack a monad transformer
    on a normal monad, the result is another monad. This suggests the
    possibility that we can again stack a monad transformer on top of our
    combined monad, in order to get a new monad and in fact, this is a common
    thing to do. Under what circumstances might we want to create such a
    stack?</p><ul class="calibre18"><li class="calibre19"><p class="docText">If we need to talk to the outside world, we'll have
        IO at the base of the stack. Otherwise, we will have some
        normal monad.</p></li><li class="calibre19"><p class="docText">If we add a ReaderT layer, <a name="I_indexterm18_d1e39692" class="calibre27" id="I_indexterm18_d1e39692"></a>we give ourselves access to read-only configuration
        <span class="docEmphasis">information</span>.</p></li><li class="calibre19"><p class="docText">Add a StateT layer, <a name="I_indexterm18_d1e39705" class="calibre27" id="I_indexterm18_d1e39705"></a>and we gain a global state that we can modify.</p></li><li class="calibre19"><p class="docText">Should we need the ability to log events, we can add a
        WriterT layer.</p></li></ul><a name="x_et" class="calibre27" id="x_et"></a><p class="docText">The power of this approach is that we can customize the
    stack to our exact needs, specifying which kinds of effects we want to
    support.</p><a name="x_ft" class="calibre27" id="x_ft"></a><p class="docText">As a small example of stacked monad transformers in
    action, here is a reworking of the <i class="docEmphasis">countEntries</i> function<a name="I_indexterm18_d1e39722" class="calibre27" id="I_indexterm18_d1e39722"></a> we developed earlier. We will modify it to recurse no
    deeper into a directory tree than a given amount and to record the maximum
    depth it reaches:</p><pre class="calibre39">-- file: ch18/UglyStack.hs
import System.Directory
import System.FilePath
import Control.Monad.Reader
import Control.Monad.State

data AppConfig = AppConfig {
      cfgMaxDepth :: Int
    } deriving (Show)

data AppState = AppState {
      stDeepestReached :: Int
    } deriving (Show)</pre><br class="calibre48"/>
<a name="x_gt" class="calibre27" id="x_gt"></a><p class="docText">We use ReaderT to store configuration data,
    in the form of the maximum depth of recursion we will perform. We also use
    StateT to record the maximum depth we reach during an actual
    traversal:</p><pre class="calibre39">-- file: ch18/UglyStack.hs
type App = ReaderT AppConfig (StateT AppState IO)</pre><br class="calibre48"/>
<a name="x_ht" class="calibre27" id="x_ht"></a><p class="docText">Our transformer stack has IO on the bottom,
    then StateT, with ReaderT on top. In this
    particular case, it doesn't matter whether we have ReaderT or
    WriterT on top, but IO must be on the
    bottom.</p><a name="x_SJ1" class="calibre27" id="x_SJ1"></a><p class="docText">Even a small stack of monad transformers quickly develops
    an unwieldy type name. We can use a <tt class="calibre34">type</tt> alias to reduce the lengths of the type
    signatures that we write.</p><a name="I_sidebar18_d1e39764" class="calibre27" id="I_sidebar18_d1e39764"></a></td>
                    </tr>
                  </table>
                </div>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

