---
layout: page
title: "Real World Haskell, 1st Edition"
prev: databases_statements.html
next: databases_metadata.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"> 
           
          <span class="calibre9"><a target="_self" href="databases_statements.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="databases_metadata.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="databases_readingresults" class="calibre27" id="databases_readingresults"></a><h3 id="title-IDABJNNN" class="docSection1Title">21.9. Reading Results</h3><a name="x_rc" class="calibre27" id="x_rc"></a><p class="docText">So far, we have discussed queries that insert or change
    data. Let's now go over getting data back out of the database. The type of
    the function <tt class="calibre34">quickQuery'</tt>
    looks<a name="I_indexterm21_d1e44893" class="calibre27" id="I_indexterm21_d1e44893"></a> very similar to <tt class="calibre34">run</tt>, but
    it returns a list of results instead of a count of changed rows. <tt class="calibre34">quickQuery'</tt> is normally used<a name="I_indexterm21_d1e44903" class="calibre27" id="I_indexterm21_d1e44903"></a> with SELECT statements. Let's see an example:</p><pre class="calibre39">ghci&gt; <b class="calibre40">conn &lt;- connectSqlite3 "test1.db"</b>ghci&gt; <b class="calibre40">quickQuery' conn "SELECT * from test where id &lt; 2" []</b>
[[SqlString "0",SqlNull],[SqlString "0",SqlString "zero"],
[SqlString "1",SqlString "one"],[SqlString "0",SqlNull],
[SqlString "0",SqlString "zero"],[SqlString "1",SqlString "one"]]
ghci&gt; <b class="calibre40">disconnect conn</b></pre><a name="x_sc" class="calibre27" id="x_sc"></a><p class="docText"><tt class="calibre34">quickQuery'</tt> works with
    replaceable parameters, as we just discussed. In this case, we aren't
    using any, so the set of values to replace is the empty list at the end of
    the <tt class="calibre34">quickQuery'</tt> call. <tt class="calibre34">quickQuery'</tt> returns a list of rows, where each
    row is itself represented as <tt class="calibre34">[SqlValue]</tt>. The values in the row are listed in
    the order returned by the database. You can use <tt class="calibre34">fromSql</tt> to convert them into regular Haskell
    types as needed.</p><a name="x_tc" class="calibre27" id="x_tc"></a><p class="docText">It's a bit hard to read that output. Let's extend this
    example to format the results nicely. Here's some code to do that:</p><pre class="calibre39">-- file: ch21/query.hs
import Database.HDBC.Sqlite3 (connectSqlite3)
import Database.HDBC

{- | Define a function that takes an integer representing the maximum
id value to look up.  Will fetch all matching rows from the test database
and print them to the screen in a friendly format. -}
query :: Int -&gt; IO ()
query maxId = 
    do -- Connect to the database
       conn &lt;- connectSqlite3 "test1.db"

       -- Run the query and store the results in r
       r &lt;- quickQuery' conn
            "SELECT id, desc from test where id &lt;= ? ORDER BY id, desc"
            [toSql maxId]

       -- Convert each row into a String
       let stringRows = map convRow r
                        
       -- Print the rows out
       mapM_ putStrLn stringRows

       -- And disconnect from the database
       disconnect conn

    where convRow :: [SqlValue] -&gt; String
          convRow [sqlId, sqlDesc] = 
              show intid ++ ": " ++ desc
              where intid = (fromSql sqlId)::Integer
                    desc = case fromSql sqlDesc of
                             Just x -&gt; x
                             Nothing -&gt; "NULL"
          convRow x = fail $ "Unexpected result: " ++ show x</pre><br class="calibre48"/>
<a name="x_uc" class="calibre27" id="x_uc"></a><p class="docText">This program does mostly the same thing as our example
    with <i class="docEmphasis">ghci</i> but with a new addition: the
    <tt class="calibre34">convRow</tt> function. This function takes a
    row of data from the database and converts it to a <tt class="calibre34">String</tt>. This string can then be easily printed
    out.</p><a name="x_vc" class="calibre27" id="x_vc"></a><p class="docText">Notice how we took <tt class="calibre34">intid</tt> from <tt class="calibre34">fromSql</tt> directly but processed <tt class="calibre34">fromSql sqlDesc</tt> as a <tt class="calibre34">Maybe String</tt> type. If you recall, we declared
    that the first column in this table can never contain a NULL value but
    that the second column could. Therefore, we can safely ignore the
    potential for a NULL in the first column but not in the second. It is
    possible to use <tt class="calibre34">fromSql</tt> to convert the
    second column to a <tt class="calibre34">String</tt> directly, and
    it would even work—until a row with a NULL in that position is
    encountered. This would cause a runtime exception. So, we convert a SQL
    NULL value into the string <tt class="calibre34">"NULL"</tt>. When
    printed, this will be indistinguishable from a SQL string <tt class="calibre34">'NULL'</tt>, but that's acceptable for this example.
    Let's try calling this function in <i class="docEmphasis">ghci</i>:</p><pre class="calibre39">ghci&gt; <b class="calibre40">:load query.hs</b>
[1 of 1] Compiling Main             ( query.hs, interpreted )
Ok, modules loaded: Main.
ghci&gt; <b class="calibre40">query 2</b>
0: NULL
0: NULL
0: zero
0: zero
1: one
1: one
2: two
2: two</pre><a name="databases_readingstatements" class="calibre27" id="databases_readingstatements"></a><h4 id="title-IDAMNNNN" class="docSection1Title">21.9.1. Reading with Statements</h4><a name="x_wc" class="calibre27" id="x_wc"></a><p class="docText">As we discussed in <a class="docLink" href="databases_statements.html#databases_statements">Section 21.8</a>, you can use statements for reading.
      There are a number of ways of reading data from statements that can be
      useful in certain situations. Like <tt class="calibre34">run</tt>, <tt class="calibre34">quickQuery'</tt> is a convenience function that in
      fact uses statements to accomplish its task.</p><a name="x_xc" class="calibre27" id="x_xc"></a><p class="docText">To create a statement for reading, we use <tt class="calibre34">prepare</tt> just as we would for a statement that
      will be used to write data. You also use <tt class="calibre34">execute</tt> to execute it on the database server.
      Then, we can use various functions to read data from the <tt class="calibre34">Statement</tt>. The <tt class="calibre34">fetchAllRows'</tt> function<a name="I_indexterm21_d1e45022" class="calibre27" id="I_indexterm21_d1e45022"></a><a name="I_indexterm21_d1e45025" class="calibre27" id="I_indexterm21_d1e45025"></a><a name="I_indexterm21_d1e45029" class="calibre27" id="I_indexterm21_d1e45029"></a> returns <tt class="calibre34">[[SqlValue]]</tt>,
      just like <tt class="calibre34">quickQuery'</tt>. There is also
      a function called <tt class="calibre34">sFetchAllRows'</tt>,
      which converts every column's data to <tt class="calibre34">Maybe
      String</tt> before returning it. Finally, there is <tt class="calibre34">fetchAllRowsAL'</tt>, which returns <tt class="calibre34">(String, SqlValue)</tt> pairs for each column. The
      <tt class="calibre34">String</tt> is the column name as returned
      by the database; see <a class="docLink" href="databases_metadata.html#databases_metadata">Section 21.10</a> for other
      ways to obtain column names.</p><a name="x_yc" class="calibre27" id="x_yc"></a><p class="docText">You can also read data one row at a time by calling
      <tt class="calibre34">fetchRow</tt>, which returns <tt class="calibre34">IO (Maybe [SqlValue])</tt>. It will be <tt class="calibre34">Nothing</tt> if all the results have already been
      read, or one row otherwise.</p><a name="databases_readinglazy" class="calibre27" id="databases_readinglazy"></a><h4 id="title-IDAVQNNN" class="docSection1Title">21.9.2. Lazy Reading</h4><a name="x_zc" class="calibre27" id="x_zc"></a><p class="docText">Back in <a class="docLink" href="io_lazy.html#io_lazy">Section 7.4</a>, we talked about lazy
      I/O from files. <a name="I_indexterm21_d1e45075" class="calibre27" id="I_indexterm21_d1e45075"></a><a name="I_indexterm21_d1e45080" class="calibre27" id="I_indexterm21_d1e45080"></a>It is also possible to read data lazily from databases.
      This can be particularly useful when dealing with queries that return an
      exceptionally large amount of data. By reading data lazily, you can
      still use convenient functions such as <tt class="calibre34">fetchAllRows</tt> instead of having to manually
      read each row as it comes in. If we are careful in our use of the data,
      we can avoid having to buffer all of the results in memory.</p><a name="x_Ad" class="calibre27" id="x_Ad"></a><p class="docText">Lazy reading from a database, however, is more complex
      than reading from a file. When we're done reading data lazily from a
      file, the file is closed—which is generally fine. When we're done
      reading data lazily from a database, the database connection is still
      open—you may be submitting other queries with it, for instance. Some
      databases can even support multiple simultaneous queries, so HDBC can't
      just close the connection when we're done.</p><a name="x_Bd" class="calibre27" id="x_Bd"></a><p class="docText">When using lazy reading, it is critically important that
      we finish reading the entire data set before we attempt to close the
      connection or execute a new query. We encourage you to use the strict
      functions, or row-by-row processing, wherever possible to minimize
      complex interactions with lazy reading.</p><p class="calibre37"><table border="0" cellspacing="0" cellpadding="1" width="90%" class="calibre41"><tr class="calibre16"><td class="v3"><table width="100%" border="0" cellspacing="0" cellpadding="6" class="calibre42"><tr class="calibre16"><td width="60" valign="top" class="v3"><img src="tip_yellow.gif" alt="" class="calibre43"/></td><td valign="top" class="v3"><a name="x_gv" class="calibre27" id="x_gv"></a><p class="docText">If you are new to HDBC or the concept of lazy reading
        but have lots of data to read, repeated calls to <tt class="calibre34">fetchRow</tt> may be easier to understand. Lazy
        reading is a powerful and useful tool, but must be used
        correctly.</p></td></tr></table></td></tr></table></p><br class="calibre48"/><a name="x_Cd" class="calibre27" id="x_Cd"></a><p class="docText">To read lazily from a database, we use the same
      functions we used before, without the apostrophe. For instance, use
      <tt class="calibre34">fetchAllRows</tt> instead of <tt class="calibre34">fetchAllRows'</tt>. The types of the lazy
      functions<a name="I_indexterm21_d1e45105" class="calibre27" id="I_indexterm21_d1e45105"></a> are the same as their strict cousins. Here's an example
      of lazy reading:</p><pre class="calibre39">ghci&gt; <b class="calibre40">conn &lt;- connectSqlite3 "test1.db"</b>ghci&gt; <b class="calibre40">stmt &lt;- prepare conn "SELECT * from test where id &lt; 2"</b>ghci&gt; <b class="calibre40">execute stmt []</b>
0
ghci&gt; <b class="calibre40">results &lt;- fetchAllRowsAL stmt</b>
[[("id",SqlString "0"),("desc",SqlNull)],[("id",SqlString "0"),
("desc",SqlString "zero")],[("id",SqlString "1"),("desc",SqlString "one")]
,[("id",SqlString "0"),("desc",SqlNull)],[("id",SqlString "0"),
("desc",SqlString "zero")],[("id",SqlString "1"),("desc",SqlString "one")]]
ghci&gt; <b class="calibre40">mapM_ print results</b>
[("id",SqlString "0"),("desc",SqlNull)]
[("id",SqlString "0"),("desc",SqlString "zero")]
[("id",SqlString "1"),("desc",SqlString "one")]
[("id",SqlString "0"),("desc",SqlNull)]
[("id",SqlString "0"),("desc",SqlString "zero")]
[("id",SqlString "1"),("desc",SqlString "one")]ghci&gt; <b class="calibre40">disconnect conn</b></pre><a name="x_Dd" class="calibre27" id="x_Dd"></a><p class="docText">Note that you could have used <tt class="calibre34">fetchAllRowsAL'</tt> here<a name="I_indexterm21_d1e45148" class="calibre27" id="I_indexterm21_d1e45148"></a> as well. However, if you had a large data set to read, it
      would consume a lot of memory. By reading the data lazily, we can print
      out extremely large result sets using a constant amount of memory. With
      the lazy version, results will be evaluated in chunks; with the strict
      version, all results are read up front, stored in RAM, and then
      printed.</p>
<a href="21061538.html" class="calibre2"><img src="pixel.gif" alt="" border="0" class="calibre31"/></a><ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"> 
           
          <span class="calibre33"><a target="_self" href="databases_statements.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="databases_metadata.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

