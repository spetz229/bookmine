---
layout: page
title: "Real World Haskell, 1st Edition"
prev: concurrent_hard_split_001.html
next: I_sect124_d1e47441_split_000.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"> 
           
          <span class="calibre9"><a target="_self" href="concurrent_hard_split_000.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="I_sect124_d1e47441_split_000.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="I_sect124_d1e47262" class="calibre27" id="I_sect124_d1e47262"></a><h3 id="title-IDAOY2CF" class="docSection1Title">24.8. Using Multiple Cores with GHC</h3><a name="x_x41" class="calibre27" id="x_x41"></a><p class="docText">By default<a name="I_indexterm24_d1e47267" class="calibre27" id="I_indexterm24_d1e47267"></a>, <span class="docMonofont">GHC</span> generates<a name="ch24-multicoreprogramming" class="calibre27" id="ch24-multicoreprogramming"></a><a name="I_indexterm24_d1e47275" class="calibre27" id="I_indexterm24_d1e47275"></a> programs that use just one core, even when we write
    explicitly concurrent code. To use multiple cores, we must explicitly
    choose to do so. We make this <a name="I_indexterm24_d1e47281" class="calibre27" id="I_indexterm24_d1e47281"></a>choice at <span class="docEmphasis">link time</span>, when we are
    generating an executable program:</p><ul class="calibre18"><li class="calibre19"><p class="docText">The <span class="docEmphasis">nonthreaded</span>
        runtime<a name="I_indexterm24_d1e47295" class="calibre27" id="I_indexterm24_d1e47295"></a> library runs all Haskell threads in a single operating
        system thread. This runtime is highly efficient for creating threads
        and passing data around in MVars.</p></li><li class="calibre19"><p class="docText">The <span class="docEmphasis">threaded</span> runtime<a name="I_indexterm24_d1e47308" class="calibre27" id="I_indexterm24_d1e47308"></a> library uses multiple operating system threads to run
        Haskell threads. It has somewhat more overhead for creating threads
        and using MVars.</p></li></ul><a name="x_A51" class="calibre27" id="x_A51"></a><p class="docText">If we pass the <i class="docEmphasis">-threaded</i> option
    <a name="I_indexterm24_d1e47320" class="calibre27" id="I_indexterm24_d1e47320"></a>to the compiler, it will link our program against the
    threaded runtime library. We do not need to use <i class="docEmphasis">-threaded</i>
    when we are compiling libraries or source files—only when we are finally
    generating an executable.</p><a name="x_B51" class="calibre27" id="x_B51"></a><p class="docText">Even when we select the threaded runtime for our program,
    it will still default to using only one core when we run it. We must
    explicitly tell the runtime how many cores to use.</p><a name="I_sect124_d1e47262d1e47616" class="calibre27" id="I_sect124_d1e47262d1e47616"></a><h4 id="title-IDA302CF" class="docSection1Title">24.8.1. Runtime Options</h4><a name="x_C51" class="calibre27" id="x_C51"></a><p class="docText">We can pass<a name="I_indexterm24_d1e47334" class="calibre27" id="I_indexterm24_d1e47334"></a> options to <span class="docMonofont">GHC</span>'s runtime system on the command line
      of our program. Before handing control to our code, the runtime scans
      the program's arguments for the special command-line option
      <i class="docEmphasis">+RTS</i>. It interprets everything that follows (until the
      special option <i class="docEmphasis">-RTS</i>) as an option for the runtime
      system, not our program. It hides all of these options from our code.
      When we use<a name="I_indexterm24_d1e47347" class="calibre27" id="I_indexterm24_d1e47347"></a> the <tt class="calibre34">System.Environment</tt> module's <i class="docEmphasis">getArgs</i> function to obtain our command-line
      arguments, we will not find any runtime options in the list.</p><a name="x_D51" class="calibre27" id="x_D51"></a><p class="docText">The threaded runtime accepts an option
      <i class="docEmphasis">-N</i>.<sup class="docFootnote"><a class="docLink1" href="#x_D51d1e47650">[57]</a></sup> This takes one argument, which specifies the number of
      cores that <span class="docMonofont">GHC</span>'s runtime
      system should use. The option parser is picky: there cannot be any
      spaces between <i class="docEmphasis">-N</i> and the number that follows it. The
      option <i class="docEmphasis">-N4</i> is acceptable, but
      <i class="docEmphasis">-N 4</i> is not.</p><blockquote class="calibre30"><p class="docFootnote1"><sup class="calibre50"><a name="x_D51d1e47650" class="calibre5" id="x_D51d1e47650">[57]</a></sup> The nonthreaded runtime does not understand this
          option and will reject it with an error message.</p></blockquote><a name="I_sect124_d1e47262d1e47667" class="calibre27" id="I_sect124_d1e47262d1e47667"></a><h4 id="title-IDAU22CF" class="docSection1Title">24.8.2. Finding the Number of Available Cores from Haskell</h4><a name="x_F51" class="calibre27" id="x_F51"></a><p class="docText">The module <tt class="calibre34">GHC.Conc</tt> exports<a name="I_indexterm24_d1e47388" class="calibre27" id="I_indexterm24_d1e47388"></a> a variable, <span class="docMonofont">numCapabilities</span>, that
      tells us how many cores the runtime system has been given with<a name="I_indexterm24_d1e47395" class="calibre27" id="I_indexterm24_d1e47395"></a> the <i class="docEmphasis">-N</i> RTS option:</p><pre class="calibre39">-- file: ch24/NumCapabilities.hs
import GHC.Conc (numCapabilities)
import System.Environment (getArgs)

main = do
  args &lt;- getArgs
  putStrLn $ "command line arguments: " ++ show args
  putStrLn $ "number of cores: " ++ show numCapabilities</pre><br class="calibre48"/>
<a name="x_G51" class="calibre27" id="x_G51"></a><p class="docText">If we compile and run this program, we can see that the
      options to the runtime system are not visible to the program, but we can
      see how many cores it can run on:</p><pre class="calibre39">$<b class="calibre40">ghc -c NumCapabilities.hs</b>$<b class="calibre40">ghc -threaded -o NumCapabilities NumCapabilities.o</b>$<b class="calibre40">./NumCapabilities +RTS -N4 -RTS foo</b>
command line arguments: ["foo"]
number of cores: 4</pre><a name="I_sect124_d1e47262d1e47707" class="calibre27" id="I_sect124_d1e47262d1e47707"></a><h4 id="title-IDAD42CF" class="docSection1Title">24.8.3. Choosing the Right Runtime</h4><a name="x_H51" class="calibre27" id="x_H51"></a><p class="docText">The decision of which runtime to use is not completely
      clear cut. While the threaded runtime can use multiple cores, it has a
      cost: threads and sharing data between them are more expensive than with
      the nonthreaded runtime.</p><a name="x_I51" class="calibre27" id="x_I51"></a><p class="docText">Furthermore, the garbage collector used by <span class="docMonofont">GHC</span> as of version 6.8.3 is
      single-threaded: it pauses all other threads while it runs and executes
      on one core. This limits the performance improvement we can hope to see
      from using multiple cores.<sup class="docFootnote"><a class="docLink1" href="#x_I51d1e47717">[58]</a></sup> In many real-world concurrent programs, an individual
      thread will spend most of its time waiting for a network request or
      response. In these cases, if a single Haskell program serves tens of
      thousands of concurrent clients, the lower overhead of the nonthreaded
      runtime may be helpful. For example, instead of having a single server
      program use the threaded runtime on four cores, we might see better
      performance if we design our server so that we can run four copies of it
      simultaneously and use the nonthreaded runtime.</p><blockquote class="calibre30"><p class="docFootnote1"><sup class="calibre50"><a name="x_I51d1e47717" class="calibre5" id="x_I51d1e47717">[58]</a></sup> As of this writing, the garbage collector is being
          retooled to use multiple cores, but we cannot yet predict its future
          effect.</p></blockquote><a name="x_K51" class="calibre27" id="x_K51"></a><p class="docText">Our purpose here is not to dissuade you from using the
      threaded runtime. It is not much more expensive than the nonthreaded
      runtime—threads remain amazingly cheap compared to the runtimes of most
      other programming languages. We merely want to make it clear that
      switching to the threaded runtime will not necessarily result in an
      automatic win.</p>
<a href="21061538.html" class="calibre2"><img src="pixel.gif" alt="" border="0" class="calibre31"/></a><ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"> 
           
          <span class="calibre33"><a target="_self" href="concurrent_hard_split_000.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="I_sect124_d1e47441_split_000.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

