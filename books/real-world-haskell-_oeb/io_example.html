---
layout: page
title: "Real World Haskell, 1st Edition"
prev: io_files.html
next: io_lazy.html
book_path: books/real-world-haskell-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>

    <a name="toppage" class="calibre5" id="toppage"></a>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody">
      <tr valign="top" class="calibre6">
        <td class="calibre7">
          <a name="MainContent" class="calibre5" id="MainContent"></a>
          <table width="95%" class="sfbody">
            <tr class="calibre6">
              <td class="v">
                <!--Copyright (c) 2002 Safari Tech Books Online-->
                <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody">
                  <tr class="calibre6">
                    <td valign="middle" class="v1" height="5">
                      <img src="pixel.gif" alt="" border="0" class="calibre8"/>
                    </td>
                  </tr>
                  <tr class="calibre6">
                    <td valign="middle" class="v1">
                      <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody">
                        <tr class="calibre6">
                          <td class="v"><span class="calibre9"> </span>
                   
                  <span class="calibre9">   </span>
             <span class="calibre9"> </span></td>
                        </tr>
                      </table>
                    </td>
                    <td class="v1"/>
                    <td valign="middle" class="v2"> 
           
          <span class="calibre9"><a target="_self" href="io_files.html" title="Previous section" class="calibre13"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre14"/></a></span>
				
				 
				
				<span class="calibre9"><a target="_self" href="io_lazy.html" title="Next section" class="calibre13"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre14"/></a></span></td>
                  </tr>
                </table>
                <div id="section" class="calibre15">
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v3">Safari IT Books Language Constructs Functional Programming Haskell Safari IT Books Programming Programming Programming Bryan O'Sullivan  Donald Bruce Stewart  John Goerzen  O'Reilly Media, Inc. Real World Haskell, 1st Edition<a name="io_example" class="calibre27" id="io_example"></a><h3 id="title-IDAKKHNG" class="docSection1Title">7.3. Extended Example: Functional I/O and Temporary Files</h3><a name="x_HD" class="calibre27" id="x_HD"></a><p class="docText">Here's<a name="I_indexterm7_d1e19757" class="calibre27" id="I_indexterm7_d1e19757"></a><a name="I_indexterm7_d1e19758" class="calibre27" id="I_indexterm7_d1e19758"></a> a larger example that puts
    together some concepts from this chapter, from some earlier chapters, and
    a few you haven't seen yet. Take a look at the program and see if you can
    figure out what it does and how it works:</p><pre class="calibre39">-- file: ch07/tempfile.hs
import System.IO
import System.Directory(getTemporaryDirectory, removeFile)
import System.IO.Error(catch)
import Control.Exception(finally)

-- The main entry point.  Work with a temp file in myAction.
main :: IO ()
main = withTempFile "mytemp.txt" myAction

{- The guts of the program.  Called with the path and handle of a temporary
   file.  When this function exits, that file will be closed and deleted
   because myAction was called from withTempFile. -}
myAction :: FilePath -&gt; Handle -&gt; IO ()
myAction tempname temph = 
    do -- Start by displaying a greeting on the terminal
       putStrLn "Welcome to tempfile.hs"
       putStrLn $ "I have a temporary file at " ++ tempname

       -- Let's see what the initial position is
       pos &lt;- hTell temph
       putStrLn $ "My initial position is " ++ show pos

       -- Now, write some data to the temporary file
       let tempdata = show [1..10]
       putStrLn $ "Writing one line containing " ++ 
                  show (length tempdata) ++ " bytes: " ++
                  tempdata
       hPutStrLn temph tempdata

       -- Get our new position.  This doesn't actually modify pos
       -- in memory, but makes the name "pos" correspond to a different 
       -- value for the remainder of the "do" block.
       pos &lt;- hTell temph
       putStrLn $ "After writing, my new position is " ++ show pos

       -- Seek to the beginning of the file and display it
       putStrLn $ "The file content is: "
       hSeek temph AbsoluteSeek 0

       -- hGetContents performs a lazy read of the entire file
       c &lt;- hGetContents temph

       -- Copy the file byte-for-byte to stdout, followed by \n
       putStrLn c

       -- Let's also display it as a Haskell literal
       putStrLn $ "Which could be expressed as this Haskell literal:"
       print c

{- This function takes two parameters: a filename pattern and another
   function.  It will create a temporary file, and pass the name and Handle
   of that file to the given function.

   The temporary file is created with openTempFile.  The directory is the one
   indicated by getTemporaryDirectory, or, if the system has no notion of
   a temporary directory, "." is used.  The given pattern is passed to
   openTempFile.

   After the given function terminates, even if it terminates due to an
   exception, the Handle is closed and the file is deleted. -}
withTempFile :: String -&gt; (FilePath -&gt; Handle -&gt; IO a) -&gt; IO a
withTempFile pattern func =
    do -- The library ref says that getTemporaryDirectory may raise on
       -- exception on systems that have no notion of a temporary directory.
       -- So, we run getTemporaryDirectory under catch.  catch takes
       -- two functions: one to run, and a different one to run if the
       -- first raised an exception.  If getTemporaryDirectory raised an
       -- exception, just use "." (the current working directory).
       tempdir &lt;- catch (getTemporaryDirectory) (\_ -&gt; return ".")
       (tempfile, temph) &lt;- openTempFile tempdir pattern 

       -- Call (func tempfile temph) to perform the action on the temporary
       -- file.  finally takes two actions.  The first is the action to run.
       -- The second is an action to run after the first, regardless of
       -- whether the first action raised an exception.  This way, we ensure
       -- the temporary file is always deleted.  The return value from finally
       -- is the first action's return value.
       finally (func tempfile temph) 
               (do hClose temph
                   removeFile tempfile)</pre><br class="calibre48"/>
<a name="x_ID" class="calibre27" id="x_ID"></a><p class="docText">Let's start looking at this program from the end. The
    <tt class="calibre34">withTempFile</tt> function demonstrates that
    Haskell doesn't forget its functional nature when I/O is introduced. This
    function takes a <tt class="calibre34">String</tt> and another
    function. The function passed to <tt class="calibre34">withTempFile</tt> is invoked with the name and
    <tt class="calibre34">Handle</tt> of a temporary file. When that
    function exits, the temporary file is closed and deleted. So even when
    dealing with I/O, we can still find the idiom of passing functions as
    parameters to be convenient. Lisp programmers might find our <tt class="calibre34">withTempFile</tt> function similar to Lisp's <tt class="calibre34">with-open-file</tt> function.</p><a name="x_JD" class="calibre27" id="x_JD"></a><p class="docText">There is some exception handling going on to make the
    program more robust in the face of errors. You normally want the temporary
    files to be deleted after processing completes, even if something went
    wrong. So we make sure that happens. For more on exception handling, see
    <a class="docLink" href="errors_split_000.html#errors">Chapter 19</a>.</p><a name="x_KD" class="calibre27" id="x_KD"></a><p class="docText">Let's return to the start of the program. <tt class="calibre34">main</tt> is defined simply as <tt class="calibre34">withTempFile "mytemp.txt" myAction</tt>. <tt class="calibre34">myAction</tt>, then, will be invoked with the name
    and <tt class="calibre34">Handle</tt> of the temporary
    file.</p><a name="x_LD" class="calibre27" id="x_LD"></a><p class="docText"><tt class="calibre34">myAction</tt> displays some
    information to the terminal, writes some data to the file, seeks to the
    beginning of the file, and reads the data back with <tt class="calibre34">hGetContents</tt>.<sup class="docFootnote"><a class="docLink1" href="#x_LDd1e20168">[22]</a></sup> It then displays the contents of the file byte for byte and
    also as a Haskell literal via <tt class="calibre34">print c</tt>.
    That's the same as <tt class="calibre34">putStrLn (show
    c)</tt>.</p><blockquote class="calibre30"><p class="docFootnote1"><sup class="calibre50"><a name="x_LDd1e20168" class="calibre5" id="x_LDd1e20168">[22]</a></sup> <tt class="calibre34">hGetContents</tt> is
        discussed in <a class="docLink" href="io_lazy.html#io_lazy">Section 7.4</a></p></blockquote><a name="x_ND" class="calibre27" id="x_ND"></a><p class="docText">Let's look at the output:</p><pre class="calibre39">$ <b class="calibre40">runhaskell tempfile.hs</b>
Welcome to tempfile.hs
I have a temporary file at /tmp/mytemp8572.txt
My initial position is 0
Writing one line containing 22 bytes: [1,2,3,4,5,6,7,8,9,10]
After writing, my new position is 23
The file content is:
[1,2,3,4,5,6,7,8,9,10]

Which could be expressed as this Haskell literal:
"[1,2,3,4,5,6,7,8,9,10]\n"</pre><a name="x_OD" class="calibre27" id="x_OD"></a><p class="docText">Every time you run this program, your temporary filename
    should be slightly different, since it contains a randomly generated
    component. Looking at this output, there are a few questions that might
    occur to you:</p><div class="calibre15"><ol class="docList2" type="1"><li class="calibre19"><div class="calibre15"><p class="docText">Why is your position 23 after writing a line with 22
        bytes?</p></div></li><li class="calibre19"><div class="calibre15"><p class="docText">Why is there an empty line after the file content
        display?</p></div></li><li class="calibre19"><div class="calibre15"><p class="docText">Why is there a <tt class="calibre34">\n</tt>
        at the end of the Haskell literal display?</p></div></li></ol></div><a name="x_SD" class="calibre27" id="x_SD"></a><p class="docText">You might be able to guess that the answers to all three
    questions are related. See if you can work out the answers for a moment.
    If you need some help, here are the <span class="docEmphasis">explanations</span>:</p><div class="calibre15"><ol class="docList2" type="1"><li class="calibre19"><div class="calibre15"><p class="docText">Because we used <tt class="calibre34">hPutStrLn</tt> instead of <tt class="calibre34">hPutStr</tt> to write the data. <tt class="calibre34">hPutStrLn</tt> always terminates the line by
        writing a <tt class="calibre34">\n</tt> at the end, which
        didn't appear in <tt class="calibre34">tempdata</tt>.</p></div></li><li class="calibre19"><div class="calibre15"><p class="docText">We used <tt class="calibre34">putStrLn c</tt>
        to display the file contents <tt class="calibre34">c</tt>.
        Because the data was written originally with <tt class="calibre34">hPutStrLn</tt>, <tt class="calibre34">c</tt> ends with the newline character, and
        <tt class="calibre34">putStrLn</tt> adds a second newline
        character. The result is a blank line.</p></div></li><li class="calibre19"><div class="calibre15"><p class="docText">The <tt class="calibre34">\n</tt> is the
        newline character from the original <tt class="calibre34">hPutStrLn</tt>.</p></div></li></ol></div><a name="x_dN" class="calibre27" id="x_dN"></a><p class="docText">As a final note, the byte counts may be different on some
    operating systems. Windows, for instance, uses the two-byte sequence
    <tt class="calibre34">\r\n</tt> as the end-of-line marker, so you
    may see differences on that platform.</p>
<a href="21061538.html" class="calibre2"><img src="pixel.gif" alt="" border="0" class="calibre31"/></a><ul class="calibre18"></ul></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="middle" class="v3" height="5">
                        <img src="pixel.gif" alt="" border="0" class="calibre32"/>
                      </td>
                    </tr>
                    <tr class="calibre16">
                      <td valign="middle" class="v3">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" class="sfbody1">
                          <tr class="calibre16">
                            <td class="v5"><span class="calibre33"> </span>
                   
                  <span class="calibre33">   </span>
             <span class="calibre33"> </span></td>
                          </tr>
                        </table>
                      </td>
                      <td class="v3"/>
                      <td valign="middle" class="v6"> 
           
          <span class="calibre33"><a target="_self" href="io_files.html" title="Previous section" class="calibre2"><img border="0" src="btn_prev.gif" alt="Previous section" id="btn_prev" class="calibre17"/></a></span>
				
				 
				
				<span class="calibre33"><a target="_self" href="io_lazy.html" title="Next section" class="calibre2"><img border="0" src="btn_next.gif" alt="Next section" id="btn_next" class="calibre17"/></a></span></td>
                    </tr>
                  </table>
                  <table width="100%" border="0" cellspacing="0" cellpadding="2" class="sfbody1">
                    <tr class="calibre16">
                      <td valign="top" class="v6">
                        <span class="calibre33"></span>
                      </td>
                    </tr>
                  </table>
                </div>
                <!--IP User 2-->
              </td>
            </tr>
          </table>
        </td>
        <td class="calibre7">
                         
                      </td>
      </tr>
      <tr class="calibre6">
        <td colspan="3" valign="bottom" class="calibre7">
          <br class="calibre20"/>
          <p class="v4"></p>
          <br class="calibre20"/>
        </td>
      </tr>
    </table>
  </div>

{% endraw %}

