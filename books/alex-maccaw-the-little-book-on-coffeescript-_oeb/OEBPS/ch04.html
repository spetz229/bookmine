---
layout: page
title: "The Little Book on CoffeeScript"
prev: OEBPS/ch03s11.html
next: OEBPS/ch04s02.html
book_path: books/alex-maccaw-the-little-book-on-coffeescript-_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="calibre1"></div><div class="book" title="Chapter 4. Compiling CoffeeScript"><div class="book"><div class="book"><div class="book"><div class="calibre1"></div><h1 class="title1"><a id="compiling_coffeescript" class="calibre2"></a>Chapter 4. Compiling CoffeeScript</h1></div></div></div><p class="calibre8">An issue with CoffeeScript is that it puts another layer between you
  and JavaScript, and having to manually compile CoffeeScript files whenever
  they change quickly gets old. Fortunately, CoffeeScript has some alternative
  forms of compilation that can make the development cycle somewhat
  smoother.</p><p class="calibre8">As we covered in <a class="ulink" href="pr01s02.html" title="Initial Setup">Initial Setup</a>, we can compile
  CoffeeScript files using the coffee executable:</p><pre class="screen">coffee --compile --output lib src</pre><p class="calibre8">However, calling that whenever a source file changes is a bit of a
  bore, so let’s look into automating it.</p><div class="book" title="Cake"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="I_sect14_d1e1546" class="calibre2"></a>Cake</h1></div></div></div><p class="calibre8"><a class="ulink" href="http://jashkenas.github.com/coffee-script/#cake">Cake</a> is a
    super simple build system along the lines of <a class="ulink" href="http://www.gnu.org/software/make/">Make</a> and <a class="ulink" href="http://rake.rubyforge.org/">Rake</a>. The library is bundled with
    the <code class="literal">coffee-script</code> npm package, and
    available via an executable called <code class="literal">cake</code>.</p><p class="calibre8">You can define tasks using CoffeeScript in a file called <code class="literal">Cakefile</code>. Cake will pick these up, and can be
    invoked by running <code class="literal">cake [task]
    [options]</code> from within the directory. To print a list of all the
    tasks and options, just type <code class="literal">cake</code>.</p><p class="calibre8">Tasks are defined using the <code class="literal">task()</code> function, passing a name, optional
    description, and callback function. For example, create a file called
    <code class="literal">Cakefile</code>, and two directories, <code class="literal">lib</code> and <code class="literal">src</code>.
    Add the following to the <code class="literal">Cakefile</code>:</p><pre class="screen">fs = require 'fs'

{print} = require 'util'
{spawn} = require 'child_process'

build = (callback) -&gt;
  coffee = spawn 'coffee', ['-c', '-o', 'lib', 'src']
  coffee.stderr.on 'data', (data) -&gt;
    process.stderr.write data.toString()
  coffee.stdout.on 'data', (data) -&gt;
    print data.toString()
  coffee.on 'exit', (code) -&gt;
    callback?() if code is 0

task 'build', 'Build lib/ from src/', -&gt;
  build()</pre><p class="calibre8">In the example above, we’re defining a task called <code class="literal">build</code> that can be invoked by running <code class="literal">cake build</code>. This runs the same command as the
    previous example, compiling all the CoffeeScript files in <code class="literal">src</code> to JavaScript in <code class="literal">lib</code>. You can now reference JavaScript files in
    the <code class="literal">lib</code> directory as per usual from
    your HTML:</p><pre class="screen">&lt;script src="lib/app.js" type="text/javascript" charset="utf-8"&gt;&lt;/script&gt;</pre><p class="calibre8">We’re still having to manually run <code class="literal">cake
    build</code> whenever our CoffeeScript code changes, which is far from
    ideal. Luckily, the <code class="literal">coffee</code> command
    takes another option, <code class="literal">--watch</code>, which
    instructs it to watch a directory for changes and re-compiling as
    necessary. Let’s define another task using that:</p><pre class="screen">task 'watch', 'Watch src/ for changes', -&gt;
  coffee = spawn 'coffee', ['-w', '-c', '-o', 'lib', 'src']
  coffee.stderr.on 'data', (data) -&gt;
    process.stderr.write data.toString()
  coffee.stdout.on 'data', (data) -&gt;
    print data.toString()</pre><p class="calibre8">If one task relies on another, you can run other tasks using
    <code class="literal">invoke(name)</code>. Let’s add a utility task
    to our <code class="literal">Cakefile</code> which is going to both
    open <code class="literal">index.html</code> and start watching the
    source for changes:</p><pre class="screen">task 'open', 'Open index.html', -&gt;
  # First open, then watch
  spawn 'open', 'index.html'
  invoke 'watch'</pre><p class="calibre8">You can also define options for your task using the <code class="literal">option()</code> function, which takes a short name,
    long name, and description:</p><pre class="screen">option '-o', '--output [DIR]', 'output dir'

task 'build', 'Build lib/ from src/', -&gt;
  # Now we have access to a `options` object
  coffee = spawn 'coffee', ['-c', '-o', options.output or 'lib', 'src']
  coffee.stderr.on 'data', (data) -&gt;
    process.stderr.write data.toString()
  coffee.stdout.on 'data', (data) -&gt;
    print data.toString()</pre><p class="calibre8">As you can see, the task context now has access to an <code class="literal">options</code> object containing any data specified by
    the user. If we run <code class="literal">cake</code> without any
    other arguments, all the tasks and options will be listed.</p><p class="calibre8">Cake’s a great way of automating common tasks such as compiling
    CoffeeScript without going to the hassle of using bash or Makefiles. It’s
    also worth taking a look at <a class="ulink" href="http://jashkenas.github.com/coffee-script/documentation/docs/cake.html">Cake’s
    source</a>, a great example of CoffeeScript’s expressiveness and
    beautifully documented alongside the code comments.</p></div></div></div>

{% endraw %}

