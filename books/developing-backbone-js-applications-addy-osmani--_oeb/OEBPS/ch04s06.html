---
layout: page
title: "Developing Backbone.js Applications"
prev: OEBPS/ch04s05.html
next: OEBPS/ch04s07.html
book_path: books/developing-backbone-js-applications-addy-osmani--_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="book" title="Decoupling Backbone with the Mediator and Facade patterns"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="decoupling-backbone-with-the-mediator-and-facade-patterns" class="calibre1"></a>Decoupling Backbone with the
    Mediator and Facade patterns</h1></div></div></div><p class="calibre6">
      In this section we’ll discuss applying some of the concepts I
      cover in my article on
      <a class="ulink" href="http://addyosmani.com/largescalejavascript">Large-scale
      JavaScript Application development</a> to Backbone.
    </p><div class="book" title="Summary"><div class="book"><div class="book"><div class="book"><h2 class="title3"><a id="summary-1" class="calibre1"></a>Summary</h2></div></div></div><p class="calibre6">
        At a high-level, one architecture that works for such
        applications is something which is:
      </p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre6">
            <span class="firstname"><strong class="calibre8">Highly decoupled</strong></span>:
            encouraging modules to only publish and subscribe to events
            of interest rather than directly communicating with each
            other. This helps us to build applications who’s units of
            code aren’t highly tied (coupled) together and can thus be
            reused more easily.
          </p></li><li class="listitem"><p class="calibre6">
            <span class="firstname"><strong class="calibre8">Supports module-level
            security</strong></span>: whereby modules are only able to
            execute behavior they’ve been permitted to. Application
            security is an area which is often overlooked in JavaScript
            applications, but can be quite easily implemented in a
            flexible manner.
          </p></li><li class="listitem"><p class="calibre6">
            <span class="firstname"><strong class="calibre8">Supports failover</strong></span>:
            allowing an application continuing to function even if
            particular modules fail. The typical example I give of this
            is the GMail chat widget. Imagine being able to build
            applications in a way that if one widget on the page fails
            (e.g chat), the rest of your application (mail) can continue
            to function without being affected.
          </p></li></ul></div><p class="calibre6">
        This is an architecture which has been implemented by a number
        of different companies in the past, including Yahoo! (for their
        modularized homepage - which Nicholas Zakas has
        <a class="ulink" href="http://www.youtube.com/watch?v=vXjVFPosQHw">spoken</a>
        about) and AOL for some of our upcoming projects.
      </p><p class="calibre6">
        The three design patterns that make this architecture possible
        are the:
      </p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre6">
            <span class="firstname"><strong class="calibre8">Module pattern</strong></span>: used for
            encapsulating unique blocks of code, where functions and
            variables can be kept either public or private.
            (<span class="firstname">“<span class="firstname">private</span>”</span> in the simulation of privacy sense,
            as of course don’t have true privacy in JavaScript)
          </p></li><li class="listitem"><p class="calibre6">
            <span class="firstname"><strong class="calibre8">Mediator pattern</strong></span>: used
            when the communication between modules may be complex, but
            is still well defined. If it appears a system may have too
            many relationships between modules in your code, it may be
            time to have a central point of control, which is where the
            pattern fits in.
          </p></li><li class="listitem"><p class="calibre6">
            <span class="firstname"><strong class="calibre8">Facade pattern</strong></span>: used for
            providing a convenient higher-level interface to a larger
            body of code, hiding its true underlying complexity
          </p></li></ul></div><p class="calibre6">
        Their specific roles in this architecture can be found below.
      </p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre6">
            <span class="firstname"><strong class="calibre8">Modules</strong></span>: There are almost
            two concepts of what defines a module. As AMD is being used
            as a module wrapper, technically each model, view and
            collection can be considered a module. We then have the
            concept of modules being distinct blocks of code outside of
            just MVC/MV*. For the latter, these types of
            <span class="firstname">“<span class="firstname">modules</span>”</span> are primarily concerned with
            broadcasting and subscribing to events of interest rather
            than directly communicating with each other.They are made
            possible through the Mediator pattern.
          </p></li><li class="listitem"><p class="calibre6">
            <span class="firstname"><strong class="calibre8">Mediator</strong></span>: The mediator
            has a varying role depending on just how you wish to
            implement it. In my article, I mention using it as a module
            manager with the ability to start and stop modules at will,
            however when it comes to Backbone, I feel that simplifying
            it down to the role of a central <span class="firstname">“<span class="firstname">controller</span>”</span>
            that provides pub/sub capabilities should suffice. One can
            of course go all out in terms of building a module system
            that supports module starting, stopping, pausing etc,
            however the scope of this is outside of this chapter.
          </p></li><li class="listitem"><p class="calibre6">
            <span class="firstname"><strong class="calibre8">Facade</strong></span>: This acts as a
            secure middle-layer that both abstracts an application core
            (Mediator) and relays messages from the modules back to the
            Mediator so they don’t touch it directly. The Facade also
            performs the duty of application security guard; it checks
            event notifications from modules against a configuration
            (permissions.js, which we will look at later) to ensure
            requests from modules are only processed if they are
            permitted to execute the behavior passed.
          </p></li></ul></div><p class="calibre6">
        For ease of reference, I sometimes refer to these three patterns
        grouped together as Aura (a word that means subtle, luminous
        light).
      </p></div><div class="book" title="Practical"><div class="book"><div class="book"><div class="book"><h2 class="title3"><a id="practical-2" class="calibre1"></a>Practical</h2></div></div></div><p class="calibre6">
        For the practical section of this chapter, we’ll be extending
        the well-known Backbone Todo application using the three
        patterns mentioned above. The complete code for this section can
        be found here: https://github.com/addyosmani/backbone-aura and
        should ideally be run on at minimum, a local HTTP server.
      </p><p class="calibre6">
        The application is broken down into AMD modules that cover
        everything from Backbone models through to application-level
        modules. The views publish events of interest to the rest of the
        application and modules can then subscribe to these event
        notifications.
      </p><p class="calibre6">
        All subscriptions from modules go through a facade (or sandbox).
        What this does is check against the subscriber name and the
        <span class="firstname">“<span class="firstname">channel/notification</span>”</span> it’s attempting to subscribe
        to. If a channel <span class="firstname"><em class="calibre9">doesn’t</em></span> have permissions
        to be subscribed to (something established through
        permissions.js), the subscription isn’t permitted.
      </p><p class="calibre6">
        <span class="firstname"><strong class="calibre8">Mediator</strong></span>
      </p><p class="calibre6">
        Found in <code class="literal">aura/mediator.js</code>
      </p><p class="calibre6">
        Below is a very simple AMD-wrapped implementation of the
        mediator pattern, based on prior work by Ryan Florence. It
        accepts as it’s input an object, to which it attaches
        <code class="literal">publish()</code> and <code class="literal">subscribe()</code>
        methods. In a larger application, the mediator can contain
        additional utilities, such as handlers for initializing,
        starting and stopping modules, but for demonstration purposes,
        these two methods should work fine for our needs.
      </p><pre class="programlistingjavascript"><code class="nx">define</code><code class="p">([],</code> <code class="kd">function</code><code class="p">(</code><code class="nx">obj</code><code class="p">){</code>

  <code class="kd">var</code> <code class="nx">channels</code> <code class="o">=</code> <code class="p">{};</code>
  <code class="kd">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">obj</code><code class="p">)</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{};</code>

  <code class="nx">obj</code><code class="p">.</code><code class="nx">subscribe</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">channel</code><code class="p">,</code> <code class="nx">subscription</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">channels</code><code class="p">[</code><code class="nx">channel</code><code class="p">])</code> <code class="nx">channels</code><code class="p">[</code><code class="nx">channel</code><code class="p">]</code> <code class="o">=</code> <code class="p">[];</code>
    <code class="nx">channels</code><code class="p">[</code><code class="nx">channel</code><code class="p">].</code><code class="nx">push</code><code class="p">(</code><code class="nx">subscription</code><code class="p">);</code>
  <code class="p">};</code>

  <code class="nx">obj</code><code class="p">.</code><code class="nx">publish</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">channel</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">channels</code><code class="p">[</code><code class="nx">channel</code><code class="p">])</code> <code class="kd">return</code><code class="p">;</code>
    <code class="kd">var</code> <code class="nx">args</code> <code class="o">=</code> <code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>
    <code class="kd">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">l</code> <code class="o">=</code> <code class="nx">channels</code><code class="p">[</code><code class="nx">channel</code><code class="p">].</code><code class="nx">length</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">l</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">channels</code><code class="p">[</code><code class="nx">channel</code><code class="p">][</code><code class="nx">i</code><code class="p">].</code><code class="nx">apply</code><code class="p">(</code><code class="kd">this</code><code class="p">,</code> <code class="nx">args</code><code class="p">);</code>
    <code class="p">}</code>
  <code class="p">};</code>

  <code class="kd">return</code> <code class="nx">obj</code><code class="p">;</code>

<code class="p">});</code>
</pre><p class="calibre6">
        <span class="firstname"><strong class="calibre8">Facade</strong></span>
      </p><p class="calibre6">
        Found in <code class="literal">aura/facade.js</code>
      </p><p class="calibre6">
        Next, we have an implementation of the facade pattern. Now the
        classical facade pattern applied to JavaScript would probably
        look a little like this:
      </p><pre class="programlistingjavascript"><code class="kd">var</code> <code class="nx">module</code> <code class="o">=</code> <code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">_private</code> <code class="o">=</code> <code class="p">{</code>
        <code class="nx">i</code><code class="o">:</code><code class="mi">5</code><code class="p">,</code>
        <code class="nx">get</code> <code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'current value:'</code> <code class="o">+</code> <code class="kd">this</code><code class="p">.</code><code class="nx">i</code><code class="p">);</code>
        <code class="p">},</code>
        <code class="nx">set</code> <code class="o">:</code> <code class="kd">function</code><code class="p">(</code> <code class="nx">val</code> <code class="p">)</code> <code class="p">{</code>
            <code class="kd">this</code><code class="p">.</code><code class="nx">i</code> <code class="o">=</code> <code class="nx">val</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">run</code> <code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'running'</code><code class="p">);</code>
        <code class="p">},</code>
        <code class="nx">jump</code><code class="o">:</code> <code class="kd">function</code><code class="p">(){</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'jumping'</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">};</code>
    <code class="kd">return</code> <code class="p">{</code>
        <code class="nx">facade</code> <code class="o">:</code> <code class="kd">function</code><code class="p">(</code> <code class="nx">args</code> <code class="p">)</code> <code class="p">{</code>
            <code class="nx">_private</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="nx">args</code><code class="p">.</code><code class="nx">val</code><code class="p">);</code>
            <code class="nx">_private</code><code class="p">.</code><code class="nx">get</code><code class="p">();</code>
            <code class="kd">if</code> <code class="p">(</code> <code class="nx">args</code><code class="p">.</code><code class="nx">run</code> <code class="p">)</code> <code class="p">{</code>
                <code class="nx">_private</code><code class="p">.</code><code class="nx">run</code><code class="p">();</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}());</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">facade</code><code class="p">({</code><code class="nx">run</code><code class="o">:</code> <code class="kd">true</code><code class="p">,</code> <code class="nx">val</code><code class="o">:</code><code class="mi">10</code><code class="p">});</code>
<code class="c">//outputs current value: 10, running</code>
</pre><p class="calibre6">
        It’s effectively a variation of the module pattern, where
        instead of simply returning an interface of supported methods,
        your API can completely hide the true implementation powering
        it, returning something simpler. This allows the logic being
        performed in the background to be as complex as necessary,
        whilst all the end-user experiences is a simplified API they
        pass options to (note how in our case, a single method
        abstraction is exposed). This is a beautiful way of providing
        APIs that can be easily consumed.
      </p><p class="calibre6">
        That said, to keep things simple, our implementation of an
        AMD-compatible facade will act a little more like a proxy.
        Modules will communicate directly through the facade to access
        the mediator’s <code class="literal">publish()</code> and
        <code class="literal">subscribe()</code> methods, however, they won’t as
        such touch the mediator directly.This enables the facade to
        provide application-level validation of any subscriptions and
        publications made.
      </p><p class="calibre6">
        It also allows us to implement a simple, but flexible,
        permissions checker (as seen below) which will validate
        subscriptions made against a permissions configuration to see
        whether it’s permitted or not.
      </p><pre class="programlistingjavascript"><code class="nx">define</code><code class="p">([</code> <code class="s">"../aura/mediator"</code> <code class="p">,</code> <code class="s">"../aura/permissions"</code> <code class="p">],</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">mediator</code><code class="p">,</code> <code class="nx">permissions</code><code class="p">)</code> <code class="p">{</code>

    <code class="kd">var</code> <code class="nx">facade</code> <code class="o">=</code> <code class="nx">facade</code> <code class="o">||</code> <code class="p">{};</code>

    <code class="nx">facade</code><code class="p">.</code><code class="nx">subscribe</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">subscriber</code><code class="p">,</code> <code class="nx">channel</code><code class="p">,</code> <code class="nx">callback</code><code class="p">){</code>

        <code class="c">// Note: Handling permissions/security is optional here</code>
        <code class="c">// The permissions check can be removed </code>
        <code class="c">// to just use the mediator directly.</code>

        <code class="kd">if</code><code class="p">(</code><code class="nx">permissions</code><code class="p">.</code><code class="nx">validate</code><code class="p">(</code><code class="nx">subscriber</code><code class="p">,</code> <code class="nx">channel</code><code class="p">)){</code>
            <code class="nx">mediator</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code> <code class="nx">channel</code><code class="p">,</code> <code class="nx">callback</code> <code class="p">);</code>
        <code class="p">}</code>
    <code class="p">}</code>

    <code class="nx">facade</code><code class="p">.</code><code class="nx">publish</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">channel</code><code class="p">){</code>
        <code class="nx">mediator</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code> <code class="nx">channel</code> <code class="p">);</code>
    <code class="p">}</code>
    <code class="kd">return</code> <code class="nx">facade</code><code class="p">;</code>

<code class="p">});</code>
</pre><p class="calibre6">
        <span class="firstname"><strong class="calibre8">Permissions</strong></span>
      </p><p class="calibre6">
        Found in <code class="literal">aura/permissions.js</code>
      </p><p class="calibre6">
        In our simple permissions configuration, we support checking
        against subscription requests to establish whether they are
        allowed to clear. This enforces a flexible security layer for
        the application.
      </p><p class="calibre6">
        To visually see how this works, consider changing say,
        permissions -&gt; renderDone -&gt; todoCounter to be false. This
        will completely disable the application from from rendering or
        displaying the counts component for Todo items left (because
        they aren’t allowed to subscribe to that event notification).
        The rest of the Todo app can still however be used without
        issue.
      </p><p class="calibre6">
        It’s a very dumbed down example of the potential for application
        security, but imagine how powerful this might be in a large app
        with a significant number of visual widgets.
      </p><pre class="programlistingjavascript"><code class="nx">define</code><code class="p">([],</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>

    <code class="c">// Permissions</code>

    <code class="c">// A permissions structure can support checking</code>
    <code class="c">// against subscriptions prior to allowing them </code>
    <code class="c">// to clear. This enforces a flexible security </code>
    <code class="c">// layer for your application.</code>

    <code class="kd">var</code> <code class="nx">permissions</code> <code class="o">=</code> <code class="p">{</code>

        <code class="nx">newContentAvailable</code><code class="o">:</code> <code class="p">{</code>
            <code class="nx">contentUpdater</code><code class="o">:</code><code class="kd">true</code>
        <code class="p">},</code>

        <code class="nx">endContentEditing</code><code class="o">:</code><code class="p">{</code>
            <code class="nx">todoSaver</code><code class="o">:</code><code class="kd">true</code>
        <code class="p">},</code>

        <code class="nx">beginContentEditing</code><code class="o">:</code><code class="p">{</code>
            <code class="nx">editFocus</code><code class="o">:</code><code class="kd">true</code>
        <code class="p">},</code>

        <code class="nx">addingNewTodo</code><code class="o">:</code><code class="p">{</code>
            <code class="nx">todoTooltip</code><code class="o">:</code><code class="kd">true</code>
        <code class="p">},</code>

        <code class="nx">clearContent</code><code class="o">:</code><code class="p">{</code>
            <code class="nx">garbageCollector</code><code class="o">:</code><code class="kd">true</code>
        <code class="p">},</code>

        <code class="nx">renderDone</code><code class="o">:</code><code class="p">{</code>
            <code class="nx">todoCounter</code><code class="o">:</code><code class="kd">true</code> <code class="c">//switch to false to see what happens :)</code>
        <code class="p">},</code>

        <code class="nx">destroyContent</code><code class="o">:</code><code class="p">{</code>
            <code class="nx">todoRemover</code><code class="o">:</code><code class="kd">true</code>
        <code class="p">},</code>

        <code class="nx">createWhenEntered</code><code class="o">:</code><code class="p">{</code>
            <code class="nx">keyboardManager</code><code class="o">:</code><code class="kd">true</code>
        <code class="p">}</code>

    <code class="p">};</code>

    <code class="nx">permissions</code><code class="p">.</code><code class="nx">validate</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">subscriber</code><code class="p">,</code> <code class="nx">channel</code><code class="p">){</code>
        <code class="kd">var</code> <code class="nx">test</code> <code class="o">=</code> <code class="nx">permissions</code><code class="p">[</code><code class="nx">channel</code><code class="p">][</code><code class="nx">subscriber</code><code class="p">];</code>
        <code class="kd">return</code> <code class="nx">test</code><code class="o">===</code><code class="kd">undefined</code><code class="o">?</code> <code class="kd">false</code><code class="o">:</code> <code class="nx">test</code><code class="p">;</code>
    <code class="p">};</code>

    <code class="kd">return</code> <code class="nx">permissions</code><code class="p">;</code>

<code class="p">});</code>
</pre><p class="calibre6">
        <span class="firstname"><strong class="calibre8">Subscribers</strong></span>
      </p><p class="calibre6">
        Found in <code class="literal">subscribers.js</code>
      </p><p class="calibre6">
        Subscriber <span class="firstname">“<span class="firstname">modules</span>”</span> communicate through the facade
        back to the mediator and perform actions when a notification
        event of a particular name is published.
      </p><p class="calibre6">
        For example, when a user enters in a new piece of text for a
        Todo item and hits <span class="firstname">“<span class="firstname">enter</span>”</span> the application
        publishes a notification saying two things: a) a new Todo item
        is available and b) the text content of the new item is X. It’s
        then left up to the rest of the application to do with this
        information whatever it wishes.
      </p><p class="calibre6">
        In order to update your Backbone application to primarily use
        pub/sub, a lot of the work you may end up doing will be moving
        logic coupled inside of specific views to modules outside of it
        which are reactionary.
      </p><p class="calibre6">
        Take the <code class="literal">todoSaver</code> for example - it’s
        responsibility is saving new Todo items to models once the a
        <code class="literal">notificationName</code> called
        <span class="firstname">“<span class="firstname">newContentAvailable</span>”</span> has fired. If you take a look
        at the permissions structure in the last code sample, you’ll
        notice that <span class="firstname">“<span class="firstname">newContentAvailable</span>”</span> is present there.
        If I wanted to prevent subscribers from being able to subscribe
        to this notification, I simply set it to a boolean value of
        <code class="literal">false</code>.
      </p><p class="calibre6">
        Again, this is a massive oversimplification of how advanced your
        permissions structures could get, but it’s certainly one way of
        controlling what parts of your application can or can’t be
        accessed by specific modules at any time.
      </p><pre class="programlistingjavascript"><code class="nx">define</code><code class="p">([</code><code class="s">"jquery"</code><code class="p">,</code> <code class="s">"underscore"</code><code class="p">,</code> <code class="s">"aura/facade"</code><code class="p">],</code> 
<code class="kd">function</code> <code class="p">(</code><code class="nx">$</code><code class="p">,</code> <code class="nx">_</code><code class="p">,</code> <code class="nx">facade</code><code class="p">)</code> <code class="p">{</code>

    <code class="c">// Subscription 'modules' for our views. These take the </code>
    <code class="c">// the form facade.subscribe( subscriberName, notificationName , callBack )</code>

    <code class="c">// Update view with latest todo content</code>
    <code class="c">// Subscribes to: newContentAvailable</code>

    <code class="nx">facade</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s">'contentUpdater'</code><code class="p">,</code> <code class="s">'newContentAvailable'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">context</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">content</code> <code class="o">=</code> <code class="nx">context</code><code class="p">.</code><code class="nx">model</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s">'content'</code><code class="p">);</code>
        <code class="nx">context</code><code class="p">.</code><code class="nx">$</code><code class="p">(</code><code class="s">'.todo-content'</code><code class="p">).</code><code class="nx">text</code><code class="p">(</code><code class="nx">content</code><code class="p">);</code>
        <code class="nx">context</code><code class="p">.</code><code class="nx">input</code> <code class="o">=</code> <code class="nx">context</code><code class="p">.</code><code class="nx">$</code><code class="p">(</code><code class="s">'.todo-input'</code><code class="p">);</code>
        <code class="nx">context</code><code class="p">.</code><code class="nx">input</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="s">'blur'</code><code class="p">,</code> <code class="nx">context</code><code class="p">.</code><code class="nx">close</code><code class="p">);</code>
        <code class="nx">context</code><code class="p">.</code><code class="nx">input</code><code class="p">.</code><code class="nx">val</code><code class="p">(</code><code class="nx">content</code><code class="p">);</code>
    <code class="p">});</code>


    <code class="c">// Save models when a user has finishes editing</code>
    <code class="c">// Subscribes to: endContentEditing</code>
    <code class="nx">facade</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s">'todoSaver'</code><code class="p">,</code><code class="s">'endContentEditing'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">context</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">try</code> <code class="p">{</code>
            <code class="nx">context</code><code class="p">.</code><code class="nx">model</code><code class="p">.</code><code class="nx">save</code><code class="p">({</code>
                <code class="nx">content</code><code class="o">:</code> <code class="nx">context</code><code class="p">.</code><code class="nx">input</code><code class="p">.</code><code class="nx">val</code><code class="p">()</code>
            <code class="p">});</code>
            <code class="nx">context</code><code class="p">.</code><code class="nx">$el</code><code class="p">.</code><code class="nx">removeClass</code><code class="p">(</code><code class="s">"editing"</code><code class="p">);</code>
        <code class="p">}</code> <code class="kd">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
            <code class="c">//console.log(e);</code>
        <code class="p">}</code>
    <code class="p">});</code>


    <code class="c">// Delete a todo when the user no longer needs it</code>
    <code class="c">// Subscribes to: destroyContent</code>
    <code class="nx">facade</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s">'todoRemover'</code><code class="p">,</code><code class="s">'destroyContent'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">context</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">try</code> <code class="p">{</code>
            <code class="nx">context</code><code class="p">.</code><code class="nx">model</code><code class="p">.</code><code class="nx">clear</code><code class="p">();</code>
        <code class="p">}</code> <code class="kd">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
            <code class="c">//console.log(e);</code>
        <code class="p">}</code>
    <code class="p">});</code>


    <code class="c">// When a user is adding a new entry, display a tooltip</code>
    <code class="c">// Subscribes to: addingNewTodo</code>
    <code class="nx">facade</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s">'todoTooltip'</code><code class="p">,</code><code class="s">'addingNewTodo'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">context</code><code class="p">,</code> <code class="nx">todo</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">tooltip</code> <code class="o">=</code> <code class="nx">context</code><code class="p">.</code><code class="nx">$</code><code class="p">(</code><code class="s">".ui-tooltip-top"</code><code class="p">);</code>
        <code class="kd">var</code> <code class="nx">val</code> <code class="o">=</code> <code class="nx">context</code><code class="p">.</code><code class="nx">input</code><code class="p">.</code><code class="nx">val</code><code class="p">();</code>
        <code class="nx">tooltip</code><code class="p">.</code><code class="nx">fadeOut</code><code class="p">();</code>
        <code class="kd">if</code> <code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">tooltipTimeout</code><code class="p">)</code> <code class="nx">clearTimeout</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">tooltipTimeout</code><code class="p">);</code>
        <code class="kd">if</code> <code class="p">(</code><code class="nx">val</code> <code class="o">==</code> <code class="s">''</code> <code class="o">||</code> <code class="nx">val</code> <code class="o">==</code> <code class="nx">context</code><code class="p">.</code><code class="nx">input</code><code class="p">.</code><code class="nx">attr</code><code class="p">(</code><code class="s">'placeholder'</code><code class="p">))</code> <code class="kd">return</code><code class="p">;</code>
        <code class="kd">var</code> <code class="nx">show</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
                <code class="nx">tooltip</code><code class="p">.</code><code class="nx">show</code><code class="p">().</code><code class="nx">fadeIn</code><code class="p">();</code>
            <code class="p">};</code>
        <code class="nx">context</code><code class="p">.</code><code class="nx">tooltipTimeout</code> <code class="o">=</code> <code class="nx">_</code><code class="p">.</code><code class="nx">delay</code><code class="p">(</code><code class="nx">show</code><code class="p">,</code> <code class="mi">1000</code><code class="p">);</code>
    <code class="p">});</code>


    <code class="c">// Update editing UI on switching mode to editing content</code>
    <code class="c">// Subscribes to: beginContentEditing</code>
    <code class="nx">facade</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s">'editFocus'</code><code class="p">,</code><code class="s">'beginContentEditing'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">context</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">context</code><code class="p">.</code><code class="nx">$el</code><code class="p">.</code><code class="nx">addClass</code><code class="p">(</code><code class="s">"editing"</code><code class="p">);</code>
        <code class="nx">context</code><code class="p">.</code><code class="nx">input</code><code class="p">.</code><code class="nx">focus</code><code class="p">();</code>
    <code class="p">});</code>


    <code class="c">// Create a new todo entry </code>
    <code class="c">// Subscribes to: createWhenEntered</code>
    <code class="nx">facade</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s">'keyboardManager'</code><code class="p">,</code><code class="s">'createWhenEntered'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">context</code><code class="p">,</code> <code class="nx">e</code><code class="p">,</code> <code class="nx">todos</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">keyCode</code> <code class="o">!=</code> <code class="mi">13</code><code class="p">)</code> <code class="kd">return</code><code class="p">;</code>
        <code class="nx">todos</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">newAttributes</code><code class="p">());</code>
        <code class="nx">context</code><code class="p">.</code><code class="nx">input</code><code class="p">.</code><code class="nx">val</code><code class="p">(</code><code class="s">''</code><code class="p">);</code>
    <code class="p">});</code>



    <code class="c">// A Todo and remaining entry counter</code>
    <code class="c">// Subscribes to: renderDone</code>
    <code class="nx">facade</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s">'todoCounter'</code><code class="p">,</code><code class="s">'renderDone'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">context</code><code class="p">,</code> <code class="nx">Todos</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">var</code> <code class="nx">done</code> <code class="o">=</code> <code class="nx">Todos</code><code class="p">.</code><code class="nx">done</code><code class="p">().</code><code class="nx">length</code><code class="p">;</code>
        <code class="nx">context</code><code class="p">.</code><code class="nx">$</code><code class="p">(</code><code class="s">'#todo-stats'</code><code class="p">).</code><code class="nx">html</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">statsTemplate</code><code class="p">({</code>
            <code class="nx">total</code><code class="o">:</code> <code class="nx">Todos</code><code class="p">.</code><code class="nx">length</code><code class="p">,</code>
            <code class="nx">done</code><code class="o">:</code> <code class="nx">Todos</code><code class="p">.</code><code class="nx">done</code><code class="p">().</code><code class="nx">length</code><code class="p">,</code>
            <code class="nx">remaining</code><code class="o">:</code> <code class="nx">Todos</code><code class="p">.</code><code class="nx">remaining</code><code class="p">().</code><code class="nx">length</code>
        <code class="p">}));</code>
    <code class="p">});</code>


    <code class="c">// Clear all completed todos when clearContent is dispatched</code>
    <code class="c">// Subscribes to: clearContent</code>
    <code class="nx">facade</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s">'garbageCollector'</code><code class="p">,</code><code class="s">'clearContent'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">Todos</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">_</code><code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="nx">Todos</code><code class="p">.</code><code class="nx">done</code><code class="p">(),</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">todo</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">todo</code><code class="p">.</code><code class="nx">clear</code><code class="p">();</code>
        <code class="p">});</code>
    <code class="p">});</code>


<code class="p">});</code>
</pre><p class="calibre6">
        That’s it for this section. If you’ve been intrigued by some of
        the concepts covered, I encourage you to consider taking a look
        at my
        <a class="ulink" href="http://addyosmani.com/blog/large-scale-javascript-application-architecture/">slides</a>
        on Large-scale JS from the jQuery Summit or my longer post on
        the topic
        <a class="ulink" href="http://addyosmani.com/largescalejavascript">here</a>
        for more information.
      </p></div></div></div>

{% endraw %}

