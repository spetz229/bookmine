---
layout: page
title: "Developing Backbone.js Applications"
prev: OEBPS/ch03s02.html
next: OEBPS/ch03s04.html
book_path: books/developing-backbone-js-applications-addy-osmani--_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="book" title="Building Backbone.js Apps With Ruby, Sinatra, MongoDB and Haml"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="building-backbone.js-apps-with-ruby-sinatra-mongodb-and-haml" class="calibre1"></a>Building Backbone.js Apps With Ruby, Sinatra,
  MongoDB and Haml</h1></div></div></div><div class="book" title="Introduction"><div class="book"><div class="book"><div class="book"><h2 class="title3"><a id="introduction-1" class="calibre1"></a>Introduction</h2></div></div></div><p class="calibre6">
      In this chapter we’re going to explore writing Backbone.js
      applications with a Ruby back-end. To assist with this, we’re
      going to use
      <a class="ulink" href="http://www.sinatrarb.com/">Sinatra</a> - a DSL
      (domain specific language) for rapidly creating web applications
      in Ruby. Similar to the
      <a class="ulink" href="https://github.com/addyosmani/backbone-fundamentals/#stack1">section</a>
      on writing an application with Node.js, our server-side language
      (Ruby) will be used to power an API whilst Backbone.js will be the
      client consuming it.
    </p></div><div class="book" title="What Is Sinatra?"><div class="book"><div class="book"><div class="book"><h2 class="title3"><a id="what-is-sinatra" class="calibre1"></a>What Is Sinatra?</h2></div></div></div><p class="calibre6">
      In the past, you’ve likely come across or used
      <a class="ulink" href="http://rubyonrails.org">Ruby on Rails</a> (RoR) -
      a popular web application framework for the Ruby programming
      language that helps organize applications using the MVC pattern.
      Sinatra is a much smaller, more light-weight alternative to it.
    </p><p class="calibre6">
      Whilst a very basic Rails application may require a more strict
      project structure (such as requiring the use of controllers, views
      and routing etc.), Sinatra doesn’t require as many of these
      dependencies, sacrificing the helpers needed to connect to
      databases, tools to create forms or any of the other utilities
      Rails comes with out of the box.
    </p><p class="calibre6">
      What Sinatra does have is a
      <span class="firstname"><strong class="calibre8">minimal</strong></span> set of features most
      useful for tying specific URLs and RESTful HTTP actions to blocks
      of Ruby code and returning this code’s output as a response.
      Sinatra is particularly useful for getting projects up and running
      quickly where we don’t have a need for the extra pieces RoR
      provides.
    </p><p class="calibre6">
      For those who are familiar with more Rails, you probably know that
      it requires a separate routes file to define how an application
      should be responding to requests. These are then piped into the
      relevant models and controllers as needed.
    </p><p class="calibre6">
      Sinatra takes a more straight-forward approach, providing us with
      the most simple path to handling routing. By declaring
      <code class="literal">get</code>,<code class="literal">post</code>,
      <code class="literal">put</code> or <code class="literal">delete</code> actions, we
      can inform Sinatra to add a new route, which we can then have
      respond to requests.
    </p><p class="calibre6">
      The framework is particularly useful for writing APIs, widgets and
      small-scale applications that can power the backend of a
      client-heavy application. As mentioned, we will be using it to
      power our API.
    </p></div><div class="book" title="Getting Started With Sinatra"><div class="book"><div class="book"><div class="book"><h2 class="title3"><a id="getting-started-with-sinatra" class="calibre1"></a>Getting Started With Sinatra</h2></div></div></div><p class="calibre6">
      Let’s review how to write and run a very basic Sinatra
      application. As most programming languages and frameworks
      typically start with some variation of <span class="firstname">“<span class="firstname">Hello World</span>”</span>,
      we’ll start with a similar example.
    </p><p class="calibre6">
      Note: Before beginning this section, I recommend installing
      Sinatra on your system. A guide to doing this can be found in the
      <a class="firstname" href="ch03s05.html#preq">prerequisites</a> section lower down in
      the article.
    </p><div class="book" title="Routes"><div class="book"><div class="book"><div class="book"><h3 class="title4"><a id="routes" class="calibre1"></a>Routes</h3></div></div></div><p class="calibre6">
        As mentioned, Sinatra allows us to define new routes using HTTP
        actions. Semantically, a route follows quite a simple structure:
      </p><pre class="programlistingjavascript"><code class="o">&lt;</code><code class="nx">a</code> <code class="no">HTTP</code> <code class="nx">action</code><code class="o">&gt;</code> <code class="o">&lt;</code><code class="nx">the</code> <code class="nx">desired</code> <code class="nx">route</code><code class="o">&gt;</code> <code class="kd">do</code>
   <code class="c"># some behaviour</code>
<code class="kd">end</code>
</pre><p class="calibre6">
        A tiny route that outputs a <span class="firstname">“<span class="firstname">Hello World</span>”</span>-like
        message when we attempt to <span class="firstname">“<span class="firstname">get</span>”</span> the root could
        thus be written as follows:
      </p><pre class="programlistingjavascript"><code class="nb">require</code> <code class="s">'sinatra'</code>

<code class="nx">get</code> <code class="s">'/'</code> <code class="kd">do</code>
   <code class="s">"Hello World! Is it me you're looking for?"</code>
<code class="kd">end</code>
</pre><p class="calibre6">
        To run this snippet, we can can simply save it to a local ’.rb’
        file and execute it as follows:
      </p><pre class="programlistingjavascript"><code class="nx">ruby</code> <code class="o">-</code><code class="nx">rubygems</code> <code class="nx">example</code><code class="o">.</code><code class="nx">rb</code>
</pre><p class="calibre6">
        If we now navigated to http://localhost:4567 in our browser we
        could now see the application running successfully.
      </p><p class="calibre6">
        The HTTP verbs we commonly work with when writing RESTful web
        services are: <code class="literal">get</code>, <code class="literal">post</code>,
        <code class="literal">delete</code> and <code class="literal">put</code>. As we now
        know, all Sinatra routes are basically HTTP actions
        (`<code class="literal">get</code> etc.) that are paired with a
        URL-matching pattern. We associate a pair of an action and route
        with code we would like sent back to the browser (executed)if
        the route is reached. Sinatra doesn’t enforce much in the way of
        architectural structure, instead relying on simplicity to
        supporting writing powerful APIs.
      </p><p class="calibre6">
        Here’s an example of a skeleton service we could put together
        supporting four common HTTP actions: ruby ``` get
        <span class="firstname">“<span class="firstname">/items</span>”</span> do # list all items available end
      </p><p class="calibre6">
        get <span class="firstname">“<span class="firstname">/item/:id</span>”</span> do # get a single item end
      </p><p class="calibre6">
        post <span class="firstname">“<span class="firstname">/item</span>”</span> do # create a new item end
      </p><p class="calibre6">
        put <span class="firstname">“<span class="firstname">/item/:id</span>”</span> do # update an existing item end
      </p><p class="calibre6">
        delete <span class="firstname">“<span class="firstname">/item/:id</span>”</span> do # delete an item end ```
      </p><p class="calibre6">
        Sinatra’s routing is both easy for beginners to get started with
        but is also flexible enough for those wishing to define more
        complex routes. As you probably noticed in the above example,
        routes can include named parameters (e.g
        <code class="literal">/item/:id</code>). We can actually access the
        content of these routes using the <code class="literal">params</code> hash
        as follows:
      </p><pre class="programlistingjavascript"><code class="nx">get</code> <code class="s">'/item/:id'</code> <code class="kd">do</code>
  <code class="c"># this matches "GET /item/10" and "GET /item/11"</code>
  <code class="c"># params[:id] is "10" or "11"</code>
  <code class="s">"You reached </code><code class="err">#{</code><code class="nx">params</code><code class="o">[</code><code class="ss">:id</code><code class="o">]</code><code class="err">}</code><code class="s">"</code>
<code class="kd">end</code>
</pre><p class="calibre6">
        Sinatra also supports route matching via splats, wildcards and
        regular expressions. For more information on this I recommend
        reading the official
        <a class="ulink" href="http://www.sinatrarb.com/documentation">docs</a>.
        Let’s now take a look at handlers.
      </p><p class="calibre6">
        Sinatra includes convenient handler methods for tasks such as
        redirection, halting and passing.
      </p><div class="book" title="Redirection"><div class="book"><div class="book"><div class="book"><h4 class="title5"><a id="redirection" class="firstname"></a>Redirection</h4></div></div></div><p class="calibre6">
          A simple route supporting redirection which returns a 302
          response can be written as follows:
        </p><pre class="programlistingjavascript"><code class="nx">get</code> <code class="s">'/items'</code> <code class="kd">do</code>
      <code class="nx">redirect</code> <code class="s">'/items/welcome'</code>
<code class="kd">end</code>
</pre><p class="calibre6">
          And if we wish to pass additional parameters such as arguments
          we can do so like this: redirect
          <span class="firstname">“<span class="firstname">http://site.com/</span>”</span>, <span class="firstname">“<span class="firstname">Oops! I think we have
          a problem!</span>”</span>
        </p></div><div class="book" title="Halting"><div class="book"><div class="book"><div class="book"><h4 class="title5"><a id="halting" class="firstname"></a>Halting</h4></div></div></div><p class="calibre6">
          To immediately stop a request (halting) we can use
          <span class="firstname">“<span class="firstname">halt</span>”</span>. Heres an example of halting a request
          where we specify the message body:
        </p><p class="calibre6">
          <code class="literal">halt "who goes there!?"</code>
        </p></div><div class="book" title="Passing"><div class="book"><div class="book"><div class="book"><h4 class="title5"><a id="passing" class="firstname"></a>Passing</h4></div></div></div><p class="calibre6">
          <span class="firstname">“<span class="firstname">Passing</span>”</span> is the concept of deferring processing
          of a block to the next matching route. We do this using
          <code class="literal">pass</code>. In the following example if a
          parameter isnt the username we expect (rick-astley) we simply
          pass it on:
        </p><pre class="programlistingjavascript"><code class="nx">get</code> <code class="s">'/members/:username'</code> <code class="kd">do</code>
 <code class="nx">pass</code> <code class="kd">unless</code> <code class="nx">params</code><code class="o">[</code><code class="ss">:username</code><code class="o">]</code> <code class="o">==</code> <code class="s">'rick-astley'</code>
 <code class="s">'Never gonna give you up, never gonna let you down'</code>
<code class="kd">end</code>

<code class="nx">get</code> <code class="s">'/member/*'</code> <code class="kd">do</code>
 <code class="s">'Welcome!'</code>
<code class="kd">end</code>
</pre><p class="calibre6">
          There are also handler methods that can assist with sessions
          (specifically, cookie-based session handling). To use
          Sinatra’s session handling, first enable it in your
          application with:
        </p><pre class="programlistingjavascript"><code class="nx">enable</code> <code class="ss">:sessions</code>
</pre><p class="calibre6">
          You can then use the session handling capabilities as follows:
        </p><pre class="programlistingjavascript"><code class="nx">get</code> <code class="s">'/items'</code> <code class="kd">do</code>
  <code class="nx">session</code><code class="o">[</code><code class="s">'visitCounter'</code><code class="o">]</code> <code class="o">||=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="nx">session</code><code class="o">[</code><code class="s">'visitCounter'</code><code class="o">]</code> <code class="o">+=</code> <code class="mi">1</code><code class="p">;</code>
  <code class="s">"This page has been accessed </code><code class="err">#{</code><code class="nx">session</code><code class="o">[</code><code class="s">'visitCounter'</code><code class="o">]</code><code class="err">}</code><code class="s"> times"</code>
<code class="kd">end</code>
</pre><p class="calibre6">
          Note: By default enable:sessions will store all data in
          cookies. If this is not desired, you can not call this and
          instead use some Rack middleware instead. For more on this see
          <a class="ulink" href="http://www.sinatrarb.com/intro#Using%20Sessions">here</a>.
        </p><p class="calibre6">
          This only touches the surface of what can be done using routes
          and handlers, but is sufficient for us to write the
          Sinatra-powered API service we require in the practical
          section of this chapter.
        </p></div></div></div><div class="book" title="Templating And HAML"><div class="book"><div class="book"><div class="book"><h2 class="title3"><a id="templating-and-haml" class="calibre1"></a>Templating And HAML</h2></div></div></div><p class="calibre6">
      Let’s now discuss templating.Out of the box, we can begin using
      templates in our Sinatra applications with ERB. ERB is included
      with Ruby and allows Ruby code to be added to any plain text
      document for the purpose of generating information or flow
      control. In the following example using an ERB template, note that
      views are by default located in the <code class="literal">views</code>
      directory of our application.
    </p><pre class="programlistingjavascript"><code class="nx">get</code> <code class="s">'/items'</code> <code class="kd">do</code>
  <code class="nx">erb</code> <code class="ss">:default</code>
  <code class="c"># renders views/default.erb</code>
<code class="kd">end</code>
</pre><p class="calibre6">
      A useful Sinatra convention worth noting is how layouts are
      handled. Layouts automatically search for a views/layout template
      which is rendered before any other views are loaded. With ERB, our
      views/layout.erb file could look as follows:
    </p><pre class="programlistingjavascript"><code class="nt">&lt;html&gt;</code>
  <code class="nt">&lt;head&gt;&lt;/head&gt;</code>
  <code class="nt">&lt;body&gt;</code>
    <code class="err">&lt;</code>%= data %&gt;
  <code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code>
</pre><p class="calibre6">
      Haml is a popular alternative to ERB which offers an abstract
      syntax for writing application templates. It has been said to be:
    </p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre6">
          Straight-forward to learn
        </p></li><li class="listitem"><p class="calibre6">
          Very easy to read and use for visually expressing a hierarchy
          of DOM elements
        </p></li><li class="listitem"><p class="calibre6">
          Popular with web designers as it builds on top of CSS syntax
        </p></li><li class="listitem"><p class="calibre6">
          Well documented with a large community backing it
        </p></li><li class="listitem"><p class="calibre6">
          Almost as fast as ERB
        </p></li></ul></div><p class="calibre6">
      For the purpose of comparison, below we can see an ERB template
      compared to it’s Haml equivalent.
    </p><div class="book" title="ERB"><div class="book"><div class="book"><div class="book"><h3 class="title4"><a id="erb" class="calibre1"></a>ERB</h3></div></div></div><pre class="programlistingjavascript"><code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"todo"</code> <code class="na">id=</code><code class="s">"content"</code><code class="nt">&gt;</code>
  <code class="nt">&lt;h2</code> <code class="na">class=</code><code class="s">"entry_title"</code><code class="nt">&gt;</code><code class="err">&lt;</code>%= h @todo.title %&gt;<code class="nt">&lt;/h2&gt;</code>
  <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"entry_link"</code><code class="nt">&gt;</code><code class="err">&lt;</code>%= link_to('link', @todo.link) %&gt;<code class="nt">&lt;/div&gt;</code>
<code class="nt">&lt;/div&gt;</code>
</pre></div><div class="book" title="Haml"><div class="book"><div class="book"><div class="book"><h3 class="title4"><a id="haml" class="calibre1"></a>Haml</h3></div></div></div><pre class="programlistingjavascript">.todo#content
  %h2.entry_title= @todo.title
  .entry_link= link_to('link', @todo.link)
</pre><p class="calibre6">
        One of the first things we notice is that the Haml snippet looks
        significantly more like CSS than it does traditional markup.
        It’s much easier to read and we no longer need to be concerned
        with divs, spans, closing tags or other semantic rules that
        usually mean more keystrokes. The approach taken to making
        whitespace a part of the syntax also means it can be much easier
        to compare changes between multiple documents (especially if
        you’re doing a diff).
      </p><p class="calibre6">
        In the list of Haml features, we briefly mentioned web
        designers. As developers, we regularly need to communicate and
        work with designers, but we always have to remember that at the
        end of the day, they are not programmers. They’re usually more
        concerned with the look and the feel of an application, but if
        we want them to write mark-up as a part of the templates or
        skins they create, Haml is a simpler option that has worked well
        for teams at a number of companies.
      </p><pre class="programlistingjavascript"><code class="o">%</code><code class="nx">h1</code> <code class="no">This</code> <code class="nx">is</code> <code class="nx">some</code> <code class="nx">h1</code> <code class="nx">text</code>
<code class="o">%</code><code class="nx">h2</code> <code class="no">This</code> <code class="nx">is</code> <code class="nx">some</code> <code class="nx">h2</code> <code class="nx">text</code><code class="o">.</code>

<code class="o">%</code><code class="nb">p</code> <code class="no">Now</code> <code class="nx">we</code> <code class="nx">have</code> <code class="nx">a</code> <code class="nx">line</code> <code class="nx">containing</code> <code class="nx">a</code> <code class="nx">single</code> <code class="nx">instance</code> <code class="nx">variable</code><code class="p">:</code> <code class="vi">@content</code>
<code class="o">%</code><code class="nb">p</code><code class="o">=</code> <code class="vi">@content</code>

<code class="o">%</code><code class="nb">p</code> <code class="no">Embedding</code> <code class="no">Ruby</code> <code class="nx">code</code> <code class="kd">in</code> <code class="nx">the</code> <code class="nx">middle</code> <code class="nx">of</code> <code class="nx">a</code> <code class="nx">line</code> <code class="nx">can</code> <code class="nx">be</code> <code class="nx">done</code> <code class="nx">using</code> <code class="o">==.</code>
<code class="o">%</code><code class="nb">p</code><code class="o">==</code> <code class="no">Here</code> <code class="nx">is</code> <code class="nx">an</code> <code class="nx">example</code><code class="p">:</code> <code class="c">#{@foobar}</code>

<code class="o">%</code><code class="nb">p</code> <code class="no">We</code> <code class="nx">can</code> <code class="nx">also</code> <code class="nx">add</code> <code class="nx">attributes</code> <code class="nx">using</code> <code class="p">{}</code>
<code class="o">%</code><code class="nb">p</code><code class="p">{</code><code class="ss">:style</code> <code class="o">=&gt;</code> <code class="s">"color:green"</code><code class="p">}</code> <code class="no">We</code> <code class="nx">just</code> <code class="nx">made</code> <code class="nx">this</code> <code class="nx">paragraph</code> <code class="nx">green!</code>

<code class="o">%</code><code class="nb">p</code> <code class="no">You</code><code class="err">'</code><code class="nx">ll</code> <code class="nx">want</code> <code class="nx">to</code> <code class="nx">apply</code> <code class="nx">classes</code> <code class="ow">and</code> <code class="nx">ids</code> <code class="nx">to</code> <code class="nx">your</code> <code class="no">DOM</code><code class="p">,</code> <code class="nx">too</code><code class="o">.</code>
<code class="o">%</code><code class="nb">p</code><code class="o">.</code><code class="nx">foo</code> <code class="no">This</code> <code class="nx">has</code> <code class="nx">the</code> <code class="nx">foo</code> <code class="kd">class</code>
<code class="o">%</code><code class="nb">p</code><code class="o">.</code><code class="nx">bar</code> <code class="no">This</code> <code class="nx">has</code> <code class="nx">the</code> <code class="nx">bar</code> <code class="kd">class</code>
<code class="o">%</code><code class="nb">p</code><code class="c">#foobar This has the foobar id</code>
<code class="o">%</code><code class="nb">p</code><code class="o">.</code><code class="nx">foo</code><code class="c">#foobar Or you can combine them!</code>

<code class="o">%</code><code class="nb">p</code> <code class="no">Nesting</code> <code class="nx">can</code> <code class="nx">be</code> <code class="nx">done</code> <code class="nx">like</code> <code class="nx">this</code>
<code class="o">%</code><code class="nb">p</code>
  <code class="no">Or</code> <code class="nx">even</code> <code class="nx">like</code> <code class="nx">this</code>
</pre><p class="calibre6">
        Note: Haml is whitespace sensitive and will not correctly work
        if it isn’t indented by an even number of spaces. This is due to
        whitespace being used for nesting in place of the classic HTML
        markup approach of closing tags.
      </p></div></div></div></div>

{% endraw %}

