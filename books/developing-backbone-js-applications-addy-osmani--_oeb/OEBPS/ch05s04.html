---
layout: page
title: "Developing Backbone.js Applications"
prev: OEBPS/ch05s03.html
next: OEBPS/ch05s05.html
book_path: books/developing-backbone-js-applications-addy-osmani--_oeb/
---
{% include JB/setup %}
{% raw %}
<div>
<div class="book" title="SinonJS"><div class="book"><div class="book"><div class="book"><h1 class="title2"><a id="sinonjs" class="calibre1"></a>SinonJS</h1></div></div></div><p class="calibre6">
    Similar to the section on testing Backbone.js apps using the Jasmine
    BDD framework, we’re nearly ready to take what we’ve learned and
    write a number of QUnit tests for our Todo application.
  </p><p class="calibre6">
    Before we start though, you may have noticed that QUnit doesn’t
    support test spies. Test spies are functions which record arguments,
    exceptions and return values for any of their calls. They’re
    typically used to test callbacks and how functions may be used in
    the application being tested. In testing frameworks, spies can
    usually be either anonymous functions or wrap functions which
    already exist.
  </p><div class="book" title="What is SinonJS?"><div class="book"><div class="book"><div class="book"><h2 class="title3"><a id="what-is-sinonjs" class="calibre1"></a>What is SinonJS?</h2></div></div></div><p class="calibre6">
      In order for us to substitute support for spies in QUnit, we will
      be taking advantage of a mocking framework called
      <a class="ulink" href="http://sinonjs.org/">SinonJS</a> by Christian
      Johansen. We will also be using the
      <a class="ulink" href="http://sinonjs.org/qunit/">SinonJS-QUnit
      adapter</a> which provides seamless integration with QUnit
      (meaning setup is minimal). Sinon.JS is completely test-framework
      agnostic and should be easy to use with any testing framework, so
      it’s ideal for our needs.
    </p><p class="calibre6">
      The framework supports three features we’ll be taking advantage of
      for unit testing our application:
    </p><div class="book"><ul class="itemizedlist"><li class="listitem"><p class="calibre6">
          <span class="firstname"><strong class="calibre8">Anonymous spies</strong></span>
        </p></li><li class="listitem"><p class="calibre6">
          <span class="firstname"><strong class="calibre8">Spying on existing methods</strong></span>
        </p></li><li class="listitem"><p class="calibre6">
          <span class="firstname"><strong class="calibre8">A rich inspection interface</strong></span>
        </p></li></ul></div><p class="calibre6">
      Using <code class="literal">this.spy()</code> without any arguments creates
      an anonymous spy. This is comparable to
      <code class="literal">jasmine.createSpy()</code> and we can observe basic
      usage of a SinonJS spy in the following example:
    </p><div class="book" title="Basic Spies:"><div class="book"><div class="book"><div class="book"><h3 class="title4"><a id="basic-spies" class="calibre1"></a>Basic Spies:</h3></div></div></div><pre class="programlistingjavascript"><code class="nx">test</code><code class="p">(</code><code class="s">"should call all subscribers for a message exactly once"</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">message</code> <code class="o">=</code> <code class="nx">getUniqueString</code><code class="p">();</code>
    <code class="kd">var</code> <code class="nx">spy</code> <code class="o">=</code> <code class="kd">this</code><code class="p">.</code><code class="nx">spy</code><code class="p">();</code>

    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code> <code class="nx">message</code><code class="p">,</code> <code class="nx">spy</code> <code class="p">);</code>
    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">publishSync</code><code class="p">(</code> <code class="nx">message</code><code class="p">,</code> <code class="s">"Hello World"</code> <code class="p">);</code>

    <code class="nx">ok</code><code class="p">(</code> <code class="nx">spy1</code><code class="p">.</code><code class="nx">calledOnce</code><code class="p">,</code> <code class="s">"the subscriber was called once"</code> <code class="p">);</code>
<code class="p">});</code>
</pre><p class="calibre6">
        We can also use <code class="literal">this.spy()</code> to spy on existing
        functions (like jQuery’s <code class="literal">$.ajax</code>) in the
        example below. When spying on a function which already exists,
        the function behaves normally but we get access to data about
        its calls which can be very useful for testing purposes.
      </p></div><div class="book" title="Spying On Existing Functions:"><div class="book"><div class="book"><div class="book"><h3 class="title4"><a id="spying-on-existing-functions" class="calibre1"></a>Spying On Existing Functions:</h3></div></div></div><pre class="programlistingjavascript"><code class="nx">test</code><code class="p">(</code> <code class="s">"should inspect jQuery.getJSON's usage of jQuery.ajax"</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">this</code><code class="p">.</code><code class="nx">spy</code><code class="p">(</code> <code class="nx">jQuery</code><code class="p">,</code> <code class="s">"ajax"</code> <code class="p">);</code>

    <code class="nx">jQuery</code><code class="p">.</code><code class="nx">getJSON</code><code class="p">(</code> <code class="s">"/todos/completed"</code> <code class="p">);</code>

    <code class="nx">ok</code><code class="p">(</code> <code class="nx">jQuery</code><code class="p">.</code><code class="nx">ajax</code><code class="p">.</code><code class="nx">calledOnce</code> <code class="p">);</code>
    <code class="nx">equals</code><code class="p">(</code> <code class="nx">jQuery</code><code class="p">.</code><code class="nx">ajax</code><code class="p">.</code><code class="nx">getCall</code><code class="p">(</code><code class="mi">0</code><code class="p">).</code><code class="nx">args</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">url</code><code class="p">,</code> <code class="s">"/todos/completed"</code> <code class="p">);</code>
    <code class="nx">equals</code><code class="p">(</code> <code class="nx">jQuery</code><code class="p">.</code><code class="nx">ajax</code><code class="p">.</code><code class="nx">getCall</code><code class="p">(</code><code class="mi">0</code><code class="p">).</code><code class="nx">args</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">dataType</code><code class="p">,</code> <code class="s">"json"</code> <code class="p">);</code>
<code class="p">});</code>
</pre><p class="calibre6">
        SinonJS comes with a rich spy interface which allows us to test
        whether a spy was called with a specific argument, if it was
        called a specific number of times and test against the values of
        arguments. A complete list of features supported in the
        interface can be found here (http://sinonjs.org/docs/), but
        let’s take a look at some examples demonstrating some of the
        most commonly used ones:
      </p></div><div class="book" title="Matching arguments: test a spy was called with a specific set of arguments:"><div class="book"><div class="book"><div class="book"><h3 class="title4"><a id="matching-arguments-test-a-spy-was-called-with-a-specific-set-of-arguments" class="calibre1"></a>Matching arguments: test a spy was called with a specific
      set of arguments:</h3></div></div></div><pre class="programlistingjavascript"><code class="nx">test</code><code class="p">(</code> <code class="s">"Should call a subscriber with standard matching"</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">spy</code> <code class="o">=</code> <code class="nx">sinon</code><code class="p">.</code><code class="nx">spy</code><code class="p">();</code>

    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code> <code class="s">"message"</code><code class="p">,</code> <code class="nx">spy</code> <code class="p">);</code>
    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">publishSync</code><code class="p">(</code> <code class="s">"message"</code><code class="p">,</code> <code class="p">{</code> <code class="nx">id</code><code class="o">:</code> <code class="mi">45</code> <code class="p">}</code> <code class="p">);</code>

    <code class="nx">assertTrue</code><code class="p">(</code> <code class="nx">spy</code><code class="p">.</code><code class="nx">calledWith</code><code class="p">(</code> <code class="p">{</code> <code class="nx">id</code><code class="o">:</code> <code class="mi">45</code> <code class="p">}</code> <code class="p">)</code> <code class="p">);</code>
<code class="p">});</code>
</pre></div><div class="book" title="Stricter argument matching: test a spy was called at least once with specific arguments and no others:"><div class="book"><div class="book"><div class="book"><h3 class="title4"><a id="stricter-argument-matching-test-a-spy-was-called-at-least-once-with-specific-arguments-and-no-others" class="calibre1"></a>Stricter argument matching: test a spy was called at least
      once with specific arguments and no others:</h3></div></div></div><pre class="programlistingjavascript"><code class="nx">test</code><code class="p">(</code> <code class="s">"Should call a subscriber with strict matching"</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">spy</code> <code class="o">=</code> <code class="nx">sinon</code><code class="p">.</code><code class="nx">spy</code><code class="p">();</code>

    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code> <code class="s">"message"</code><code class="p">,</code> <code class="nx">spy</code> <code class="p">);</code>
    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">publishSync</code><code class="p">(</code> <code class="s">"message"</code><code class="p">,</code> <code class="s">"many"</code><code class="p">,</code> <code class="s">"arguments"</code> <code class="p">);</code>
    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">publishSync</code><code class="p">(</code> <code class="s">"message"</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="mi">34</code> <code class="p">);</code>

    <code class="c">// This passes</code>
    <code class="nx">assertTrue</code><code class="p">(</code> <code class="nx">spy</code><code class="p">.</code><code class="nx">calledWith</code><code class="p">(</code><code class="s">"many"</code><code class="p">)</code> <code class="p">);</code>     

    <code class="c">// This however, fails   </code>
    <code class="nx">assertTrue</code><code class="p">(</code> <code class="nx">spy</code><code class="p">.</code><code class="nx">calledWithExactly</code><code class="p">(</code> <code class="s">"many"</code> <code class="p">)</code> <code class="p">);</code> 
<code class="p">});</code>
</pre></div><div class="book" title="Testing call order: testing if a spy was called before or after another spy:"><div class="book"><div class="book"><div class="book"><h3 class="title4"><a id="testing-call-order-testing-if-a-spy-was-called-before-or-after-another-spy" class="calibre1"></a>Testing call order: testing if a spy was called before or
      after another spy:</h3></div></div></div><pre class="programlistingjavascript"><code class="nx">test</code><code class="p">(</code> <code class="s">"Should call a subscriber and maintain call order"</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">a</code> <code class="o">=</code> <code class="nx">sinon</code><code class="p">.</code><code class="nx">spy</code><code class="p">();</code>
    <code class="kd">var</code> <code class="nx">b</code> <code class="o">=</code> <code class="nx">sinon</code><code class="p">.</code><code class="nx">spy</code><code class="p">();</code>

    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code> <code class="s">"message"</code><code class="p">,</code> <code class="nx">a</code> <code class="p">);</code>
    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code> <code class="s">"event"</code><code class="p">,</code> <code class="nx">b</code> <code class="p">);</code>

    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">publishSync</code><code class="p">(</code> <code class="s">"message"</code><code class="p">,</code> <code class="p">{</code> <code class="nx">id</code><code class="o">:</code> <code class="mi">45</code> <code class="p">}</code> <code class="p">);</code>
    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">publishSync</code><code class="p">(</code> <code class="s">"event"</code><code class="p">,</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">]</code> <code class="p">);</code>

    <code class="nx">assertTrue</code><code class="p">(</code> <code class="nx">a</code><code class="p">.</code><code class="nx">calledBefore</code><code class="p">(</code><code class="nx">b</code><code class="p">)</code> <code class="p">);</code>
    <code class="nx">assertTrue</code><code class="p">(</code> <code class="nx">b</code><code class="p">.</code><code class="nx">calledAfter</code><code class="p">(</code><code class="nx">a</code><code class="p">)</code> <code class="p">);</code>
<code class="p">});</code>
</pre></div><div class="book" title="Match execution counts: test a spy was called a specific number of times:"><div class="book"><div class="book"><div class="book"><h3 class="title4"><a id="match-execution-counts-test-a-spy-was-called-a-specific-number-of-times" class="calibre1"></a>Match execution counts: test a spy was called a specific
      number of times:</h3></div></div></div><pre class="programlistingjavascript"><code class="nx">test</code><code class="p">(</code> <code class="s">"Should call a subscriber and check call counts"</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">message</code> <code class="o">=</code> <code class="nx">getUniqueString</code><code class="p">();</code>
    <code class="kd">var</code> <code class="nx">spy</code> <code class="o">=</code> <code class="kd">this</code><code class="p">.</code><code class="nx">spy</code><code class="p">();</code>

    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code> <code class="nx">message</code><code class="p">,</code> <code class="nx">spy</code> <code class="p">);</code>
    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">publishSync</code><code class="p">(</code> <code class="nx">message</code><code class="p">,</code> <code class="s">"some payload"</code> <code class="p">);</code>


    <code class="c">// Passes if spy was called once and only once.</code>
    <code class="nx">ok</code><code class="p">(</code> <code class="nx">spy</code><code class="p">.</code><code class="nx">calledOnce</code> <code class="p">);</code> <code class="c">// calledTwice and calledThrice are also supported</code>

    <code class="c">// The number of recorded calls.</code>
    <code class="nx">equal</code><code class="p">(</code> <code class="nx">spy</code><code class="p">.</code><code class="nx">callCount</code><code class="p">,</code> <code class="mi">1</code> <code class="p">);</code>

    <code class="c">// Directly checking the arguments of the call</code>
    <code class="nx">equals</code><code class="p">(</code> <code class="nx">spy</code><code class="p">.</code><code class="nx">getCall</code><code class="p">(</code><code class="mi">0</code><code class="p">).</code><code class="nx">args</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code> <code class="nx">message</code> <code class="p">);</code>
<code class="p">});</code>
</pre></div></div><div class="book" title="Stubs and mocks"><div class="book"><div class="book"><div class="book"><h2 class="title3"><a id="stubs-and-mocks" class="calibre1"></a>Stubs and mocks</h2></div></div></div><p class="calibre6">
      SinonJS also supports two other powerful features which are useful
      to be aware of: stubs and mocks. Both stubs and mocks implement
      all of the features of the spy API, but have some added
      functionality.
    </p><div class="book" title="Stubs"><div class="book"><div class="book"><div class="book"><h3 class="title4"><a id="stubs" class="calibre1"></a>Stubs</h3></div></div></div><p class="calibre6">
        A stub allows us to replace any existing behaviour for a
        specific method with something else. They can be very useful for
        simulating exceptions and are most often used to write test
        cases when certain dependencies of your code-base may not yet be
        written.
      </p><p class="calibre6">
        Let us briefly re-explore our Backbone Todo application, which
        contained a Todo model and a TodoList collection. For the
        purpose of this walkthrough, we want to isolate our TodoList
        collection and fake the Todo model to test how adding new models
        might behave.
      </p><p class="calibre6">
        We can pretend that the models have yet to be written just to
        demonstrate how stubbing might be carried out. A shell
        collection just containing a reference to the model to be used
        might look like this:
      </p><pre class="programlistingjavascript"><code class="kd">var</code> <code class="nx">TodoList</code> <code class="o">=</code> <code class="nx">Backbone</code><code class="p">.</code><code class="nx">Collection</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
    <code class="nx">model</code><code class="o">:</code> <code class="nx">Todo</code>
<code class="p">});</code>

<code class="c">// Let's assume our instance of this collection is</code>
<code class="kd">this</code><code class="p">.</code><code class="nx">todoList</code><code class="p">;</code>
</pre><p class="calibre6">
        Assuming our collection is instantiating new models itself, it’s
        necessary for us to stub the models constructor function for the
        the test. This can be done by creating a simple stub as follows:
      </p><pre class="programlistingjavascript"><code class="kd">this</code><code class="p">.</code><code class="nx">todoStub</code> <code class="o">=</code> <code class="nx">sinon</code><code class="p">.</code><code class="nx">stub</code><code class="p">(</code> <code class="nb">window</code><code class="p">,</code> <code class="s">"Todo"</code> <code class="p">);</code>
</pre><p class="calibre6">
        The above creates a stub of the Todo method on the window
        object. When stubbing a persistent object, it’s necessary to
        restore it to its original state. This can be done in a
        <code class="literal">teardown()</code> as follows:
      </p><pre class="programlistingjavascript"><code class="kd">this</code><code class="p">.</code><code class="nx">todoStub</code><code class="p">.</code><code class="nx">restore</code><code class="p">();</code>
</pre><p class="calibre6">
        After this, we need to alter what the constructor returns, which
        can be efficiently done using a plain
        <code class="literal">Backbone.Model</code> constructor. Whilst this isn’t
        a Todo model, it does still provide us an actual Backbone model.
      </p><pre class="programlistingjavascript"><code class="nx">teardown</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">this</code><code class="p">.</code><code class="nx">todoStub</code> <code class="o">=</code> <code class="nx">sinon</code><code class="p">.</code><code class="nx">stub</code><code class="p">(</code> <code class="nb">window</code><code class="p">,</code> <code class="s">"Todo"</code> <code class="p">);</code>
    <code class="kd">this</code><code class="p">.</code><code class="nx">model</code> <code class="o">=</code> <code class="kd">new</code> <code class="nx">Backbone</code><code class="p">.</code><code class="nx">Model</code><code class="p">({</code>
      <code class="nx">id</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> 
      <code class="nx">title</code><code class="o">:</code> <code class="s">"Hello world"</code>
    <code class="p">});</code>
    <code class="kd">this</code><code class="p">.</code><code class="nx">todoStub</code><code class="p">.</code><code class="nx">returns</code><code class="p">(</code> <code class="kd">this</code><code class="p">.</code><code class="nx">model</code> <code class="p">);</code>
<code class="p">});</code>
</pre><p class="calibre6">
        The expectation here might be that this snippet would ensure our
        TodoList collection always instantiates a stubbed Todo model,
        but because a reference to the model in the collection is
        already present, we need to reset the model property of our
        collection as follows:
      </p><pre class="programlistingjavascript"><code class="kd">this</code><code class="p">.</code><code class="nx">todoList</code><code class="p">.</code><code class="nx">model</code> <code class="o">=</code> <code class="nx">Todo</code><code class="p">;</code>
</pre><p class="calibre6">
        The result of this is that when our TodoList collection
        instantiates new Todo models, it will return our plain Backbone
        model instance as desired. This allows us to write a spec for
        testing the addition of new model literals as follows:
      </p><pre class="programlistingjavascript"><code class="nx">module</code><code class="p">(</code> <code class="s">"Should function when instantiated with model literals"</code><code class="p">,</code> <code class="p">{</code>

  <code class="nx">setup</code><code class="o">:</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>

    <code class="kd">this</code><code class="p">.</code><code class="nx">todoStub</code> <code class="o">=</code> <code class="nx">sinon</code><code class="p">.</code><code class="nx">stub</code><code class="p">(</code><code class="nb">window</code><code class="p">,</code> <code class="s">"Todo"</code><code class="p">);</code>
    <code class="kd">this</code><code class="p">.</code><code class="nx">model</code> <code class="o">=</code> <code class="kd">new</code> <code class="nx">Backbone</code><code class="p">.</code><code class="nx">Model</code><code class="p">({</code>
      <code class="nx">id</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> 
      <code class="nx">title</code><code class="o">:</code> <code class="s">"Hello world"</code>
    <code class="p">});</code>

    <code class="kd">this</code><code class="p">.</code><code class="nx">todoStub</code><code class="p">.</code><code class="nx">returns</code><code class="p">(</code><code class="kd">this</code><code class="p">.</code><code class="nx">model</code><code class="p">);</code>
    <code class="kd">this</code><code class="p">.</code><code class="nx">todos</code> <code class="o">=</code> <code class="kd">new</code> <code class="nx">TodoList</code><code class="p">();</code>

    <code class="c">// Let's reset the relationship to use a stub</code>
    <code class="kd">this</code><code class="p">.</code><code class="nx">todos</code><code class="p">.</code><code class="nx">model</code> <code class="o">=</code> <code class="nx">Todo</code><code class="p">;</code> 
    <code class="kd">this</code><code class="p">.</code><code class="nx">todos</code><code class="p">.</code><code class="nx">add</code><code class="p">({</code>
      <code class="nx">id</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> 
      <code class="nx">title</code><code class="o">:</code> <code class="s">"Hello world"</code>
    <code class="p">});</code>
  <code class="p">},</code>

  <code class="nx">teardown</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">this</code><code class="p">.</code><code class="nx">todoStub</code><code class="p">.</code><code class="nx">restore</code><code class="p">();</code>
  <code class="p">}</code>

<code class="p">});</code>

<code class="nx">test</code><code class="p">(</code><code class="s">"should add a model"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">equal</code><code class="p">(</code> <code class="kd">this</code><code class="p">.</code><code class="nx">todos</code><code class="p">.</code><code class="nx">length</code><code class="p">,</code> <code class="mi">1</code> <code class="p">);</code>
<code class="p">});</code>

<code class="nx">test</code><code class="p">(</code><code class="s">"should find a model by id"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">equal</code><code class="p">(</code> <code class="kd">this</code><code class="p">.</code><code class="nx">todos</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="mi">5</code><code class="p">).</code><code class="nx">get</code><code class="p">(</code><code class="s">"id"</code><code class="p">),</code> <code class="mi">5</code> <code class="p">);</code>
  <code class="p">});</code>
<code class="p">});</code>
</pre></div><div class="book" title="Mocks"><div class="book"><div class="book"><div class="book"><h3 class="title4"><a id="mocks" class="calibre1"></a>Mocks</h3></div></div></div><p class="calibre6">
        Mocks are effectively the same as stubs, however they mock a
        complete API out and have some built-in expectations for how
        they should be used. The difference between a mock and a spy is
        that as the expectations for their use are pre-defined, it will
        fail if any of these are not met.
      </p><p class="calibre6">
        Here’s a snippet with sample usage of a mock based on PubSubJS.
        Here, we have a <code class="literal">clearTodo()</code> method as a
        callback and use mocks to verify its behavior.
      </p><pre class="programlistingjavascript"><code class="nx">test</code><code class="p">(</code><code class="s">"should call all subscribers when exceptions"</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">myAPI</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">clearTodo</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{}</code> <code class="p">};</code>

    <code class="kd">var</code> <code class="nx">spy</code> <code class="o">=</code> <code class="kd">this</code><code class="p">.</code><code class="nx">spy</code><code class="p">();</code>
    <code class="kd">var</code> <code class="nx">mock</code> <code class="o">=</code> <code class="kd">this</code><code class="p">.</code><code class="nx">mock</code><code class="p">(</code> <code class="nx">myAPI</code> <code class="p">);</code>
    <code class="nx">mock</code><code class="p">.</code><code class="nx">expects</code><code class="p">(</code> <code class="s">"clearTodo"</code> <code class="p">).</code><code class="nx">once</code><code class="p">().</code><code class="kd">throws</code><code class="p">();</code>

    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code> <code class="s">"message"</code><code class="p">,</code> <code class="nx">myAPI</code><code class="p">.</code><code class="nx">clearTodo</code> <code class="p">);</code>
    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code> <code class="s">"message"</code><code class="p">,</code> <code class="nx">spy</code> <code class="p">);</code>
    <code class="nx">PubSub</code><code class="p">.</code><code class="nx">publishSync</code><code class="p">(</code> <code class="s">"message"</code><code class="p">,</code> <code class="kd">undefined</code> <code class="p">);</code>

    <code class="nx">mock</code><code class="p">.</code><code class="nx">verify</code><code class="p">();</code>
    <code class="nx">ok</code><code class="p">(</code> <code class="nx">spy</code><code class="p">.</code><code class="nx">calledOnce</code> <code class="p">);</code>
<code class="p">});</code>
</pre></div></div></div></div>

{% endraw %}

